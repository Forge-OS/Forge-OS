const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./PerfChart-BaUZSk_m.js","./react-vendor-D4yGots9.js","./recharts-vendor-DqQ-4nM4.js","./d3-render-vendor-RkpHolfk.js","./d3-scale-vendor-BynLqmir.js","./IntelligencePanel-k9uqzesM.js","./TreasuryPanel-B20KsyP-.js","./PortfolioPanel-8fdeEgfw.js","./PnlAttributionPanel-DdqVmX3l.js","./AlertsPanel-CidWn8vy.js"])))=>i.map(i=>d[i]);
var Ji=Object.defineProperty;var Zi=(e,t,r)=>t in e?Ji(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var gt=(e,t,r)=>Zi(e,typeof t!="symbol"?t+"":t,r);import{j as n,r as y,R as Un,a as eo}from"./react-vendor-D4yGots9.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const a of d.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function r(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function s(o){if(o.ep)return;o.ep=!0;const d=r(o);fetch(o.href,d)}})();const Nt=[{id:"mainnet",label:"Kaspa Mainnet",aliases:["mainnet","kaspa_mainnet","kaspa-mainnet","mainnet-11","mainnet11"],addressPrefixes:["kaspa"]},{id:"testnet-10",label:"Kaspa Testnet 10",aliases:["testnet","testnet10","testnet-10","tn10","kaspa_testnet_10","kaspa-testnet-10"],addressPrefixes:["kaspatest"]},{id:"testnet-11",label:"Kaspa Testnet 11",aliases:["testnet11","testnet-11","tn11","kaspa_testnet_11","kaspa-testnet-11"],addressPrefixes:["kaspatest"]},{id:"testnet-12",label:"Kaspa Testnet 12",aliases:["testnet12","testnet-12","tn12","kaspa_testnet_12","kaspa-testnet-12"],addressPrefixes:["kaspatest"]},{id:"devnet",label:"Kaspa Devnet",aliases:["devnet","kaspadev","kaspa_devnet","kaspa-devnet"],addressPrefixes:["kaspadev"]},{id:"simnet",label:"Kaspa Simnet",aliases:["simnet","kaspasim","kaspa_simnet","kaspa-simnet"],addressPrefixes:["kaspasim"]}],to=Nt;function Ws(e){return String(e||"").trim().toLowerCase().replace(/_/g,"-")}function ro(e){const t=Ws(String(e??""));if(!t)return null;const r=Nt.find(s=>s.aliases.some(o=>Ws(o)===t));return r||(["livenet","live","main","0"].includes(t)?Nt[0]:["test","testnet","test-net","tn","1"].includes(t)?Nt[1]:["2","tn11"].includes(t)?Nt[2]:["3","tn12"].includes(t)?Nt[3]:null)}function sr(e){return ro(e||"mainnet")||Nt[0]}function ls(e,t){const r=e.indexOf(":");if(r<1)return!1;const s=e.slice(0,r).toLowerCase();return t.addressPrefixes.includes(s)}const us=(e,t=4)=>parseFloat(e||0).toFixed(t),$n=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),ml=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),Ze=e=>e?`${e.slice(0,18)}...${e.slice(-6)}`:"â€”",_l=(e,t,r)=>Math.min(r,Math.max(t,e)),vr=()=>Math.random().toString(36).slice(2,10),so=/^[qpzry9x8gf2tvdw0s3jn54khce6mua7l]+$/i,Bn=["kaspa","kaspatest","kaspadev","kaspasim"],St=(e,t=Bn)=>{const r=String(e||"").trim().toLowerCase(),s=r.indexOf(":");if(s<=0||s===r.length-1)return!1;const o=r.slice(0,s),d=r.slice(s+1);return!t.map(a=>a.toLowerCase()).includes(o)||d.length<61||d.length>63?!1:so.test(d)},$e=(e,t=Bn)=>{const r=String(e||"").trim();if(!St(r,t))throw new Error(`Invalid Kaspa address for allowed prefixes: ${t.join(", ")}`);const s=r.toLowerCase(),o=s.indexOf(":"),d=s.slice(0,o),a=s.slice(o+1);return`${d}:${a}`},no={},Q=no;function io(){if(typeof window>"u")return"";const e=new URLSearchParams(window.location.search).get("network");if(e)return e;try{window.localStorage.getItem("forgeos.network")&&window.localStorage.removeItem("forgeos.network")}catch{}return""}const Dn=io(),oo=Dn||Q.VITE_KAS_NETWORK||"mainnet",rr=sr(oo),Te=rr.id,Dt=Te.startsWith("testnet"),Qe=Dn?rr.label:Q.VITE_KAS_NETWORK_LABEL||rr.label,Ae=rr.addressPrefixes;function ao(e){return String(e||"").split(",").map(t=>t.trim()).filter(Boolean)}function fs(e){return String(e||"").trim().replace(/\/+$/,"")}function Rr(e,t,r){return String((Dt?t:e)||r||"").trim()}const co=Rr(Q.VITE_KAS_API_MAINNET,Q.VITE_KAS_API_TESTNET,Q.VITE_KAS_API),wr=fs(co||(Dt?"https://api-tn10.kaspa.org":"https://api.kaspa.org")),lo=Rr(Q.VITE_KAS_API_FALLBACKS_MAINNET,Q.VITE_KAS_API_FALLBACKS_TESTNET,Q.VITE_KAS_API_FALLBACKS),zn=ao(lo).map(e=>fs(e)).filter(e=>e&&e!==wr),uo=Rr(Q.VITE_KAS_EXPLORER_MAINNET,Q.VITE_KAS_EXPLORER_TESTNET,Q.VITE_KAS_EXPLORER),Ut=fs(uo||(Dt?"https://explorer-tn10.kaspa.org":"https://explorer.kaspa.org")),zr=Rr(Q.VITE_KAS_WS_URL_MAINNET,Q.VITE_KAS_WS_URL_TESTNET,Q.VITE_KAS_WS_URL),fo=Q.VITE_KASPIUM_DEEP_LINK_SCHEME||"kaspium://",ms=String(Q.VITE_KAS_ENFORCE_WALLET_NETWORK||"true").toLowerCase()!=="false",_r=String(Q.VITE_ACCUMULATE_ONLY||"true").toLowerCase()!=="false",Hs=[wr,...zn].map(e=>String(e||"").trim()).filter(Boolean),mo=new Set(Hs).size!==Hs.length;if(mo)throw new Error("Duplicate Kaspa API endpoints detected in VITE_KAS_API* configuration.");function zt(e,t,r){try{return $e(e,t)}catch{throw new Error(`Invalid ${r}. Expected prefixes: ${t.join(", ")}`)}}const Zr="kaspa:qpv7fcvdlz6th4hqjtm9qkkms2dw0raem963x3hm8glu3kjgj7922vy69hv85",_o=Q.VITE_TREASURY_ADDRESS_MAINNET||Zr,po=Q.VITE_TREASURY_ADDRESS_TESTNET||"kaspatest:qpqz2vxj23kvh0m73ta2jjn2u4cv4tlufqns2eap8mxyyt0rvrxy6ejkful67",Lr=zt(_o,["kaspa"],"VITE_TREASURY_ADDRESS_MAINNET"),_s=zt(po,["kaspatest"],"VITE_TREASURY_ADDRESS_TESTNET");if(Lr!==Zr)throw new Error(`Mainnet treasury address is pinned and must be ${Zr}.`);const ho=Q.VITE_ACCUMULATION_ADDRESS_MAINNET||Lr,go=Q.VITE_ACCUMULATION_ADDRESS_TESTNET||_s,So=zt(ho,["kaspa"],"VITE_ACCUMULATION_ADDRESS_MAINNET"),yo=zt(go,["kaspatest"],"VITE_ACCUMULATION_ADDRESS_TESTNET"),Eo=Q.VITE_DEMO_ADDRESS_MAINNET||Lr,xo=Q.VITE_DEMO_ADDRESS_TESTNET||_s,bo=zt(Eo,["kaspa"],"VITE_DEMO_ADDRESS_MAINNET"),Ao=zt(xo,["kaspatest"],"VITE_DEMO_ADDRESS_TESTNET"),To=Dt?Ao:bo,No=Dt?_s:Lr,Ir=Dt?yo:So,et=Number(Q.VITE_FEE_RATE||.2),ft=Number(Q.VITE_TREASURY_SPLIT||.3),ps=Number((1-ft).toFixed(2)),Yt=String(Q.VITE_TREASURY_FEE_ONCHAIN_ENABLED||"true").toLowerCase()!=="false",er=.5,vt=2e-4,Vs=.75,tr=Number(Q.VITE_FREE_CYCLES_PER_DAY||30);String(Q.VITE_BILLING_UPGRADE_URL||"").trim();String(Q.VITE_BILLING_CONTACT||"").trim();const Cr=Number(Q.VITE_AUTO_CYCLE_SECONDS||120),Gs=String(Q.VITE_LIVE_EXECUTION_DEFAULT||"false").toLowerCase()==="true",ot=Math.max(1,Math.round(Number(Q.VITE_PNL_REALIZED_MIN_CONFIRMATIONS||1)));function vo(e,t){const r=String(e||"").trim();if(!r)return null;try{const s=JSON.parse(r);if(!s||typeof s!="object"||Array.isArray(s))throw new Error("Expected a JSON object.");return s}catch(s){throw new Error(`Invalid ${t}: ${String((s==null?void 0:s.message)||s||"json_parse_error")}`)}}const Xt={base:ot,byAction:{REDUCE:Math.max(ot,ot+1),REBALANCE:Math.max(ot,ot+1)},byRisk:{HIGH:Math.max(ot,ot+1)},amountTiersKas:[]},nt=vo(Q.VITE_PNL_REALIZED_CONFIRMATION_POLICY_JSON,"VITE_PNL_REALIZED_CONFIRMATION_POLICY_JSON"),Io=nt?{...Xt,...nt,byAction:{...Xt.byAction,...typeof nt.byAction=="object"&&!Array.isArray(nt.byAction)?nt.byAction:{}},byRisk:{...Xt.byRisk,...typeof nt.byRisk=="object"&&!Array.isArray(nt.byRisk)?nt.byRisk:{}},amountTiersKas:Array.isArray(nt.amountTiersKas)?nt.amountTiersKas:Xt.amountTiersKas}:Xt,Co=Math.max(0,Number(Q.VITE_RECEIPT_CONSISTENCY_CONFIRM_TS_TOLERANCE_MS||15e3)),ko=Math.max(0,Number(Q.VITE_RECEIPT_CONSISTENCY_FEE_KAS_TOLERANCE||.001)),Mo=Math.max(0,Number(Q.VITE_RECEIPT_CONSISTENCY_SLIPPAGE_KAS_TOLERANCE||.02)),Wr=Math.max(2,Math.round(Number(Q.VITE_RECEIPT_CONSISTENCY_REPEAT_ALERT_THRESHOLD||3))),Ro=Math.max(1,Math.round(Number(Q.VITE_RECEIPT_CONSISTENCY_DEGRADE_MIN_CHECKS||6))),Ys=Math.max(0,Math.min(100,Number(Q.VITE_RECEIPT_CONSISTENCY_DEGRADE_MISMATCH_RATE_PCT||20))),wo=String(Q.VITE_RECEIPT_CONSISTENCY_BLOCK_AUTO_APPROVE_ON_DEGRADED||"true").toLowerCase()!=="false",Ot=String(Q.VITE_CALIBRATION_GUARDRAILS_ENABLED||"true").toLowerCase()!=="false",Xs=Math.max(1,Math.round(Number(Q.VITE_CALIBRATION_MIN_SAMPLES||12))),es=Math.max(0,Number(Q.VITE_CALIBRATION_BRIER_WARN||.24)),qs=Math.max(es,Number(Q.VITE_CALIBRATION_BRIER_CRITICAL||.34)),ts=Math.max(0,Number(Q.VITE_CALIBRATION_EV_CAL_ERROR_WARN_PCT||2)),Qs=Math.max(ts,Number(Q.VITE_CALIBRATION_EV_CAL_ERROR_CRITICAL_PCT||5)),rs=Math.max(0,Math.min(100,Number(Q.VITE_CALIBRATION_REGIME_HIT_MIN_PCT||55))),Js=Math.max(0,Math.min(rs,Number(Q.VITE_CALIBRATION_REGIME_HIT_CRITICAL_PCT||46))),Wn=Math.max(0,Math.min(1,Number(Q.VITE_CALIBRATION_SIZE_MULTIPLIER_WARN||.85))),Hn=Math.max(0,Math.min(Wn,Number(Q.VITE_CALIBRATION_SIZE_MULTIPLIER_DEGRADED||.6))),Lo=Math.max(0,Math.min(Hn,Number(Q.VITE_CALIBRATION_SIZE_MULTIPLIER_CRITICAL||.35))),Zs=Math.max(0,Math.min(1,Number(Q.VITE_CALIBRATION_AUTO_APPROVE_DISABLE_HEALTH_BELOW||.4))),Po=Math.max(0,Math.min(.95,Number(Q.VITE_CALIBRATION_AUTO_APPROVE_DISABLE_MIN_SIZE_REDUCTION_PCT||.1)));if(!Number.isFinite(et)||et<0)throw new Error("Invalid VITE_FEE_RATE. Expected a non-negative numeric value.");if(!Number.isFinite(ft)||ft<0||ft>1)throw new Error("Invalid VITE_TREASURY_SPLIT. Expected a value between 0 and 1.");const it=Number((et*ft).toFixed(6));if(!Number.isFinite(tr)||tr<1)throw new Error("Invalid VITE_FREE_CYCLES_PER_DAY. Expected an integer >= 1.");if(!Number.isFinite(Cr)||Cr<15)throw new Error("Invalid VITE_AUTO_CYCLE_SECONDS. Expected a numeric value >= 15.");if(!Number.isFinite(ot)||ot<1)throw new Error("Invalid VITE_PNL_REALIZED_MIN_CONFIRMATIONS. Expected an integer >= 1.");const i={s1:"#0B1118",s2:"#101923",s3:"#16222F",border:"#213043",muted:"#32435A",accent:"#39DDB6",aLow:"#112C2A",text:"#EAF1F8",dim:"#8FA0B5",danger:"#FF5D7A",dLow:"#311520",warn:"#F7B267",wLow:"#322515",ok:"#4ADE80",oLow:"#11261A",purple:"#8F7BFF",shadow:"0 18px 45px rgba(0,0,0,0.38)"},L={fontFamily:"'IBM Plex Mono','SFMono-Regular',Menlo,Monaco,monospace"};function Oo(e){const{resolveKaspaNetwork:t,DEFAULT_NETWORK:r,normalizeKaspaAddress:s,ALL_KASPA_ADDRESS_PREFIXES:o,ALLOWED_ADDRESS_PREFIXES:d,ENFORCE_WALLET_NETWORK:a,NETWORK_LABEL:u,isAddressPrefixCompatible:c,normalizeWalletError:l,withTimeout:_,GHOST_CONNECT_TIMEOUT_MS:A,WALLET_SEND_TIMEOUT_MS:v,ghostInvoke:g,probeGhostProviders:N,formatKasAmountString:C,parseAnyTxid:M,promptForTxidIfNeeded:x,normalizeOutputList:R}=e;return{async probeProviders(b){try{return await N(b)}catch{return[]}},async connect(){try{const b=await _(g("account",[],A),A+1e3,"ghost_connect_account"),f=Array.isArray(b==null?void 0:b.addresses)?b.addresses:[];if(!f.length)throw new Error("Ghost Wallet did not return any accounts");const p=t(r),S=t((b==null?void 0:b.networkId)||p.id),K=s(f[0],o);if(!c(K,S))throw new Error(`Ghost Wallet returned an address prefix that does not match ${S.label}. Check wallet network/account and retry.`);if(a&&S.id!==p.id)throw new Error(`Ghost Wallet is on ${S.label}. Expected ${u}. Switch network in wallet and retry.`);if(!c(K,p))throw new Error(`Ghost Wallet returned a ${S.label} address, but ForgeOS is using ${u}. Switch the app profile or wallet network and retry.`);return{address:K,network:S.id,provider:"ghost"}}catch(b){throw l(b,"Ghost Wallet connect failed")}},async send(b,f){if(!(Number(f)>0))throw new Error("Amount must be greater than zero");const p=s(b,d);try{const S=await _(g("transact",[[[p,C(f)]]],v),v+1e3,"ghost_transact"),K=M(S);return await x(K,"Ghost Wallet",typeof S=="string"?S:JSON.stringify(S))}catch(S){throw l(S,"Ghost Wallet send failed")}},async sendOutputs(b,f){const p=R(b);if(!p.length)throw new Error("Ghost Wallet outputs are required");if(p.length===1)return this.send(p[0].to,p[0].amount_kas);try{const S=await _(g("transact",[p.map(j=>[j.to,C(j.amount_kas)])],v),v+1e3,"ghost_transact_multi"),K=M(S);return await x(K,"Ghost Wallet (multi-output)",typeof S=="string"?S:JSON.stringify(S))}catch(S){throw l(S,"Ghost Wallet multi-output send failed")}}}}function Ko(e){const{normalizeKaspaAddress:t,ALLOWED_ADDRESS_PREFIXES:r,DEFAULT_NETWORK:s,normalizeOutputList:o,isLikelyTxid:d}=e;return{connect(a,u){return{address:t(u,r),network:s,provider:a}},async send(a,u,c,l,_){const A=t(u,r),v=o(_||[]);if(!(Number(c)>0)&&!v.length)throw new Error("Amount must be greater than zero");if(typeof window>"u"||typeof window.prompt!="function")throw new Error(`${String(a||"Hardware")} bridge flow requires a browser prompt context`);const g=v.length?v.map(C=>`${C.to}  ${C.amount_kas} KAS`).join(`
`):`${A}  ${Number(c).toFixed(8)} KAS`,N=window.prompt(`${String(a||"Hardware").toUpperCase()} bridge flow

Create and broadcast this transaction in your wallet/device, then paste txid.

Outputs:
${g}

Note: ${String(l||"").slice(0,120)}`);if(!N)throw new Error("Transaction not confirmed. No txid provided.");if(!d(String(N).trim()))throw new Error("Invalid txid format. Expected a 64-char hex transaction id.");return String(N).trim()}}}function jo(e){const{normalizeKaspaAddress:t,ALLOWED_ADDRESS_PREFIXES:r,DEFAULT_NETWORK:s,KASPIUM_DEEP_LINK_SCHEME:o,isLikelyTxid:d}=e;return{connect(a){return{address:t(a,r),network:s,provider:"kaspium"}},async send(a,u,c){const l=t(a,r);if(!(Number(u)>0))throw new Error("Amount must be greater than zero");if(typeof window>"u")throw new Error("Kaspium deep-link is only available in browser environments");const _=encodeURIComponent(String(u)),A=c?encodeURIComponent(c):"",v=`${l}?amount=${_}${c?`&message=${A}`:""}`;let g=v;o&&!o.toLowerCase().startsWith("kaspa")&&(g=`${o.endsWith("://")?o:`${o}://`}send?address=${encodeURIComponent(l)}&amount=${_}${c?`&note=${A}`:""}`),window.location.href=g;const N=typeof window.prompt=="function"?window.prompt.bind(window):null;if(!N)throw new Error("Kaspium confirmation prompt unavailable in this browser context");const C=N(`Complete transfer in Kaspium and paste txid.
Deep link:
${g}

Fallback URI:
${v}`);if(!C)throw new Error("Transaction not confirmed. No txid provided.");if(!d(C))throw new Error("Invalid txid format. Expected a 64-char hex transaction id.");return C.trim()}}}function Fo(e){const{getKastleProvider:t,withTimeout:r,WALLET_CALL_TIMEOUT_MS:s,WALLET_SEND_TIMEOUT_MS:o,KASTLE_CONNECT_TIMEOUT_MS:d,resolveKaspaNetwork:a,DEFAULT_NETWORK:u,normalizeKaspaAddress:c,ALL_KASPA_ADDRESS_PREFIXES:l,ALLOWED_ADDRESS_PREFIXES:_,ENFORCE_WALLET_NETWORK:A,NETWORK_LABEL:v,isAddressPrefixCompatible:g,normalizeWalletError:N,toSompi:C,parseAnyTxid:M,isLikelyTxid:x,KASTLE_RAW_TX_ENABLED:R,KASTLE_TX_BUILDER_URL:b,KASTLE_RAW_TX_MANUAL_JSON_PROMPT_ENABLED:f,getKastleRawTxJsonBuilderBridge:p,buildKastleRawTxJson:S,normalizeOutputList:K,kastleNetworkIdForCurrentProfile:j,setKastleAccountCacheAddress:F,getKastleCachedAccountAddress:B}=e;return{async connect(){var I;const U=t();try{typeof U.connect=="function"&&await r(Promise.resolve(U.connect()),d,"kastle_connect");let h=null;if(typeof U.getAccount=="function")h=await r(Promise.resolve(U.getAccount()),s,"kastle_get_account");else if(typeof U.request=="function")h=await r(Promise.resolve(U.request("kas:get_account")),s,"kastle_request_get_account");else throw new Error("Kastle provider missing getAccount()/request()");const G=c(String((h==null?void 0:h.address)||((I=h==null?void 0:h.addresses)==null?void 0:I[0])||""),l);F(G);const $=a(u);let W=$;if(typeof U.request=="function")try{const Y=await r(Promise.resolve(U.request("kas:get_network")),s,"kastle_get_network");W=a((Y==null?void 0:Y.networkId)||Y)}catch{W=$}if(!g(G,W))throw new Error(`Kastle returned an address prefix that does not match ${W.label}. Check wallet network/account and retry.`);if(A&&W.id!==$.id)throw new Error(`Kastle is on ${W.label}. Expected ${v}. Switch network in wallet and retry.`);if(!g(G,$))throw new Error(`Kastle returned a ${W.label} address, but ForgeOS is using ${v}. Switch the app profile or wallet network and retry.`);return{address:G,network:W.id,provider:"kastle"}}catch(h){throw N(h,"Kastle connect failed")}},async send(U,I){const h=t();if(!(Number(I)>0))throw new Error("Amount must be greater than zero");const G=c(U,_),$=C(I);try{if(typeof h.sendKaspa!="function")throw new Error("Kastle provider missing sendKaspa()");const W=await r(Promise.resolve(h.sendKaspa(G,$)),o,"kastle_send_kaspa"),Y=M(W);if(!Y||!x(Y))throw new Error("Kastle did not return a transaction id");return Y}catch(W){throw N(W,"Kastle send failed")}},canSignAndBroadcastRawTx(){if(!R)return!1;try{const U=typeof window<"u"?window.kastle:null;return!!(U&&typeof U.signAndBroadcastTx=="function")}catch{return!1}},canMultiOutputRawTxPath(){return this.canSignAndBroadcastRawTx()?b||p()?!0:typeof window>"u"?!1:!!(f&&typeof window.prompt=="function"):!1},async sendRawTx(U,I){const h=K(U);if(h.length<=1){const W=h[0];if(!W)throw new Error("Kastle raw tx requires at least one output");return this.send(W.to,W.amount_kas)}if(!this.canSignAndBroadcastRawTx())throw new Error("Kastle raw multi-output path unavailable (feature disabled or signAndBroadcastTx not detected)");const G=t(),$=j();try{const W=await S(h,I,B()),Y=await r(Promise.resolve(G.signAndBroadcastTx($,W)),o,"kastle_sign_and_broadcast_tx"),te=M(Y);if(!te||!x(te))throw new Error("Kastle signAndBroadcastTx did not return a transaction id");return te}catch(W){throw N(W,"Kastle raw multi-output send failed")}},async signMessage(U){const I=t();if(typeof I.signMessage!="function"&&typeof I.request!="function")throw new Error("Kastle provider missing signMessage/request");try{return typeof I.signMessage=="function"?r(Promise.resolve(I.signMessage(U)),s,"kastle_sign_message"):r(Promise.resolve(I.request("kas:sign_message",U)),s,"kastle_request_sign_message")}catch(h){throw N(h,"Kastle sign failed")}}}}function Uo(e){const{getKaswareProvider:t,withTimeout:r,WALLET_CALL_TIMEOUT_MS:s,WALLET_SEND_TIMEOUT_MS:o,resolveKaspaNetwork:d,DEFAULT_NETWORK:a,normalizeKaspaAddress:u,ALL_KASPA_ADDRESS_PREFIXES:c,ALLOWED_ADDRESS_PREFIXES:l,ENFORCE_WALLET_NETWORK:_,NETWORK_LABEL:A,isAddressPrefixCompatible:v,normalizeWalletError:g,parseKaswareBalance:N,parseKaswareTxid:C,isLikelyTxid:M,toSompi:x}=e;return{async connect(){const R=t();if(typeof R.requestAccounts!="function")throw new Error("Kasware provider missing requestAccounts()");try{const b=await r(Promise.resolve(R.requestAccounts()),s,"kasware_request_accounts");if(!(b!=null&&b.length))throw new Error("No accounts returned from Kasware");const f=d(a),p=u(b[0],c);let S=f;if(typeof R.getNetwork=="function")try{const K=await r(Promise.resolve(R.getNetwork()),s,"kasware_get_network");S=d(K)}catch{S=f}if(!v(p,S))throw new Error(`Kasware returned an address prefix that does not match ${S.label}. Check wallet network/account and retry.`);if(_&&S.id!==f.id)throw new Error(`Kasware is on ${S.label}. Expected ${A}. Switch network in wallet and retry.`);if(!v(p,f))throw new Error(`Kasware returned a ${S.label} address, but ForgeOS is using ${A}. Switch the app profile or wallet network and retry.`);return{address:p,network:S.id,provider:"kasware"}}catch(b){throw g(b,"Kasware connect failed")}},async getBalance(){const R=t();if(typeof R.getBalance!="function")throw new Error("Kasware provider missing getBalance()");try{const b=await r(Promise.resolve(R.getBalance()),s,"kasware_get_balance");return N(b)}catch(b){throw g(b,"Kasware balance failed")}},async send(R,b){const f=t();if(!(Number(b)>0))throw new Error("Amount must be greater than zero");const p=u(R,l),S=x(b);let K;try{if(typeof f.sendKaspa=="function")K=await r(Promise.resolve(f.sendKaspa(p,S)),o,"kasware_send_kaspa");else if(typeof f.sendKAS=="function")K=await r(Promise.resolve(f.sendKAS(p,S)),o,"kasware_send_kas");else throw new Error("Kasware provider missing sendKaspa()/sendKAS()")}catch(F){throw g(F,"Kasware send failed")}const j=C(K);if(!j||!M(j))throw new Error("Kasware did not return a transaction id");return j},async signMessage(R){const b=t();if(typeof b.signMessage!="function"&&typeof b.signData!="function")throw new Error("Kasware provider missing signMessage/signData");try{return typeof b.signMessage=="function"?r(Promise.resolve(b.signMessage(R)),s,"kasware_sign_message"):r(Promise.resolve(b.signData(R)),s,"kasware_sign_data")}catch(f){throw g(f,"Kasware sign failed")}}}}class hs extends Error{constructor(r){super(r.message);gt(this,"domain");gt(this,"code");gt(this,"retryable");gt(this,"details");gt(this,"cause");this.name="ForgeError",this.domain=r.domain,this.code=r.code,this.retryable=!!r.retryable,this.details=r.details,this.cause=r.cause}}function $o(e){return e instanceof hs}function gs(e){return new hs(e)}function Bo(e,t){const r=String(t||"").toLowerCase();if(e==="wallet"){if(/timeout/.test(r))return"WALLET_TIMEOUT";if(/rejected|denied|cancel/.test(r))return"WALLET_USER_REJECTED";if(/network/.test(r)&&/mismatch|expected|switch/.test(r))return"WALLET_NETWORK_MISMATCH";if(/not detected|unavailable|not connected|browser wallet apis unavailable/.test(r))return"WALLET_UNAVAILABLE";if(/provider missing|invalid/.test(r))return"WALLET_PROVIDER_INVALID"}return e==="rpc"?/timeout/.test(r)?"RPC_TIMEOUT":/429|rate/i.test(r)?"RPC_RATE_LIMIT":/invalid/.test(r)?"RPC_RESPONSE_INVALID":"RPC_UNAVAILABLE":e==="ai"?/timeout/.test(r)?"AI_TIMEOUT":"AI_UNAVAILABLE":e==="tx"?/invalid/.test(r)?"TX_INVALID":/rejected|denied|cancel/.test(r)?"TX_REJECTED":"TX_BROADCAST_FAILED":e==="lifecycle"?"LIFECYCLE_INVALID_TRANSITION":"UNKNOWN"}function Pr(e,t={}){if($o(e))return e;const r=String((e==null?void 0:e.message)||e||t.message||"Unknown error"),s=t.domain||"system",o=t.code||Bo(s,r),d=typeof t.retryable=="boolean"?t.retryable:/(timeout|network|unavailable|429|503|502|504)/i.test(r);return new hs({message:r,domain:s,code:o,retryable:d,details:t.details,cause:e})}function Ss(e){const t=Pr(e);return`${t.code}: ${t.message}`}function pr(e,t){return Pr(e,{domain:"wallet",details:t})}function ys(e,t){return Pr(e,{domain:"rpc",details:t})}const Or=["kaspa","kaspatest","kaspadev","kaspasim"],Es=15e3,xs=45e3,Vn=350,Gn=45e3;var vn,In;const Do=String(((In=(vn=import.meta)==null?void 0:vn.env)==null?void 0:In.VITE_KASTLE_RAW_TX_ENABLED)||"false").toLowerCase()==="true";var Cn,kn;const Yn=String(((kn=(Cn=import.meta)==null?void 0:Cn.env)==null?void 0:kn.VITE_KASTLE_RAW_TX_MANUAL_JSON_PROMPT_ENABLED)||"true").toLowerCase()!=="false";var Mn,Rn;const Xn=String(((Rn=(Mn=import.meta)==null?void 0:Mn.env)==null?void 0:Rn.VITE_KASTLE_TX_BUILDER_URL)||"").trim();var wn,Ln;const zo=String(((Ln=(wn=import.meta)==null?void 0:wn.env)==null?void 0:Ln.VITE_KASTLE_TX_BUILDER_TOKEN)||"").trim();var Pn,On;const Wo=Math.max(1e3,Number(((On=(Pn=import.meta)==null?void 0:Pn.env)==null?void 0:On.VITE_KASTLE_TX_BUILDER_TIMEOUT_MS)||12e3));var Kn,jn;const Ho=String(((jn=(Kn=import.meta)==null?void 0:Kn.env)==null?void 0:jn.VITE_KASTLE_TX_BUILDER_STRICT)||"false").toLowerCase()==="true",Vo=6e4;function qn(e){return Math.floor(Number(e||0)*1e8)}function Go(e){const t=Number((e==null?void 0:e.total)??(e==null?void 0:e.confirmed)??(e==null?void 0:e.balance)??0);return Number.isFinite(t)?us(t/1e8,4):"0.0000"}function Yo(e){return typeof e=="string"?e:(e==null?void 0:e.txid)||(e==null?void 0:e.hash)||(e==null?void 0:e.transactionId)||""}function kt(e){return/^[a-fA-F0-9]{64}$/.test(String(e||"").trim())}function Xo(e){return Number(e||0).toFixed(8).replace(/\.?0+$/,"")||"0"}function Qn(){return sr(Te).id==="mainnet"?"mainnet":"testnet-10"}function Jn(){if(typeof window>"u")return null;const e=window.__FORGEOS_KASTLE_BUILD_TX_JSON__;return typeof e=="function"?e:null}function Kr(e){return Array.isArray(e)?e.map(t=>({to:$e(String((t==null?void 0:t.to)||(t==null?void 0:t.address)||""),Ae),amount_kas:Number(Number((t==null?void 0:t.amount_kas)??(t==null?void 0:t.amount)??0).toFixed(8))})).filter(t=>t.to&&t.amount_kas>0):[]}function Ar(e,t=0){var s,o,d,a;if(t>4||e==null)return"";if(typeof e=="string"){const u=e.trim();if(kt(u))return u;const c=/"(?:transactionId|transaction_id|txid|hash|id)"\s*:\s*"([a-fA-F0-9]{64})"/.exec(u)||/([a-fA-F0-9]{64})/.exec(u);return(c==null?void 0:c[1])||""}if(typeof e!="object")return"";const r=[e.txid,e.hash,e.transactionId,e.transaction_id,e.id,(s=e==null?void 0:e.transaction)==null?void 0:s.txid,(o=e==null?void 0:e.transaction)==null?void 0:o.hash,(d=e==null?void 0:e.transaction)==null?void 0:d.transactionId,(a=e==null?void 0:e.transaction)==null?void 0:a.id];for(const u of r){const c=Ar(u,t+1);if(c)return c}if(Array.isArray(e)){for(const u of e){const c=Ar(u,t+1);if(c)return c}return""}for(const u of Object.values(e)){const c=Ar(u,t+1);if(c)return c}return""}function Zn(e){return Ar(e)}function jr(e,t,r){let s=null;const o=new Promise((d,a)=>{s=setTimeout(()=>a(new Error(`${r}_timeout_${t}ms`)),t)});return Promise.race([e,o]).finally(()=>{s&&clearTimeout(s)})}function bs(e,t){const r=String((e==null?void 0:e.message)||e||"wallet_error");return/user rejected|rejected|denied|cancel/i.test(r)?pr(new Error(`${t}: User rejected wallet request`),{context:t}):/timeout/i.test(r)?pr(new Error(`${t}: Wallet request timed out`),{context:t}):/not detected|not connected/i.test(r)?pr(new Error(`${t}: Wallet unavailable`),{context:t}):pr(new Error(`${t}: ${r}`),{context:t})}function qo(){if(typeof window>"u")throw new Error("Browser wallet APIs unavailable outside browser environment");const e=window.kasware;if(!e)throw new Error("Kasware extension not detected. Install from kasware.org");return e}function ei(){if(typeof window>"u")throw new Error("Browser wallet APIs unavailable outside browser environment");const e=window.kastle;if(!e)throw new Error("Kastle extension not detected. Install from kastle.cc");return e}async function Qo(e,t,r){if(e&&kt(e))return e;if(typeof window>"u"||typeof window.prompt!="function")throw new Error(`${t} did not return a transaction id`);const s=String(r||"").slice(0,600),o=window.prompt(`${t} did not return a clear txid. Paste the broadcast txid.

Raw wallet response preview:
${s}`);if(!o)throw new Error("Transaction not confirmed. No txid provided.");if(!kt(o.trim()))throw new Error("Invalid txid format. Expected a 64-char hex transaction id.");return o.trim()}function Jo(e){const{allKaspaAddressPrefixes:t,walletCallTimeoutMs:r,kastleAccountCacheTtlMs:s,kastleTxBuilderUrl:o,kastleTxBuilderToken:d,kastleTxBuilderTimeoutMs:a,kastleTxBuilderStrict:u,kastleRawTxManualJsonPromptEnabled:c,getKastleProvider:l,withTimeout:_,normalizeKaspaAddress:A,normalizeOutputList:v,kastleNetworkIdForCurrentProfile:g,getKastleRawTxJsonBuilderBridge:N}=e;let C={address:"",ts:0};async function M(){var j;if(C.address&&Date.now()-C.ts<=s)return C.address;const p=l();let S=null;if(typeof p.getAccount=="function")S=await _(Promise.resolve(p.getAccount()),r,"kastle_get_account_for_raw_tx");else if(typeof p.request=="function")S=await _(Promise.resolve(p.request("kas:get_account")),r,"kastle_request_get_account_for_raw_tx");else throw new Error("Kastle provider missing getAccount()/request()");const K=A(String((S==null?void 0:S.address)||((j=S==null?void 0:S.addresses)==null?void 0:j[0])||""),t);return C={address:K,ts:Date.now()},K}function x(p){C={address:p,ts:Date.now()}}function R(){return C.address}async function b(p,S,K){var h;if(!o)return"";if(typeof fetch!="function")throw new Error("Kastle tx builder requires fetch()");const j=String(K||"").trim(),F=j?A(j,t):await M(),B=g(),U=typeof AbortController<"u"?new AbortController:null,I=U?setTimeout(()=>U.abort(),a):null;try{const G=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",...d?{Authorization:`Bearer ${d}`}:{}},body:JSON.stringify({wallet:"kastle",networkId:B,fromAddress:F,outputs:v(p).map(te=>({address:te.to,amountKas:Number(te.amount_kas)})),purpose:String(S||"").slice(0,140)}),...U?{signal:U.signal}:{}}),$=await G.text();if(!G.ok)throw new Error(`kastle_tx_builder_${G.status}:${String($||"").slice(0,180)}`);const W=$?JSON.parse($):{},Y=typeof W=="string"?W.trim():String((W==null?void 0:W.txJson)||((h=W==null?void 0:W.result)==null?void 0:h.txJson)||"").trim();if(!Y)throw new Error("Kastle tx builder did not return txJson");return Y}finally{I&&clearTimeout(I)}}async function f(p,S,K){const j=v(p);if(!j.length)throw new Error("Kastle raw tx requires outputs");let F=null;if(o)try{const h=await b(j,S,K);if(h)return h}catch(h){if(F=h,u)throw h}const B=N();if(B){const h=await B({networkId:g(),outputs:j,purpose:String(S||"").slice(0,140)});if(typeof h!="string"||!h.trim())throw new Error("Kastle raw tx builder bridge returned an empty txJson");return h.trim()}if(!c||typeof window>"u"||typeof window.prompt!="function"){const h=F?` Backend builder error: ${String((F==null?void 0:F.message)||F).slice(0,180)}`:"";throw new Error(`Kastle raw tx builder unavailable. Provide VITE_KASTLE_TX_BUILDER_URL, window.__FORGEOS_KASTLE_BUILD_TX_JSON__, or enable manual txJson prompt.${h}`)}const U=["KASTLE raw multi-output txJson required","","Forge.OS can call kastle.signAndBroadcastTx(networkId, txJson), but no automatic txJson builder is currently available in this runtime.",...F?[`Builder error: ${String((F==null?void 0:F.message)||F).slice(0,180)}`,""]:[],"Paste a prebuilt txJson (serializeToSafeJSON) matching the outputs below.","",`Network: ${g()}`,`Purpose: ${String(S||"").slice(0,120)||"Forge.OS multi-output"}`,"Outputs:",...j.map((h,G)=>`  ${G+1}. ${h.to}  ${Number(h.amount_kas).toFixed(8)} KAS`)].join(`
`),I=window.prompt(U)||"";if(!I.trim())throw new Error("Kastle raw tx cancelled: no txJson provided");return I.trim()}return{getKastleAccountAddress:M,setKastleAccountCacheAddress:x,getKastleCachedAccountAddress:R,buildKastleRawTxJson:f}}const As=Jo({allKaspaAddressPrefixes:Or,walletCallTimeoutMs:Es,kastleAccountCacheTtlMs:Vo,kastleTxBuilderUrl:Xn,kastleTxBuilderToken:zo,kastleTxBuilderTimeoutMs:Wo,kastleTxBuilderStrict:Ho,kastleRawTxManualJsonPromptEnabled:Yn,getKastleProvider:ei,withTimeout:jr,normalizeKaspaAddress:$e,normalizeOutputList:Kr,kastleNetworkIdForCurrentProfile:Qn,getKastleRawTxJsonBuilderBridge:Jn}),Zo=(...e)=>As.setKastleAccountCacheAddress(...e),ea=(...e)=>As.getKastleCachedAccountAddress(...e),ta=(...e)=>As.buildKastleRawTxJson(...e);function ra(e){return!!(e&&typeof e.id=="string"&&typeof e.name=="string")}function Hr(){if(typeof window>"u")throw new Error("Ghost Wallet is only available in browser environments");return window}function sa(e){const{scanTimeoutMs:t}=e;let r=null,s={ts:0,providers:[]};function o(l="ghost_bridge_reset"){if(typeof window<"u"&&r)try{window.removeEventListener("kaspa:event",r.onEvent),window.removeEventListener("kaspa:disconnect",r.onDisconnect),window.dispatchEvent(new CustomEvent("kaspa:disconnect"))}catch{}if(r)for(const _ of r.pending.values())clearTimeout(_.timer),_.reject(new Error(l));r=null}async function d(l=t){const _=Hr();if(Date.now()-s.ts<1e3&&s.providers.length)return[...s.providers];const v=new Map,g=C=>{const M=C.detail;ra(M)&&v.set(M.id,{id:M.id,name:M.name})};_.addEventListener("kaspa:provider",g);try{_.dispatchEvent(new CustomEvent("kaspa:requestProviders"))}catch{}await new Promise(C=>setTimeout(C,Math.max(50,l))),_.removeEventListener("kaspa:provider",g);const N=[...v.values()];return s={ts:Date.now(),providers:N},N}function a(){return r}async function u(){const l=Hr(),_=a();if(_!=null&&_.connected)return _;const A=await d(),v=A.find(N=>/ghost/i.test(String(N.name||"")))||A[0];if(!v)throw new Error("Ghost Wallet provider bridge not detected");r&&o("ghost_bridge_reconnect");const g={provider:v,nextRequestId:1,connected:!0,pending:new Map,onEvent(N){const C=N.detail;if(!C||typeof C.id!="number")return;const M=g.pending.get(C.id);if(M){if(g.pending.delete(C.id),clearTimeout(M.timer),C.error){M.reject(new Error(String(C.error)));return}if(C.data===!1){M.reject(new Error("Ghost Wallet request was rejected"));return}M.resolve(C.data)}},onDisconnect(){o("ghost_bridge_disconnected")}};l.addEventListener("kaspa:event",g.onEvent),l.addEventListener("kaspa:disconnect",g.onDisconnect);try{l.dispatchEvent(new CustomEvent("kaspa:connect",{detail:v.id}))}catch(N){throw l.removeEventListener("kaspa:event",g.onEvent),l.removeEventListener("kaspa:disconnect",g.onDisconnect),N}return r=g,g}async function c(l,_,A){const v=Hr(),g=await u(),N=g.nextRequestId++;return new Promise((C,M)=>{const x=setTimeout(()=>{g.pending.delete(N),M(new Error(`ghost_${String(l)}_timeout_${A}ms`))},A);g.pending.set(N,{timer:x,resolve:C,reject:M});try{v.dispatchEvent(new CustomEvent("kaspa:invoke",{detail:{id:N,method:l,params:_}}))}catch(R){clearTimeout(x),g.pending.delete(N),M(R)}})}return{probeGhostProviders:d,ghostInvoke:c}}const ti=sa({scanTimeoutMs:Vn}),na=(...e)=>ti.probeGhostProviders(...e),ia=(...e)=>ti.ghostInvoke(...e),hr=Uo({getKaswareProvider:qo,withTimeout:jr,WALLET_CALL_TIMEOUT_MS:Es,WALLET_SEND_TIMEOUT_MS:xs,resolveKaspaNetwork:sr,DEFAULT_NETWORK:Te,normalizeKaspaAddress:$e,ALL_KASPA_ADDRESS_PREFIXES:Or,ALLOWED_ADDRESS_PREFIXES:Ae,ENFORCE_WALLET_NETWORK:ms,NETWORK_LABEL:Qe,isAddressPrefixCompatible:ls,normalizeWalletError:bs,parseKaswareBalance:Go,parseKaswareTxid:Yo,isLikelyTxid:kt,toSompi:qn}),Tt=Fo({getKastleProvider:ei,withTimeout:jr,WALLET_CALL_TIMEOUT_MS:Es,WALLET_SEND_TIMEOUT_MS:xs,KASTLE_CONNECT_TIMEOUT_MS:Gn,resolveKaspaNetwork:sr,DEFAULT_NETWORK:Te,normalizeKaspaAddress:$e,ALL_KASPA_ADDRESS_PREFIXES:Or,ALLOWED_ADDRESS_PREFIXES:Ae,ENFORCE_WALLET_NETWORK:ms,NETWORK_LABEL:Qe,isAddressPrefixCompatible:ls,normalizeWalletError:bs,toSompi:qn,parseAnyTxid:Zn,isLikelyTxid:kt,KASTLE_RAW_TX_ENABLED:Do,KASTLE_TX_BUILDER_URL:Xn,KASTLE_RAW_TX_MANUAL_JSON_PROMPT_ENABLED:Yn,getKastleRawTxJsonBuilderBridge:Jn,buildKastleRawTxJson:ta,normalizeOutputList:Kr,kastleNetworkIdForCurrentProfile:Qn,setKastleAccountCacheAddress:Zo,getKastleCachedAccountAddress:ea}),gr=Oo({resolveKaspaNetwork:sr,DEFAULT_NETWORK:Te,normalizeKaspaAddress:$e,ALL_KASPA_ADDRESS_PREFIXES:Or,ALLOWED_ADDRESS_PREFIXES:Ae,ENFORCE_WALLET_NETWORK:ms,NETWORK_LABEL:Qe,isAddressPrefixCompatible:ls,normalizeWalletError:bs,withTimeout:jr,GHOST_CONNECT_TIMEOUT_MS:Gn,WALLET_SEND_TIMEOUT_MS:xs,ghostInvoke:ia,probeGhostProviders:na,formatKasAmountString:Xo,parseAnyTxid:Zn,promptForTxidIfNeeded:Qo,normalizeOutputList:Kr}),en=jo({normalizeKaspaAddress:$e,ALLOWED_ADDRESS_PREFIXES:Ae,DEFAULT_NETWORK:Te,KASPIUM_DEEP_LINK_SCHEME:fo,isLikelyTxid:kt}),tn=Ko({normalizeKaspaAddress:$e,ALLOWED_ADDRESS_PREFIXES:Ae,DEFAULT_NETWORK:Te,normalizeOutputList:Kr,isLikelyTxid:kt}),he={detect(){let e,t;try{e=typeof window<"u"?window.kasware:void 0,t=typeof window<"u"?window.kastle:void 0}catch{e=void 0,t=void 0}return{kasware:!!e,kastle:!!t,ghost:!1,kaspium:!0,kaswareMethods:e?{requestAccounts:typeof e.requestAccounts=="function",getNetwork:typeof e.getNetwork=="function",getBalance:typeof e.getBalance=="function",signMessage:typeof e.signMessage=="function",sendKaspa:typeof e.sendKaspa=="function"}:null,kastleMethods:t?{connect:typeof t.connect=="function",getAccount:typeof t.getAccount=="function",request:typeof t.request=="function",sendKaspa:typeof t.sendKaspa=="function",signMessage:typeof t.signMessage=="function",signAndBroadcastTx:typeof t.signAndBroadcastTx=="function"}:null}},async probeGhostProviders(e){return gr.probeProviders(e??Vn)},async connectKasware(){return hr.connect()},async connectKastle(){return Tt.connect()},async connectGhost(){return gr.connect()},connectKaspium(e){return en.connect(e)},async getKaswareBalance(){return hr.getBalance()},async sendKasware(e,t){return hr.send(e,t)},async sendKastle(e,t){return Tt.send(e,t)},canKastleSignAndBroadcastRawTx(){return Tt.canSignAndBroadcastRawTx()},canKastleMultiOutputRawTxPath(){return Tt.canMultiOutputRawTxPath()},async sendKastleRawTx(e,t){return Tt.sendRawTx(e,t)},async sendGhost(e,t){return gr.send(e,t)},async sendGhostOutputs(e,t){return gr.sendOutputs(e,t)},async sendKaspium(e,t,r){return en.send(e,t,r)},async signMessageKasware(e){return hr.signMessage(e)},async signMessageKastle(e){return Tt.signMessage(e)},supportsNativeMultiOutput(e){const t=String(e||"").toLowerCase();return t==="ghost"?!0:t==="kastle"?Tt.canMultiOutputRawTxPath():!1},async connectHardwareBridge(e,t){return tn.connect(e,t)},async sendHardwareBridge(e,t,r,s,o){return tn.send(e,t,r,s,o)}},oa=new URL(""+new URL("kastle-Td3Ch6zZ.svg",import.meta.url).href,import.meta.url).href,aa=new URL("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xml:space='preserve'%20style='fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2'%20viewBox='0%200%20512%20512'%3e%3cpath%20d='M1835.38%201331.2c-10.65-14.43-25.84-33.39-47.42-58.25-83.91-96.68-206.13-306.46-209.78-392.2-3.65-85.74-69.32-213.43-301-240.79-231.68-27.36-249.91%20240.79-249.91%20240.79s8.21%20249-199.75%20362.1c-207.96%20113.1-67.49%20125.87-9.12%20138.64%2058.37%2012.77-76.61%2089.38-12.77%20127.69s113.1-25.54%20125.87%2063.85c12.77%2089.39%20162.35%2036.48%20182.42%2067.49%2020.07%2031.01%20109.45%20167.83%20231.67%20131.34%20122.22-36.49%2091.21-89.38%20166-91.21%2074.79-1.83%20135-23.71%20120.4-85.73-14.6-62.02%2072-73.88%20114-70.23%2042%203.65%2069.32-34.66%2018.24-78.44-39.16-33.57%206.39-70.35%2053.62-75%2019.36-1.9%2029.07-24.41%2017.53-40.05Zm-595.63-460.52c-10.67%2039.05-39.2%2065.33-63.79%2058.63-24.59-6.7-35.88-43.79-25.21-82.92%2010.67-39.13%2039.18-65.3%2063.74-58.58%2024.56%206.72%2035.91%2043.77%2025.26%2082.87ZM1382%20929.31c-24.56%206.7-53.17-19.58-63.76-58.63-10.59-39.05.64-76.22%2025.18-82.87%2024.54-6.65%2053.15%2019.53%2063.82%2058.58%2010.67%2039.05-.65%2076.22-25.24%2082.92Z'%20style='fill:%23fff;fill-rule:nonzero'%20transform='translate(-318.426%20-286.541)%20scale(.449124)'/%3e%3c/svg%3e",import.meta.url).href,ri=[{id:"kasware",name:"Kasware",class:"extension",status:"live",connectMode:"injected",description:"Injected browser wallet for direct Kaspa signing and broadcast.",uiIcon:"ðŸ§©",docsUrl:"https://docs.kasware.xyz/wallet/dev-base/kaspa",websiteUrl:"https://www.kasware.xyz",sourceUrls:["https://docs.kasware.xyz/wallet/dev-base/kaspa","https://github.com/kasware-wallet/extension","https://kaspa.org/directory/kasware/"],tags:["kaspa","browser-extension","dapp"],capabilities:{detect:!0,connect:!0,send:!0,network:!0,signMessage:!0,deeplink:!1,manualTxid:!1,psktSign:!0,nativeMultiOutputSend:"unsupported"},notes:["Kasware docs expose sendKaspa(toAddress, sompi[, options]) single-recipient send.","Kasware exposes signPskt and some KRC20 methods with extra output arrays; a PSKT-based multi-output path may be possible in a future adapter."]},{id:"kaspium",name:"Kaspium",class:"mobile",status:"live",connectMode:"deeplink",description:"Mobile wallet via deep-link handoff with manual txid confirmation in Forge.OS.",uiIcon:"ðŸ“±",docsUrl:"https://github.com/azbuky/kaspium_wallet",websiteUrl:"https://kaspium.io",sourceUrls:["https://github.com/azbuky/kaspium_wallet","https://kaspa.org/kaspium-v1-0-1-release/"],tags:["kaspa","mobile","deeplink"],capabilities:{detect:!1,connect:!0,send:!0,network:!1,signMessage:!1,deeplink:!0,manualTxid:!0,psktSign:!1,nativeMultiOutputSend:"unsupported"},notes:["Current Forge.OS integration is a single-recipient deep-link + pasted txid flow.","No public injected dApp provider API documented in the Kaspium repo."]},{id:"kastle",name:"Kastle",class:"extension",status:"live",connectMode:"injected",description:"Kaspa browser extension wallet with injected dApp API and direct signing/broadcast.",uiIcon:"ðŸ°",logoSrc:oa,docsUrl:"https://github.com/forbole/kastle",websiteUrl:"https://kastle.cc/",sourceUrls:["https://github.com/forbole/kastle"],tags:["kaspa","browser-extension","dapp"],capabilities:{detect:!0,connect:!0,send:!0,network:!0,signMessage:!0,deeplink:!1,manualTxid:!1,psktSign:!1,nativeMultiOutputSend:"pskt_path"},notes:["Injected `window.kastle` API supports connect/getAccount/request/sendKaspa/signMessage.","Native sendKaspa is single-recipient; multi-output may be possible via signAndBroadcastTx(txJson) with a Forge.OS transaction builder path."]},{id:"ghost",name:"Ghost Wallet",class:"extension",status:"live",connectMode:"injected",description:"Kaspa browser extension using a custom provider event bridge for account + transact calls.",uiIcon:"ðŸ‘»",logoSrc:aa,docsUrl:"https://github.com/ghost-wallet/web-extension",websiteUrl:"https://github.com/ghost-wallet/web-extension",sourceUrls:["https://github.com/ghost-wallet/web-extension"],tags:["kaspa","browser-extension","provider-bridge"],capabilities:{detect:!1,connect:!0,send:!0,network:!0,signMessage:!1,deeplink:!1,manualTxid:!1,psktSign:!1,nativeMultiOutputSend:"supported"},notes:["Ghost exposes a `kaspa:*` provider event protocol (account/transact) instead of a global injected object.","Provider transact accepts an outputs array, so multi-output treasury-combined sends are potentially viable in a future adapter path."]},{id:"demo",name:"Demo Mode",class:"web",status:"live",connectMode:"demo",description:"Simulated signer for UI testing, E2E flows, and onboarding.",uiIcon:"ðŸ§ª",tags:["simulation","test"],capabilities:{detect:!1,connect:!0,send:!0,network:!0,signMessage:!1,deeplink:!1,manualTxid:!1,psktSign:!1,nativeMultiOutputSend:"not_applicable"},notes:["No blockchain broadcast. Used for UI/QA only."]},{id:"kasperia",name:"Kasperia",class:"extension",status:"research",connectMode:"injected",description:"Kaspa/Kasplex browser extension wallet with developer docs and SDK messaging.",uiIcon:"ðŸŒ‰",docsUrl:"https://kasperia-doc.github.io/",websiteUrl:"https://kasperia-doc.github.io/",sourceUrls:["https://kasperia-doc.github.io/"],tags:["browser-extension","kasplex","l2"],capabilities:{detect:!1,connect:!1,send:!1,network:!1,signMessage:!1,deeplink:!1,manualTxid:!1,psktSign:!1,nativeMultiOutputSend:"unknown"},notes:["Promising for future dApp integration, but Forge.OS adapter work depends on stable injected provider docs/API shape."]},{id:"tangem",name:"Tangem",class:"hardware",status:"live",connectMode:"bridge",description:"Hardware bridge flow (manual sign/broadcast + txid handoff) for accumulation-focused cold custody operations.",uiIcon:"ðŸ’³",websiteUrl:"https://tangem.com/",sourceUrls:["https://kaspa.org/kaspa-integrated-on-tangem/","https://kaspa.org/directory/tangem-ag/"],tags:["hardware","cold-storage","accumulation"],capabilities:{detect:!1,connect:!0,send:!0,network:!1,signMessage:!1,deeplink:!1,manualTxid:!0,psktSign:!1,nativeMultiOutputSend:"unknown"},notes:["Forge.OS uses a manual hardware bridge flow today (address pairing + external signing/broadcast + pasted txid)."]},{id:"onekey",name:"OneKey",class:"hardware",status:"live",connectMode:"bridge",description:"Hardware bridge flow (manual sign/broadcast + txid handoff) for secure accumulation and large-balance operations.",uiIcon:"ðŸ”",websiteUrl:"https://shop.onekey.so/",sourceUrls:["https://kaspa.org/kaspa-integrated-on-onekey/"],tags:["hardware","cold-storage"],capabilities:{detect:!1,connect:!0,send:!0,network:!1,signMessage:!1,deeplink:!1,manualTxid:!0,psktSign:!1,nativeMultiOutputSend:"unknown"},notes:["Forge.OS uses a manual hardware bridge flow today (address pairing + external signing/broadcast + pasted txid)."]},{id:"zelcore",name:"Zelcore",class:"desktop",status:"research",connectMode:"manual",description:"Multi-asset wallet with Kaspa support; useful for operator holdings and portfolio visibility.",uiIcon:"ðŸ–¥ï¸",sourceUrls:["https://kaspa.org/kaspa-on-zelcore-wallet-and-defi/"],tags:["desktop","multi-asset"],capabilities:{detect:!1,connect:!1,send:!1,network:!1,signMessage:!1,deeplink:!1,manualTxid:!0,psktSign:!1,nativeMultiOutputSend:"unknown"},notes:["No Forge.OS dApp signing path yet; candidate for watch-only/import workflows first."]}],ca=ri.filter(e=>e.status==="live"&&e.capabilities.connect);ri.filter(e=>e.status!=="live"&&e.id!=="demo");function da(e){return e==="extension"?"EXTENSION":e==="mobile"?"MOBILE":e==="hardware"?"HARDWARE":e==="desktop"?"DESKTOP":"WEB"}function la(e){return e==="supported"?"MULTI-OUTPUT: YES":e==="unsupported"?"MULTI-OUTPUT: NO (NATIVE SEND)":e==="pskt_path"?"MULTI-OUTPUT: PSKT PATH":e==="not_applicable"?"MULTI-OUTPUT: N/A":"MULTI-OUTPUT: UNKNOWN"}const ge=({children:e,p:t=16,style:r={},...s})=>n.jsx("div",{...s,style:{background:`linear-gradient(165deg, ${i.s2} 0%, #0a1725 52%, ${i.s1} 100%)`,border:`1px solid ${i.border}cc`,borderRadius:14,padding:t,boxShadow:`${i.shadow}, inset 0 1px 0 rgba(255,255,255,0.04)`,backdropFilter:"blur(6px)",transition:"border-color 0.18s ease, box-shadow 0.18s ease, transform 0.18s ease",...r},children:e}),Ce=({children:e,color:t})=>n.jsx("div",{style:{fontSize:10,color:t||i.dim,letterSpacing:"0.1em",textTransform:"uppercase",marginBottom:6,...L},children:e}),ee=({text:e,color:t=i.accent,dot:r,...s})=>n.jsxs("span",{...s,style:{background:t+"18",color:t,border:`1px solid ${t}35`,borderRadius:6,padding:"3px 9px",fontSize:11,letterSpacing:"0.04em",...L,display:"inline-flex",alignItems:"center",gap:5,whiteSpace:"nowrap"},children:[r&&n.jsx("span",{style:{width:5,height:5,borderRadius:"50%",background:t,display:"inline-block"}}),e]}),pe=({children:e,onClick:t,variant:r="primary",disabled:s,style:o={},size:d="md",...a})=>{const u={primary:{bg:`linear-gradient(90deg, ${i.accent} 0%, #7BE9CF 100%)`,color:"#04110E",border:`1px solid ${i.accent}55`,shadow:"0 10px 24px rgba(57,221,182,0.26)"},ghost:{bg:"transparent",color:i.text,border:`1px solid ${i.border}`,shadow:"none"},danger:{bg:i.dLow,color:i.danger,border:`1px solid ${i.danger}55`,shadow:"none"},warn:{bg:i.wLow,color:i.warn,border:`1px solid ${i.warn}50`,shadow:"none"}}[r];return n.jsx("button",{...a,onClick:t,disabled:s,onMouseEnter:c=>{s||(c.currentTarget.style.transform="translateY(-1px)",c.currentTarget.style.filter="brightness(1.06)")},onMouseLeave:c=>{c.currentTarget.style.transform="translateY(0)",c.currentTarget.style.filter="brightness(1)"},onMouseDown:c=>{s||(c.currentTarget.style.transform="translateY(0) scale(0.995)")},onMouseUp:c=>{s||(c.currentTarget.style.transform="translateY(-1px) scale(1)")},style:{background:u.bg,color:u.color,border:u.border,borderRadius:10,padding:d==="sm"?"6px 12px":"10px 18px",fontSize:d==="sm"?11:12,cursor:s?"not-allowed":"pointer",opacity:s?.45:1,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",boxShadow:u.shadow,transition:"all 0.16s ease",...L,...o},children:e})},$t=({label:e,value:t,onChange:r,placeholder:s,type:o="text",hint:d,suffix:a})=>n.jsxs("div",{style:{marginBottom:16},children:[e&&n.jsx(Ce,{children:e}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("input",{value:t,onChange:u=>r(u.target.value),type:o,placeholder:s,style:{width:"100%",background:i.s3,border:`1px solid ${i.border}`,borderRadius:10,color:i.text,padding:`10px ${a?"40px":"12px"} 10px 12px`,fontSize:12,...L,outline:"none",boxSizing:"border-box",transition:"border-color 0.16s ease, box-shadow 0.16s ease"},onFocus:u=>{u.target.style.borderColor=i.accent,u.target.style.boxShadow=`0 0 0 2px ${i.accent}22`},onBlur:u=>{u.target.style.borderColor=i.border,u.target.style.boxShadow="none"}}),a&&n.jsx("span",{style:{position:"absolute",right:12,top:"50%",transform:"translateY(-50%)",fontSize:11,color:i.dim,...L},children:a})]}),d&&n.jsx("div",{style:{fontSize:11,color:i.dim,marginTop:4},children:d})]}),si=({m:e=12})=>n.jsx("div",{style:{height:1,background:i.border,margin:`${e}px 0`}}),Ct=({href:e,label:t="â†—"})=>n.jsx("a",{href:e,target:"_blank",rel:"noopener noreferrer",style:{fontSize:11,color:i.accent,...L,textDecoration:"none",border:`1px solid ${i.accent}25`,padding:"3px 9px",borderRadius:3},children:t});function ni(){return n.jsxs("div",{className:"forge-atmosphere","aria-hidden":"true",children:[n.jsx("div",{className:"forge-atmosphere__aura forge-atmosphere__aura--north"}),n.jsx("div",{className:"forge-atmosphere__aura forge-atmosphere__aura--east"}),n.jsx("div",{className:"forge-atmosphere__aura forge-atmosphere__aura--south"}),n.jsx("div",{className:"forge-atmosphere__grid"}),n.jsxs("div",{className:"forge-atmosphere__rings",children:[n.jsx("span",{className:"forge-ring forge-ring--one"}),n.jsx("span",{className:"forge-ring forge-ring--two"}),n.jsx("span",{className:"forge-ring forge-ring--three"})]}),n.jsxs("div",{className:"forge-atmosphere__blips",children:[n.jsx("span",{className:"forge-blip forge-blip--a"}),n.jsx("span",{className:"forge-blip forge-blip--b"}),n.jsx("span",{className:"forge-blip forge-blip--c"})]})]})}function ua({onConnect:e}){const[t,r]=y.useState(null),[s,o]=y.useState(null),[d,a]=y.useState(""),[u,c]=y.useState(""),[l,_]=y.useState(""),[A,v]=y.useState(""),[g,N]=y.useState(null),C=he.detect(),M=y.useMemo(()=>`forgeos.kaspium.address.${Te}`,[]),x=y.useMemo(()=>`forgeos.wallet.lastProvider.${Te}`,[]),R=u.trim(),b=St(R,Ae),f=!!t;y.useEffect(()=>{if(!(typeof window>"u"))try{const h=(window.localStorage.getItem(M)||"").trim();h&&St(h,Ae)&&_(h);const G=(window.localStorage.getItem(x)||"").trim();G&&v(G)}catch{}},[M,x]),y.useEffect(()=>{let I=!1;if(typeof he.probeGhostProviders=="function")return he.probeGhostProviders(250).then(h=>{I||N(Array.isArray(h)?h.length:0)}).catch(()=>{I||N(0)}),()=>{I=!0}},[]);const p=I=>{const h=I.trim();if(!(!h||!St(h,Ae))&&(_(h),!(typeof window>"u")))try{window.localStorage.setItem(M,h)}catch{}},S=I=>{if(v(I),!(typeof window>"u"))try{window.localStorage.setItem(x,I)}catch{}},K=async()=>{var $;const I=(u.trim()||l.trim()).trim();if(I&&St(I,Ae))return $e(I,Ae);if(typeof navigator<"u"&&(($=navigator.clipboard)!=null&&$.readText))try{const W=await navigator.clipboard.readText(),Y=String(W||"").trim().split(/\s+/)[0]||"";if(Y&&St(Y,Ae)){const te=$e(Y,Ae);return c(te),p(te),te}}catch{}const h=window.prompt(`Paste your ${Qe} Kaspium address (${Ae.join(", ")}).`)||"",G=$e(h,Ae);return c(G),p(G),G},j=async I=>{const h=window.prompt(`Paste your ${Qe} ${I} receive address (${Ae.join(", ")}).`)||"";return $e(h,Ae)},F=async I=>{r(I),o(null),a("");try{let h;if(I==="kasware")h=await he.connectKasware(),a("Kasware session ready. Extension signing is armed.");else if(I==="kastle")h=await he.connectKastle(),a("Kastle session ready. Extension signing is armed.");else if(I==="ghost")h=await he.connectGhost(),a("Ghost Wallet session ready. Provider bridge is connected.");else if(I==="tangem"||I==="onekey"){const G=await j(I==="tangem"?"Tangem":"OneKey");h=await he.connectHardwareBridge(I,G),a(`${I==="tangem"?"Tangem":"OneKey"} bridge session ready for ${Ze(h.address)}.`)}else if(I==="kaspium"){const G=await K();h=he.connectKaspium(G),p(h.address),a(`Kaspium session ready for ${Ze(h.address)}.`)}else h={address:To,network:Te,provider:"demo"},a("Demo session ready.");S(I),e(h)}catch(h){o(Ss(h)||(h==null?void 0:h.message)||"Wallet connection failed.")}r(null)},B=ca.map(I=>{if(I.id==="kasware")return{...I,statusText:C.kasware?"Detected in this tab":"Not detected in this tab",statusColor:C.kasware?i.ok:i.warn,cta:"Connect Kasware"};if(I.id==="kastle")return{...I,statusText:C.kastle?"Detected in this tab":"Not detected in this tab",statusColor:C.kastle?i.ok:i.warn,cta:"Connect Kastle"};if(I.id==="ghost"){const h=Number(g||0)>0;return{...I,statusText:g==null?"Scanning provider bridge...":h?`Detected ${g} provider${g===1?"":"s"}`:"Provider probes on connect",statusColor:g==null?i.dim:h?i.ok:i.warn,cta:"Connect Ghost"}}return I.id==="kaspium"?{...I,statusText:b?`Address ready Â· ${Ze(R)}`:"Address resolves on connect",statusColor:b?i.ok:i.warn,cta:b?"Connect Kaspium":"Connect + Pair Address"}:I.id==="tangem"||I.id==="onekey"?{...I,statusText:"Manual bridge (address + txid handoff)",statusColor:i.warn,cta:`Connect ${I.name}`}:{...I,statusText:"No blockchain broadcast",statusColor:i.dim,cta:"Enter Demo Mode"}}),U=y.useMemo(()=>{const I=Array.isArray(B)?B:[],h=I.filter(Y=>["kasware","kastle","ghost"].includes(String(Y.id))),G=I.filter(Y=>["kaspium","tangem","onekey"].includes(String(Y.id))),$=I.filter(Y=>String(Y.id)==="demo"),W=I.filter(Y=>!h.includes(Y)&&!G.includes(Y)&&!$.includes(Y));return[{key:"direct",title:"Direct Wallets",subtitle:"Browser-native Kaspa signing and broadcast in this session.",items:[...h,...W.filter(Y=>String(Y.class)==="extension")]},{key:"mobile-bridge",title:"Mobile & Hardware Bridge",subtitle:"Deep-link or bridge/manual handoff flows with non-custodial signing.",items:[...G,...W.filter(Y=>String(Y.class)!=="extension"&&String(Y.id)!=="demo")]},{key:"sandbox",title:"Sandbox",subtitle:"UI / workflow validation with no on-chain broadcast.",items:$}].filter(Y=>Y.items.length>0)},[B]);return n.jsxs("div",{className:"forge-shell",style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"clamp(18px, 2vw, 28px)"},children:[n.jsx(ni,{}),n.jsxs("div",{className:"forge-content forge-gate-layout",children:[n.jsxs("section",{className:"forge-gate-hero",children:[n.jsxs("div",{className:"forge-gate-hero-main",children:[n.jsx("div",{className:"forge-gate-kicker",children:"FORGE.OS // KASPA-NATIVE QUANT STACK"}),n.jsxs("h1",{className:"forge-gate-title",children:[n.jsx("span",{style:{color:i.accent},children:"FORGE"}),".OS TRADING CONTROL SURFACE"]}),n.jsx("p",{className:"forge-gate-copy",children:"Full-screen command center for wallet-native execution, AI-guided quant cycles, and DAG-aware capital routing. Connect a supported wallet to operate the system. Signing remains inside your wallet at all times."}),n.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginTop:16},children:[n.jsx(ee,{text:`${Qe} SESSION`,color:i.ok,dot:!0}),n.jsx(ee,{text:"WALLET-NATIVE AUTHORIZATION",color:i.accent,dot:!0}),n.jsx(ee,{text:"SESSION CONTINUITY",color:i.purple,dot:!0})]}),n.jsx("div",{className:"forge-gate-hero-strip",children:[["EXECUTION","Wallet-native signing + queue lifecycle"],["TRUTH","Receipt-aware attribution + consistency checks"],["ROUTING","DAG-aware capital allocation + guardrails"]].map(([I,h])=>n.jsxs("div",{className:"forge-gate-hero-strip-item",children:[n.jsx("div",{className:"forge-gate-hero-strip-k",children:I}),n.jsx("div",{className:"forge-gate-hero-strip-v",children:h})]},I))})]}),n.jsxs("div",{className:"forge-gate-points",children:[n.jsxs("div",{className:"forge-gate-point",children:[n.jsx("div",{className:"forge-gate-point-value",children:"UTXO-Native"}),n.jsx("div",{className:"forge-gate-point-label",children:"Kaspa-first architecture"})]}),n.jsxs("div",{className:"forge-gate-point",children:[n.jsx("div",{className:"forge-gate-point-value",children:"Non-Custodial"}),n.jsx("div",{className:"forge-gate-point-label",children:"Private keys stay in wallet"})]}),n.jsxs("div",{className:"forge-gate-point",children:[n.jsx("div",{className:"forge-gate-point-value",children:Qe}),n.jsx("div",{className:"forge-gate-point-label",children:"Active network profile"})]})]})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[n.jsxs("div",{style:{marginBottom:18,textAlign:"center"},children:[n.jsxs("div",{style:{fontSize:"clamp(24px, 4vw, 34px)",fontWeight:700,...L,letterSpacing:"0.12em",marginBottom:6},children:[n.jsx("span",{style:{color:i.accent},children:"FORGE"}),n.jsx("span",{style:{color:i.text},children:".OS"})]}),n.jsx("div",{style:{fontSize:11,color:i.dim,letterSpacing:"0.08em",...L},children:"AI-NATIVE FINANCIAL OPERATING SYSTEM Â· POWERED BY KASPA"})]}),n.jsx("div",{className:"forge-content",style:{width:"100%",maxWidth:760},children:n.jsxs(ge,{p:24,style:{width:"100%"},children:[n.jsx("div",{style:{fontSize:14,color:i.text,fontWeight:700,...L,marginBottom:4},children:"Connect Wallet"}),n.jsx("div",{style:{fontSize:12,color:i.dim,marginBottom:14},children:"All operations are wallet-native. Forge.OS never stores private keys or signs transactions on your behalf."}),n.jsxs("div",{style:{fontSize:11,color:i.dim,...L,marginBottom:14},children:["Runtime network: ",Qe," Â· accepted prefixes: ",Ae.join(", ")]}),n.jsx("div",{className:"forge-wallet-sections",children:U.map(I=>n.jsxs("div",{className:"forge-wallet-section",children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[n.jsxs("div",{children:[n.jsx("div",{style:{fontSize:12,color:i.text,fontWeight:700,...L,letterSpacing:"0.08em"},children:I.title}),n.jsx("div",{style:{fontSize:10,color:i.dim,marginTop:2},children:I.subtitle})]}),n.jsx(ee,{text:`${I.items.length} WALLET${I.items.length===1?"":"S"}`,color:i.dim})]}),n.jsx("div",{className:"forge-wallet-grid forge-wallet-grid--matrix",children:I.items.map(h=>n.jsxs("div",{className:`forge-wallet-card ${A===h.id?"forge-wallet-card--preferred":""}`,children:[n.jsxs("div",{className:"forge-wallet-card-head",children:[h.logoSrc?n.jsx("div",{style:{width:32,height:32,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.02)",border:`1px solid ${i.border}`,borderRadius:6,overflow:"hidden",flexShrink:0},children:n.jsx("img",{src:h.logoSrc,alt:`${h.name} logo`,style:{width:22,height:22,objectFit:"contain"}})}):n.jsx("div",{style:{fontSize:22,width:32,display:"flex",justifyContent:"center",flexShrink:0},children:h.uiIcon}),n.jsxs("div",{style:{minWidth:0,flex:1},children:[n.jsxs("div",{style:{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap"},children:[n.jsx("div",{style:{fontSize:12,color:i.text,fontWeight:700,...L},children:h.name}),A===h.id?n.jsx(ee,{text:"LAST USED",color:i.accent}):null,n.jsx(ee,{text:da(h.class),color:i.dim})]}),n.jsx("div",{style:{fontSize:10,color:h.statusColor,marginTop:4,...L},children:h.statusText})]})]}),n.jsx("div",{style:{fontSize:11,color:i.dim,marginTop:8,lineHeight:1.35,display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},title:h.description,children:h.description}),n.jsxs("div",{style:{display:"flex",gap:6,marginTop:8,flexWrap:"wrap"},children:[n.jsx(ee,{text:la(h.capabilities.nativeMultiOutputSend),color:i.text}),h.capabilities.network?n.jsx(ee,{text:"NETWORK AWARE",color:i.ok}):null,h.capabilities.manualTxid?n.jsx(ee,{text:"MANUAL TXID",color:i.warn}):null]}),n.jsxs("div",{className:"forge-wallet-card-actions",children:[n.jsx(pe,{onClick:()=>F(h.id),disabled:f&&t!==h.id,variant:h.id==="demo"?"ghost":"primary",size:"sm",style:{flex:1,minWidth:0},children:t===h.id?"CONNECTING...":h.cta}),h.docsUrl?n.jsx(Ct,{href:h.docsUrl,label:"DOCS â†—"}):null]})]},h.id))})]},I.key))}),d?n.jsx("div",{style:{marginTop:12,padding:"10px 14px",background:i.oLow,border:`1px solid ${i.ok}44`,borderRadius:4,fontSize:12,color:i.ok,...L},children:d}):null,s&&n.jsx("div",{style:{marginTop:14,padding:"10px 14px",background:i.dLow,borderRadius:4,fontSize:12,color:i.danger,...L},children:s}),n.jsx(si,{m:18}),n.jsxs("div",{style:{fontSize:11,color:i.dim,...L,lineHeight:1.6},children:["Forge.OS never requests your private key Â· All transaction signing happens in your wallet Â· ",Qe," only"]})]})})]})]})]})}function Ts({tx:e,wallet:t,onSign:r,onReject:s}){const[o,d]=y.useState(!1),[a,u]=y.useState(null),c=async()=>{d(!0),u(null);try{let l;(t==null?void 0:t.provider)==="kasware"?l=await he.sendKasware(e.to,e.amount_kas):(t==null?void 0:t.provider)==="kastle"?l=await he.sendKastle(e.to,e.amount_kas):(t==null?void 0:t.provider)==="ghost"?l=await he.sendGhost(e.to,e.amount_kas):(t==null?void 0:t.provider)==="tangem"||(t==null?void 0:t.provider)==="onekey"?l=await he.sendHardwareBridge(t.provider,e.to,e.amount_kas,e.purpose,e.outputs):(t==null?void 0:t.provider)==="kaspium"?l=await he.sendKaspium(e.to,e.amount_kas,e.purpose):(await new Promise(_=>setTimeout(_,1200)),l=Array.from({length:64},()=>"0123456789abcdef"[Math.floor(Math.random()*16)]).join("")),r({...e,txid:l,signed_at:Date.now()})}catch(l){u(Ss(l))}d(!1)};return n.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,padding:20},children:n.jsxs(ge,{p:28,style:{maxWidth:480,width:"100%",border:`1px solid ${i.warn}40`},children:[n.jsx("div",{style:{fontSize:14,color:i.warn,fontWeight:700,...L,marginBottom:4},children:"âš  TRANSACTION SIGNING REQUIRED"}),n.jsx("div",{style:{fontSize:12,color:i.dim,marginBottom:18},children:(t==null?void 0:t.provider)==="kasware"?"Kasware will prompt you to sign.":(t==null?void 0:t.provider)==="kastle"?"Kastle will prompt you to sign.":(t==null?void 0:t.provider)==="ghost"?"Ghost Wallet will prompt you to approve the provider transaction.":(t==null?void 0:t.provider)==="tangem"||(t==null?void 0:t.provider)==="onekey"?`${String((t==null?void 0:t.provider)||"hardware").toUpperCase()} bridge flow will prompt for txid after external wallet/device broadcast.`:(t==null?void 0:t.provider)==="kaspium"?"Kaspium deep-link will open; paste txid after broadcast.":"Confirm this transaction to proceed."}),Array.isArray(e==null?void 0:e.outputs)&&e.outputs.length>1&&n.jsxs("div",{style:{fontSize:11,color:i.accent,marginBottom:12,...L},children:["Multi-output transaction Â· ",e.outputs.length," recipients (treasury-combined path)"]}),(e==null?void 0:e.metaKind)==="treasury_fee"&&n.jsx("div",{style:{fontSize:12,color:i.warn,marginBottom:12,...L},children:"Protocol treasury fee payout transfer (separate on-chain micro-transaction)"}),n.jsx(ge,{p:0,style:{marginBottom:16},children:[["Type",e.type],["From",Ze(e.from)],["To",Ze(e.to)],["Amount",`${e.amount_kas} KAS`],["Fee",`${vt} KAS`],["Purpose",e.purpose]].map(([l,_],A,v)=>n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"9px 14px",borderBottom:A<v.length-1?`1px solid ${i.border}`:"none"},children:[n.jsx("span",{style:{fontSize:12,color:i.dim,...L},children:l}),n.jsx("span",{style:{fontSize:12,color:i.text,...L},children:_})]},l))}),a&&n.jsxs("div",{style:{fontSize:12,color:i.danger,...L,marginBottom:12,padding:"8px 12px",background:i.dLow,borderRadius:4},children:["Error: ",a]}),n.jsxs("div",{style:{display:"flex",gap:10},children:[n.jsx(pe,{onClick:s,variant:"ghost",style:{flex:1,padding:"10px 0"},children:"REJECT"}),n.jsx(pe,{onClick:c,disabled:o,style:{flex:2,padding:"10px 0"},children:o?"SIGNING...":"SIGN & BROADCAST"})]}),n.jsx("div",{style:{fontSize:11,color:i.dim,marginTop:10,textAlign:"center",...L},children:"Signing occurs client-side Â· Private key never leaves your wallet"})]})})}const fa={name:"",kpiTarget:"12",capitalLimit:"5000",risk:"medium",execMode:"manual",autoApproveThreshold:"50",kpiMetric:"ROI %",horizon:30,revenueSource:"momentum",dataSources:["KAS On-Chain","Kaspa DAG"],frequency:"1h",strategyTemplate:"dca_accumulator",strategyLabel:"Steady DCA Builder",strategyClass:"accumulation",riskBudgetWeight:"1.0",portfolioAllocationPct:"25"},ii=[{id:"dca_accumulator",name:"Steady DCA Builder",class:"accumulation",purpose:"Core accumulation engine for steady inventory growth with low drawdown behavior.",bestFor:"Range-to-neutral regimes, long accumulation windows, disciplined compounding.",desc:"Frequent small entries, strict downside control, and conservative auto-execution thresholds.",defaults:{risk:"low",kpiTarget:"10",horizon:90,frequency:"4h",revenueSource:"accumulation",execMode:"manual",autoApproveThreshold:"25"}},{id:"trend",name:"Trend Rider",class:"accumulation",purpose:"Compound into persistent directional moves while protecting against reversals.",bestFor:"Clear momentum regimes with stable liquidity and improving edge score.",desc:"Scales entries with trend persistence and tightens risk when momentum degrades.",defaults:{risk:"medium",kpiTarget:"18",horizon:45,frequency:"1h",revenueSource:"trend",execMode:"manual",autoApproveThreshold:"40"}},{id:"mean_reversion",name:"Dip Harvester",class:"accumulation",purpose:"Accumulate discounted KAS during temporary weakness without chasing breakouts.",bestFor:"Range regimes, oversold snaps, and volatility normalization after spikes.",desc:"Buys weakness with quant-regime gating and reduced chase behavior.",defaults:{risk:"low",kpiTarget:"14",horizon:30,frequency:"30m",revenueSource:"mean-reversion",execMode:"manual",autoApproveThreshold:"20"}},{id:"vol_breakout",name:"Volatility Expansion Hunter",class:"accumulation",purpose:"Exploit expansion regimes with tighter automation controls and rapid reviews.",bestFor:"Breakout conditions, elevated DAA activity, and strong regime transitions.",desc:"Responds to volatility expansion while preserving accumulation-only discipline.",defaults:{risk:"medium",kpiTarget:"22",horizon:21,frequency:"15m",revenueSource:"breakout",execMode:"notify",autoApproveThreshold:"15"}}],ma=[{v:"low",l:"Low",desc:"Tight stops. Max 5% exposure per action."},{v:"medium",l:"Medium",desc:"Balanced Kelly sizing. 10% max exposure."},{v:"high",l:"High",desc:"Aggressive. 20% max. Wide targets."}],oi=[{v:"autonomous",l:"Fully Autonomous",desc:"Auto-signs under threshold. Manual above."},{v:"manual",l:"Manual Approval",desc:"Every action requires wallet signature."},{v:"notify",l:"Notify Only",desc:"Decisions generated, no execution."}],_a=({d:e,set:t,wallet:r})=>n.jsxs("div",{children:[n.jsx("div",{style:{fontSize:17,color:i.text,fontWeight:700,marginBottom:3,...L},children:"Configure Agent"}),n.jsxs("div",{style:{fontSize:12,color:i.dim,marginBottom:20},children:["Connected: ",n.jsx("span",{style:{color:i.accent,...L},children:Ze(r==null?void 0:r.address)})]}),n.jsx(Ce,{children:"Strategy Profile (Self-Trading Bot, Accumulation-First)"}),n.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:8,marginBottom:16},children:ii.map(s=>{const o=e.strategyTemplate===s.id;return n.jsxs("div",{onClick:()=>{t("strategyTemplate",s.id),t("strategyLabel",s.name),t("strategyClass",s.class),Object.entries(s.defaults).forEach(([d,a])=>t(d,a))},style:{padding:"10px 12px",borderRadius:8,cursor:"pointer",border:`1px solid ${o?i.accent:i.border}`,background:o?i.aLow:i.s2,transition:"all 0.15s"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:8,alignItems:"center",marginBottom:4},children:[n.jsx("div",{style:{fontSize:12,color:o?i.accent:i.text,fontWeight:700,...L},children:s.name}),n.jsx(ee,{text:s.class.toUpperCase(),color:s.class==="accumulation"?i.ok:i.warn})]}),n.jsx("div",{style:{fontSize:11,color:i.text,marginBottom:3},children:s.purpose||s.desc}),s.bestFor&&n.jsxs("div",{style:{fontSize:10,color:i.dim},children:["Best for: ",s.bestFor]}),s.desc&&s.purpose&&n.jsx("div",{style:{fontSize:10,color:i.dim,marginTop:3},children:s.desc})]},s.id)})}),n.jsx($t,{label:"Agent Name",value:e.name,onChange:s=>t("name",s),placeholder:"KAS-Alpha-01"}),n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[n.jsx($t,{label:"ROI Target",value:e.kpiTarget,onChange:s=>t("kpiTarget",s),type:"number",placeholder:"12",suffix:"%"}),n.jsx($t,{label:"Capital / Cycle",value:e.capitalLimit,onChange:s=>t("capitalLimit",s),type:"number",placeholder:"5000",suffix:"KAS"})]}),n.jsx(Ce,{children:"Risk Tolerance"}),n.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8},children:ma.map(s=>{const o=e.risk===s.v;return n.jsxs("div",{onClick:()=>t("risk",s.v),style:{padding:"12px 10px",borderRadius:4,cursor:"pointer",border:`1px solid ${o?i.accent:i.border}`,background:o?i.aLow:i.s2,textAlign:"center",transition:"all 0.15s"},children:[n.jsx("div",{style:{fontSize:13,color:o?i.accent:i.text,fontWeight:700,...L,marginBottom:3},children:s.l}),n.jsx("div",{style:{fontSize:11,color:i.dim},children:s.desc})]},s.v)})})]}),pa=({d:e,set:t})=>n.jsxs("div",{children:[n.jsx("div",{style:{fontSize:17,color:i.text,fontWeight:700,marginBottom:3,...L},children:"Execution & Signing"}),n.jsx("div",{style:{fontSize:12,color:i.dim,marginBottom:20},children:"Configure how the agent acts and when your wallet signs."}),oi.map(r=>{const s=e.execMode===r.v;return n.jsxs("div",{onClick:()=>t("execMode",r.v),style:{padding:14,borderRadius:6,marginBottom:10,cursor:"pointer",border:`1px solid ${s?i.accent:i.border}`,background:s?i.aLow:i.s2,transition:"all 0.15s"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:4},children:[n.jsx("div",{style:{width:11,height:11,borderRadius:"50%",border:`2px solid ${s?i.accent:i.muted}`,background:s?i.accent:"transparent",flexShrink:0}}),n.jsx("span",{style:{fontSize:13,color:s?i.accent:i.text,fontWeight:700,...L},children:r.l})]}),n.jsx("div",{style:{fontSize:12,color:i.dim,marginLeft:21},children:r.desc})]},r.v)}),n.jsxs("div",{style:{padding:"10px 12px",borderRadius:6,border:`1px solid ${i.border}`,background:i.s2,marginBottom:6},children:[n.jsx("div",{style:{fontSize:11,color:i.dim,...L,marginBottom:4},children:"PORTFOLIO ALLOCATOR"}),n.jsx("div",{style:{fontSize:12,color:i.text},children:"Automatic"}),n.jsx("div",{style:{fontSize:11,color:i.dim,marginTop:2},children:"Forge.OS manages shared portfolio allocation and risk budget weighting automatically. You fund in KAS and the bot handles routing."})]}),n.jsx(si,{}),n.jsxs("div",{style:{padding:"10px 12px",borderRadius:6,border:`1px solid ${i.border}`,background:i.s2},children:[n.jsx("div",{style:{fontSize:11,color:i.dim,...L,marginBottom:4},children:"SIGNING POLICY"}),n.jsx("div",{style:{fontSize:12,color:i.text},children:"Wallet-Native Guardrails"}),n.jsx("div",{style:{fontSize:11,color:i.dim,marginTop:2},children:"Forge.OS handles queueing and safety checks automatically. Larger or riskier actions can still require manual wallet signing depending on execution mode and runtime guardrails."})]})]}),ha=({d:e,wallet:t,onDeploy:r})=>{const s=e.name&&e.capitalLimit&&e.kpiTarget,o=ii.find(d=>d.id===e.strategyTemplate);return n.jsxs("div",{children:[n.jsx("div",{style:{fontSize:17,color:i.text,fontWeight:700,marginBottom:3,...L},children:"Review & Deploy"}),n.jsx("div",{style:{fontSize:12,color:i.dim,marginBottom:18},children:"Agent vault will be provisioned. Initial funding requires a wallet signature."}),n.jsx(ge,{p:0,style:{marginBottom:14},children:[["Agent",e.name||"â€”"],["Strategy Template",e.strategyLabel||e.strategyTemplate||"Custom"],["Wallet",Ze(t==null?void 0:t.address)],["Network",(t==null?void 0:t.network)||Te],["ROI Target",`${e.kpiTarget}%`],["Capital / Cycle",`${e.capitalLimit} KAS`],["Portfolio Allocator","AUTO"],["Risk",e.risk.toUpperCase()],["Exec Mode",e.execMode.replace(/_/g," ").toUpperCase()],["Signing","WALLET-NATIVE GUARDRAILS"]].map(([d,a],u,c)=>n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"9px 16px",borderBottom:u<c.length-1?`1px solid ${i.border}`:"none"},children:[n.jsx("span",{style:{fontSize:12,color:i.dim,...L},children:d}),n.jsx("span",{style:{fontSize:12,color:i.text,...L},children:a})]},d))}),(o==null?void 0:o.purpose)&&n.jsxs("div",{style:{background:i.s2,border:`1px solid ${i.border}`,borderRadius:4,padding:"10px 14px",marginBottom:12},children:[n.jsx("div",{style:{fontSize:11,color:i.dim,...L,marginBottom:4},children:"STRATEGY PURPOSE"}),n.jsx("div",{style:{fontSize:12,color:i.text,marginBottom:4},children:o.purpose}),o.bestFor&&n.jsxs("div",{style:{fontSize:11,color:i.dim},children:["Best for: ",o.bestFor]})]}),n.jsxs("div",{style:{background:i.s2,border:`1px solid ${i.border}`,borderRadius:4,padding:"9px 14px",marginBottom:12,fontSize:11,color:i.dim},children:["Shared portfolio allocation and risk weighting are auto-managed by Forge.OS. Your primary funding input is ",n.jsx("span",{style:{color:i.text,...L},children:"Capital / Cycle (KAS)"}),"."]}),n.jsxs("div",{style:{background:i.wLow,border:`1px solid ${i.warn}30`,borderRadius:4,padding:"10px 14px",marginBottom:16,fontSize:12,color:i.dim},children:["Deployment triggers a wallet signature to provision the agent vault. Vault address: ",n.jsx("span",{style:{color:i.accent,...L},children:Ze(Ir)})]}),n.jsx(pe,{onClick:r,disabled:!s,style:{width:"100%",padding:"11px 0"},children:"DEPLOY AGENT â€” SIGN WITH WALLET"}),!s&&n.jsx("div",{style:{fontSize:11,color:i.warn,marginTop:6,textAlign:"center",...L},children:"Name, capital, and target required."})]})};function H(e,t=0){const r=Number(e);return Number.isFinite(r)?r:t}function ga(e){if(!Array.isArray(e==null?void 0:e.outputs))return;const t=e.outputs.map(r=>({to:$e(String((r==null?void 0:r.to)||(r==null?void 0:r.address)||""),Ae),amount_kas:Number(H((r==null?void 0:r.amount_kas)??(r==null?void 0:r.amount),0).toFixed(6)),tag:r!=null&&r.tag?String(r.tag).slice(0,40):void 0})).filter(r=>r.to&&r.amount_kas>0);if(t.length)return t}function Sa(e,t,r){if(!(e!=null&&e.length))return{to:t,amount_kas:r};const s=e.find(o=>String(o.tag||"").toLowerCase()==="primary")||e[0];return{to:s.to,amount_kas:s.amount_kas}}function Ns(e){var A,v;const t=ga(e),r=String((e==null?void 0:e.to)||"").trim(),s=Number(H(e==null?void 0:e.amount_kas,0).toFixed(6)),o=r?$e(r,Ae):((A=t==null?void 0:t[0])==null?void 0:A.to)||"",d=s>0?s:Number(((v=t==null?void 0:t[0])==null?void 0:v.amount_kas)||0),a=Sa(t,o,d),u=a.to,c=Number(H(a.amount_kas,0).toFixed(6));if(!(c>0)||!u)throw new Error("Invalid tx amount_kas/to; must be > 0 and valid address");const l=String((e==null?void 0:e.status)||"pending").toLowerCase(),_=l==="pending"||l==="signing"||l==="signed"||l==="rejected"||l==="failed"?l:"pending";return{...e,id:String((e==null?void 0:e.id)||"").trim(),type:String((e==null?void 0:e.type)||"TX").trim()||"TX",from:e!=null&&e.from?String(e.from).trim():void 0,to:u,amount_kas:c,outputs:t,purpose:String((e==null?void 0:e.purpose)||"ForgeOS transaction").trim().slice(0,140),status:_,ts:Math.max(0,Math.round(H(e==null?void 0:e.ts,Date.now()))),receipt_lifecycle:(e==null?void 0:e.receipt_lifecycle)==="broadcasted"||(e==null?void 0:e.receipt_lifecycle)==="pending_confirm"||(e==null?void 0:e.receipt_lifecycle)==="confirmed"||(e==null?void 0:e.receipt_lifecycle)==="failed"||(e==null?void 0:e.receipt_lifecycle)==="timeout"?e.receipt_lifecycle:"submitted",submitted_ts:Math.max(0,Math.round(H(e==null?void 0:e.submitted_ts,(e==null?void 0:e.ts)??Date.now()))),broadcast_ts:H(e==null?void 0:e.broadcast_ts,NaN)>0?Math.round(H(e==null?void 0:e.broadcast_ts,0)):void 0,confirm_ts:H(e==null?void 0:e.confirm_ts,NaN)>0?Math.round(H(e==null?void 0:e.confirm_ts,0)):void 0,confirm_detected_ts:H(e==null?void 0:e.confirm_detected_ts,NaN)>0?Math.round(H(e==null?void 0:e.confirm_detected_ts,0)):void 0,confirm_ts_source:(e==null?void 0:e.confirm_ts_source)==="chain"||(e==null?void 0:e.confirm_ts_source)==="poll"?e.confirm_ts_source:void 0,receipt_last_checked_ts:H(e==null?void 0:e.receipt_last_checked_ts,NaN)>0?Math.round(H(e==null?void 0:e.receipt_last_checked_ts,0)):void 0,receipt_next_check_at:H(e==null?void 0:e.receipt_next_check_at,NaN)>0?Math.round(H(e==null?void 0:e.receipt_next_check_at,0)):void 0,receipt_attempts:Math.max(0,Math.round(H(e==null?void 0:e.receipt_attempts,0))),confirmations:Math.max(0,Math.round(H(e==null?void 0:e.confirmations,0))),failure_reason:(e==null?void 0:e.failure_reason)==null?null:String(e.failure_reason).slice(0,240),broadcast_price_usd:Number.isFinite(H(e==null?void 0:e.broadcast_price_usd,NaN))?H(e==null?void 0:e.broadcast_price_usd,0):void 0,confirm_price_usd:Number.isFinite(H(e==null?void 0:e.confirm_price_usd,NaN))?H(e==null?void 0:e.confirm_price_usd,0):void 0,receipt_block_time_ms:H(e==null?void 0:e.receipt_block_time_ms,NaN)>0?Math.round(H(e==null?void 0:e.receipt_block_time_ms,0)):void 0,receipt_fee_sompi:Number.isFinite(H(e==null?void 0:e.receipt_fee_sompi,NaN))?Math.max(0,Math.round(H(e==null?void 0:e.receipt_fee_sompi,0))):void 0,receipt_fee_kas:Number.isFinite(H(e==null?void 0:e.receipt_fee_kas,NaN))?Math.max(0,Number(H(e==null?void 0:e.receipt_fee_kas,0).toFixed(8))):void 0,receipt_mass:Number.isFinite(H(e==null?void 0:e.receipt_mass,NaN))?Math.max(0,Math.round(H(e==null?void 0:e.receipt_mass,0))):void 0,receipt_source_path:e!=null&&e.receipt_source_path?String(e.receipt_source_path).slice(0,240):void 0,receipt_source:e!=null&&e.receipt_source?String(e.receipt_source).slice(0,120):void 0,receipt_imported_from:(e==null?void 0:e.receipt_imported_from)==="callback_consumer"||(e==null?void 0:e.receipt_imported_from)==="kaspa_api"?e.receipt_imported_from:void 0,receipt_backend_updated_at:H(e==null?void 0:e.receipt_backend_updated_at,NaN)>0?Math.round(H(e==null?void 0:e.receipt_backend_updated_at,0)):void 0,receipt_slippage_kas:Number.isFinite(H(e==null?void 0:e.receipt_slippage_kas,NaN))?Math.max(0,Number(H(e==null?void 0:e.receipt_slippage_kas,0).toFixed(8))):void 0,backend_confirm_ts:H(e==null?void 0:e.backend_confirm_ts,NaN)>0?Math.round(H(e==null?void 0:e.backend_confirm_ts,0)):void 0,backend_confirmations:Number.isFinite(H(e==null?void 0:e.backend_confirmations,NaN))?Math.max(0,Math.round(H(e==null?void 0:e.backend_confirmations,0))):void 0,backend_receipt_fee_kas:Number.isFinite(H(e==null?void 0:e.backend_receipt_fee_kas,NaN))?Math.max(0,Number(H(e==null?void 0:e.backend_receipt_fee_kas,0).toFixed(8))):void 0,backend_receipt_fee_sompi:Number.isFinite(H(e==null?void 0:e.backend_receipt_fee_sompi,NaN))?Math.max(0,Math.round(H(e==null?void 0:e.backend_receipt_fee_sompi,0))):void 0,backend_receipt_slippage_kas:Number.isFinite(H(e==null?void 0:e.backend_receipt_slippage_kas,NaN))?Math.max(0,Number(H(e==null?void 0:e.backend_receipt_slippage_kas,0).toFixed(8))):void 0,chain_confirm_ts:H(e==null?void 0:e.chain_confirm_ts,NaN)>0?Math.round(H(e==null?void 0:e.chain_confirm_ts,0)):void 0,chain_confirmations:Number.isFinite(H(e==null?void 0:e.chain_confirmations,NaN))?Math.max(0,Math.round(H(e==null?void 0:e.chain_confirmations,0))):void 0,chain_receipt_fee_kas:Number.isFinite(H(e==null?void 0:e.chain_receipt_fee_kas,NaN))?Math.max(0,Number(H(e==null?void 0:e.chain_receipt_fee_kas,0).toFixed(8))):void 0,chain_receipt_fee_sompi:Number.isFinite(H(e==null?void 0:e.chain_receipt_fee_sompi,NaN))?Math.max(0,Math.round(H(e==null?void 0:e.chain_receipt_fee_sompi,0))):void 0,chain_derived_slippage_kas:Number.isFinite(H(e==null?void 0:e.chain_derived_slippage_kas,NaN))?Math.max(0,Number(H(e==null?void 0:e.chain_derived_slippage_kas,0).toFixed(8))):void 0,receipt_consistency_status:(e==null?void 0:e.receipt_consistency_status)==="consistent"||(e==null?void 0:e.receipt_consistency_status)==="mismatch"||(e==null?void 0:e.receipt_consistency_status)==="insufficient"?e.receipt_consistency_status:void 0,receipt_consistency_mismatches:Array.isArray(e==null?void 0:e.receipt_consistency_mismatches)?e.receipt_consistency_mismatches.map(g=>String(g)).filter(Boolean).slice(0,8):void 0,receipt_consistency_checked_ts:H(e==null?void 0:e.receipt_consistency_checked_ts,NaN)>0?Math.round(H(e==null?void 0:e.receipt_consistency_checked_ts,0)):void 0,receipt_consistency_confirm_ts_drift_ms:Number.isFinite(H(e==null?void 0:e.receipt_consistency_confirm_ts_drift_ms,NaN))?Math.max(0,Math.round(H(e==null?void 0:e.receipt_consistency_confirm_ts_drift_ms,0))):void 0,receipt_consistency_fee_diff_kas:Number.isFinite(H(e==null?void 0:e.receipt_consistency_fee_diff_kas,NaN))?Math.max(0,Number(H(e==null?void 0:e.receipt_consistency_fee_diff_kas,0).toFixed(8))):void 0,receipt_consistency_slippage_diff_kas:Number.isFinite(H(e==null?void 0:e.receipt_consistency_slippage_diff_kas,NaN))?Math.max(0,Number(H(e==null?void 0:e.receipt_consistency_slippage_diff_kas,0).toFixed(8))):void 0,metaKind:(e==null?void 0:e.metaKind)==="treasury_fee"?"treasury_fee":(e==null?void 0:e.metaKind)==="deploy"?"deploy":"action"}}function kr(e){const t={id:String((e==null?void 0:e.id)||"").trim(),status:"pending",ts:Date.now(),submitted_ts:Date.now(),receipt_lifecycle:"submitted",receipt_attempts:0,confirmations:0,failure_reason:null,...e};if(!t.id)throw new Error("Queue tx requires id");return Ns(t)}async function ya(e,t){const r=Ns(t),s=Array.isArray(r.outputs)?r.outputs:[],o=s.length>1;if(o&&!he.supportsNativeMultiOutput(String((e==null?void 0:e.provider)||"")))throw new Error(`Wallet ${String((e==null?void 0:e.provider)||"unknown")} does not support native multi-output send`);return(e==null?void 0:e.provider)==="kasware"?he.sendKasware(r.to,r.amount_kas):(e==null?void 0:e.provider)==="kastle"?o&&he.canKastleSignAndBroadcastRawTx()?he.sendKastleRawTx(s,r.purpose):he.sendKastle(r.to,r.amount_kas):(e==null?void 0:e.provider)==="ghost"?s.length?he.sendGhostOutputs(s,r.purpose):he.sendGhost(r.to,r.amount_kas):(e==null?void 0:e.provider)==="kaspium"?he.sendKaspium(r.to,r.amount_kas,r.purpose):(e==null?void 0:e.provider)==="tangem"||(e==null?void 0:e.provider)==="onekey"?he.sendHardwareBridge(String((e==null?void 0:e.provider)||"hardware"),r.to,r.amount_kas,r.purpose,s):(await new Promise(d=>setTimeout(d,300)),Array.from({length:64},()=>"0123456789abcdef"[Math.floor(Math.random()*16)]).join(""))}function Ea({wallet:e,onComplete:t}){var v;const[r,s]=y.useState(0),[o,d]=y.useState({...fa}),a=(g,N)=>d(C=>({...C,[g]:N})),[u,c]=y.useState(!1),l=()=>{c(!0)},_=g=>{c(!1),t({...o,wallet:e,deployTx:g,deployedAt:Date.now(),agentId:`forge_${vr()}`})},A=kr({id:`deploy_${vr()}`,type:"AGENT_DEPLOY",metaKind:"deploy",from:e==null?void 0:e.address,to:Ir,amount_kas:parseFloat(o.capitalLimit)||5e3,purpose:"Agent vault provisioning + initial capital"});return n.jsxs("div",{style:{maxWidth:1040,margin:"0 auto",padding:"clamp(18px, 2.2vw, 34px)"},children:[u&&n.jsx(Ts,{tx:A,wallet:e,onSign:_,onReject:()=>c(!1)}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:22},children:[n.jsx("span",{style:{fontSize:10,color:i.dim,letterSpacing:"0.12em",...L},children:"FORGE.OS / NEW AGENT"}),n.jsx("span",{style:{width:1,height:12,background:i.border,display:"inline-block"}}),n.jsx(ee,{text:((v=e==null?void 0:e.provider)==null?void 0:v.toUpperCase())||"CONNECTED",color:i.ok,dot:!0})]}),n.jsxs(ge,{p:28,style:{maxWidth:680,margin:"0 auto"},children:[n.jsx("div",{style:{display:"flex",gap:5,marginBottom:26},children:[0,1,2].map(g=>n.jsx("div",{style:{height:3,flex:1,borderRadius:2,background:g<=r?i.accent:i.muted,transition:"background 0.3s"}},g))}),r===0&&n.jsx(_a,{d:o,set:a,wallet:e}),r===1&&n.jsx(pa,{d:o,set:a}),r===2&&n.jsx(ha,{d:o,wallet:e,onDeploy:l}),n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:22,paddingTop:16,borderTop:`1px solid ${i.border}`},children:[n.jsx(pe,{onClick:()=>s(g=>g-1),variant:"ghost",disabled:r===0,children:"BACK"}),n.jsxs("span",{style:{fontSize:11,color:i.dim,alignSelf:"center",...L},children:["STEP ",r+1," / 3"]}),r<2&&n.jsx(pe,{onClick:()=>s(g=>g+1),children:"NEXT"}),r===2&&n.jsx("div",{})]})]})]})}const xa="modulepreload",ba=function(e,t){return new URL(e,t).href},rn={},Wt=function(t,r,s){let o=Promise.resolve();if(r&&r.length>0){const a=document.getElementsByTagName("link"),u=document.querySelector("meta[property=csp-nonce]"),c=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));o=Promise.allSettled(r.map(l=>{if(l=ba(l,s),l in rn)return;rn[l]=!0;const _=l.endsWith(".css"),A=_?'[rel="stylesheet"]':"";if(!!s)for(let N=a.length-1;N>=0;N--){const C=a[N];if(C.href===l&&(!_||C.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${A}`))return;const g=document.createElement("link");if(g.rel=_?"stylesheet":xa,_||(g.as="script"),g.crossOrigin="",g.href=l,c&&g.setAttribute("nonce",c),document.head.appendChild(g),_)return new Promise((N,C)=>{g.addEventListener("load",N),g.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${l}`)))})}))}function d(a){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=a,window.dispatchEvent(u),!u.defaultPrevented)throw a}return o.then(a=>{for(const u of a||[])u.status==="rejected"&&d(u.reason);return t().catch(d)})};function P(e,t=0){const r=Number(e);return Number.isFinite(r)?r:t}function ae(e,t,r){return Math.min(r,Math.max(t,e))}function ai(e){return e.length?e.reduce((t,r)=>t+r,0)/e.length:0}function Aa(e){if(e.length<2)return 0;const t=ai(e);return e.reduce((r,s)=>r+(s-t)**2,0)/(e.length-1)}function ci(e){return Math.sqrt(Math.max(0,Aa(e)))}function Jt(e){return e[e.length-1]}function Ta(e){if(e.length<2)return[];const t=[];for(let r=1;r<e.length;r+=1)t.push(e[r]-e[r-1]);return t}function Vr(e,t=1){if(e.length<=t)return 0;const r=Jt(e),s=e[e.length-1-t];return!(s>0)||!Number.isFinite(r)?0:(r-s)/s}function Na(e){const t=[];for(let r=1;r<e.length;r+=1){const s=e[r-1],o=e[r];s>0&&o>0&&t.push(Math.log(o/s))}return t}function va(e,t=.94){if(!e.length)return 0;let r=e[0]**2;for(let s=1;s<e.length;s+=1)r=t*r+(1-t)*e[s]**2;return Math.sqrt(Math.max(0,r))}function Ia(e){if(e.length<2)return 0;const t=e.length;let r=0,s=0,o=0,d=0;for(let u=0;u<t;u+=1)r+=u,s+=e[u],o+=u*e[u],d+=u*u;const a=t*d-r*r;return a===0?0:(t*o-r*s)/a}function Ca(e,t){if(!t.length)return 0;const r=ci(t);return r===0?0:(e-ai(t))/r}function ka(e){if(!e.length)return 0;let t=e[0],r=0;for(const s of e)s>t&&(t=s),t>0&&(r=Math.max(r,(t-s)/t));return r}function Ma(e){return e>30?1:e<-30?0:1/(1+Math.exp(-e))}function z(e,t=4){const r=10**t;return Math.round(e*r)/r}function Sr(e,t){return t<=0?[]:e.slice(Math.max(0,e.length-t))}function Ra(e){const t=String((e==null?void 0:e.risk)||"medium").toLowerCase(),r=String((e==null?void 0:e.strategyTemplate)||"").toLowerCase();if(t==="low"){const o={label:"low",kellyCap:.08,riskCeiling:.42,exposureCapPct:.12,drawdownPenaltyStart:.03};return r==="dca_accumulator"?{...o,kellyCap:.06,exposureCapPct:.1,drawdownPenaltyStart:.025}:r==="mean_reversion"?{...o,riskCeiling:.38,exposureCapPct:.1}:o}if(t==="high"){const o={label:"high",kellyCap:.22,riskCeiling:.82,exposureCapPct:.35,drawdownPenaltyStart:.1};return r==="vol_breakout"?{...o,kellyCap:.2,exposureCapPct:.28,riskCeiling:.76}:o}const s={label:"medium",kellyCap:.14,riskCeiling:.65,exposureCapPct:.22,drawdownPenaltyStart:.06};return r==="trend"?{...s,kellyCap:.16,exposureCapPct:.24}:r==="dca_accumulator"?{...s,kellyCap:.1,riskCeiling:.58,exposureCapPct:.16,drawdownPenaltyStart:.045}:r==="mean_reversion"?{...s,riskCeiling:.56,exposureCapPct:.18}:r==="vol_breakout"?{...s,kellyCap:.12,riskCeiling:.6,drawdownPenaltyStart:.05}:s}function sn(e){var d,a,u,c,l,_,A,v;if(!e)return null;const t=P(e.ts??e.fetched??((d=e==null?void 0:e.kasData)==null?void 0:d.fetched)??((a=e==null?void 0:e.kasData)==null?void 0:a.ts),NaN),r=P(e.priceUsd??e.price??((u=e==null?void 0:e.kasData)==null?void 0:u.priceUsd),0),s=P(e.daaScore??((c=e==null?void 0:e.dag)==null?void 0:c.daaScore)??((l=e==null?void 0:e.kasData)==null?void 0:l.daaScore)??((A=(_=e==null?void 0:e.kasData)==null?void 0:_.dag)==null?void 0:A.daaScore),0),o=P(e.walletKas??((v=e==null?void 0:e.kasData)==null?void 0:v.walletKas),0);return!Number.isFinite(t)||t<=0?null:{ts:t,priceUsd:Math.max(0,r),daaScore:Math.max(0,s),walletKas:Math.max(0,o)}}function wa(e,t){const r=[];for(const d of Array.isArray(t==null?void 0:t.history)?t.history:[]){const a=sn(d);a&&r.push(a)}const s=sn(e);s&&r.push(s),r.sort((d,a)=>d.ts-a.ts);const o=[];for(const d of r){const a=o[o.length-1];a&&d.ts===a.ts&&d.priceUsd===a.priceUsd&&d.daaScore===a.daaScore&&d.walletKas===a.walletKas||o.push(d)}return o.slice(-240)}function La(e){return e<.008?"LOW":e<.02?"MEDIUM":"HIGH"}function Pa(e,t){return!(t>0)||e<=t*.06?"MINIMAL":e<=t*.2?"MODERATE":"SIGNIFICANT"}function Oa(e,t,r,s){return e<-.45||r>.12&&t>.02?"RISK_OFF":e>.4&&t<.03&&s>=0?"TREND_UP":Math.abs(e)<.15&&t>.015?"RANGE_VOL":s>.25&&e>=0?"FLOW_ACCUMULATION":"NEUTRAL"}function Ka(e){const t=[];return e.dataQualityScore<.55&&t.push("Limited local sample history"),e.volatilityEstimate==="HIGH"&&t.push("Elevated short-horizon volatility"),e.drawdownPct>.08&&t.push("Recent drawdown pressure"),e.liquidityImpact!=="MINIMAL"&&t.push("Position size may impact wallet liquidity"),e.regime==="RISK_OFF"&&t.push("Risk-off regime detected"),t.length===0&&t.push("Normal market conditions"),t.slice(0,5)}function ja(e){const t=e.momentumScore>.2?"positive momentum":e.momentumScore<-.2?"negative momentum":"mixed momentum",r=e.regime.toLowerCase().replace(/_/g," ");return[`${e.action} because the local quant core detects ${r} with ${t}, EWMA volatility ${(e.ewmaVol*100).toFixed(2)}%, and DAA velocity ${z(e.daaVelocity,2)}.`,`Model win probability is ${(e.winProbability*100).toFixed(1)}% with expected value ${z(e.expectedValuePct,2)}%; sizing is capped by risk profile and data-quality score ${z(e.dataQualityScore,2)}.`].join(" ")}function Fa(e,t,r){const s=wa(t,r),o=Ra(e),d=Math.max(0,P(e==null?void 0:e.capitalLimit,0)),a=s[s.length-1],u=P(r==null?void 0:r.now,Date.now()),c=s.map(ve=>ve.priceUsd).filter(ve=>ve>0),l=s.map(ve=>ve.daaScore).filter(ve=>ve>0),_=s.map(ve=>ve.walletKas).filter(ve=>ve>=0),A=Na(c),v=Sr(A,24),g=A.length?Jt(A):0,N=va(v,.92),C=La(N),M=Vr(c,1),x=Vr(c,5),R=Vr(c,20),b=M*1.4+x*.9+R*.6,f=ae(b*12,-2,2),p=ae(Ca(g,v),-4,4),S=Ta(l),K=S.length?Jt(S):0,j=Ia(Sr(l,16)),F=ci(Sr(S,16)),B=ae(j/Math.max(1,Math.abs(K)||1)*.25+(K>0?.15:-.1),-1,1),U=ka(Sr(c,48)),I=ae(c.length/32,0,1),h=ae(l.length/32,0,1),G=ae(s.length/48,0,1),$=ae(.15+G*.45+I*.3+h*.1,.15,1),W=ae(N/.03,0,2),Y=ae((U-o.drawdownPenaltyStart)/Math.max(.01,.2-o.drawdownPenaltyStart),0,1.2),te=1-$,ie=ae(f/2,-1,1),me=Ma(.1+ie*1.25+B*.55-W*.55-Y*.6),Ee=ae(.5+(me-.5)*(.4+$*.6),.35,.82),Se=z(Ee*100,2),Pe=f>.35?2.1:f<-.35?1.1:C==="HIGH"?1.3:1.7,Ie=z(ae(N*100*2.2+1.4,1.2,12),2),We=z(ae(Ie*Pe,2.2,22),2),xe=z(Ee*We-(1-Ee)*Ie,2),be=Math.max(.01,Pe),tt=Math.max(0,Ee-(1-Ee)/be),He=ae(o.kellyCap*(.55+.45*$),.02,o.kellyCap),Ve=z(ae(tt,0,He),4),Je=z(ae(.18+W*.26+Y*.28+(f<-.35?.16:0)+(C==="HIGH"&&F>15?.1:0)+te*.18-(f>.35?.06:0),.04,.98),4),Ge=Oa(f,N,U,B),at=z(xe/Math.max(1,Ie),4),Z=Math.max(0,P((a==null?void 0:a.walletKas)??(t==null?void 0:t.walletKas),0)),we=Z>0?Z:Math.max(0,Jt(_)||0);let Me="HOLD";Je>o.riskCeiling+.08&&f<-.2&&we>.5?Me="REDUCE":xe>.35&&Ve>.01&&Je<=o.riskCeiling?Me="ACCUMULATE":Math.abs(f)<.12&&C==="HIGH"&&(Me="REBALANCE");const m=d*Ve*(1+ae(xe/6,0,.65)),E=d*o.exposureCapPct,q=we>0?we*Math.max(.08,o.exposureCapPct):d;let T=Math.min(d,Math.max(0,m),E,q);Me==="HOLD"&&(T=0),Me==="REDUCE"&&(T=Math.min(Math.max(d*.05,m),we*.25||d)),Me==="REBALANCE"&&(T=Math.min(Math.max(d*.03,m*.7),q)),T=z(Math.max(0,T),6);const X=d>0?z(ae(T/d*100,0,100),2):0,ne=Pa(T,we||d||1),V=Me==="ACCUMULATE"?Ge==="TREND_UP"?"ENTRY":"SCALING":Me==="REDUCE"?"EXIT":"HOLDING",_e=z(ae(.52+ae(Math.abs(xe)/5,0,.2)+$*.15-Je*.12+(Me==="HOLD"?.02:0),.45,.97),4),k=Ka({dataQualityScore:$,volatilityEstimate:C,drawdownPct:U,liquidityImpact:ne,regime:Ge}),le=ja({action:Me,regime:Ge,momentumScore:f,ewmaVol:N,winProbability:Ee,expectedValuePct:xe,dataQualityScore:$,daaVelocity:K}),Ne=ae(Math.round(45+Je*120+(C==="HIGH"?45:0)),45,240),ye=new Date(u+Ne*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),Le={regime:Ge,sample_count:s.length,data_quality_score:z($,4),price_usd:z(P(Jt(c),P(t==null?void 0:t.priceUsd,0)),6),price_return_1_pct:z(M*100,4),price_return_5_pct:z(x*100,4),price_return_20_pct:z(R*100,4),momentum_z:z(p,4),ewma_volatility:z(N,6),daa_velocity:z(K,4),daa_slope:z(j,4),drawdown_pct:z(U*100,4),win_probability_model:z(Ee,4),edge_score:z(at,4),kelly_raw:z(tt,4),kelly_cap:z(He,4),risk_ceiling:z(o.riskCeiling,4),risk_profile:o.label,exposure_cap_pct:z(o.exposureCapPct*100,4),strategy_template:String((e==null?void 0:e.strategyTemplate)||"custom")};return{action:Me,confidence_score:_e,risk_score:Je,kelly_fraction:Ve,capital_allocation_kas:T,capital_allocation_pct:X,expected_value_pct:xe,stop_loss_pct:Ie,take_profit_pct:We,monte_carlo_win_pct:Se,volatility_estimate:C,liquidity_impact:ne,strategy_phase:V,rationale:le,risk_factors:k,next_review_trigger:`Re-evaluate in ~${Ne}s (around ${ye}) or on >${z(Ie/2,2)}% price move / regime change.`,decision_source:"quant-core",decision_source_detail:`regime:${Ge};samples:${s.length}`,quant_metrics:Le}}function Ua(e){return{...e||{},risk_factors:Array.isArray(e==null?void 0:e.risk_factors)?[...e.risk_factors]:[],quant_metrics:e!=null&&e.quant_metrics&&typeof e.quant_metrics=="object"?{...e.quant_metrics}:void 0}}function $a(e){const t=new Map;return{get(r){return t.get(r)||null},set(r,s,o){for(t.set(r,{ts:Date.now(),signature:s,decision:Ua(o)});t.size>e;){const d=t.keys().next().value;if(!d)break;t.delete(d)}}}}function Ba(e,t){var v,g;const r=String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"default").trim().toLowerCase(),s=String((e==null?void 0:e.risk)||"medium").trim().toLowerCase(),o=String((e==null?void 0:e.strategyTemplate)||(e==null?void 0:e.strategyLabel)||"custom").trim().toLowerCase(),d=String((e==null?void 0:e.execMode)||(e==null?void 0:e.mode)||"default").trim().toLowerCase(),a=z(Math.max(0,P(e==null?void 0:e.capitalLimit,0)),6),u=z(Math.max(0,P(e==null?void 0:e.kpiTarget,0)),4),c=Math.max(0,Math.round(P(e==null?void 0:e.horizon,0))),l=z(Math.max(0,P(e==null?void 0:e.autoApproveThreshold,0)),6),_=String((t==null?void 0:t.address)||"").trim().toLowerCase(),A=String(((v=t==null?void 0:t.dag)==null?void 0:v.networkName)||((g=t==null?void 0:t.dag)==null?void 0:g.network)||"").trim().toLowerCase();return[r,s,`tpl:${o}`,`mode:${d}`,`${a}`,`kpi:${u}`,`hz:${c}`,`aa:${l}`,`addr:${_}`,`net:${A}`].join("|")}function Da(e){const t=(e==null?void 0:e.quant_metrics)||{},r=String(t.regime||"NA"),s=String((e==null?void 0:e.volatility_estimate)||"NA"),o=String((e==null?void 0:e.action)||"HOLD"),d=Math.round(ae(P(e==null?void 0:e.confidence_score,0)*10,0,10)),a=Math.round(ae(P(e==null?void 0:e.risk_score,1)*10,0,10)),u=Math.round(ae(P(t.edge_score,0)*10,-20,20)),c=Math.round(ae(P(e==null?void 0:e.kelly_fraction,0)*100,0,100)),l=Math.round(ae(P(t.data_quality_score,0)*10,0,10)),_=Math.round(ae(P(t.sample_count,0),0,999));return[r,s,o,`c${d}`,`r${a}`,`e${u}`,`k${c}`,`d${l}`,`s${_}`].join("|")}const Fr="sha256/canonical-json";function ss(e){if(e==null)return"null";const t=typeof e;return t==="number"?Number.isFinite(e)?JSON.stringify(e):"null":t==="boolean"?e?"true":"false":t==="string"?JSON.stringify(e):Array.isArray(e)?`[${e.map(r=>ss(r)).join(",")}]`:t==="object"?`{${Object.entries(e).filter(([s,o])=>typeof o<"u").sort(([s],[o])=>s.localeCompare(o)).map(([s,o])=>`${JSON.stringify(s)}:${ss(o)}`).join(",")}}`:"null"}async function za(e){var d;const r=new TextEncoder().encode(e),s=(d=globalThis.crypto)==null?void 0:d.subtle;if(!s||typeof s.digest!="function")throw new Error("SHA-256 hashing requires WebCrypto subtle.digest");const o=await s.digest("SHA-256",r);return Array.from(new Uint8Array(o)).map(a=>a.toString(16).padStart(2,"0")).join("")}async function Gr(e){return`${Fr}:${await za(ss(e))}`}function Wa(e,t){return{audit_record_version:String((e==null?void 0:e.audit_record_version)||t.decisionAuditRecordVersion),hash_algo:String((e==null?void 0:e.hash_algo)||t.auditHashAlgo),prompt_version:String((e==null?void 0:e.prompt_version)||t.aiPromptVersion),ai_response_schema_version:String((e==null?void 0:e.ai_response_schema_version)||t.aiResponseSchemaVersion),quant_feature_snapshot_hash:String((e==null?void 0:e.quant_feature_snapshot_hash)||""),decision_hash:String((e==null?void 0:e.decision_hash)||""),overlay_plan_reason:String((e==null?void 0:e.overlay_plan_reason)||""),engine_path:String((e==null?void 0:e.engine_path)||""),created_ts:Math.max(0,Math.round(P(e==null?void 0:e.created_ts,Date.now())))}}function nn(e){return new Promise(t=>setTimeout(t,e))}function on(e){const t=Math.floor(Math.random()*90);return 160*(e+1)+t}function Ha(e){try{return JSON.parse(e)}catch{throw new Error("AI response was not valid JSON")}}function Va(e){const t={"Content-Type":"application/json"};if(e.apiUrl.includes("api.anthropic.com")){if(!e.anthropicApiKey)throw new Error("Anthropic API key missing. Set VITE_ANTHROPIC_API_KEY or configure VITE_AI_API_URL to your secure backend endpoint.");t["x-api-key"]=e.anthropicApiKey,t["anthropic-version"]="2023-06-01"}return t}function Ga(e,t,r){var d,a,u,c,l,_,A;const s={fetched:P(t==null?void 0:t.fetched,0),address:String((t==null?void 0:t.address)||""),walletKas:z(P(t==null?void 0:t.walletKas,0),6),priceUsd:z(P(t==null?void 0:t.priceUsd,0),8),dag:{daaScore:P((d=t==null?void 0:t.dag)==null?void 0:d.daaScore,0),difficulty:P(((a=t==null?void 0:t.dag)==null?void 0:a.difficulty)??((u=t==null?void 0:t.dag)==null?void 0:u.virtualDaaScore),0),networkName:String(((c=t==null?void 0:t.dag)==null?void 0:c.networkName)||((l=t==null?void 0:t.dag)==null?void 0:l.network)||""),pastMedianTime:P(((_=t==null?void 0:t.dag)==null?void 0:_.pastMedianTime)??((A=t==null?void 0:t.dag)==null?void 0:A.virtualPastMedianTime),0)}},o=(r==null?void 0:r.quant_metrics)||{};return`You are a quant-grade AI risk overlay for a Kaspa-native autonomous trading engine. The local quant core (deterministic math) has already computed features, regime, Kelly cap, and risk limits. Your job is to refine the decision WITHOUT violating the local risk envelope.

Respond ONLY with a valid JSON object â€” no markdown, no prose, no code fences.

AGENT PROFILE:
Name: ${e.name}
Strategy: momentum / on-chain flow / risk-controlled execution
Risk Tolerance: ${e.risk} (low=conservative, high=aggressive)
KPI Target: ${e.kpiTarget}% ROI
Capital per Cycle: ${e.capitalLimit} KAS
Auto-Approve Threshold: ${e.autoApproveThreshold} KAS

KASPA SNAPSHOT:
${JSON.stringify(s)}

LOCAL QUANT CORE PRIOR (trust this as the primary signal unless you have a strong reason):
${JSON.stringify({action:r.action,confidence_score:r.confidence_score,risk_score:r.risk_score,kelly_fraction:r.kelly_fraction,capital_allocation_kas:r.capital_allocation_kas,expected_value_pct:r.expected_value_pct,stop_loss_pct:r.stop_loss_pct,take_profit_pct:r.take_profit_pct,monte_carlo_win_pct:r.monte_carlo_win_pct,quant_metrics:o,rationale:r.rationale,risk_factors:r.risk_factors})}

RULES:
1. Do not exceed quant_metrics.kelly_cap in kelly_fraction.
2. Do not exceed local quant capital_allocation_kas by more than 25%.
3. If quant_metrics.regime is RISK_OFF, avoid ACCUMULATE unless confidence_score >= 0.9 and risk_score <= quant_metrics.risk_ceiling.
4. Preserve strict risk discipline; prefer HOLD over low-quality conviction.
5. Keep rationale concise and reference actual metrics from the snapshot/core prior.

OUTPUT (strict JSON, all fields required):
{
  "action": "ACCUMULATE or REDUCE or HOLD or REBALANCE",
  "confidence_score": 0.00,
  "risk_score": 0.00,
  "kelly_fraction": 0.00,
  "capital_allocation_kas": 0.00,
  "capital_allocation_pct": 0,
  "expected_value_pct": 0.00,
  "stop_loss_pct": 0.00,
  "take_profit_pct": 0.00,
  "monte_carlo_win_pct": 0,
  "volatility_estimate": "LOW or MEDIUM or HIGH",
  "liquidity_impact": "MINIMAL or MODERATE or SIGNIFICANT",
  "strategy_phase": "ENTRY or SCALING or HOLDING or EXIT",
  "rationale": "Two concise sentences citing specific metrics and why this refines the quant-core prior.",
  "risk_factors": ["factor1", "factor2", "factor3"],
  "next_review_trigger": "Describe the specific condition that should trigger next decision cycle"
}`}async function Ya(e){var l;const{agent:t,kasData:r,quantCoreDecision:s,config:o,sanitizeDecision:d}=e,a=Ga(t,r,s),u=o.apiUrl.includes("api.anthropic.com")?{model:o.model,max_tokens:900,messages:[{role:"user",content:a}]}:{prompt:a,agent:t,kasData:r,quantCore:s};let c;for(let _=0;_<o.maxAttempts;_+=1){const A=new AbortController,v=setTimeout(()=>A.abort(),o.timeoutMs);try{const g=await fetch(o.apiUrl,{method:"POST",headers:Va(o),body:JSON.stringify(u),signal:A.signal});if(!g.ok){const N=Number(g.status||0);if(o.retryableStatuses.has(N)&&_+1<o.maxAttempts){await nn(on(_));continue}throw new Error(`AI endpoint ${N||"request_failed"}`)}c=await g.json();break}catch(g){const N=(g==null?void 0:g.name)==="AbortError",C=String((g==null?void 0:g.message)||""),M=(g==null?void 0:g.name)==="TypeError"||/failed to fetch|network|load failed/i.test(C);if(!N&&M&&_+1<o.maxAttempts){await nn(on(_));continue}throw g}finally{clearTimeout(v)}}if((l=c==null?void 0:c.error)!=null&&l.message)throw new Error(c.error.message);if(Array.isArray(c==null?void 0:c.content)){const _=c.content.map(v=>v.text||"").join(""),A=Ha(_.replace(/```json|```/g,"").trim());return d({...A,decision_source:"ai"},t)}return c!=null&&c.decision?d({...c.decision,decision_source:"ai"},t):d({...c,decision_source:"ai"},t)}function Xa(e){const{coreDecision:t,cached:r,config:s}=e,o=Date.now(),d=Da(t),a=(t==null?void 0:t.quant_metrics)||{};if(!s.aiTransportReady)return{kind:"skip",reason:"ai_transport_not_configured",signature:d};if(s.aiOverlayMode==="off")return{kind:"skip",reason:"ai_overlay_mode_off",signature:d};if(s.aiOverlayMode==="always")return{kind:"call",reason:"ai_overlay_mode_always",signature:d};if(r&&r.signature===d){const f=Math.max(0,o-r.ts);if(f<=s.minIntervalMs)return{kind:"reuse",reason:`cache_hit_min_interval_${f}ms`,signature:d};if(s.aiOverlayMode==="adaptive"&&f<=s.cacheTtlMs){const p=P(t==null?void 0:t.confidence_score,0),S=P(t==null?void 0:t.risk_score,1),K=P(a.risk_ceiling,.65),j=String(a.regime||"NEUTRAL"),F=Math.abs(P(a.edge_score,0)),B=p<.88&&p>.56,U=Math.abs(S-K)<.06;if(!B&&!U&&!(j==="RISK_OFF"||j==="RANGE_VOL")&&F>.2)return{kind:"reuse",reason:`cache_hit_stable_state_${f}ms`,signature:d}}}const u=P(a.data_quality_score,0),c=P(t==null?void 0:t.confidence_score,0),l=P(t==null?void 0:t.risk_score,1),_=P(a.risk_ceiling,.65),A=String(a.regime||"NEUTRAL"),v=Math.abs(P(a.edge_score,0)),g=P(a.sample_count,0),N=P(t==null?void 0:t.kelly_fraction,0);if(u<.4||g<6)return{kind:"skip",reason:"low_data_quality",signature:d};const C=A==="RISK_OFF"||A==="RANGE_VOL",M=Math.abs(l-_)<.08,x=c<.9&&c>.58,R=v<.12;return u>=.72&&c>=.88&&!C&&!M&&v>=.25&&(N===0||N>=.02)?{kind:"skip",reason:"quant_core_high_conviction",signature:d}:C||M||x||R?{kind:"call",reason:"adaptive_uncertain_or_sensitive",signature:d}:{kind:"skip",reason:"adaptive_cost_control",signature:d}}function qa(e,t,r){const s=[...Array.isArray(e)?e:[],...Array.isArray(t)?t:[]];return r&&s.push(r),Array.from(new Set(s.map(o=>String(o).trim()).filter(Boolean))).slice(0,6)}function Qa(e){var K,j,F;const{agent:t,coreDecision:r,aiDecision:s,aiLatencyMs:o,startedAt:d,sanitizeDecision:a}=e,u=String(((K=r==null?void 0:r.quant_metrics)==null?void 0:K.regime)||"NEUTRAL"),c=P((j=r==null?void 0:r.quant_metrics)==null?void 0:j.risk_ceiling,.65),l=String((s==null?void 0:s.action)||"HOLD");let _=l,A=!1;u==="RISK_OFF"&&l==="ACCUMULATE"&&(_=r.action==="REDUCE"?"REDUCE":"HOLD",A=!0),P(r==null?void 0:r.risk_score,0)>c&&l==="ACCUMULATE"&&(_=r.action==="REDUCE"?"REDUCE":"HOLD",A=!0);const v=z(Math.max(P(r==null?void 0:r.risk_score,1),P(s==null?void 0:s.risk_score,1)),4);let g=z(ae(P(r==null?void 0:r.confidence_score,.5)*.58+P(s==null?void 0:s.confidence_score,.5)*.42-(A?.08:0),0,1),4);_==="HOLD"&&(g=Math.min(g,.86));const N=P((F=r==null?void 0:r.quant_metrics)==null?void 0:F.kelly_cap,P(r==null?void 0:r.kelly_fraction,0)),C=z(ae(Math.min(Math.max(P(r==null?void 0:r.kelly_fraction,0)*.8,P(s==null?void 0:s.kelly_fraction,0)*.6),N||1),0,1),4);let M=0;const x=P(r==null?void 0:r.capital_allocation_kas,0),R=P(s==null?void 0:s.capital_allocation_kas,0);_==="ACCUMULATE"?M=Math.min(R||x,x*1.25||R||0):(_==="REDUCE"||_==="REBALANCE")&&(M=Math.min(Math.max(x,R*.75),Math.max(x*1.5,R)));const b=qa(r==null?void 0:r.risk_factors,s==null?void 0:s.risk_factors,A?"AI signal conflict; core risk override applied":void 0),f=String((s==null?void 0:s.rationale)||"AI overlay unavailable.").trim(),S=`${String((r==null?void 0:r.rationale)||"").trim()} AI overlay: ${f}`.slice(0,900);return a({...s,action:_,confidence_score:g,risk_score:v,kelly_fraction:C,capital_allocation_kas:_==="HOLD"?0:M,expected_value_pct:z(P(r==null?void 0:r.expected_value_pct,0)*.6+P(s==null?void 0:s.expected_value_pct,0)*.4,2),stop_loss_pct:z(Math.max(P(r==null?void 0:r.stop_loss_pct,0),P(s==null?void 0:s.stop_loss_pct,0)),2),take_profit_pct:z(P(r==null?void 0:r.take_profit_pct,0)*.6+P(s==null?void 0:s.take_profit_pct,0)*.4,2),monte_carlo_win_pct:z(P(r==null?void 0:r.monte_carlo_win_pct,0)*.65+P(s==null?void 0:s.monte_carlo_win_pct,0)*.35,2),volatility_estimate:(r==null?void 0:r.volatility_estimate)||(s==null?void 0:s.volatility_estimate),liquidity_impact:(r==null?void 0:r.liquidity_impact)||(s==null?void 0:s.liquidity_impact),strategy_phase:_==="ACCUMULATE"?(r==null?void 0:r.strategy_phase)||(s==null?void 0:s.strategy_phase):(s==null?void 0:s.strategy_phase)||(r==null?void 0:r.strategy_phase),rationale:S,risk_factors:b,next_review_trigger:(r==null?void 0:r.next_review_trigger)||(s==null?void 0:s.next_review_trigger),decision_source:"hybrid-ai",decision_source_detail:`regime:${u};ai_latency_ms:${o};mode:quant_core_guarded`,quant_metrics:{...(r==null?void 0:r.quant_metrics)||{},ai_overlay_applied:!0,ai_action_raw:l,ai_confidence_raw:P(s==null?void 0:s.confidence_score,0)},engine_latency_ms:Date.now()-d},t)}const Ja={},ze=Ja;function Za(e,t=!1){const r=String(e??"").trim();return r?/^(1|true|yes)$/i.test(r):t}function ec(e){const t=String(e||"always").trim().toLowerCase();return t==="off"||t==="always"||t==="adaptive"?t:"adaptive"}const Yr=ze.VITE_AI_API_URL||"https://api.anthropic.com/v1/messages",an=ze.VITE_ANTHROPIC_API_KEY||"",di=Math.max(0,Number(ze.VITE_AI_OVERLAY_MIN_INTERVAL_MS||15e3)),tc=Math.max(di,Number(ze.VITE_AI_OVERLAY_CACHE_TTL_MS||45e3)),ce={aiApiUrl:Yr,aiModel:ze.VITE_AI_MODEL||"claude-sonnet-4-20250514",anthropicApiKey:an,aiTimeoutMs:Math.max(800,Number(ze.VITE_AI_SOFT_TIMEOUT_MS||2200)),aiFallbackEnabled:String(ze.VITE_AI_FALLBACK_ENABLED||"true").toLowerCase()!=="false",aiOverlayMode:ec(ze.VITE_AI_OVERLAY_MODE),aiOverlayMinIntervalMs:di,aiOverlayCacheTtlMs:tc,aiOverlayCacheMaxEntries:512,aiTransportReady:!!Yr&&(!Yr.includes("api.anthropic.com")||!!an),aiMaxAttempts:Math.max(1,Math.min(3,Number(ze.VITE_AI_MAX_ATTEMPTS||2))),aiRetryableStatuses:new Set([408,425,429,500,502,503,504]),decisionAuditRecordVersion:"forgeos.decision.audit.v1",aiPromptVersion:"forgeos.quant.overlay.prompt.v1",aiResponseSchemaVersion:"forgeos.ai.decision.schema.v1",auditSignerUrl:String(ze.VITE_DECISION_AUDIT_SIGNER_URL||"").trim(),auditSignerToken:String(ze.VITE_DECISION_AUDIT_SIGNER_TOKEN||"").trim(),auditSignerTimeoutMs:Math.max(500,Number(ze.VITE_DECISION_AUDIT_SIGNER_TIMEOUT_MS||1500)),auditSignerRequired:Za(ze.VITE_DECISION_AUDIT_SIGNER_REQUIRED,!1)};function vs(e,t){return[String(e||"").trim(),t].filter(Boolean).join(";").slice(0,220)}function cn(e){const{agent:t,coreDecision:r,reason:s,startedAt:o,sanitizeDecision:d}=e;return d({...r,decision_source:"quant-core",decision_source_detail:vs(r==null?void 0:r.decision_source_detail,`fallback_reason:${s}`),engine_latency_ms:Date.now()-o},t)}function dn(e){var a;const{agent:t,cached:r,startedAt:s,reason:o,sanitizeDecision:d}=e;return d({...r.decision||{},decision_source:"hybrid-ai",decision_source_detail:vs((a=r==null?void 0:r.decision)==null?void 0:a.decision_source_detail,o),engine_latency_ms:Date.now()-s},t)}function rc(){const e={"Content-Type":"application/json"};return ce.auditSignerToken&&(e.Authorization=`Bearer ${ce.auditSignerToken}`),e}async function sc(e){var d;const t=e==null?void 0:e.audit_record;if(!t||!ce.auditSignerUrl)return e;const r=Wa(t,{decisionAuditRecordVersion:ce.decisionAuditRecordVersion,auditHashAlgo:Fr,aiPromptVersion:ce.aiPromptVersion,aiResponseSchemaVersion:ce.aiResponseSchemaVersion}),s=new AbortController,o=setTimeout(()=>s.abort(),ce.auditSignerTimeoutMs);try{const a=await fetch(ce.auditSignerUrl,{method:"POST",headers:rc(),body:JSON.stringify({signingPayload:r}),signal:s.signal}),u=await a.json().catch(()=>({}));if(!a.ok)throw new Error(String(((d=u==null?void 0:u.error)==null?void 0:d.message)||`audit_signer_${a.status||"failed"}`));const c=u!=null&&u.signature&&typeof u.signature=="object"?u.signature:u,l={status:"signed",alg:String((c==null?void 0:c.alg)||(c==null?void 0:c.algorithm)||"unknown").slice(0,80),key_id:String((c==null?void 0:c.keyId)||(c==null?void 0:c.key_id)||"").slice(0,160),sig_b64u:String((c==null?void 0:c.signatureB64u)||(c==null?void 0:c.signature)||(c==null?void 0:c.sig_b64u)||"").slice(0,600),payload_hash_sha256_b64u:String((c==null?void 0:c.payloadHashSha256B64u)||(c==null?void 0:c.payload_hash_sha256_b64u)||"").slice(0,160),signer:String((c==null?void 0:c.signer)||"audit-signer").slice(0,80),signed_ts:Math.max(0,Math.round(P((c==null?void 0:c.signedAt)??(c==null?void 0:c.signed_ts),Date.now()))),signing_latency_ms:Math.max(0,Math.round(P((c==null?void 0:c.signingLatencyMs)??(c==null?void 0:c.signing_latency_ms),0))),public_key_pem:typeof(c==null?void 0:c.publicKeyPem)=="string"?c.publicKeyPem.slice(0,4e3):typeof(c==null?void 0:c.public_key_pem)=="string"?c.public_key_pem.slice(0,4e3):void 0};return{...e,audit_record:{...t,crypto_signature:l}}}catch(a){const u=(a==null?void 0:a.name)==="AbortError"?`audit_signer_timeout_${ce.auditSignerTimeoutMs}ms`:String((a==null?void 0:a.message)||"audit_signer_failed");if(ce.auditSignerRequired)throw new Error(u);return{...e,audit_record:{...t,crypto_signature:{status:"error",signer:"audit-signer",error:u.slice(0,240)}}}}finally{clearTimeout(o)}}function nc(e,t,r){var o,d,a;const s=(r==null?void 0:r.quant_metrics)||{};return{agent:{id:String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"agent"),risk:String((e==null?void 0:e.risk)||""),capitalLimit:z(Math.max(0,P(e==null?void 0:e.capitalLimit,0)),6),autoApproveThreshold:z(Math.max(0,P(e==null?void 0:e.autoApproveThreshold,0)),6),strategyTemplate:String((e==null?void 0:e.strategyTemplate)||(e==null?void 0:e.strategyLabel)||"custom")},kaspa:{address:String((t==null?void 0:t.address)||""),walletKas:z(Math.max(0,P(t==null?void 0:t.walletKas,0)),6),priceUsd:z(Math.max(0,P(t==null?void 0:t.priceUsd,0)),8),daaScore:Math.max(0,Math.round(P((o=t==null?void 0:t.dag)==null?void 0:o.daaScore,0))),network:String(((d=t==null?void 0:t.dag)==null?void 0:d.networkName)||((a=t==null?void 0:t.dag)==null?void 0:a.network)||"")},quantCore:{action:String((r==null?void 0:r.action)||"HOLD"),confidence_score:z(P(r==null?void 0:r.confidence_score,0),4),risk_score:z(P(r==null?void 0:r.risk_score,0),4),kelly_fraction:z(P(r==null?void 0:r.kelly_fraction,0),6),capital_allocation_kas:z(P(r==null?void 0:r.capital_allocation_kas,0),6),expected_value_pct:z(P(r==null?void 0:r.expected_value_pct,0),4),quant_metrics:{regime:String((s==null?void 0:s.regime)||""),sample_count:Math.max(0,Math.round(P(s==null?void 0:s.sample_count,0))),edge_score:z(P(s==null?void 0:s.edge_score,0),6),data_quality_score:z(P(s==null?void 0:s.data_quality_score,0),6),ewma_volatility:z(P(s==null?void 0:s.ewma_volatility,0),6),risk_ceiling:z(P(s==null?void 0:s.risk_ceiling,0),6),kelly_cap:z(P(s==null?void 0:s.kelly_cap,0),6)}}}}function ic(e,t){var r,s,o,d,a;return{regime:String(((r=t==null?void 0:t.quant_metrics)==null?void 0:r.regime)||""),sample_count:Math.max(0,Math.round(P((s=t==null?void 0:t.quant_metrics)==null?void 0:s.sample_count,0))),edge_score:z(P((o=t==null?void 0:t.quant_metrics)==null?void 0:o.edge_score,0),6),data_quality_score:z(P((d=t==null?void 0:t.quant_metrics)==null?void 0:d.data_quality_score,0),6),price_usd:z(P(e==null?void 0:e.priceUsd,0),8),wallet_kas:z(P(e==null?void 0:e.walletKas,0),6),daa_score:Math.max(0,Math.round(P((a=e==null?void 0:e.dag)==null?void 0:a.daaScore,0)))}}async function oc(e){const t=e.decision||{},r=nc(e.agent,e.kasData,e.quantCoreDecision),s=await Gr(r),o={...t,audit_record:void 0},d=await Gr(o),a=await Gr({decision_hash:d,quant_feature_snapshot_hash:s,prompt_version:ce.aiPromptVersion,ai_response_schema_version:ce.aiResponseSchemaVersion,overlay_plan_reason:e.overlayPlanReason,engine_path:e.enginePath});return e.sanitizeDecision({...t,audit_record:{audit_record_version:ce.decisionAuditRecordVersion,hash_algo:Fr,prompt_version:ce.aiPromptVersion,ai_response_schema_version:ce.aiResponseSchemaVersion,quant_feature_snapshot_hash:s,decision_hash:d,audit_sig:a,overlay_plan_reason:e.overlayPlanReason,engine_path:e.enginePath,prompt_used:e.enginePath==="hybrid-ai"||e.enginePath==="ai",ai_transport_ready:ce.aiTransportReady,created_ts:Date.now(),quant_feature_snapshot_excerpt:ic(e.kasData,e.quantCoreDecision)}},e.agent)}async function qt(e){const t=await oc(e);return sc(t)}const li=$a(ce.aiOverlayCacheMaxEntries);function ac(e){if(!e||typeof e!="object"||Array.isArray(e))return;const t={};for(const[r,s]of Object.entries(e))if(r){if(typeof s=="number"){if(!Number.isFinite(s))continue;t[r]=Math.abs(s)>=1e3?Math.round(s):z(s,6);continue}if(typeof s=="string"){t[r]=s.slice(0,80);continue}typeof s=="boolean"&&(t[r]=s)}return Object.keys(t).length>0?t:void 0}function Xe(e,t){const r=String((e==null?void 0:e.action)||"HOLD").toUpperCase(),s=["ACCUMULATE","REDUCE","HOLD","REBALANCE"].includes(r)?r:"HOLD",o=Math.max(0,P(t==null?void 0:t.capitalLimit,0)),d=ae(P(e==null?void 0:e.capital_allocation_kas,0),0,o),a=o>0?ae(d/o*100,0,100):ae(P(e==null?void 0:e.capital_allocation_pct,0),0,100),u=ae(P(e==null?void 0:e.confidence_score,0),0,1),c=ae(P(e==null?void 0:e.risk_score,1),0,1),l=String((e==null?void 0:e.volatility_estimate)||"MEDIUM").toUpperCase(),_=["LOW","MEDIUM","HIGH"].includes(l)?l:"MEDIUM",A=String((e==null?void 0:e.liquidity_impact)||"MODERATE").toUpperCase(),v=["MINIMAL","MODERATE","SIGNIFICANT"].includes(A)?A:"MODERATE",g=String((e==null?void 0:e.strategy_phase)||"HOLDING").toUpperCase(),N=["ENTRY","SCALING","HOLDING","EXIT"].includes(g)?g:"HOLDING",C=Array.isArray(e==null?void 0:e.risk_factors)?e.risk_factors.map(j=>String(j)).filter(Boolean).slice(0,6):[],M=String((e==null?void 0:e.decision_source)||"ai").toLowerCase(),x=["ai","fallback","quant-core","hybrid-ai"].includes(M)?M:"ai",R=String((e==null?void 0:e.decision_source_detail)||"").slice(0,220),b=ac(e==null?void 0:e.quant_metrics),f=Math.max(0,Math.round(P(e==null?void 0:e.engine_latency_ms,0))),p=e!=null&&e.audit_record&&typeof e.audit_record=="object"?e.audit_record:null,S=p!=null&&p.crypto_signature&&typeof p.crypto_signature=="object"?p.crypto_signature:null,K=p?{audit_record_version:String(p.audit_record_version||ce.decisionAuditRecordVersion).slice(0,80),hash_algo:String(p.hash_algo||Fr).slice(0,64),prompt_version:String(p.prompt_version||ce.aiPromptVersion).slice(0,80),ai_response_schema_version:String(p.ai_response_schema_version||ce.aiResponseSchemaVersion).slice(0,80),quant_feature_snapshot_hash:String(p.quant_feature_snapshot_hash||"").slice(0,120),decision_hash:String(p.decision_hash||"").slice(0,120),audit_sig:String(p.audit_sig||"").slice(0,140),overlay_plan_reason:String(p.overlay_plan_reason||"").slice(0,160),engine_path:String(p.engine_path||"").slice(0,80),prompt_used:!!p.prompt_used,ai_transport_ready:!!p.ai_transport_ready,created_ts:Math.max(0,Math.round(P(p.created_ts,0))),crypto_signature:S?{status:String(S.status||"").slice(0,32)||void 0,alg:String(S.alg||"").slice(0,80)||void 0,key_id:String(S.key_id||S.keyId||"").slice(0,160)||void 0,sig_b64u:String(S.sig_b64u||S.signatureB64u||"").slice(0,600)||void 0,payload_hash_sha256_b64u:String(S.payload_hash_sha256_b64u||S.payloadHashSha256B64u||"").slice(0,160)||void 0,signer:String(S.signer||"").slice(0,80)||void 0,signed_ts:Math.max(0,Math.round(P(S.signed_ts??S.signedAt,0))),signing_latency_ms:Math.max(0,Math.round(P(S.signing_latency_ms??S.signingLatencyMs,0))),public_key_pem:typeof S.public_key_pem=="string"?S.public_key_pem.slice(0,4e3):typeof S.publicKeyPem=="string"?S.publicKeyPem.slice(0,4e3):void 0,error:String(S.error||"").slice(0,240)||void 0}:void 0,quant_feature_snapshot_excerpt:p.quant_feature_snapshot_excerpt&&typeof p.quant_feature_snapshot_excerpt=="object"?{regime:String(p.quant_feature_snapshot_excerpt.regime||"").slice(0,40),sample_count:Math.max(0,Math.round(P(p.quant_feature_snapshot_excerpt.sample_count,0))),edge_score:z(P(p.quant_feature_snapshot_excerpt.edge_score,0),6),data_quality_score:z(P(p.quant_feature_snapshot_excerpt.data_quality_score,0),6),price_usd:z(P(p.quant_feature_snapshot_excerpt.price_usd,0),8),wallet_kas:z(P(p.quant_feature_snapshot_excerpt.wallet_kas,0),6),daa_score:Math.max(0,Math.round(P(p.quant_feature_snapshot_excerpt.daa_score,0)))}:void 0}:void 0;return{action:s,confidence_score:z(u,4),risk_score:z(c,4),kelly_fraction:ae(P(e==null?void 0:e.kelly_fraction,0),0,1),capital_allocation_kas:Number(d.toFixed(6)),capital_allocation_pct:Number(a.toFixed(2)),expected_value_pct:Number(P(e==null?void 0:e.expected_value_pct,0).toFixed(2)),stop_loss_pct:Number(Math.max(0,P(e==null?void 0:e.stop_loss_pct,0)).toFixed(2)),take_profit_pct:Number(Math.max(0,P(e==null?void 0:e.take_profit_pct,0)).toFixed(2)),monte_carlo_win_pct:Number(ae(P(e==null?void 0:e.monte_carlo_win_pct,0),0,100).toFixed(2)),volatility_estimate:_,liquidity_impact:v,strategy_phase:N,rationale:String((e==null?void 0:e.rationale)||"No rationale returned by engine."),risk_factors:C,next_review_trigger:String((e==null?void 0:e.next_review_trigger)||"On next cycle or major DAA/price movement."),decision_source:x,decision_source_detail:R,quant_metrics:b,engine_latency_ms:f,...K?{audit_record:K}:{}}}function cc(e){return li.get(e)}function dc(e,t,r){li.set(e,t,r)}async function ln(e,t,r){const s=Date.now(),o=Xe({...Fa(e,t,r),engine_latency_ms:Date.now()-s},e),d=Ba(e,t),a=cc(d),u=Xa({coreDecision:o,cached:a,config:{aiTransportReady:ce.aiTransportReady,aiOverlayMode:ce.aiOverlayMode,minIntervalMs:ce.aiOverlayMinIntervalMs,cacheTtlMs:ce.aiOverlayCacheTtlMs}});if(u.kind==="skip"&&u.reason==="ai_transport_not_configured"&&!ce.aiFallbackEnabled&&ce.aiOverlayMode!=="off")throw new Error("Real AI overlay is required but AI transport is not configured (set VITE_AI_API_URL and credentials/proxy).");if(u.kind==="skip")return qt({decision:cn({agent:e,coreDecision:o,reason:u.reason,startedAt:s,sanitizeDecision:Xe}),agent:e,kasData:t,quantCoreDecision:o,overlayPlanReason:u.reason,enginePath:"quant-core",sanitizeDecision:Xe});if(u.kind==="reuse"&&a)return qt({decision:dn({agent:e,cached:a,startedAt:s,reason:u.reason,sanitizeDecision:Xe}),agent:e,kasData:t,quantCoreDecision:o,overlayPlanReason:u.reason,enginePath:"hybrid-ai",sanitizeDecision:Xe});const c=Date.now();try{const l=await Ya({agent:e,kasData:t,quantCoreDecision:o,config:{apiUrl:ce.aiApiUrl,model:ce.aiModel,anthropicApiKey:ce.anthropicApiKey,timeoutMs:ce.aiTimeoutMs,maxAttempts:ce.aiMaxAttempts,retryableStatuses:ce.aiRetryableStatuses},sanitizeDecision:Xe}),_=Date.now()-c,A=Qa({agent:e,coreDecision:o,aiDecision:l,aiLatencyMs:_,startedAt:s,sanitizeDecision:Xe});return A.decision_source_detail=vs(A==null?void 0:A.decision_source_detail,`overlay_plan:${u.reason}`),dc(d,u.signature,A),qt({decision:A,agent:e,kasData:t,quantCoreDecision:o,overlayPlanReason:u.reason,enginePath:"hybrid-ai",sanitizeDecision:Xe})}catch(l){if(a){const _=Math.max(0,Date.now()-a.ts);if(_<=ce.aiOverlayCacheTtlMs)return qt({decision:dn({agent:e,cached:a,startedAt:s,reason:`ai_error_cache_reuse_${_}ms`,sanitizeDecision:Xe}),agent:e,kasData:t,quantCoreDecision:o,overlayPlanReason:`ai_error_cache_reuse_${_}ms`,enginePath:"hybrid-ai",sanitizeDecision:Xe})}if(ce.aiFallbackEnabled){const _=(l==null?void 0:l.name)==="AbortError"?`ai_timeout_${ce.aiTimeoutMs}ms`:(l==null?void 0:l.message)||"request failure";return qt({decision:cn({agent:e,coreDecision:o,reason:_,startedAt:s,sanitizeDecision:Xe}),agent:e,kasData:t,quantCoreDecision:o,overlayPlanReason:_,enginePath:"quant-core",sanitizeDecision:Xe})}throw(l==null?void 0:l.name)==="AbortError"?new Error(`AI request timeout (${ce.aiTimeoutMs}ms)`):l}}const ui="true".toLowerCase()!=="false",un=Math.max(1e3,8e3),lc=[/^Quant worker timeout/i,/^Quant worker crashed/i,/^Worker postMessage/i];let ut=null,Tr=!1,fn=!1,uc=1;const It=new Map;function Mr(){if(ut)try{ut.terminate()}catch{}ut=null,Tr=!1}function fi(){if(!ui||typeof window>"u"||typeof Worker>"u")return null;if(ut&&Tr)return ut;if(fn&&!Tr)return null;fn=!0;try{return ut=new Worker(new URL(""+new URL("quantEngine.worker-SO4Bc77v.js",import.meta.url).href,import.meta.url),{type:"module"}),ut.onmessage=e=>{const t=e.data,r=It.get(Number(t==null?void 0:t.id));r&&(It.delete(Number(t.id)),clearTimeout(r.timeoutId),t!=null&&t.ok?r.resolve(t.decision):r.reject(new Error(String((t==null?void 0:t.error)||"Quant worker error"))))},ut.onerror=()=>{for(const[e,t]of It.entries())clearTimeout(t.timeoutId),t.reject(new Error("Quant worker crashed")),It.delete(e);Mr()},Tr=!0,ut}catch{return Mr(),null}}async function fc(e,t,r){const s=fi();if(!s)return ln(e,t,r);const o=uc++;return new Promise((d,a)=>{const u=setTimeout(()=>{It.delete(o),Mr(),a(new Error(`Quant worker timeout (${un}ms)`))},un);It.set(o,{resolve:d,reject:a,timeoutId:u});try{s.postMessage({id:o,agent:e,kasData:t,context:r})}catch(c){clearTimeout(u),It.delete(o),Mr(),a(new Error(`Worker postMessage failed: ${String((c==null?void 0:c.message)||c||"unknown_error")}`))}}).catch(d=>{const a=String((d==null?void 0:d.message)||"");if(!lc.some(c=>c.test(a)))throw d;return ln(e,t,r).catch(c=>{throw c||d})})}function mc(){return ui&&fi()?"worker":"main-thread"}const _c={SYSTEM:i.dim,DATA:"#6BA3FF",AI:i.accent,VALID:i.warn,EXEC:i.ok,ERROR:i.danger,SIGN:i.purple,TREASURY:i.warn},ns=e=>{const t=Date.now();return[{ts:t-72e5,type:"SYSTEM",msg:`Agent ${e} provisioned. Vault address mapped to session.`,fee:null},{ts:t-714e4,type:"SIGN",msg:"Deploy transaction signed via Kasware. Vault funded.",fee:null},{ts:t-71e5,type:"TREASURY",msg:"Protocol fee: 0.20 KAS â†’ Treasury 0.06 KAS / Pool 0.14 KAS",fee:.2},{ts:t-36e5,type:"DATA",msg:"Kaspa DAG snapshot ingested. DAA score, hashrate, UTXO set analysed.",fee:null},{ts:t-354e4,type:"AI",msg:"Quant engine invoked. Kelly criterion + Monte Carlo computed.",fee:.12},{ts:t-35e5,type:"VALID",msg:"Risk gate PASSED Â· Conf 0.82 Â· Kelly 0.08 Â· Phase: ENTRY",fee:null},{ts:t-349e4,type:"EXEC",msg:"ACCUMULATE â€” 400 KAS Â· Auto-approved (below threshold)",fee:.08},{ts:t-18e5,type:"AI",msg:"Quant engine invoked.",fee:.12},{ts:t-178e4,type:"VALID",msg:"Conf 0.71 < 0.75 threshold â€” HOLD enforced.",fee:null},{ts:t-177e4,type:"EXEC",msg:"HOLD â€” confidence gate. Position maintained.",fee:.08}]},pc="forgeos.usage.v2",hc="forgeos.usage.v1";function gc(e){return String(e||"global").trim().toLowerCase().replace(/[^a-z0-9:_-]/g,"_").slice(0,128)||"global"}function mi(e){return`${pc}:${gc(e)}`}function Sc(e=new Date){return e.toISOString().slice(0,10)}function yc(e){if(typeof window>"u")return null;try{const t=window.localStorage.getItem(mi(e));if(!t)return null;const r=JSON.parse(t);return!r||typeof r.day!="string"||!Number.isFinite(r.used)?null:{day:r.day,used:Math.max(0,Math.floor(r.used))}}catch{return null}}function is(e,t){if(!(typeof window>"u"))try{window.localStorage.setItem(mi(t),JSON.stringify(e))}catch{}}function Ec(){if(typeof window>"u")return null;try{const e=window.localStorage.getItem(hc);if(!e)return null;const t=JSON.parse(e);return!t||typeof t.day!="string"||!Number.isFinite(t.used)?null:{day:t.day,used:Math.max(0,Math.floor(t.used))}}catch{return null}}function _i(e,t){const r=Sc(),s=yc(t)||(t?null:Ec());if(!s||s.day!==r){const d={day:r,used:0};return is(d,t),d}const o={day:r,used:Math.min(s.used,Math.max(0,Math.floor(e)))};return(o.day!==s.day||o.used!==s.used)&&is(o,t),o}function os(e,t){const r=Math.max(1,Math.floor(t)),s=Math.min(e.used,r),o=Math.max(0,r-s);return{day:e.day,used:s,limit:r,remaining:o,locked:o<=0}}function xc(e,t){return os(_i(e,t),e)}function bc(e,t){const r=_i(e,t),s=Math.max(1,Math.floor(e));if(r.used>=s)return os(r,s);const o={...r,used:r.used+1};return is(o,t),os(o,s)}function mn(e,t){return xc(e,t)}const se=(e,t=0)=>{const r=Number(e);return Number.isFinite(r)?r:t},Xr=(e,t,r)=>Math.min(r,Math.max(t,e));function Ac(e){var t,r;for(let s=1;s<e.length;s+=1)if(se((t=e[s-1])==null?void 0:t.ts,0)>se((r=e[s])==null?void 0:r.ts,0))return!1;return!0}function pi(e,t){var c,l,_;if(!Array.isArray(e)||e.length===0||!Number.isFinite(t))return-1;let r=0,s=e.length-1;for(;r<=s;){const A=r+s>>1,v=se((c=e[A])==null?void 0:c.ts,0);if(v===t)return A;v<t?r=A+1:s=A-1}const o=Math.max(0,s),d=Math.min(e.length-1,r),a=Math.abs(se((l=e[o])==null?void 0:l.ts,0)-t),u=Math.abs(se((_=e[d])==null?void 0:_.ts,0)-t);return a<=u?o:d}function Tc(e,t,r=3){var u,c;const s=pi(e,t);if(s<0)return null;const o=se((u=e[s])==null?void 0:u.priceUsd,0);if(!(o>0))return null;const d=Math.min(e.length-1,s+Math.max(1,r)),a=se((c=e[d])==null?void 0:c.priceUsd,0);return a>0?(a-o)/o*100:null}function _n(e,t){var o;const r=pi(e,t);if(r<0)return null;const s=se((o=e[r])==null?void 0:o.priceUsd,0);return s>0?s:null}function pn(e){const t=String(e||"MODERATE").toUpperCase();return t==="MINIMAL"?6:t==="SIGNIFICANT"?45:18}function Nc(e,t){const r=Math.max(1,Math.round(se(e==null?void 0:e.base,t))),s={},o={};for(const[a,u]of Object.entries((e==null?void 0:e.byAction)||{})){const c=String(a||"").toUpperCase();c&&(s[c]=Math.max(1,Math.round(se(u,r))))}for(const[a,u]of Object.entries((e==null?void 0:e.byRisk)||{})){const c=String(a||"").toUpperCase();c&&(o[c]=Math.max(1,Math.round(se(u,r))))}const d=Array.isArray(e==null?void 0:e.amountTiersKas)?e.amountTiersKas.map(a=>({minAmountKas:Math.max(0,se(a==null?void 0:a.minAmountKas,0)),minConfirmations:Math.max(1,Math.round(se(a==null?void 0:a.minConfirmations,r)))})).filter(a=>a.minAmountKas>=0&&a.minConfirmations>=1).sort((a,u)=>a.minAmountKas-u.minAmountKas):[];return{base:r,byAction:s,byRisk:o,amountTiersKas:d}}function vc(e){var s,o,d,a;const t=String(((s=e==null?void 0:e.dec)==null?void 0:s.risk)||((d=(o=e==null?void 0:e.dec)==null?void 0:o.quant_metrics)==null?void 0:d.risk_profile)||"").toUpperCase();if(t==="LOW"||t==="MEDIUM"||t==="HIGH")return t;const r=se((a=e==null?void 0:e.dec)==null?void 0:a.risk_score,NaN);return Number.isFinite(r)?r>=.7?"HIGH":r>=.4?"MEDIUM":"LOW":""}function Ic(e,t){var a,u,c;let r=Math.max(1,Number((t==null?void 0:t.base)||1));const s=String((e==null?void 0:e.type)||((a=e==null?void 0:e.dec)==null?void 0:a.action)||"").toUpperCase();s&&((u=t==null?void 0:t.byAction)==null?void 0:u[s])!=null&&(r=Math.max(r,Math.max(1,Math.round(se(t.byAction[s],r)))));const o=vc(e);o&&((c=t==null?void 0:t.byRisk)==null?void 0:c[o])!=null&&(r=Math.max(r,Math.max(1,Math.round(se(t.byRisk[o],r)))));const d=Math.max(0,se(e==null?void 0:e.amount_kas,0));for(const l of(t==null?void 0:t.amountTiersKas)||[])d>=Math.max(0,se(l==null?void 0:l.minAmountKas,0))&&(r=Math.max(r,Math.max(1,Math.round(se(l==null?void 0:l.minConfirmations,r)))));return r}function Cc(e,t){const r=String(e||"").toUpperCase();if(!r||!Number.isFinite(t))return null;const s=Math.abs(t);return r.includes("TREND_UP")?t>0:r.includes("TREND_DOWN")?t<0:r.includes("RISK_OFF")?t<=0:r.includes("RANGE_LOW")||r==="RANGE"?s<.8:r.includes("RANGE_VOL")?s>=.8:null}function kc(e){var Le,ve,oe;const t=Array.isArray(e.decisions)?e.decisions:[],s=(Array.isArray(e.queue)?e.queue:[]).filter(w=>(w==null?void 0:w.metaKind)!=="treasury_fee"),o=Array.isArray(e.log)?e.log:[],d=Array.isArray(e.marketHistory)?Ac(e.marketHistory)?e.marketHistory:[...e.marketHistory].sort((w,J)=>se(w==null?void 0:w.ts,0)-se(J==null?void 0:J.ts,0)):[],a=Math.max(1,Math.round(se(e==null?void 0:e.realizedMinConfirmations,1))),u=Nc(e==null?void 0:e.confirmationDepthPolicy,a),c=t.filter(w=>{var Ye;return String(((Ye=w==null?void 0:w.dec)==null?void 0:Ye.action)||"HOLD").toUpperCase()!=="HOLD"}),l=s.filter(w=>(w==null?void 0:w.status)==="signed"),_=s.filter(w=>(w==null?void 0:w.status)==="pending"),A=s.filter(w=>(w==null?void 0:w.status)==="rejected"),v=o.reduce((w,J)=>w+Math.max(0,se(J==null?void 0:J.fee,0)),0);let g=0,N=0,C=0,M=0,x=0,R=0,b=0,f=0,p=0,S=0,K=0,j=0,F=0;for(const w of t){const J=(w==null?void 0:w.dec)||{},Ye=String((J==null?void 0:J.action)||"HOLD").toUpperCase(),rt=Math.max(0,se(J==null?void 0:J.capital_allocation_kas,0)),Re=se(J==null?void 0:J.expected_value_pct,0),mt=Xr(se(J==null?void 0:J.confidence_score,0),0,1),Ht=String((J==null?void 0:J.liquidity_impact)||"MODERATE"),_t=String((J==null?void 0:J.decision_source)||(w==null?void 0:w.source)||"ai");C+=mt,M+=Re,Ye!=="HOLD"&&(g+=rt*(Re/100),N+=rt*(pn(Ht)/1e4));const Ke=Tc(d,se(w==null?void 0:w.ts,0),3);if(Ke!=null){R+=1;let Be=0;Ye==="ACCUMULATE"?Be=Ke:Ye==="REDUCE"?Be=-Ke:Be=-Math.abs(Ke)*.1,x+=Be,Be>0&&(b+=1);const je=(J==null?void 0:J.quant_metrics)||{},Vt=Xr(se(je==null?void 0:je.win_probability_model,se(J==null?void 0:J.monte_carlo_win_pct,50)/100),0,1),ct=Be>0?1:0,Gt=1-Math.abs(Vt-ct);f+=Xr(Gt-(_t==="quant-core"||_t==="fallback"?.03:0),0,1),p+=1,S+=(mt-ct)**2,K+=1;const st=Cc(je==null?void 0:je.regime,Ke);typeof st=="boolean"&&(F+=1,st&&(j+=1))}}let B=0,U=0,I=0,h=0,G=0,$=0,W=0,Y=0,te=0,ie=0,me=0,Ee=0,Se=0,Pe=0,Ie=0;for(const w of l){const J=String((w==null?void 0:w.receipt_lifecycle)||""),Ye=String((w==null?void 0:w.receipt_imported_from)||"").toLowerCase(),rt=String((w==null?void 0:w.receipt_source_path)||"").toLowerCase(),Re=String((w==null?void 0:w.confirm_ts_source)||"").toLowerCase(),mt=Ye==="callback_consumer"||rt.includes("callback-consumer"),Ht=Ye==="kaspa_api"||Re==="chain",_t=Math.max(0,se(w==null?void 0:w.confirmations,0)),Ke=Ic(w,u);(ie===0||Ke<ie)&&(ie=Ke),Ke>me&&(me=Ke);const Be=_t>=Ke;if(J!=="confirmed"){te+=1;continue}mt?Y+=1:Ht?W+=1:te+=1,B+=1;const je=Math.max(0,se(w==null?void 0:w.amount_kas,0)),Vt=String(((Le=w==null?void 0:w.dec)==null?void 0:Le.liquidity_impact)||"MODERATE");I+=je*(pn(Vt)/1e4);const ct=se(w==null?void 0:w.receipt_fee_kas,NaN);Be&&Number.isFinite(ct)&&ct>=0&&(G+=ct,$+=1);const Gt=se(w==null?void 0:w.broadcast_ts,0),bt=se(w==null?void 0:w.confirm_ts,0),st=String((w==null?void 0:w.confirm_ts_source)||"")==="chain"&&bt>0,Mt=se(w==null?void 0:w.broadcast_price_usd,0)>0?se(w==null?void 0:w.broadcast_price_usd,0):_n(d,Gt)??0,dt=st?_n(d,bt)??se(w==null?void 0:w.confirm_price_usd,0):se(w==null?void 0:w.confirm_price_usd,0),Rt=se(w==null?void 0:w.receipt_slippage_kas,NaN);if(Number.isFinite(Rt)&&Rt>=0&&Be){U+=1,h+=Rt;continue}if(Be&&st&&Mt>0&&dt>0&&(U+=1),Be&&Mt>0&&dt>0&&je>0){const wt=String((w==null?void 0:w.type)||((ve=w==null?void 0:w.dec)==null?void 0:ve.action)||"").toUpperCase()==="REDUCE"?-1:1,or=(dt-Mt)/Mt;h+=je*Math.abs(or)*Math.abs(wt);const ar=or*wt*100,Fe=se((oe=w==null?void 0:w.dec)==null?void 0:oe.expected_value_pct,0);Pe+=je*(ar/100),Ie+=je*(Fe/100),Ee+=Math.abs(ar-Fe),Se+=1}}const We=Math.max(0,N-I+h),xe=l.length,be=c.length,tt=_.length,He=A.length,Ve=be>0?xe/be*100:0,Je=xe>0?B/xe*100:0,Ge=[..._,...A].reduce((w,J)=>w+Math.max(0,se(J==null?void 0:J.amount_kas,0)),0),at=t.length>0?C/t.length:0,Z=t.length>0?M/t.length:0,we=R>0?x/R:0,Me=p>0?f/p:0,m=K>0?S/K:0,E=F>0?j/F*100:0,q=Se>0?Ee/Se:0,T=Pe-Ie,X=g-v-N,ne=xe>0&&B===xe,V=xe>0?U/xe*100:0,_e=B>0?$/B*100:0,k=ne&&B>0&&U===B,le=B===0?"estimated":k?"realized":"hybrid",Ne=v,ye=g-Ne-We;return{grossEdgeKas:Number(g.toFixed(6)),netPnlKas:Number(ye.toFixed(6)),netPnlMode:le,feesKas:Number(Ne.toFixed(6)),realizedChainFeeKas:Number(G.toFixed(6)),slippageKas:Number(We.toFixed(6)),estimatedSlippageKas:Number(N.toFixed(6)),estimatedNetPnlKas:Number(X.toFixed(6)),realizedExecutionDriftKas:Number(h.toFixed(6)),actionableSignals:be,executedSignals:xe,confirmedSignals:B,pendingSignals:tt,rejectedSignals:He,fillRatePct:Number(Ve.toFixed(2)),receiptCoveragePct:Number(Je.toFixed(2)),realizedReceiptCoveragePct:Number(V.toFixed(2)),chainFeeCoveragePct:Number(_e.toFixed(2)),realizedMinConfirmations:a,confirmationFloorObservedMin:Math.max(0,Math.round(ie||u.base)),confirmationFloorObservedMax:Math.max(0,Math.round(me||u.base)),provenanceChainSignals:W,provenanceBackendSignals:Y,provenanceEstimatedSignals:te,missedFillKas:Number(Ge.toFixed(6)),avgSignalConfidence:Number(at.toFixed(4)),avgExpectedValuePct:Number(Z.toFixed(4)),signalQualityScore:Number(Me.toFixed(4)),confidenceBrierScore:Number(m.toFixed(6)),evCalibrationErrorPct:Number(q.toFixed(6)),realizedVsExpectedEdgeKas:Number(T.toFixed(6)),regimeHitRatePct:Number(E.toFixed(2)),regimeHitSamples:F,timingAlphaPct:Number(we.toFixed(4)),timingWins:b,timingSamples:R,rows:[{label:"Gross Edge",value:Number(g.toFixed(6)),hint:"Expected-value weighted edge from actionable signals"},{label:"Fees",value:Number((-Ne).toFixed(6)),hint:"Protocol + execution fees from runtime logs"},{label:"Chain Fee (receipts)",value:Number((-G).toFixed(6)),hint:"On-chain network fee parsed from confirmed receipt payloads (coverage may be partial)"},{label:B>0?"Slippage (hybrid)":"Slippage (est)",value:Number((-We).toFixed(6)),hint:B>0?"Confirmed receipts use backend slippage when available, otherwise realized execution drift; remaining fills use estimated liquidity impact":"Liquidity-impact estimate from decision liquidity bucket"},{label:(B>0,"Realized Drift (receipts)"),value:Number((-h).toFixed(6)),hint:le==="realized"?"Backend slippage or observed price drift using chain confirmation timestamps and market snapshots":"Backend slippage or observed price drift between broadcast and confirmation timestamps for confirmed executions"},{label:le==="realized"?"Net PnL (realized)":B>0?"Net PnL (hybrid)":"Net PnL (est)",value:Number((B>0?ye:X).toFixed(6)),hint:le==="realized"?`All executed signals confirmed with receipt-aware drift at >= ${a} confirmation${a===1?"":"s"}`:B>0?"Gross edge - fees - hybrid slippage (realized where receipts are confirmed)":"Gross edge - fees - estimated slippage"},{label:"Timing Alpha %",value:Number(we.toFixed(6)),hint:"Directionally signed follow-through after signals"},{label:"Missed Fill KAS",value:Number((-Ge).toFixed(6)),hint:"Pending + rejected queued execution notional"}]}}var Fn;const xt=((Fn=import.meta)==null?void 0:Fn.env)||{},yt=String(xt.VITE_EXECUTION_RECEIPT_API_URL||"").trim().replace(/\/+$/,""),Et=String(xt.VITE_EXECUTION_RECEIPT_API_TOKEN||"").trim(),Is=Math.max(500,Number(xt.VITE_EXECUTION_RECEIPT_API_TIMEOUT_MS||4e3)),hi=String(xt.VITE_EXECUTION_RECEIPT_IMPORT_ENABLED||"true").toLowerCase()!=="false",Mc=String(xt.VITE_EXECUTION_RECEIPT_SSE_ENABLED||"true").toLowerCase()!=="false",gi=String(xt.VITE_EXECUTION_RECEIPT_SSE_URL||"").trim().replace(/\/+$/,""),Rc=String(xt.VITE_EXECUTION_RECEIPT_SSE_REPLAY||"true").toLowerCase()!=="false",hn=Math.max(0,Number(xt.VITE_EXECUTION_RECEIPT_SSE_REPLAY_LIMIT||100));function Cs(e){const t=String(e||"").trim().toLowerCase();if(!/^[a-f0-9]{64}$/.test(t))throw new Error("invalid_txid");return t}function as(e){const t=e!=null&&e.receipt&&typeof e.receipt=="object"?e.receipt:null;if(!t)return null;const r=Cs(String(t.txid||""));return{...t,txid:r}}function ks(){return hi&&!!yt}function Si(){const e=gi||(yt?`${yt}/v1/execution-receipts/stream`:"");return hi&&Mc&&!!e&&typeof EventSource<"u"}function Ms(){return ks()}function wc(e){return!e||typeof e!="object"?null:e.receipt&&typeof e.receipt=="object"?as(e):e.txid?as({receipt:e}):null}function Lc(){const e=gi||(yt?`${yt}/v1/execution-receipts/stream`:"");if(!e)return"";const t=new URL(e,typeof window<"u"?window.location.origin:"http://localhost");return Rc&&t.searchParams.set("replay","1"),hn>0&&t.searchParams.set("limit",String(hn)),Et&&t.searchParams.set("token",Et),t.toString()}function Pc(e){if(!Si())return null;const t=Lc();if(!t)return null;const r=e==null?void 0:e.onReceipt,s=e==null?void 0:e.onStatus,o=new EventSource(t);s==null||s("connecting");const d=()=>s==null?void 0:s("open"),a=()=>s==null?void 0:s("error"),u=c=>{try{const l=c!=null&&c.data?JSON.parse(String(c.data)):null,_=wc(l);_&&typeof r=="function"&&r(_)}catch{}};return o.addEventListener("open",d),o.addEventListener("error",a),o.addEventListener("receipt",u),{close(){try{o.removeEventListener("open",d)}catch{}try{o.removeEventListener("error",a)}catch{}try{o.removeEventListener("receipt",u)}catch{}try{o.close()}catch{}s==null||s("closed")},source:o,url:t}}async function Oc(e){if(!ks())return null;const t=Cs(e);if(typeof fetch!="function")throw new Error("backend_receipt_fetch_unavailable");const r=typeof AbortController<"u"?new AbortController:null,s=r?setTimeout(()=>r.abort(),Is):null;try{const o=await fetch(`${yt}/v1/execution-receipts?txid=${encodeURIComponent(t)}`,{method:"GET",headers:{Accept:"application/json",...Et?{Authorization:`Bearer ${Et}`}:{}},...r?{signal:r.signal}:{}});if(o.status===404)return null;const d=await o.text();if(!o.ok)throw new Error(`backend_receipt_${o.status}:${String(d||"").slice(0,180)}`);const a=d?JSON.parse(d):{};return as(a)}finally{s&&clearTimeout(s)}}async function Kc(e){if(!Ms())return!1;if(typeof fetch!="function")throw new Error("backend_receipt_metrics_fetch_unavailable");const t=String((e==null?void 0:e.status)||"").toLowerCase();if(!["consistent","mismatch","insufficient"].includes(t))throw new Error("invalid_consistency_status");const r=typeof AbortController<"u"?new AbortController:null,s=r?setTimeout(()=>r.abort(),Is):null;try{return!!(await fetch(`${yt}/v1/receipt-consistency`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...Et?{Authorization:`Bearer ${Et}`}:{}},body:JSON.stringify({txid:e!=null&&e.txid?Cs(String(e.txid)):void 0,queueId:e!=null&&e.queueId?String(e.queueId).slice(0,120):void 0,agentId:e!=null&&e.agentId?String(e.agentId).slice(0,120):void 0,agentName:e!=null&&e.agentName?String(e.agentName).slice(0,120):void 0,status:t,mismatches:Array.isArray(e==null?void 0:e.mismatches)?e.mismatches.map(d=>String(d).trim()).filter(Boolean).slice(0,8):[],provenance:e!=null&&e.provenance?String(e.provenance).slice(0,24):void 0,truthLabel:e!=null&&e.truthLabel?String(e.truthLabel).slice(0,48):void 0,checkedTs:Number.isFinite(Number(e==null?void 0:e.checkedTs))?Math.max(0,Math.round(Number(e==null?void 0:e.checkedTs))):void 0,confirmTsDriftMs:Number.isFinite(Number(e==null?void 0:e.confirmTsDriftMs))?Math.max(0,Math.round(Number(e==null?void 0:e.confirmTsDriftMs))):void 0,feeDiffKas:Number.isFinite(Number(e==null?void 0:e.feeDiffKas))?Math.max(0,Number(Number(e==null?void 0:e.feeDiffKas).toFixed(8))):void 0,slippageDiffKas:Number.isFinite(Number(e==null?void 0:e.slippageDiffKas))?Math.max(0,Number(Number(e==null?void 0:e.slippageDiffKas).toFixed(8))):void 0}),...r?{signal:r.signal}:{}})).ok}finally{s&&clearTimeout(s)}}async function jc(e){if(!Ms())return!1;if(typeof fetch!="function")throw new Error("backend_calibration_metrics_fetch_unavailable");const t=typeof AbortController<"u"?new AbortController:null,r=t?setTimeout(()=>t.abort(),Is):null;try{return!!(await fetch(`${yt}/v1/calibration-metrics`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...Et?{Authorization:`Bearer ${Et}`}:{}},body:JSON.stringify({agentId:e!=null&&e.agentId?String(e.agentId).slice(0,120):void 0,agentName:e!=null&&e.agentName?String(e.agentName).slice(0,120):void 0,network:e!=null&&e.network?String(e.network).slice(0,40):void 0,walletAddress:e!=null&&e.walletAddress?String(e.walletAddress).slice(0,120):void 0,calibrationHealth:Number.isFinite(Number(e==null?void 0:e.calibrationHealth))?Math.max(0,Math.min(1.5,Number(Number(e==null?void 0:e.calibrationHealth).toFixed(6)))):void 0,calibrationTier:e!=null&&e.calibrationTier?String(e.calibrationTier).slice(0,32):void 0,sizeMultiplier:Number.isFinite(Number(e==null?void 0:e.sizeMultiplier))?Math.max(0,Math.min(2,Number(Number(e==null?void 0:e.sizeMultiplier).toFixed(6)))):void 0,autoApproveDisabled:!!(e!=null&&e.autoApproveDisabled),autoApproveDisableDeferred:!!(e!=null&&e.autoApproveDisableDeferred),confidenceBrierScore:Number.isFinite(Number(e==null?void 0:e.confidenceBrierScore))?Math.max(0,Math.min(2,Number(Number(e==null?void 0:e.confidenceBrierScore).toFixed(6)))):void 0,evCalibrationErrorPct:Number.isFinite(Number(e==null?void 0:e.evCalibrationErrorPct))?Math.max(0,Math.min(1e3,Number(Number(e==null?void 0:e.evCalibrationErrorPct).toFixed(6)))):void 0,regimeHitRatePct:Number.isFinite(Number(e==null?void 0:e.regimeHitRatePct))?Math.max(0,Math.min(100,Number(Number(e==null?void 0:e.regimeHitRatePct).toFixed(6)))):void 0,regimeHitSamples:Number.isFinite(Number(e==null?void 0:e.regimeHitSamples))?Math.max(0,Math.round(Number(e==null?void 0:e.regimeHitSamples))):void 0,truthDegraded:!!(e!=null&&e.truthDegraded),truthMismatchRatePct:Number.isFinite(Number(e==null?void 0:e.truthMismatchRatePct))?Math.max(0,Math.min(100,Number(Number(e==null?void 0:e.truthMismatchRatePct).toFixed(6)))):void 0,checkedTs:Number.isFinite(Number(e==null?void 0:e.checkedTs))?Math.max(0,Math.round(Number(e==null?void 0:e.checkedTs))):void 0}),...t?{signal:t.signal}:{}})).ok}finally{r&&clearTimeout(r)}}function Fc(e,t){switch(e){case"RUNNING":return t.type==="PAUSE"?"PAUSED":t.type==="KILL"?"SUSPENDED":t.type==="FAIL"?"ERROR":e;case"PAUSED":return t.type==="RESUME"?"RUNNING":t.type==="KILL"?"SUSPENDED":t.type==="FAIL"?"ERROR":e;case"SUSPENDED":return t.type==="RESUME"?"RUNNING":e;case"ERROR":return t.type==="RESET_ERROR"||t.type==="RESUME"?"RUNNING":t.type==="KILL"?"SUSPENDED":e;default:throw gs({domain:"lifecycle",code:"LIFECYCLE_INVALID_TRANSITION",message:`Unknown agent state: ${String(e)}`})}}function gn(e,t){switch(e){case"pending":return t.type==="BEGIN_SIGN"?"signing":t.type==="SIGN_SUCCESS"?"signed":t.type==="SIGN_REJECT"?"rejected":t.type==="FAIL"?"failed":e;case"signing":return t.type==="SIGN_SUCCESS"?"signed":t.type==="SIGN_REJECT"?"rejected":t.type==="FAIL"?"failed":e;case"failed":return t.type==="REQUEUE"?"pending":t.type==="BEGIN_SIGN"?"signing":e;case"rejected":return t.type==="REQUEUE"?"pending":e;case"signed":return e;default:throw gs({domain:"lifecycle",code:"LIFECYCLE_INVALID_TRANSITION",message:`Unknown tx lifecycle state: ${String(e)}`})}}function Uc(e,t){switch(e){case"submitted":return t.type==="BROADCASTED"?"broadcasted":t.type==="POLL_PENDING"?"pending_confirm":t.type==="CONFIRMED"?"confirmed":t.type==="FAILED"?"failed":t.type==="TIMEOUT"?"timeout":e;case"broadcasted":return t.type==="POLL_PENDING"?"pending_confirm":t.type==="CONFIRMED"?"confirmed":t.type==="FAILED"?"failed":t.type==="TIMEOUT"?"timeout":e;case"pending_confirm":return t.type==="CONFIRMED"?"confirmed":t.type==="FAILED"?"failed":t.type==="TIMEOUT"?"timeout":e;case"failed":case"timeout":case"confirmed":return t.type==="RESET"?"submitted":e;default:throw gs({domain:"lifecycle",code:"LIFECYCLE_INVALID_TRANSITION",message:`Unknown tx receipt lifecycle state: ${String(e)}`})}}function $c(e="RUNNING"){const[t,r]=y.useState(e),s=y.useCallback(o=>{r(d=>Fc(String(d||"RUNNING"),o))},[]);return{status:t,setStatus:r,transitionAgentStatus:s}}function Bc(e){const{status:t,runtimeHydrated:r,loading:s,liveConnected:o,kasDataError:d,nextAutoCycleAt:a,cycleIntervalMs:u,cycleLockRef:c,setNextAutoCycleAt:l,runCycle:_}=e,A=y.useRef({loading:s,liveConnected:o,kasDataError:d,nextAutoCycleAt:a,cycleIntervalMs:u,runCycle:_});y.useEffect(()=>{A.current={loading:s,liveConnected:o,kasDataError:d,nextAutoCycleAt:a,cycleIntervalMs:u,runCycle:_}},[s,o,d,a,u,_]),y.useEffect(()=>{if(t!=="RUNNING"||!r)return;const v=setInterval(()=>{const g=A.current;c.current||g.loading||!g.liveConnected||g.kasDataError||Date.now()<g.nextAutoCycleAt||(l(Date.now()+g.cycleIntervalMs),g.runCycle())},1e3);return()=>clearInterval(v)},[t,r,l,c])}const Dc="forgeos.alerts.v1",zc="forgeos.alerts.dedupe.v1",Wc=1200,Kt=new Map,Sn=1024,cs={enabled:!1,minIntervalSec:90,discordWebhookUrl:"",telegramBotApiUrl:"",telegramChatId:"",emailWebhookUrl:"",eventToggles:{risk_event:!0,queue_pending:!0,ai_outage:!0,regime_shift:!0,system:!1}};function Rs(e){return String(e||"default").trim().toLowerCase().replace(/[^a-z0-9:_-]/g,"_").slice(0,180)}function yi(e){return`${Dc}:${Rs(e)||"default"}`}function yn(e,t){return`${zc}:${Rs(e)||"default"}:${String(t||"event").slice(0,120)}`}function Hc(e,t){const r=Number(e);return Number.isFinite(r)?r:t}function Vc(e,t,r){return Math.min(r,Math.max(t,e))}function qr(e){return String(e||"").trim().slice(0,500)}function Ur(e){var r;const t={...cs.eventToggles};for(const s of Object.keys(t))typeof((r=e==null?void 0:e.eventToggles)==null?void 0:r[s])=="boolean"&&(t[s]=e.eventToggles[s]);return{version:1,updatedAt:Date.now(),enabled:!!(e!=null&&e.enabled),minIntervalSec:Vc(Hc(e==null?void 0:e.minIntervalSec,cs.minIntervalSec),15,3600),discordWebhookUrl:qr(e==null?void 0:e.discordWebhookUrl),telegramBotApiUrl:qr(e==null?void 0:e.telegramBotApiUrl),telegramChatId:String((e==null?void 0:e.telegramChatId)||"").trim().slice(0,120),emailWebhookUrl:qr(e==null?void 0:e.emailWebhookUrl),eventToggles:t}}function Bt(){return Ur(cs)}function ds(e){if(typeof window>"u")return Bt();try{const t=window.localStorage.getItem(yi(e));return t?Ur(JSON.parse(t)):Bt()}catch{return Bt()}}function Gc(e,t){if(!(typeof window>"u"))try{window.localStorage.setItem(yi(e),JSON.stringify(Ur(t)))}catch{}}function Yc(e,t,r){const s=r.key||`${r.type}:${r.title}`,o=Math.max(15,t.minIntervalSec)*1e3,d=Date.now(),a=`${Rs(e)}:${s}`,u=Kt.get(a)||0;if(d-u<o)return!0;if(typeof window<"u")try{const c=window.localStorage.getItem(yn(e,s)),l=c?Number(c):0;if(Number.isFinite(l)&&d-l<o)return!0}catch{}if(Kt.set(a,d),Kt.size>Sn){const c=d-o*4;for(const[l,_]of Kt.entries())if(_<c&&Kt.delete(l),Kt.size<=Sn)break}if(typeof window<"u")try{window.localStorage.setItem(yn(e,s),String(d))}catch{}return!1}function ws(e){const t=String(e.severity||"info").toUpperCase(),r=new Date(e.ts||Date.now()).toISOString(),s=`[ForgeOS][${t}] ${e.title}`,o=`${e.message}${e.meta?`
meta: ${JSON.stringify(e.meta)}`:""}`;return`${s}
${o}
${r}`.slice(0,Wc)}async function Ls(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`alert_webhook_${r.status}`);return!0}async function Xc(e,t){return e?(await Ls(e,{content:ws(t)}),!0):!1}async function qc(e,t,r){return!e||!t?!1:(await Ls(e,{chat_id:t,text:ws(r),disable_web_page_preview:!0}),!0)}async function Qc(e,t){return e?(await Ls(e,{subject:`[ForgeOS] ${t.title}`,message:ws(t),event:t}),!0):!1}async function Jc(e,t,r){const s=Ur(r||ds(e));if(!s.enabled)return{sent:!1,reason:"disabled"};if(!s.eventToggles[t.type])return{sent:!1,reason:"event_disabled"};if(!(!!s.discordWebhookUrl||!!s.telegramBotApiUrl&&!!s.telegramChatId||!!s.emailWebhookUrl))return{sent:!1,reason:"no_routes_configured"};if(Yc(e,s,t))return{sent:!1,reason:"throttled"};const d=[];let a=0;try{await Xc(s.discordWebhookUrl,t)&&(a+=1)}catch(u){d.push(`discord:${(u==null?void 0:u.message)||"send_failed"}`)}try{await qc(s.telegramBotApiUrl,s.telegramChatId,t)&&(a+=1)}catch(u){d.push(`telegram:${(u==null?void 0:u.message)||"send_failed"}`)}try{await Qc(s.emailWebhookUrl,t)&&(a+=1)}catch(u){d.push(`email:${(u==null?void 0:u.message)||"send_failed"}`)}return a===0&&d.length?{sent:!1,reason:"delivery_failed",failures:d}:{sent:a>0,sentCount:a,failures:d}}function Zc(e){const{alertScope:t,agentName:r,agentId:s,activeStrategyLabel:o}=e,[d,a]=y.useState(()=>ds(t)),[u,c]=y.useState(!1),[l,_]=y.useState(null);y.useEffect(()=>{a(ds(t))},[t]);const A=y.useCallback(async M=>{try{const x=await Jc(t,M,d);return(x!=null&&x.sent||x!=null&&x.reason)&&_(x),x}catch(x){const R={sent:!1,reason:(x==null?void 0:x.message)||"alert_error"};return _(R),R}},[d,t]),v=y.useCallback(M=>{a(x=>({...x||Bt(),...M,updatedAt:Date.now()}))},[]),g=y.useCallback((M,x)=>{a(R=>({...R||Bt(),eventToggles:{...(R||Bt()).eventToggles||{},[M]:x},updatedAt:Date.now()}))},[]),N=y.useCallback(async()=>{c(!0);try{Gc(t,d),_({sent:!0,reason:"saved",sentCount:0})}catch(M){_({sent:!1,reason:(M==null?void 0:M.message)||"save_failed"})}finally{c(!1)}},[d,t]),C=y.useCallback(async()=>{const M=await A({type:"system",key:`test_alert:${String(s||r||"agent")}`,title:`${r||"Agent"} test alert`,message:`Test alert from Forge.OS (${Te}) Â· strategy=${String(o||"Custom")}`,severity:"info",meta:{network:Te,strategy:o}});_(M)},[o,s,r,A]);return{alertConfig:d,setAlertConfig:a,alertSaveBusy:u,lastAlertResult:l,setLastAlertResult:_,sendAlertEvent:A,patchAlertConfig:v,toggleAlertType:g,saveAlertConfig:N,sendTestAlert:C}}const ed="forgeos.dashboard.v1",td=160,rd=320,sd=120,nd=240;function id(e){return String(e||"default").trim().toLowerCase().replace(/[^a-z0-9:_-]/g,"_").slice(0,180)}function Ei(e){const t=id(e);return`${ed}:${t||"default"}`}function Qr(e,t){return Array.isArray(e)?e.slice(0,t):[]}function od(e,t){return Array.isArray(e)?e.slice(Math.max(0,e.length-t)):[]}function xi(e){const t=e.attributionSummary&&typeof e.attributionSummary=="object"?{netPnlMode:String(e.attributionSummary.netPnlMode||"").slice(0,24)||void 0,truthDegraded:!!e.attributionSummary.truthDegraded,truthMismatchRatePct:Number.isFinite(Number(e.attributionSummary.truthMismatchRatePct))?Number(e.attributionSummary.truthMismatchRatePct):void 0,receiptCoveragePct:Number.isFinite(Number(e.attributionSummary.receiptCoveragePct))?Number(e.attributionSummary.receiptCoveragePct):void 0,realizedReceiptCoveragePct:Number.isFinite(Number(e.attributionSummary.realizedReceiptCoveragePct))?Number(e.attributionSummary.realizedReceiptCoveragePct):void 0,confidenceBrierScore:Number.isFinite(Number(e.attributionSummary.confidenceBrierScore))?Number(e.attributionSummary.confidenceBrierScore):void 0,evCalibrationErrorPct:Number.isFinite(Number(e.attributionSummary.evCalibrationErrorPct))?Number(e.attributionSummary.evCalibrationErrorPct):void 0,regimeHitRatePct:Number.isFinite(Number(e.attributionSummary.regimeHitRatePct))?Number(e.attributionSummary.regimeHitRatePct):void 0,regimeHitSamples:Number.isFinite(Number(e.attributionSummary.regimeHitSamples))?Number(e.attributionSummary.regimeHitSamples):void 0,realizedVsExpectedEdgeKas:Number.isFinite(Number(e.attributionSummary.realizedVsExpectedEdgeKas))?Number(e.attributionSummary.realizedVsExpectedEdgeKas):void 0,updatedAt:Date.now()}:void 0;return{version:1,updatedAt:Date.now(),status:e.status==="RUNNING"||e.status==="PAUSED"||e.status==="SUSPENDED"?e.status:"RUNNING",execMode:e.execMode==="autonomous"||e.execMode==="manual"||e.execMode==="notify"?e.execMode:"manual",liveExecutionArmed:!!e.liveExecutionArmed,nextAutoCycleAt:Number.isFinite(e.nextAutoCycleAt)&&Number(e.nextAutoCycleAt)>0?Number(e.nextAutoCycleAt):void 0,queue:Qr(e.queue,td),log:Qr(e.log,rd),decisions:Qr(e.decisions,sd),marketHistory:od(e.marketHistory,nd),attributionSummary:t}}function bi(e){if(typeof window>"u")return null;try{const t=window.localStorage.getItem(Ei(e));if(!t)return null;const r=JSON.parse(t);return xi(r)}catch{return null}}function ad(e,t){if(!(typeof window>"u"))try{const r=xi(t);window.localStorage.setItem(Ei(e),JSON.stringify(r))}catch{}}function cd(e){const{agent:t,cycleIntervalMs:r,runtimeScope:s,maxDecisionEntries:o,maxLogEntries:d,maxQueueEntries:a,maxMarketSnapshots:u,runtimeHydrated:c,setRuntimeHydrated:l,status:_,execMode:A,liveExecutionArmed:v,queue:g,log:N,decisions:C,marketHistory:M,attributionSummary:x,nextAutoCycleAt:R,setStatus:b,setExecMode:f,setLiveExecutionArmed:p,setQueue:S,setLog:K,setDecisions:j,setMarketHistory:F,setNextAutoCycleAt:B,liveExecutionDefault:U,writeDelayMs:I=250}=e;y.useEffect(()=>{l(!1);const h=bi(s);h?(h.status&&b(h.status),h.execMode&&["autonomous","manual","notify"].includes(String(h.execMode))?f(h.execMode):f(t.execMode||"manual"),typeof h.liveExecutionArmed=="boolean"?p(h.liveExecutionArmed):p(U),S(Array.isArray(h.queue)?h.queue.slice(0,a):[]),K(Array.isArray(h.log)&&h.log.length>0?h.log.slice(0,d):ns(t.name)),j(Array.isArray(h.decisions)?h.decisions.slice(0,o):[]),F(Array.isArray(h.marketHistory)?h.marketHistory.slice(-u):[]),B(Number.isFinite(h.nextAutoCycleAt)?Math.max(Date.now()+1e3,Number(h.nextAutoCycleAt)):Date.now()+r)):(b("RUNNING"),f(t.execMode||"manual"),p(U),S([]),j([]),F([]),K(ns(t.name)),B(Date.now()+r)),l(!0)},[t.execMode,t.name,r,U,o,d,u,a,s,j,f,p,K,F,B,S,l,b]),y.useEffect(()=>{if(!c)return;const h=setTimeout(()=>{ad(s,{status:_,execMode:A,liveExecutionArmed:v,queue:g,log:N,decisions:C,marketHistory:M,attributionSummary:x,nextAutoCycleAt:R})},I);return()=>clearTimeout(h)},[C,A,v,N,M,x,R,g,c,s,_,I])}function dd(e){var W,Y;const{viewportWidth:t,nextAutoCycleAt:r,status:s,totalFees:o,queue:d,decisions:a,liveConnected:u,kasDataError:c,wallet:l,kasData:_,reserveKas:A,netFeeKas:v,treasuryReserveKas:g,wsUrl:N,streamConnected:C,streamRetryCount:M}=e,x=t<760,R=t<1024,b=y.useMemo(()=>x?"1fr":R?"repeat(2,1fr)":"repeat(4,1fr)",[x,R]),f=R?"1fr":"2fr 1fr",p=R?"1fr":"1fr 1fr",S=Array.isArray(d)?d.filter(te=>(te==null?void 0:te.status)==="pending").length:0,K=Number((_==null?void 0:_.walletKas)||0),j=Math.max(0,K-A-v-g),F=u&&!c&&(l==null?void 0:l.provider)!=="demo",B=Math.max(0,Math.ceil((r-Date.now())/1e3)),U=`${Math.floor(B/60).toString().padStart(2,"0")}:${(B%60).toString().padStart(2,"0")}`,I=(W=a==null?void 0:a[0])==null?void 0:W.dec,h=String((I==null?void 0:I.decision_source)||((Y=a==null?void 0:a[0])==null?void 0:Y.source)||"ai"),G=N?C?"STREAM LIVE":M>0?`STREAM RETRY ${M}`:"STREAM DOWN":"STREAM OFF",$=N?C?i.ok:i.warn:i.dim;return{isMobile:x,isTablet:R,summaryGridCols:b,splitGridCols:f,controlsGridCols:p,pendingCount:S,liveKasNum:K,spendableKas:j,liveExecutionReady:F,autoCycleCountdownLabel:U,lastDecision:I,lastDecisionSource:h,streamBadgeText:G,streamBadgeColor:$,totalFees:o,status:s}}function ld(e){const t=Number(e);return Number.isFinite(t)?t:0}function jt(e){const t=Number(e);return Number.isFinite(t)?t:0}function ud(e){const{pnlAttribution:t,receiptConsistencyMetrics:r}=e,s=Math.max(0,jt(r==null?void 0:r.checked)),o=Math.max(0,jt(r==null?void 0:r.mismatch)),d=s>0?o/s*100:0,a=Math.max(0,jt(r==null?void 0:r.repeatedMismatchItems)),u=s>=Ro&&d>=Ys,c=[];u&&c.push(`receipt_mismatch_rate_${d.toFixed(1)}pct>=${Ys.toFixed(1)}pct`);const l={degraded:u,checked:s,mismatches:o,mismatchRatePct:Number(d.toFixed(2)),repeatedMismatchItems:a,autoApproveDisabled:u&&wo,reasons:c},_=Math.max(0,jt(t==null?void 0:t.confidenceBrierScore)),A=Math.max(0,jt(t==null?void 0:t.evCalibrationErrorPct)),v=Math.max(0,ld(t==null?void 0:t.regimeHitRatePct)),g=Math.max(0,jt(t==null?void 0:t.regimeHitSamples));let N=1;const C=[],M=g>=Xs;Ot&&M?(_>=qs?(N-=.4,C.push(`brier_${_.toFixed(4)}>=${qs}`)):_>=es&&(N-=.18,C.push(`brier_${_.toFixed(4)}>=${es}`)),A>=Qs?(N-=.35,C.push(`ev_cal_${A.toFixed(3)}>=${Qs}`)):A>=ts&&(N-=.15,C.push(`ev_cal_${A.toFixed(3)}>=${ts}`)),v<=Js?(N-=.35,C.push(`regime_hit_${v.toFixed(1)}<=${Js}`)):v<=rs&&(N-=.15,C.push(`regime_hit_${v.toFixed(1)}<=${rs}`))):Ot&&C.push(`insufficient_calibration_samples_${g}/${Xs}`),N=Math.max(0,Math.min(1,Number(N.toFixed(3))));let x="healthy",R=1;Ot&&M&&(N<.35?(x="critical",R=Lo):N<.6?(x="degraded",R=Hn):N<.85&&(x="warn",R=Wn));const b=Number(Math.max(0,Math.min(1,R)).toFixed(4)),f=Number((1-b).toFixed(4)),p=b<.9999,S=Number(Math.max(0,Math.min(.95,Po)).toFixed(4)),K=p&&f>=S,j=Ot&&M&&N<=Zs&&K,F={enabled:Ot,samplesSufficient:M,health:N,tier:x,sizeMultiplier:b,sizeReductionPct:f,sizingThrottleApplied:p,minSizeReductionRequired:S,autoApproveDisabled:j,autoApproveDisableDeferred:Ot&&M&&N<=Zs&&!K,reasons:C,metrics:{brier:_,evCalErrorPct:A,regimeHitRatePct:v,regimeHitSamples:g}},B=F.autoApproveDisabled||l.autoApproveDisabled,U=[...F.autoApproveDisabled?["calibration_guardrail"]:[],...l.autoApproveDisabled?["truth_degraded"]:[]];return{calibration:F,truth:l,effectiveSizingMultiplier:F.sizeMultiplier,autoApproveDisabled:B,autoApproveDisableReasons:U}}function fd(e){return y.useMemo(()=>ud(e),[e.pnlAttribution,e.receiptConsistencyMetrics])}const md=String(wr||"").replace(/\/+$/,""),Nr=Array.from(new Set([md,...zn.map(e=>String(e||"").replace(/\/+$/,""))])).filter(Boolean),En=12e3,yr=2,_d=250,xn=new Set([408,425,429,500,502,503,504]),pd=2e4;let Er=null,Qt=null;const hd=Te.startsWith("testnet")?"testnet":"mainnet",gd=[e=>`/transactions/${e}`,e=>`/txs/${e}`,e=>`/transaction/${e}`];function Sd(e,t){return`${e}${t}`}function bn(e){return new Promise(t=>setTimeout(t,e))}function An(e){const t=Math.floor(Math.random()*120);return _d*(e+1)+t}function yd(e){const t=String(e||"").toLowerCase();return t.includes("tn10")||t.includes("tn11")||t.includes("tn12")||t.includes("testnet")?"testnet":t.includes("api.kaspa.org")||t.includes("mainnet")?"mainnet":"unknown"}function Ed(e){const t=String(e||"").toLowerCase();if(t.includes("/addresses/kaspatest:")||t.includes("/addresses/kaspatest%3a"))return"testnet";if(t.includes("/addresses/kaspa:")||t.includes("/addresses/kaspa%3a"))return"mainnet";try{const r=decodeURIComponent(t);if(r.includes("/addresses/kaspatest:"))return"testnet";if(r.includes("/addresses/kaspa:"))return"mainnet"}catch{}return"unknown"}function xd(e){const t=Ed(e),r=t==="unknown"?hd:t;if(r==="unknown")return Nr;const s=Nr.filter(o=>{const d=yd(o);return d===r||d==="unknown"});return s.length>0?s:Nr}async function nr(e){if(Nr.length===0)throw new Error("No Kaspa API endpoints configured");const t=xd(e),r=[];for(const s of t)for(let o=0;o<yr;o+=1){const d=new AbortController,a=setTimeout(()=>d.abort(),En),u=`${o+1}/${yr}`;try{const c=await fetch(Sd(s,e),{method:"GET",headers:{Accept:"application/json"},signal:d.signal});if(!c.ok){const l=Number(c.status||0);if(xn.has(l)&&o+1<yr){await bn(An(o));continue}throw new Error(`${l||"request_failed"}`)}return await c.json()}catch(c){const l=(c==null?void 0:c.name)==="AbortError",_=String((c==null?void 0:c.message)||""),A=Number(_||0),v=xn.has(A),g=(c==null?void 0:c.name)==="TypeError"||/failed to fetch|network|load failed/i.test(_);if(o+1<yr&&(l||v||g)){await bn(An(o));continue}l?r.push(`${s} timeout (${En}ms, attempt ${u})`):g?r.push(`${s} network_error (${_||"request_failed"}, attempt ${u})`):r.push(`${s} ${_||"request_failed"} (attempt ${u})`);break}finally{clearTimeout(a)}}throw ys(new Error(`Kaspa API unavailable for ${e}: ${r.join(" | ")}`),{path:e,roots:t})}function Ai(e){const t=String(e||"").trim();if(!t)throw new Error("Missing Kaspa address");return encodeURIComponent(t)}function bd(e){const t=String(e||"").trim();if(!/^[a-fA-F0-9]{64}$/.test(t))throw new Error("Invalid txid format");return t.toLowerCase()}function Ad(e){var s;const t=(e==null?void 0:e.balance)??(e==null?void 0:e.totalBalance)??(e==null?void 0:e.availableSompi)??(e==null?void 0:e.balanceSompi)??((s=e==null?void 0:e.balances)==null?void 0:s.total)??0,r=Number(t);return Number.isFinite(r)?Math.max(0,r):0}function Td(e,t){var s;const r=(e==null?void 0:e.balanceKas)??(e==null?void 0:e.kas)??(e==null?void 0:e.balance_kas)??((s=e==null?void 0:e.balances)==null?void 0:s.kas);if(r!=null){const o=Number(r);if(Number.isFinite(o))return Math.max(0,o)}return t/1e8}function Nd(e){return Array.isArray(e)?e:Array.isArray(e==null?void 0:e.utxos)?e.utxos:Array.isArray(e==null?void 0:e.entries)?e.entries:[]}function xr(...e){for(const t of e){const r=Number(t);if(Number.isFinite(r))return r}return NaN}function vd(...e){for(const t of e)if(typeof t=="boolean")return t}function Id(e){const t=Number(e);if(!(!Number.isFinite(t)||t<=0))return t<1e12?Math.round(t*1e3):Math.round(t)}function Tn(...e){for(const t of e){const r=Number(t);if(Number.isFinite(r)&&r>=0)return Math.round(r)}}function Cd(e,t,r){var C,M,x,R,b,f,p,S,K,j,F,B,U,I;const s=(t==null?void 0:t.transaction)??(t==null?void 0:t.tx)??t,o=String((s==null?void 0:s.status)??(s==null?void 0:s.transactionStatus)??((C=s==null?void 0:s.verboseData)==null?void 0:C.status)??(s==null?void 0:s.state)??"").toLowerCase(),d=Math.max(0,Math.round(xr(s==null?void 0:s.confirmations,s==null?void 0:s.numConfirmations,s==null?void 0:s.confirmationCount,(M=s==null?void 0:s.verboseData)==null?void 0:M.confirmations,s!=null&&s.acceptingBlockBlueScore&&(s!=null&&s.blockDaaScore)?Number(s.blockDaaScore)-Number(s.acceptingBlockBlueScore):NaN)||0)),a=vd(s==null?void 0:s.isAccepted,s==null?void 0:s.accepted,(x=s==null?void 0:s.verboseData)==null?void 0:x.isAccepted,(R=s==null?void 0:s.verboseData)==null?void 0:R.accepted),u=xr(s==null?void 0:s.blockDaaScore,s==null?void 0:s.acceptingBlockBlueScore,(b=s==null?void 0:s.verboseData)==null?void 0:b.blockDaaScore,(f=s==null?void 0:s.verboseData)==null?void 0:f.acceptingBlockBlueScore),c=xr(s==null?void 0:s.blockTime,s==null?void 0:s.blockTimestamp,s==null?void 0:s.acceptedTime,(p=s==null?void 0:s.verboseData)==null?void 0:p.blockTime,(S=s==null?void 0:s.verboseData)==null?void 0:S.blockTimestamp),l=Tn(s==null?void 0:s.feeSompi,s==null?void 0:s.fee_sompi,s==null?void 0:s.networkFeeSompi,(K=s==null?void 0:s.verboseData)==null?void 0:K.feeSompi,(j=s==null?void 0:s.verboseData)==null?void 0:j.networkFeeSompi),_=xr(s==null?void 0:s.feeKas,s==null?void 0:s.fee_kas,s==null?void 0:s.networkFeeKas,(F=s==null?void 0:s.verboseData)==null?void 0:F.feeKas,(B=s==null?void 0:s.verboseData)==null?void 0:B.networkFeeKas),A=Number.isFinite(_)?Number(_):typeof l=="number"?Number((l/1e8).toFixed(8)):void 0,v=Tn(s==null?void 0:s.mass,s==null?void 0:s.transactionMass,(U=s==null?void 0:s.verboseData)==null?void 0:U.mass,(I=s==null?void 0:s.verboseData)==null?void 0:I.transactionMass),g=Id(c);let N="pending";return o.includes("confirm")||o.includes("accept")||d>0||Number.isFinite(u)?N="confirmed":(o.includes("reject")||o.includes("invalid")||o.includes("orphan")||a===!1)&&(N="failed"),{txid:e,found:!!t,status:N,confirmations:d,accepted:a,blockDaaScore:Number.isFinite(u)?Number(u):void 0,blockTime:Number.isFinite(c)?Number(c):void 0,confirmTimeMs:g,feeSompi:l,feeKas:A,mass:v,sourcePath:r,raw:t}}async function kd(e){try{return await nr(e)}catch(t){const r=String((t==null?void 0:t.message)||"");if(/(^|\s)404(\s|$)|\b404\b/.test(r))return null;throw t}}async function Ti(){const e=Date.now();return Er&&e-Er.ts<pd?Er.value:Qt||(Qt=(async()=>{const t=await nr("/info/price"),r=Number((t==null?void 0:t.price)??0);if(!Number.isFinite(r))throw ys(new Error("Invalid price payload from Kaspa API"),{endpoint:"/info/price"});return Er={value:r,ts:Date.now()},r})().finally(()=>{Qt=null}),Qt)}async function Ni(e){const t=await nr(`/addresses/${Ai(e)}/balance`),r=Ad(t),s=Td(t,r);return{kas:us(s,4),raw:r}}async function Md(e){const t=await nr(`/addresses/${Ai(e)}/utxos`);return Nd(t)}async function Rd(){const e=await nr("/info/blockdag");return(e==null?void 0:e.blockdag)??(e==null?void 0:e.blockDag)??e}async function wd(e){const t=bd(e),r=[];for(const s of gd){const o=s(t);try{const d=await kd(o);if(!d)continue;return Cd(t,d,o)}catch(d){r.push(String((d==null?void 0:d.message)||d||"request_failed"))}}if(r.length===0)return{txid:t,found:!1,status:"pending",confirmations:0};throw ys(new Error(`Kaspa tx receipt lookup failed for ${t}: ${r.join(" | ")}`),{txid:t})}const qe=(e,t=0)=>{const r=Number(e);return Number.isFinite(r)?r:t};function Ld(e){const t=Math.max(0,qe(e==null?void 0:e.amount_kas,0)),r=qe(e==null?void 0:e.broadcast_price_usd,0),s=qe(e==null?void 0:e.confirm_price_usd,0);if(!(t>0)||!(r>0)||!(s>0))return null;const o=Math.abs((s-r)/r);return Number((t*o).toFixed(8))}function Pd(e,t){const r=Date.now(),s=[],o=Math.max(0,qe((e==null?void 0:e.chain_confirm_ts)??(e==null?void 0:e.confirm_ts),0)),d=Math.max(0,qe(e==null?void 0:e.backend_confirm_ts,0)),a=o>0&&d>0,u=a?Math.abs(o-d):void 0;typeof u=="number"&&u>Math.max(0,qe(t==null?void 0:t.confirmTsDriftMs,0))&&s.push("confirm_ts");const c=qe((e==null?void 0:e.chain_receipt_fee_kas)??(e==null?void 0:e.receipt_fee_kas),NaN),l=qe(e==null?void 0:e.backend_receipt_fee_kas,NaN),_=Number.isFinite(c)&&Number.isFinite(l),A=_?Number(Math.abs(c-l).toFixed(8)):void 0;typeof A=="number"&&A>Math.max(0,qe(t==null?void 0:t.feeKasTolerance,0))&&s.push("fee_kas");const v=qe((e==null?void 0:e.backend_receipt_slippage_kas)??(e==null?void 0:e.receipt_slippage_kas),NaN),g=qe(e==null?void 0:e.chain_derived_slippage_kas,NaN),N=Number.isFinite(g)?g:Ld(e),C=Number.isFinite(v)&&Number.isFinite(N),M=C?Number(Math.abs(v-Number(N)).toFixed(8)):void 0;return typeof M=="number"&&M>Math.max(0,qe(t==null?void 0:t.slippageKasTolerance,0))&&s.push("slippage_kas"),{status:a||_||C?s.length>0?"mismatch":"consistent":"insufficient",mismatches:s,...typeof u=="number"?{confirmTsDriftMs:u}:{},...typeof A=="number"?{feeDiffKas:A}:{},...typeof M=="number"?{slippageDiffKas:M}:{},checkedTs:r}}function Od(e){const{wallet:t,maxQueueEntries:r,addLog:s,kasPriceUsd:o=0,setTab:d,onSignedAction:a,receiptRetryBaseMs:u=2e3,receiptRetryMaxMs:c=3e4,receiptTimeoutMs:l=8*60*1e3,receiptMaxAttempts:_=18,receiptPollIntervalMs:A=1200,receiptPollBatchSize:v=2,sendAlertEvent:g,agentName:N,agentId:C}=e,[M,x]=y.useState([]),[R,b]=y.useState(null),[f,p]=y.useState(0),S=y.useRef(new Set),K=y.useRef([]),j=y.useRef(!1),F=y.useRef(new Map),B=y.useRef(new Map),U=y.useRef(new Map),I=ks(),h=Si(),G=Ms(),$=12,W=y.useMemo(()=>({confirmTsDriftMs:Co,feeKasTolerance:ko,slippageKasTolerance:Mo}),[]),Y=y.useCallback(m=>{if(!m||String((m==null?void 0:m.status)||"")!=="signed")return m;const E=Pd(m,W);return{...m,receipt_consistency_status:E.status,receipt_consistency_mismatches:E.mismatches,receipt_consistency_checked_ts:E.checkedTs,receipt_consistency_confirm_ts_drift_ms:typeof E.confirmTsDriftMs=="number"?E.confirmTsDriftMs:void 0,receipt_consistency_fee_diff_kas:typeof E.feeDiffKas=="number"?E.feeDiffKas:void 0,receipt_consistency_slippage_diff_kas:typeof E.slippageDiffKas=="number"?E.slippageDiffKas:void 0}},[W]),te=y.useCallback((m,E,q={})=>{x(T=>T.map(X=>{if((X==null?void 0:X.id)!==m)return X;const ne=gn(String((X==null?void 0:X.status)||"pending"),E);return{...X,status:ne,...q}}))},[]),ie=y.useCallback((m,E,q={})=>{x(T=>T.map(X=>{if((X==null?void 0:X.id)!==m)return X;const ne=Uc(String((X==null?void 0:X.receipt_lifecycle)||"submitted"),E),V={...X,receipt_lifecycle:ne,...q};return Y(V)}))},[Y]),me=y.useCallback(m=>{const E=Math.max(0,Math.min(6,Number(m||0))),q=Math.floor(Math.random()*250);return Math.min(c,u*2**E+q)},[u,c]),Ee=y.useCallback((m,E,q={})=>{const T=Date.now(),X=Number(o||0);return{...m,status:"signed",txid:E,receipt_lifecycle:"broadcasted",broadcast_ts:T,receipt_attempts:0,confirmations:0,receipt_next_check_at:T+me(0),receipt_last_checked_ts:void 0,failure_reason:null,...X>0?{broadcast_price_usd:X}:{},...q}},[o,me]),Se=y.useCallback((m,E,q={})=>{const T=Date.now(),X=Number(o||0);ie(m,{type:"BROADCASTED"},{txid:E,broadcast_ts:T,receipt_last_checked_ts:void 0,receipt_next_check_at:T+me(0),receipt_attempts:0,confirmations:0,failure_reason:null,...X>0?{broadcast_price_usd:X}:{},...q})},[o,me,ie]),Pe=y.useCallback(async(m,E)=>{const q=String((m==null?void 0:m.id)||""),T=String((m==null?void 0:m.txid)||(E==null?void 0:E.txid)||"").trim().toLowerCase();if(!q||!T)return!1;const X=Date.now(),ne=String((E==null?void 0:E.status)||"confirmed").toLowerCase(),V=Number((E==null?void 0:E.confirmTs)||0),_e=V>0?V<1e12?Math.round(V*1e3):Math.round(V):0,k=Number((E==null?void 0:E.broadcastTs)||0),le=k>0?k<1e12?Math.round(k*1e3):Math.round(k):0,Ne=String((E==null?void 0:E.confirmTsSource)||"").toLowerCase(),ye=Ne==="chain"||Ne==="poll"?Ne:_e>0?"chain":void 0,Le={txid:T,receipt_last_checked_ts:X,confirmations:Math.max(0,Number((E==null?void 0:E.confirmations)||0)),backend_confirmations:Math.max(0,Number((E==null?void 0:E.confirmations)||0)),failure_reason:null,receipt_source_path:"callback-consumer:/v1/execution-receipts",receipt_source:E!=null&&E.source?String(E.source).slice(0,120):"callback-consumer",receipt_imported_from:"callback_consumer",receipt_backend_updated_at:Number.isFinite(Number(E==null?void 0:E.updatedAt))&&Number(E.updatedAt)>0?Math.round(Number(E.updatedAt)):X,receipt_backend_last_checked_ts:X,receipt_backend_next_check_at:void 0,receipt_backend_attempts:Math.max(0,Number((m==null?void 0:m.receipt_backend_attempts)||0))+1,backend_receipt_slippage_kas:Number.isFinite(Number(E==null?void 0:E.slippageKas))?Math.max(0,Number(Number(E.slippageKas).toFixed(8))):void 0,receipt_slippage_kas:Number.isFinite(Number(E==null?void 0:E.slippageKas))?Math.max(0,Number(Number(E.slippageKas).toFixed(8))):void 0,backend_receipt_fee_sompi:Number.isFinite(Number(E==null?void 0:E.feeSompi))?Math.max(0,Math.round(Number(E.feeSompi))):void 0,receipt_fee_sompi:Number.isFinite(Number(E==null?void 0:E.feeSompi))?Math.max(0,Math.round(Number(E.feeSompi))):void 0,backend_receipt_fee_kas:Number.isFinite(Number(E==null?void 0:E.feeKas))?Math.max(0,Number(Number(E.feeKas).toFixed(8))):void 0,receipt_fee_kas:Number.isFinite(Number(E==null?void 0:E.feeKas))?Math.max(0,Number(Number(E.feeKas).toFixed(8))):void 0,...le>0?{broadcast_ts:le}:{},..._e>0?{backend_confirm_ts:_e}:{},..._e>0?{confirm_ts:_e}:{},..._e>0?{confirm_detected_ts:X}:{},...ye?{confirm_ts_source:ye}:{},..._e>0&&ye==="chain"?{receipt_block_time_ms:_e}:{},...Number.isFinite(Number(E==null?void 0:E.priceAtBroadcastUsd))&&Number(E.priceAtBroadcastUsd)>0?{broadcast_price_usd:Number(Number(E.priceAtBroadcastUsd).toFixed(8))}:{},...Number.isFinite(Number(E==null?void 0:E.priceAtConfirmUsd))&&Number(E.priceAtConfirmUsd)>0?{confirm_price_usd:Number(Number(E.priceAtConfirmUsd).toFixed(8))}:{}};return ne==="failed"||ne==="rejected"?(ie(q,{type:"FAILED"},{...Le,receipt_next_check_at:void 0,failure_reason:"backend_receipt_failed"}),String((m==null?void 0:m.receipt_lifecycle)||"")!=="failed"&&s({type:(m==null?void 0:m.metaKind)==="treasury_fee"?"TREASURY":"ERROR",msg:`${(m==null?void 0:m.metaKind)==="treasury_fee"?"Treasury payout":"Transaction"} failed via backend receipt Â· txid: ${T.slice(0,16)}...`,fee:null,truthLabel:"ESTIMATED",receiptProvenance:"BACKEND"}),!0):ne==="confirmed"||Number((E==null?void 0:E.confirmations)||0)>0||_e>0?(ie(q,{type:"CONFIRMED"},{...Le,receipt_next_check_at:void 0}),String((m==null?void 0:m.receipt_lifecycle)||"")!=="confirmed"&&s({type:(m==null?void 0:m.metaKind)==="treasury_fee"?"TREASURY":"EXEC",msg:`${(m==null?void 0:m.metaKind)==="treasury_fee"?"Treasury payout":"Transaction"} confirmed via backend receipt Â· ${Math.max(0,Number((E==null?void 0:E.confirmations)||0))} conf Â· txid: ${T.slice(0,16)}...`,fee:null,truthLabel:"BACKEND CONFIRMED",receiptProvenance:"BACKEND"}),!0):(ie(q,{type:"POLL_PENDING"},{...Le,receipt_attempts:Math.max(0,Number((m==null?void 0:m.receipt_attempts)||0)),receipt_next_check_at:X+me(Math.max(0,Number((m==null?void 0:m.receipt_attempts)||0)))}),!0)},[s,me,ie]),Ie=y.useCallback(async m=>{const E=String((m==null?void 0:m.id)||""),q=String((m==null?void 0:m.txid)||"");if(!E||!q)return;const T=String((m==null?void 0:m.receipt_lifecycle)||"submitted"),X=j.current;if(I&&!X)try{const oe=await Oc(q);if(oe){if(await Pe(m,oe),String((oe==null?void 0:oe.status)||"").toLowerCase()==="confirmed"||String((oe==null?void 0:oe.status)||"").toLowerCase()==="failed"||String((oe==null?void 0:oe.status)||"").toLowerCase()==="rejected"||Number((oe==null?void 0:oe.confirmations)||0)>0||Number((oe==null?void 0:oe.confirmTs)||0)>0||T==="confirmed")return}else if(T==="confirmed"){const w=Math.max(0,Number((m==null?void 0:m.receipt_backend_attempts)||0))+1;if(w>=$){ie(E,{type:"CONFIRMED"},{receipt_backend_last_checked_ts:Date.now(),receipt_backend_attempts:w,receipt_backend_next_check_at:void 0,receipt_backend_backfill_exhausted:!0});return}ie(E,{type:"CONFIRMED"},{receipt_backend_last_checked_ts:Date.now(),receipt_backend_attempts:w,receipt_backend_next_check_at:Date.now()+Math.min(6e4,Math.max(5e3,u*2**Math.min(5,w)))});return}}catch{if(T==="confirmed"){const oe=Math.max(0,Number((m==null?void 0:m.receipt_backend_attempts)||0))+1;if(oe>=$){ie(E,{type:"CONFIRMED"},{receipt_backend_last_checked_ts:Date.now(),receipt_backend_attempts:oe,receipt_backend_next_check_at:void 0,receipt_backend_backfill_exhausted:!0});return}ie(E,{type:"CONFIRMED"},{receipt_backend_last_checked_ts:Date.now(),receipt_backend_attempts:oe,receipt_backend_next_check_at:Date.now()+Math.min(6e4,Math.max(5e3,u*2**Math.min(5,oe)))});return}}else if(T==="confirmed")return;const ne=Date.now(),V=Math.max(0,Number((m==null?void 0:m.receipt_attempts)||0)),_e=Math.max(0,Number((m==null?void 0:m.broadcast_ts)||(m==null?void 0:m.submitted_ts)||(m==null?void 0:m.ts)||ne));if(T!=="confirmed"&&(V>=_||ne-_e>=l)){ie(E,{type:"TIMEOUT"},{receipt_last_checked_ts:ne,receipt_next_check_at:void 0,receipt_attempts:V,failure_reason:"confirmation_timeout"}),s({type:(m==null?void 0:m.metaKind)==="treasury_fee"?"TREASURY":"EXEC",msg:`${(m==null?void 0:m.metaKind)==="treasury_fee"?"Treasury payout":"Transaction"} confirmation timeout Â· txid: ${q.slice(0,16)}...`,fee:null,truthLabel:"ESTIMATED",receiptProvenance:"CHAIN"});return}let k;try{k=await wd(q)}catch(oe){const w=V+1;ie(E,{type:"POLL_PENDING"},{receipt_last_checked_ts:Date.now(),receipt_next_check_at:Date.now()+me(w),receipt_attempts:w,failure_reason:String((oe==null?void 0:oe.message)||"receipt_lookup_failed").slice(0,240)});return}const le=Date.now();if(!(k!=null&&k.found)||k.status==="pending"){const oe=V+1;oe>=_||le-_e>=l?(ie(E,{type:"TIMEOUT"},{receipt_last_checked_ts:le,receipt_next_check_at:void 0,receipt_attempts:oe,confirmations:Math.max(0,Number((k==null?void 0:k.confirmations)||0)),failure_reason:"confirmation_timeout"}),s({type:(m==null?void 0:m.metaKind)==="treasury_fee"?"TREASURY":"EXEC",msg:`${(m==null?void 0:m.metaKind)==="treasury_fee"?"Treasury payout":"Transaction"} confirmation timeout Â· txid: ${q.slice(0,16)}...`,fee:null,truthLabel:"ESTIMATED",receiptProvenance:"CHAIN"})):ie(E,{type:"POLL_PENDING"},{receipt_last_checked_ts:le,receipt_next_check_at:le+me(oe),receipt_attempts:oe,confirmations:Math.max(0,Number((k==null?void 0:k.confirmations)||0)),failure_reason:null});return}if(k.status==="failed"){ie(E,{type:"FAILED"},{receipt_last_checked_ts:le,receipt_next_check_at:void 0,receipt_attempts:V+1,confirmations:Math.max(0,Number((k==null?void 0:k.confirmations)||0)),failure_reason:"chain_rejected"}),s({type:(m==null?void 0:m.metaKind)==="treasury_fee"?"TREASURY":"ERROR",msg:`${(m==null?void 0:m.metaKind)==="treasury_fee"?"Treasury payout":"Transaction"} failed on-chain Â· txid: ${q.slice(0,16)}...`,fee:null,truthLabel:"ESTIMATED",receiptProvenance:"CHAIN"});return}const Ne=Number(o||0),ye=Ne>0?Ne:Number(await Ti().catch(()=>0))||void 0,Le=Number((k==null?void 0:k.confirmTimeMs)||(k==null?void 0:k.blockTime)||0),ve=Le>0?Le<1e12?Math.round(Le*1e3):Math.round(Le):le;ie(E,{type:"CONFIRMED"},{receipt_last_checked_ts:le,receipt_next_check_at:void 0,receipt_attempts:V+1,confirmations:Math.max(0,Number((k==null?void 0:k.confirmations)||0)),chain_confirmations:Math.max(0,Number((k==null?void 0:k.confirmations)||0)),chain_confirm_ts:ve,confirm_ts:ve,confirm_detected_ts:le,confirm_ts_source:Le>0?"chain":"poll",receipt_block_time_ms:Le>0?ve:void 0,chain_receipt_fee_sompi:Number.isFinite(Number(k==null?void 0:k.feeSompi))?Math.max(0,Math.round(Number(k==null?void 0:k.feeSompi))):void 0,receipt_fee_sompi:Number.isFinite(Number(k==null?void 0:k.feeSompi))?Math.max(0,Math.round(Number(k==null?void 0:k.feeSompi))):void 0,chain_receipt_fee_kas:Number.isFinite(Number(k==null?void 0:k.feeKas))?Math.max(0,Number(Number(k==null?void 0:k.feeKas).toFixed(8))):void 0,receipt_fee_kas:Number.isFinite(Number(k==null?void 0:k.feeKas))?Math.max(0,Number(Number(k==null?void 0:k.feeKas).toFixed(8))):void 0,receipt_mass:Number.isFinite(Number(k==null?void 0:k.mass))?Math.max(0,Math.round(Number(k==null?void 0:k.mass))):void 0,receipt_source_path:k!=null&&k.sourcePath?String(k.sourcePath).slice(0,240):void 0,failure_reason:null,...ye?{confirm_price_usd:ye}:{},...Number.isFinite(Number(m==null?void 0:m.amount_kas))&&Number.isFinite(Number(m==null?void 0:m.broadcast_price_usd))&&Number.isFinite(Number(ye))&&Number(m==null?void 0:m.amount_kas)>0&&Number(m==null?void 0:m.broadcast_price_usd)>0&&Number(ye)>0?{chain_derived_slippage_kas:Number((Math.max(0,Number((m==null?void 0:m.amount_kas)||0))*Math.abs((Number(ye)-Number((m==null?void 0:m.broadcast_price_usd)||0))/Number((m==null?void 0:m.broadcast_price_usd)||1))).toFixed(8))}:{}}),s({type:(m==null?void 0:m.metaKind)==="treasury_fee"?"TREASURY":"EXEC",msg:`${(m==null?void 0:m.metaKind)==="treasury_fee"?"Treasury payout":"Transaction"} confirmed Â· ${Math.max(0,Number((k==null?void 0:k.confirmations)||0))} conf Â· txid: ${q.slice(0,16)}...`,fee:null,truthLabel:"CHAIN CONFIRMED",receiptProvenance:"CHAIN"})},[s,Pe,I,o,me,_,u,l,ie]),We=y.useCallback(async m=>ya(t,Ns(m)),[t]),xe=y.useCallback(m=>{x(E=>[m,...E].slice(0,r))},[r]),be=y.useCallback((m,E)=>{const q=Ee(m,E);return x(T=>[q,...T].slice(0,r)),q},[Ee,r]),tt=y.useCallback(m=>{m!=null&&m.id&&te(m.id,{type:"BEGIN_SIGN"}),b(m)},[te]),He=y.useCallback(m=>{const E=M.find(q=>q.id===m);if(te(m,{type:"SIGN_REJECT"}),(E==null?void 0:E.metaKind)==="treasury_fee"){s({type:"TREASURY",msg:`Treasury fee payout rejected by operator: ${m}`,fee:null});return}s({type:"SIGN",msg:`Transaction rejected by operator: ${m}`,fee:null})},[s,M,te]),Ve=y.useCallback(()=>{R!=null&&R.id&&He(R.id),b(null)},[He,R]),Je=y.useCallback(async m=>{var q,T;const E=R?{...R,status:"signed",txid:m.txid}:m;if(R!=null&&R.id&&(te(R.id,{type:"SIGN_SUCCESS",txid:m.txid},{txid:m.txid}),Se(R.id,m.txid)),(R==null?void 0:R.metaKind)==="treasury_fee"){s({type:"TREASURY",msg:`Treasury fee payout signed: ${R==null?void 0:R.amount_kas} KAS Â· txid: ${(q=m.txid)==null?void 0:q.slice(0,16)}...`,fee:null,truthLabel:"BROADCASTED",receiptProvenance:"ESTIMATED"}),b(null);return}s({type:"EXEC",msg:`SIGNED: ${R==null?void 0:R.type} Â· ${R==null?void 0:R.amount_kas} KAS Â· txid: ${(T=m.txid)==null?void 0:T.slice(0,16)}...`,fee:.08,truthLabel:"BROADCASTED",receiptProvenance:"ESTIMATED"}),s({type:"TREASURY",msg:`Fee split â†’ Pool: ${(et*ps).toFixed(4)} KAS / Treasury: ${(et*ft).toFixed(4)} KAS`,fee:et}),b(null),typeof a=="function"&&await a(E)},[s,Se,a,R,te]),Ge=y.useCallback(()=>{x(m=>m.map(E=>E.status==="pending"?{...E,status:gn("pending",{type:"SIGN_REJECT"})}:E)),b(null)},[]),at=y.useRef(Ie),Z=y.useRef({backendReceiptImportActive:I,receiptPollBatchSize:v,backendReceiptBackfillMaxAttempts:$});y.useEffect(()=>{at.current=Ie},[Ie]),y.useEffect(()=>{Z.current={backendReceiptImportActive:I,receiptPollBatchSize:v,backendReceiptBackfillMaxAttempts:$}},[I,v,$]),y.useEffect(()=>{K.current=Array.isArray(M)?M:[]},[M]),y.useEffect(()=>{if(!Array.isArray(M)||M.length===0)return;const m=F.current,E=B.current,q=U.current;for(const T of M){if(!(T!=null&&T.id))continue;const X=String(T.id),ne=String((T==null?void 0:T.receipt_consistency_status)||""),V=Math.max(0,Number((T==null?void 0:T.receipt_consistency_checked_ts)||0));if(G&&V>0){const _e=Math.max(0,Number(q.get(X)||0));V!==_e&&(ne==="consistent"||ne==="mismatch"||ne==="insufficient")&&(q.set(X,V),Kc({txid:T==null?void 0:T.txid,queueId:X,agentId:C,agentName:N,status:ne,mismatches:Array.isArray(T==null?void 0:T.receipt_consistency_mismatches)?T.receipt_consistency_mismatches:[],provenance:String((T==null?void 0:T.receipt_imported_from)||"").toLowerCase()==="callback_consumer"?"BACKEND":"CHAIN",truthLabel:String((T==null?void 0:T.receipt_imported_from)||"").toLowerCase()==="callback_consumer"&&String((T==null?void 0:T.receipt_lifecycle)||"")==="confirmed"?"BACKEND CONFIRMED":String((T==null?void 0:T.receipt_lifecycle)||"")==="confirmed"?"CHAIN CONFIRMED":"ESTIMATED",checkedTs:V,confirmTsDriftMs:T==null?void 0:T.receipt_consistency_confirm_ts_drift_ms,feeDiffKas:T==null?void 0:T.receipt_consistency_fee_diff_kas,slippageDiffKas:T==null?void 0:T.receipt_consistency_slippage_diff_kas}).catch(()=>{}))}if(ne==="mismatch"){const _e=Math.max(0,Number(E.get(X)||0));if(V>0&&V!==_e){E.set(X,V);const k=Math.max(0,Number(m.get(X)||0))+1;m.set(X,k),p(le=>le+1),s({type:(T==null?void 0:T.metaKind)==="treasury_fee"?"TREASURY":"WARN",msg:`Receipt consistency mismatch (${(Array.isArray(T==null?void 0:T.receipt_consistency_mismatches)?T.receipt_consistency_mismatches:[]).join(",")||"unknown"}) Â· txid: ${String((T==null?void 0:T.txid)||"").slice(0,16)}...`,fee:null,truthLabel:String((T==null?void 0:T.receipt_imported_from)||"").toLowerCase()==="callback_consumer"&&String((T==null?void 0:T.receipt_lifecycle)||"")==="confirmed"?"BACKEND CONFIRMED":String((T==null?void 0:T.receipt_lifecycle)||"")==="confirmed"?"CHAIN CONFIRMED":"ESTIMATED",receiptProvenance:String((T==null?void 0:T.receipt_imported_from)||"").toLowerCase()==="callback_consumer"?"BACKEND":"CHAIN"}),typeof g=="function"&&k>=Wr&&k%Wr===0&&g({type:"risk_event",key:`receipt_consistency:${String(C||N||"agent")}:${String((T==null?void 0:T.txid)||X)}`,title:`${N||"Agent"} receipt consistency mismatch`,message:`Repeated backend/chain receipt mismatch (${k}x) for tx ${String((T==null?void 0:T.txid)||"").slice(0,16)}... mismatch=${(Array.isArray(T==null?void 0:T.receipt_consistency_mismatches)?T.receipt_consistency_mismatches:[]).join(",")||"unknown"}`,severity:"warn",meta:{agentId:C,agentName:N,txid:T==null?void 0:T.txid,queueId:X,mismatches:(T==null?void 0:T.receipt_consistency_mismatches)||[],confirmTsDriftMs:T==null?void 0:T.receipt_consistency_confirm_ts_drift_ms,feeDiffKas:T==null?void 0:T.receipt_consistency_fee_diff_kas,slippageDiffKas:T==null?void 0:T.receipt_consistency_slippage_diff_kas}})}}else ne==="consistent"&&E.set(X,V)}},[s,C,N,G,M,g]),y.useEffect(()=>{if(j.current=!1,!I||!h)return;const m=Pc({onStatus:E=>{j.current=E==="open"},onReceipt:E=>{const q=String((E==null?void 0:E.txid)||"").trim().toLowerCase();if(!/^[a-f0-9]{64}$/.test(q))return;const T=K.current;if(!Array.isArray(T)||T.length===0)return;const X=T.filter(ne=>String((ne==null?void 0:ne.txid)||"").trim().toLowerCase()===q);for(const ne of X)Pe(ne,E)}});return()=>{var E;j.current=!1;try{(E=m==null?void 0:m.close)==null||E.call(m)}catch{}}},[Pe,I,h]),y.useEffect(()=>{let m=!1;const E=()=>{if(m)return;const T=Date.now(),X=S.current,ne=Z.current,V=K.current,_e=(Array.isArray(V)?V:[]).filter(k=>(k==null?void 0:k.status)==="signed"&&/^[a-f0-9]{64}$/i.test(String((k==null?void 0:k.txid)||""))).filter(k=>{const le=String((k==null?void 0:k.receipt_lifecycle)||"submitted");if(le==="failed"||le==="timeout")return!1;if(le==="confirmed"){if(!ne.backendReceiptImportActive||k!=null&&k.receipt_backend_updated_at||j.current||k!=null&&k.receipt_backend_backfill_exhausted||Number((k==null?void 0:k.receipt_backend_attempts)||0)>=ne.backendReceiptBackfillMaxAttempts)return!1;const Ne=Number((k==null?void 0:k.receipt_backend_next_check_at)||0);return!(Ne>0)||Ne<=T}return!0}).filter(k=>{const le=String((k==null?void 0:k.receipt_lifecycle)||"submitted"),Ne=Number(le==="confirmed"&&ne.backendReceiptImportActive&&!j.current?(k==null?void 0:k.receipt_backend_next_check_at)||0:(k==null?void 0:k.receipt_next_check_at)||0);return!(Ne>0)||Ne<=T}).filter(k=>!X.has(String((k==null?void 0:k.id)||""))).slice(0,ne.receiptPollBatchSize);for(const k of _e){const le=String((k==null?void 0:k.id)||"");le&&(X.add(le),at.current(k).finally(()=>{X.delete(le)}))}};E();const q=setInterval(E,A);return()=>{m=!0,clearInterval(q)}},[A]),y.useEffect(()=>{},[r,M,d,t==null?void 0:t.address]);const we=M.filter(m=>m.status==="pending").length,Me=y.useMemo(()=>{const m={checked:0,consistent:0,mismatch:0,insufficient:0,repeatedMismatchItems:0,mismatchRatePct:0};for(const E of M){if(String((E==null?void 0:E.status)||"")!=="signed")continue;const q=String((E==null?void 0:E.receipt_consistency_status)||"insufficient");q==="consistent"?(m.checked+=1,m.consistent+=1):q==="mismatch"?(m.checked+=1,m.mismatch+=1):m.insufficient+=1,Math.max(0,Number(F.current.get(String((E==null?void 0:E.id)||""))||0))>=Wr&&(m.repeatedMismatchItems+=1)}return m.mismatchRatePct=m.checked>0?Number((m.mismatch/m.checked*100).toFixed(2)):0,m},[M,f]);return{queue:M,setQueue:x,signingItem:R,setSigningItem:b,pendingCount:we,sendWalletTransfer:We,updateQueueItemLifecycle:te,updateQueueItemReceiptLifecycle:ie,receiptBackoffMs:me,decorateBroadcastedSignedItem:Ee,markQueueItemBroadcasted:Se,prependQueueItem:xe,prependSignedBroadcastedQueueItem:be,handleQueueSign:tt,handleQueueReject:He,handleSigningReject:Ve,handleSigned:Je,rejectAllPending:Ge,receiptConsistencyMetrics:Me}}function Kd(e){const t=e.walletAddress,r=e.wsUrl||"",s=Math.max(1e3,Number(e.livePollMs)),o=Math.max(2e3,Number(e.streamReconnectMaxDelayMs)),d=Math.max(32,Number(e.maxMarketSnapshots)),a=y.useRef(!1),[u,c]=y.useState(null),[l,_]=y.useState([]),[A,v]=y.useState(!0),[g,N]=y.useState(null),[C,M]=y.useState(!1),[x,R]=y.useState(!1),[b,f]=y.useState(0),p=y.useCallback(async()=>{if(t&&!a.current){a.current=!0,v(!0),N(null);try{const[S,K,j]=await Promise.all([Rd(),Ni(t),Ti().catch(()=>null)]),F=Date.now(),B={dag:S,priceUsd:Number(j||0),walletKas:Number(K.kas||0),address:t,fetched:F};c(B),_(U=>{var $;const I=U[U.length-1],h={ts:F,priceUsd:Number(B.priceUsd||0),daaScore:Number((($=B==null?void 0:B.dag)==null?void 0:$.daaScore)||0),walletKas:Number(B.walletKas||0)};return I&&I.priceUsd===h.priceUsd&&I.daaScore===h.daaScore&&I.walletKas===h.walletKas?U:[...U,h].slice(-d)}),M(!0)}catch(S){M(!1),N((S==null?void 0:S.message)||"Kaspa live feed disconnected")}finally{v(!1),a.current=!1}}},[d,t]);return y.useEffect(()=>{if(!t)return;p();const S=setInterval(p,s);let K=null,j=null,F=null,B=!1,U=0;const I=()=>{if(B||!r)return;const G=Math.min(o,1200*2**U);U+=1,f(U),F=setTimeout(()=>{F=null,h()},G)},h=()=>{!r||B||(K=new WebSocket(r),K.onopen=()=>{U=0,f(0),R(!0)},K.onmessage=()=>{j||(j=setTimeout(()=>{j=null,p()},1200))},K.onerror=()=>{B||R(!1)},K.onclose=()=>{R(!1),B||I()})};return r&&h(),()=>{B=!0,clearInterval(S),j&&clearTimeout(j),F&&clearTimeout(F),K&&K.close()}},[s,p,o,t,r]),{kasData:u,setKasData:c,marketHistory:l,setMarketHistory:_,kasDataLoading:A,setKasDataLoading:v,kasDataError:g,setKasDataError:N,liveConnected:C,setLiveConnected:M,streamConnected:x,streamRetryCount:b,refreshKasData:p}}const fe=(e,t,r)=>Math.min(r,Math.max(t,e)),ke=(e,t=0)=>{const r=Number(e);return Number.isFinite(r)?r:t};function jd(e){const t=String(e||"HOLD").toUpperCase();return t==="ACCUMULATE"?1:t==="REBALANCE"?.75:t==="REDUCE"?.35:.5}function Fd(e){const t=String(e||"NEUTRAL").toUpperCase();return t==="RISK_OFF"?.2:t==="RANGE_VOL"?.6:t==="TREND_UP"||t==="FLOW_ACCUMULATION"?1.1:.85}function Ud(e,t,r){const s=String(e||t||"custom").toLowerCase(),o=String(r||"NEUTRAL").toUpperCase(),d=/trend|momentum/.test(s),a=/mean[_ -]?reversion|reversion|range/.test(s),u=/breakout|volatility/.test(s),c=/\bdca\b|accumulator|accumulation/.test(s);return d?o==="TREND_UP"||o==="FLOW_ACCUMULATION"?1.16:o==="RISK_OFF"?.72:o==="RANGE_VOL"?.9:1:a?o==="RANGE_VOL"?1.14:o==="TREND_UP"?.86:o==="RISK_OFF"?.76:1:u?o==="TREND_UP"?1.08:o==="RANGE_VOL"?1.05:o==="RISK_OFF"?.74:1:c?o==="RISK_OFF"?.92:o==="FLOW_ACCUMULATION"||o==="TREND_UP"?1.08:1.02:1}function $d(e){const{calibrationRouting:t,templateRegimeBoost:r,regime:s,action:o}=e;let d=1;return t.samplesSufficient||(d*=.92),t.tier==="watch"&&(d*=.88),t.tier==="degraded"&&(d*=.68),t.tier==="critical"&&(d*=.45),t.truthDegraded&&(d*=fe(1-t.truthMismatchRatePct/140,.55,.9)),r<1&&(d*=fe(.65+r*.35,.58,.95)),String(s||"").toUpperCase()==="RISK_OFF"&&(d*=.72),String(o||"").toUpperCase()==="REDUCE"&&(d*=.65),fe(d,.2,1)}function Bd(e){const t=fe(ke(e==null?void 0:e.confidenceBrierScore,0),0,1),r=fe(ke(e==null?void 0:e.evCalibrationErrorPct,0),0,100),s=fe(ke(e==null?void 0:e.regimeHitRatePct,0),0,100),o=Math.max(0,ke(e==null?void 0:e.regimeHitSamples,0)),d=!!(e!=null&&e.truthDegraded),a=fe(ke(e==null?void 0:e.truthMismatchRatePct,0),0,100),u=fe(ke((e==null?void 0:e.realizedReceiptCoveragePct)??(e==null?void 0:e.receiptCoveragePct),0),0,100),c=o>=8,l=fe(1-t/.35,0,1.1),_=fe(1-r/20,0,1.1),A=fe(s/100,0,1.1),v=c?l*.4+_*.35+A*.25:.88,g=d?fe(1-a/120,.35,.92):1,N=fe(.7+u/100*.35,.7,1.05),C=fe(v*g*N,.2,1.1),M=c?fe(.35+C*.85,.3,1.2):.9,x=C<.42?"critical":C<.62?"degraded":C<.82?"watch":"healthy";return{samplesSufficient:c,brier:t,evCalErr:r,regimeHitRatePct:s,regimeHitSamples:o,truthDegraded:d,truthMismatchRatePct:a,receiptCoveragePct:u,health:C,sizeMultiplier:M,truthQualityScore:fe((d?.5:.9)*N*g,.2,1.1),tier:x}}function Dd(e){const t=[];return e.enabled||t.push("disabled in allocator"),e.regime==="RISK_OFF"&&t.push("risk-off regime throttle"),e.queuePressurePct>20&&t.push("queue pressure high"),e.risk>.7&&t.push("elevated risk score"),e.confidence<.7&&t.push("low confidence"),e.dataQuality<.5&&t.push("limited data quality"),(e.calibrationTier==="critical"||e.calibrationTier==="degraded")&&t.push("calibration routing throttle"),e.truthDegraded&&t.push("truth quality degraded"),e.action==="REDUCE"&&t.push("reduce signal active"),e.strategyTemplate&&t.push(`template:${String(e.strategyTemplate).slice(0,24)}`),t.length||t.push("within shared budget guardrails"),t.slice(0,4)}function zd(e){var M,x,R,b;const t=Math.max(0,ke(e.walletKas,0)),r=Math.max(0,ke((M=e.config)==null?void 0:M.reserveKas,5)),s=Math.max(0,t-r),o=fe(ke((x=e.config)==null?void 0:x.totalBudgetPct,.85),.05,1),d=fe(ke((R=e.config)==null?void 0:R.maxAgentAllocationPct,.5),.05,1),a=fe(ke((b=e.config)==null?void 0:b.rebalanceThresholdPct,.08),.01,.5),u=s*o,l=(Array.isArray(e.agents)?e.agents:[]).map(f=>{const p=(f==null?void 0:f.lastDecision)||{},S=(p==null?void 0:p.quant_metrics)||{},K=fe(ke(p==null?void 0:p.risk_score,.75),0,1),j=fe(ke(p==null?void 0:p.confidence_score,.55),0,1),F=fe(ke(S==null?void 0:S.data_quality_score,.45),0,1),B=String((p==null?void 0:p.action)||"HOLD").toUpperCase(),U=String((S==null?void 0:S.regime)||"NEUTRAL").toUpperCase(),I=Math.max(.1,ke(S==null?void 0:S.risk_ceiling,.65)),h=fe((I-K)/I,-1,1),G=Math.max(0,ke(f==null?void 0:f.pendingKas,0)),$=Math.max(0,ke(f==null?void 0:f.capitalLimitKas,0)),W=fe(ke(f==null?void 0:f.targetAllocationPct,0),0,100),Y=fe(ke(f==null?void 0:f.riskBudgetWeight,1),0,10),te=(f==null?void 0:f.enabled)!==!1,ie=$>0?fe(G/$*100,0,500):0,me=String((f==null?void 0:f.strategyTemplate)||(f==null?void 0:f.strategyClass)||"custom"),Ee=String((f==null?void 0:f.strategyClass)||""),Se=Bd(f==null?void 0:f.attributionSummary),Pe=Ud(me,Ee,U),Ie=W>0?W/100:0,We=fe(.25+j*.45+Math.max(0,h)*.2+F*.1,.05,1.1),xe=fe(1-ie/160,.2,1),be=te?Math.max(0,(Ie>0?Ie:Y*.2)*We*jd(B)*Fd(U)*Pe*Se.sizeMultiplier*xe):0;return{agentId:String((f==null?void 0:f.agentId)||(f==null?void 0:f.name)||"agent"),name:String((f==null?void 0:f.name)||(f==null?void 0:f.agentId)||"Agent"),enabled:te,targetPct:W,riskWeight:Y,capitalLimitKas:$,pendingKas:G,strategyTemplate:me,strategyClass:Ee,templateRegimeBoost:Pe,action:B,regime:U,confidence:j,risk:K,dataQuality:F,calibrationRouting:Se,score:be,queuePressurePct:ie}}),_=l.reduce((f,p)=>f+p.score,0),A=l.reduce((f,p)=>f+(p.enabled?Math.max(.1,p.riskWeight):0),0),v=l.map(f=>{const p=_>0?f.score/_:f.enabled?Math.max(.1,f.riskWeight)/Math.max(.1,A):0,S=$d({calibrationRouting:f.calibrationRouting,templateRegimeBoost:f.templateRegimeBoost,regime:f.regime,action:f.action}),K=fe(d*S,.02,1),j=u*p,F=Math.min(j,u*K),B=u>0?fe(F/u*100,0,100):0,U=Math.min(F,f.capitalLimitKas>0?f.capitalLimitKas:F,Math.max(0,u*K)),I=F-f.pendingKas;return{agentId:f.agentId,name:f.name,enabled:f.enabled,targetPct:f.targetPct,riskWeight:f.riskWeight,score:Number(f.score.toFixed(6)),routingCapMultiplier:Number(S.toFixed(4)),maxShareCapPct:Number((K*100).toFixed(2)),templateRegimeMultiplier:Number(f.templateRegimeBoost.toFixed(4)),budgetPct:Number(B.toFixed(2)),budgetKas:Number(F.toFixed(6)),cycleCapKas:Number(Math.max(0,U).toFixed(6)),queuePressurePct:Number(f.queuePressurePct.toFixed(2)),strategyTemplate:f.strategyTemplate,calibrationHealth:Number(f.calibrationRouting.health.toFixed(4)),calibrationTier:f.calibrationRouting.tier,truthQualityScore:Number(f.calibrationRouting.truthQualityScore.toFixed(4)),regime:f.regime,action:f.action,confidence:Number(f.confidence.toFixed(4)),risk:Number(f.risk.toFixed(4)),dataQuality:Number(f.dataQuality.toFixed(4)),rebalanceDeltaKas:Math.abs(I)>=u*a?Number(I.toFixed(6)):0,notes:Dd({enabled:f.enabled,action:f.action,regime:f.regime,strategyTemplate:f.strategyTemplate,queuePressurePct:f.queuePressurePct,risk:f.risk,confidence:f.confidence,dataQuality:f.dataQuality,calibrationTier:f.calibrationRouting.tier,truthDegraded:f.calibrationRouting.truthDegraded}).concat(S<.999||j>F+1e-9?["dynamic concentration cap"]:[]).slice(0,5)}}),g=v.reduce((f,p)=>f+p.budgetKas,0),N=v.length?Math.max(...v.map(f=>u>0?f.budgetKas/u*100:0)):0,C=v.length?v.reduce((f,p)=>f+p.budgetPct*p.risk,0)/100:0;return v.sort((f,p)=>p.budgetKas-f.budgetKas||f.name.localeCompare(p.name)),{walletKas:Number(t.toFixed(6)),reserveKas:Number(r.toFixed(6)),allocatableKas:Number(s.toFixed(6)),targetBudgetKas:Number(u.toFixed(6)),allocatedKas:Number(g.toFixed(6)),utilizationPct:Number((u>0?g/u*100:0).toFixed(2)),concentrationPct:Number(N.toFixed(2)),riskWeightedExposurePct:Number(C.toFixed(4)),rows:v}}const Wd="forgeos.portfolio.v1",Zt={version:1,updatedAt:0,totalBudgetPct:.85,reserveKas:5,maxAgentAllocationPct:.5,rebalanceThresholdPct:.08,agentOverrides:{}};function Hd(e){return String(e||"default").trim().toLowerCase().replace(/[^a-z0-9:_-]/g,"_").slice(0,180)}function vi(e){return`${Wd}:${Hd(e)||"default"}`}function Ft(e,t,r){return Math.min(r,Math.max(t,e))}function br(e,t){const r=Number(e);return Number.isFinite(r)?r:t}function Vd(e){if(!e||typeof e!="object")return{};const t={};return typeof e.enabled=="boolean"&&(t.enabled=e.enabled),Number.isFinite(Number(e.targetAllocationPct))&&(t.targetAllocationPct=Ft(Number(e.targetAllocationPct),0,100)),Number.isFinite(Number(e.riskWeight))&&(t.riskWeight=Ft(Number(e.riskWeight),0,10)),t}function Ii(e){const t={};if(e!=null&&e.agentOverrides&&typeof e.agentOverrides=="object")for(const[r,s]of Object.entries(e.agentOverrides)){const o=String(r||"").trim().toLowerCase().slice(0,120);o&&(t[o]=Vd(s))}return{version:1,updatedAt:Date.now(),totalBudgetPct:Ft(br(e==null?void 0:e.totalBudgetPct,Zt.totalBudgetPct),.05,1),reserveKas:Ft(br(e==null?void 0:e.reserveKas,Zt.reserveKas),0,1e6),maxAgentAllocationPct:Ft(br(e==null?void 0:e.maxAgentAllocationPct,Zt.maxAgentAllocationPct),.05,1),rebalanceThresholdPct:Ft(br(e==null?void 0:e.rebalanceThresholdPct,Zt.rebalanceThresholdPct),.01,.5),agentOverrides:t}}function Jr(){return{...Zt,updatedAt:Date.now(),agentOverrides:{}}}function Nn(e){if(typeof window>"u")return Jr();try{const t=window.localStorage.getItem(vi(e));return t?Ii(JSON.parse(t)):Jr()}catch{return Jr()}}function Gd(e,t){if(!(typeof window>"u"))try{window.localStorage.setItem(vi(e),JSON.stringify(Ii(t)))}catch{}}function Yd(e){const{portfolioScope:t,allAgents:r,activeAgentId:s,walletAddress:o,walletKas:d,activeDecisions:a,activeQueue:u,activeAttributionSummary:c}=e,[l,_]=y.useState(()=>Nn(t)),[A,v]=y.useState(0),[g,N]=y.useState(()=>({}));y.useEffect(()=>{_(Nn(t))},[t]),y.useEffect(()=>{const f=setTimeout(()=>{Gd(t,l)},200);return()=>clearTimeout(f)},[l,t]),y.useEffect(()=>{const f=String(s||""),p=()=>{const K={};for(const j of r){const F=String((j==null?void 0:j.agentId)||(j==null?void 0:j.name)||"");if(!F||F===f)continue;const B=`${Te}:${String(o||"unknown").toLowerCase()}:${F.toLowerCase()}`;K[F]=bi(B)||{}}N(K)};p();const S=setInterval(p,4e3);return()=>clearInterval(S)},[s,r,A,o]);const C=y.useMemo(()=>{const f=r.map(p=>{var h;const S=String((p==null?void 0:p.agentId)||(p==null?void 0:p.name)||""),j=S===String(s||"")?{queue:u,decisions:a,attributionSummary:c}:g[S]||{},F=Array.isArray(j.decisions)?(h=j.decisions[0])==null?void 0:h.dec:void 0,B=Array.isArray(j.queue)?j.queue.filter(G=>(G==null?void 0:G.status)==="pending"&&(G==null?void 0:G.metaKind)!=="treasury_fee").reduce((G,$)=>G+Number(($==null?void 0:$.amount_kas)||0),0):0,U=S.toLowerCase(),I=((l==null?void 0:l.agentOverrides)||{})[U]||{};return{agentId:S,name:String((p==null?void 0:p.name)||S),enabled:I.enabled!==!1,capitalLimitKas:Number((p==null?void 0:p.capitalLimit)||0),targetAllocationPct:Number(I.targetAllocationPct??(p==null?void 0:p.portfolioAllocationPct)??Math.round(100/Math.max(1,r.length))),riskBudgetWeight:Number(I.riskWeight??(p==null?void 0:p.riskBudgetWeight)??1),strategyTemplate:String((p==null?void 0:p.strategyTemplate)||(p==null?void 0:p.strategyLabel)||(p==null?void 0:p.strategyClass)||"custom"),strategyClass:String((p==null?void 0:p.strategyClass)||""),attributionSummary:j.attributionSummary||void 0,pendingKas:B,lastDecision:F}});return zd({walletKas:Number(d||0),agents:f,config:l})},[s,c,a,u,r,g,l,d]),M=y.useMemo(()=>{var f;return((f=C==null?void 0:C.rows)==null?void 0:f.find(p=>String(p==null?void 0:p.agentId)===String(s)))||null},[s,C]);return{portfolioConfig:l,setPortfolioConfig:_,peerRuntimeCache:g,portfolioSummary:C,activePortfolioRow:M,patchPortfolioConfig:f=>{_(p=>({...p,...f,updatedAt:Date.now()}))},patchPortfolioAgentOverride:(f,p)=>{const S=String(f||"").toLowerCase();S&&(_(K=>({...K,updatedAt:Date.now(),agentOverrides:{...(K==null?void 0:K.agentOverrides)||{},[S]:{...((K==null?void 0:K.agentOverrides)||{})[S]||{},...p}}})),v(K=>K+1))},refreshPortfolioPeers:()=>{v(f=>f+1)}}}function Xd(e){const{enabled:t,treasuryFeeKas:r,treasuryAddress:s,walletAddress:o,walletProvider:d,kasPriceUsd:a=0,maxQueueEntries:u,addLog:c,setQueue:l,sendWalletTransfer:_,receiptBackoffMs:A}=e,v=y.useCallback(x=>kr({id:vr(),type:"TREASURY_FEE",metaKind:"treasury_fee",from:o,to:s,amount_kas:Number(Number(r||0).toFixed(6)),purpose:`Protocol treasury fee${x!=null&&x.txid?` Â· parent ${String(x.txid).slice(0,12)}`:""}`,status:"pending",ts:Date.now(),parentActionId:(x==null?void 0:x.id)||null,parentTxid:(x==null?void 0:x.txid)||null}),[s,r,o]),g=y.useCallback(x=>!t||!(r>0)||!x||(x==null?void 0:x.metaKind)==="treasury_fee"||String((x==null?void 0:x.type)||"").toUpperCase()!=="ACCUMULATE"?!1:he.supportsNativeMultiOutput(String(d||"")),[t,r,d]),N=y.useCallback(x=>{if(!g(x))return x;const b=[...(Array.isArray(x==null?void 0:x.outputs)&&x.outputs.length?x.outputs:[{to:x.to,amount_kas:x.amount_kas,tag:"primary"}]).filter(f=>String((f==null?void 0:f.tag)||"").toLowerCase()!=="treasury"),{to:s,amount_kas:Number(Number(r||0).toFixed(6)),tag:"treasury"}];return kr({...x,outputs:b,treasuryCombined:!0,treasuryCombinedWalletProvider:d||null,treasuryCombinedFeeKas:Number(Number(r||0).toFixed(6)),treasuryCombinedAddress:s})},[g,s,r,d]),C=y.useCallback((x,R)=>{if(!t||!(r>0))return null;const b=v(x);return l(f=>f.some(S=>(S==null?void 0:S.metaKind)==="treasury_fee"&&(S==null?void 0:S.parentActionId)&&S.parentActionId===b.parentActionId&&(S.status==="pending"||S.status==="signed"||S.status==="signing"))?f:[b,...f].slice(0,u)),c({type:"TREASURY",msg:`Treasury fee payout queued${R?` (${R})`:""}: ${b.amount_kas} KAS â†’ ${s.slice(0,18)}...`,fee:null}),b},[c,v,t,u,l,s,r]),M=y.useCallback(async(x,R)=>{if(!t||!(r>0)||!x||x.metaKind==="treasury_fee")return null;if(x!=null&&x.treasuryCombined)return c({type:"TREASURY",msg:`Treasury fee combined in primary transaction (${String((x==null?void 0:x.treasuryCombinedWalletProvider)||"wallet")}) Â· ${Number((x==null?void 0:x.treasuryCombinedFeeKas)||r).toFixed(6)} KAS`,fee:null}),(x==null?void 0:x.txid)||null;const b=v(x);try{const f=await _(b),p=Date.now(),S=Number(a||0);return l(K=>{const j=K.filter(F=>!((F==null?void 0:F.metaKind)==="treasury_fee"&&(F!=null&&F.parentActionId)&&F.parentActionId===b.parentActionId));return[{...b,status:"signed",txid:f,receipt_lifecycle:"broadcasted",broadcast_ts:p,receipt_attempts:0,confirmations:0,receipt_next_check_at:p+A(0),receipt_last_checked_ts:void 0,failure_reason:null,...S>0?{broadcast_price_usd:S}:{}},...j].slice(0,u)}),c({type:"TREASURY",msg:`Treasury fee payout sent (${R}): ${b.amount_kas} KAS â†’ ${s.slice(0,18)}... Â· txid: ${String(f).slice(0,16)}...`,fee:null}),f}catch(f){return C(x,(f==null?void 0:f.message)||"wallet rejected"),null}},[c,v,t,C,a,u,A,_,l,s,r]);return{canCombineTreasuryWithAction:g,attachCombinedTreasuryOutput:N,enqueueTreasuryFeeTx:C,settleTreasuryFeePayout:M}}function qd({queue:e,wallet:t,onSign:r,onReject:s,receiptConsistencyMetrics:o}){const d=l=>l==="confirmed"?i.ok:l==="failed"||l==="timeout"?i.danger:l==="pending_confirm"||l==="broadcasted"?i.warn:i.dim,a=l=>{if(String((l==null?void 0:l.status)||"")!=="signed")return null;const _=String((l==null?void 0:l.receipt_imported_from)||"").toLowerCase(),A=String((l==null?void 0:l.receipt_source_path)||"").toLowerCase(),v=String((l==null?void 0:l.confirm_ts_source)||"").toLowerCase();return _==="callback_consumer"||A.includes("callback-consumer")?{text:"BACKEND",color:i.purple}:_==="kaspa_api"||v==="chain"?{text:"CHAIN",color:i.ok}:{text:"ESTIMATED",color:i.warn}},u=l=>{if(String((l==null?void 0:l.status)||"")!=="signed")return{text:"ESTIMATED",color:i.warn};const _=a(l),A=String((l==null?void 0:l.receipt_lifecycle)||"submitted");return A==="confirmed"?_.text==="BACKEND"?{text:"BACKEND CONFIRMED",color:i.purple}:_.text==="CHAIN"?{text:"CHAIN CONFIRMED",color:i.ok}:{text:"ESTIMATED",color:i.warn}:A==="broadcasted"||A==="pending_confirm"||A==="submitted"?{text:"BROADCASTED",color:i.warn}:{text:"ESTIMATED",color:i.warn}},c=l=>{if(String((l==null?void 0:l.status)||"")!=="signed")return null;const _=String((l==null?void 0:l.receipt_consistency_status)||"insufficient");return _==="consistent"?{text:"CONSISTENT",color:i.ok}:_==="mismatch"?{text:"MISMATCH",color:i.danger}:{text:"CHECKING",color:i.dim}};return n.jsxs("div",{children:[n.jsx("div",{style:{fontSize:13,color:i.text,fontWeight:700,...L,marginBottom:4},children:"Action Queue"}),n.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:8,alignItems:"center",marginBottom:16},children:[n.jsx("div",{style:{fontSize:12,color:i.dim},children:"Transactions pending wallet signature. Auto-approved items processed immediately."}),o&&n.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[n.jsx(ee,{text:`RC ${Number(o.checked||0)} checked`,color:i.dim}),n.jsx(ee,{text:`OK ${Number(o.consistent||0)}`,color:i.ok}),n.jsx(ee,{text:`MM ${Number(o.mismatch||0)}`,color:i.danger}),Number(o.repeatedMismatchItems||0)>0&&n.jsx(ee,{text:`REPEAT ${Number(o.repeatedMismatchItems||0)}`,color:i.warn})]})]}),e.length===0&&n.jsxs(ge,{p:32,style:{textAlign:"center"},children:[n.jsx("div",{style:{fontSize:13,color:i.dim,...L,marginBottom:4},children:"Queue empty"}),n.jsx("div",{style:{fontSize:12,color:i.dim},children:"Pending transactions will appear here awaiting your wallet signature."})]}),e.map(l=>n.jsxs(ge,{p:18,"data-testid":`queue-item-${String(l.id)}`,style:{marginBottom:10,border:`1px solid ${l.status==="pending"?i.warn:l.status==="signed"?i.ok:i.border}25`},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:12},children:[n.jsxs("div",{children:[n.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:4},children:[n.jsx(ee,{"data-testid":`queue-item-type-${String(l.id)}`,text:l.type,color:i.purple}),n.jsx(ee,{"data-testid":`queue-item-status-${String(l.id)}`,text:l.status.toUpperCase(),color:l.status==="pending"?i.warn:l.status==="signed"?i.ok:i.dim,dot:!0}),l.status==="signed"&&n.jsx(ee,{"data-testid":`queue-item-receipt-${String(l.id)}`,text:String(l.receipt_lifecycle||"submitted").toUpperCase().replace(/_/g," "),color:d(String(l.receipt_lifecycle||"submitted")),dot:!0}),l.status==="signed"&&n.jsx(ee,{"data-testid":`queue-item-truth-${String(l.id)}`,text:u(l).text,color:u(l).color}),l.status==="signed"&&(()=>{const _=a(l);return _?n.jsx(ee,{"data-testid":`queue-item-provenance-${String(l.id)}`,text:_.text,color:_.color}):null})(),l.status==="signed"&&(()=>{const _=c(l);return _?n.jsx(ee,{"data-testid":`queue-item-consistency-${String(l.id)}`,text:_.text,color:_.color}):null})()]}),n.jsx("div",{style:{fontSize:11,color:i.dim,...L},children:$n(l.ts)})]}),n.jsxs("div",{style:{fontSize:18,color:l.amount_kas>0?i.accent:i.danger,fontWeight:700,...L},children:[l.amount_kas," KAS"]})]}),n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:l.status==="pending"?12:0,fontSize:12,color:i.dim,...L},children:[n.jsxs("div",{children:["To: ",n.jsx("span",{style:{color:i.text},children:Ze(l.to)})]}),n.jsx("div",{children:l.metaKind==="treasury_fee"?n.jsxs(n.Fragment,{children:["Routing: ",n.jsx("span",{style:{color:i.warn},children:"Treasury payout transfer"})]}):l!=null&&l.treasuryCombined?n.jsxs(n.Fragment,{children:["Routing: ",n.jsxs("span",{style:{color:i.ok},children:["Combined treasury output (",Array.isArray(l==null?void 0:l.outputs)?l.outputs.length:2," outputs)"]})]}):n.jsxs(n.Fragment,{children:["Fee split: ",n.jsxs("span",{style:{color:i.text},children:["Pool ",(et*ps).toFixed(4)," / Treasury ",(et*ft).toFixed(4)]})]})})]}),l.status==="pending"&&n.jsxs("div",{style:{display:"flex",gap:8},children:[n.jsx(pe,{onClick:()=>s(l.id),variant:"danger",size:"sm",children:"REJECT"}),n.jsx(pe,{"data-testid":`queue-item-sign-${String(l.id)}`,onClick:()=>r(l),size:"sm",children:"SIGN & BROADCAST"})]}),l.status==="signed"&&l.txid&&n.jsxs("div",{children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"},children:[n.jsxs("span",{style:{fontSize:11,color:i.ok,...L},children:["âœ“ ",l.txid.slice(0,32),"..."]}),typeof l.confirmations=="number"&&n.jsxs("span",{style:{fontSize:11,color:i.dim,...L},children:["conf: ",Math.max(0,Number(l.confirmations||0))]}),n.jsx(Ct,{href:`${Ut}/txs/${l.txid}`,label:"EXPLORER â†—"})]}),(l.receipt_lifecycle==="failed"||l.receipt_lifecycle==="timeout")&&l.failure_reason&&n.jsxs("div",{style:{fontSize:11,color:i.danger,...L,marginTop:6},children:["receipt: ",String(l.failure_reason)]})]})]},l.id))]})}function Qd(e){const t=String(e||"").toLowerCase();return t==="hybrid-ai"?i.accent:t==="quant-core"?i.text:t==="fallback"?i.warn:i.purple}function Jd(e){return String(e||"").toLowerCase().includes("mainnet")?i.warn:i.ok}function Zd(e){var _,A,v,g,N,C,M,x;const{networkLabel:t,status:r,execMode:s,liveExecutionArmed:o,autoCycleCountdownLabel:d,lastDecisionSource:a,usage:u,executionGuardrails:c,receiptConsistencyMetrics:l}=e;return n.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[n.jsx(ee,{text:t.toUpperCase(),color:Jd(t)}),n.jsx(ee,{text:r,color:r==="RUNNING"?i.ok:i.warn,dot:!0}),n.jsx(ee,{text:s.toUpperCase(),color:i.accent}),n.jsx(ee,{text:o?"EXEC ARMED":"EXEC SAFE",color:o?i.ok:i.warn,dot:!0}),n.jsx(ee,{text:`AUTO ${d}`,color:r==="RUNNING"?i.ok:i.dim}),n.jsx(ee,{text:`SOURCE ${a.toUpperCase()}`,color:Qd(a)}),n.jsx(ee,{text:`CYCLES ${u.used}`,color:i.dim}),n.jsx(ee,{text:`CAL ${String(((_=c==null?void 0:c.calibration)==null?void 0:_.tier)||"healthy").toUpperCase()} ${Number(((A=c==null?void 0:c.calibration)==null?void 0:A.health)||1).toFixed(2)}`,color:((v=c==null?void 0:c.calibration)==null?void 0:v.tier)==="critical"?i.danger:((g=c==null?void 0:c.calibration)==null?void 0:g.tier)==="degraded"||((N=c==null?void 0:c.calibration)==null?void 0:N.tier)==="warn"?i.warn:i.ok}),n.jsx(ee,{text:(C=c==null?void 0:c.truth)!=null&&C.degraded?`TRUTH DEGRADED ${Number(((M=c==null?void 0:c.truth)==null?void 0:M.mismatchRatePct)||0).toFixed(1)}%`:`TRUTH OK ${Number((l==null?void 0:l.mismatchRatePct)||0).toFixed(1)}%`,color:(x=c==null?void 0:c.truth)!=null&&x.degraded?i.danger:i.ok})]})}function el(e){var _,A,v,g;const{kasDataError:t,refreshKasData:r,kasDataLoading:s,liveExecutionArmed:o,liveExecutionReady:d,executionGuardrails:a,pendingCount:u,isMobile:c,setTab:l}=e;return n.jsxs(n.Fragment,{children:[!!t&&n.jsxs("div",{style:{background:i.dLow,border:`1px solid ${i.danger}40`,borderRadius:6,padding:"11px 16px",marginBottom:14,display:"flex",alignItems:"center",justifyContent:"space-between",gap:10},children:[n.jsxs("span",{style:{fontSize:12,color:i.danger,...L},children:["Kaspa live feed error (poll fallback): ",t]}),n.jsx(pe,{onClick:r,disabled:s,size:"sm",variant:"ghost",children:s?"RECONNECTING...":"RECONNECT FEED"})]}),o&&!d&&n.jsx("div",{style:{background:i.wLow,border:`1px solid ${i.warn}40`,borderRadius:6,padding:"11px 16px",marginBottom:14},children:n.jsx("span",{style:{fontSize:12,color:i.warn,...L},children:"Live execution is armed but not ready. Require DAG live feed and a real wallet provider session (Kasware, Kaspium, Kastle, Ghost, Tangem bridge, or OneKey bridge)."})}),((_=a==null?void 0:a.truth)==null?void 0:_.degraded)&&n.jsxs("div",{style:{background:i.dLow,border:`1px solid ${i.danger}40`,borderRadius:6,padding:"11px 16px",marginBottom:14,display:"flex",justifyContent:"space-between",gap:10,flexWrap:"wrap"},children:[n.jsxs("span",{style:{fontSize:12,color:i.danger,...L},children:["Truth degraded: backend vs chain receipt mismatch rate ",a.truth.mismatchRatePct,"% (",a.truth.mismatches,"/",a.truth.checked," checks). Realized PnL is downgraded to hybrid while mismatch rate exceeds policy."]}),a.truth.autoApproveDisabled&&n.jsx(ee,{text:"AUTO-APPROVE BLOCKED (TRUTH)",color:i.danger})]}),((A=a==null?void 0:a.calibration)==null?void 0:A.enabled)&&((v=a==null?void 0:a.calibration)==null?void 0:v.samplesSufficient)&&((g=a==null?void 0:a.calibration)==null?void 0:g.tier)!=="healthy"&&n.jsxs("div",{style:{background:i.wLow,border:`1px solid ${a.calibration.tier==="critical"?i.danger:i.warn}40`,borderRadius:6,padding:"11px 16px",marginBottom:14,display:"flex",justifyContent:"space-between",gap:10,flexWrap:"wrap"},children:[n.jsxs("span",{style:{fontSize:12,color:a.calibration.tier==="critical"?i.danger:i.warn,...L},children:["Calibration guardrail ",String(a.calibration.tier).toUpperCase()," Â· health ",a.calibration.health.toFixed(3)," Â· size multiplier ",a.calibration.sizeMultiplier.toFixed(2),a.calibration.autoApproveDisabled?" Â· auto-approve disabled":"",a.calibration.autoApproveDisableDeferred?" Â· size-first throttle (auto-approve still enabled)":""]}),n.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[n.jsx(ee,{text:`BRIER ${Number(a.calibration.metrics.brier||0).toFixed(4)}`,color:i.dim}),n.jsx(ee,{text:`EV CAL ${Number(a.calibration.metrics.evCalErrorPct||0).toFixed(2)}%`,color:i.dim}),n.jsx(ee,{text:`REGIME ${Number(a.calibration.metrics.regimeHitRatePct||0).toFixed(1)}%`,color:i.dim})]})]}),u>0&&n.jsxs("div",{style:{background:i.wLow,border:`1px solid ${i.warn}40`,borderRadius:6,padding:"11px 16px",marginBottom:14,display:"flex",alignItems:c?"flex-start":"center",justifyContent:"space-between",flexDirection:c?"column":"row",gap:c?8:0},children:[n.jsxs("span",{style:{fontSize:12,color:i.warn,...L},children:["âš  ",u," transaction",u>1?"s":""," awaiting wallet signature"]}),n.jsx(pe,{onClick:()=>l("queue"),size:"sm",variant:"warn",children:"VIEW QUEUE"})]})]})}function tl({agent:e,wallet:t}){var h,G;const[r,s]=y.useState(null),[o,d]=y.useState([]),[a,u]=y.useState(!1),[c,l]=y.useState(null),[_,A]=y.useState(null),[v,g]=y.useState(null),[N,C]=y.useState(""),[M,x]=y.useState(""),[R,b]=y.useState(""),[f,p]=y.useState(typeof window<"u"?window.innerWidth:1200),S=y.useCallback(async()=>{u(!0),l(null);try{let $;(t==null?void 0:t.provider)==="kasware"?$=await he.getKaswareBalance():$=(await Ni((t==null?void 0:t.address)||e.wallet)).kas;const W=await Md((t==null?void 0:t.address)||e.wallet);s($),d(Array.isArray(W)?W.slice(0,10):[]),A(new Date)}catch($){l($.message)}u(!1)},[t,e]);y.useEffect(()=>{S()},[S]),y.useEffect(()=>{if(typeof window>"u")return;const $=()=>p(window.innerWidth);return window.addEventListener("resize",$),()=>window.removeEventListener("resize",$)},[]);const K=parseFloat(r??e.capitalLimit??0),j=Math.max(0,K-er-vt),F=j.toFixed(4),B=f<760,U=()=>{const $=Number(M);!St(N,Ae)||!($>0)||$>j||g({type:"WITHDRAW",from:t==null?void 0:t.address,to:N,amount_kas:Number($.toFixed(6)),purpose:R||"Withdrawal"})},I=()=>{g(null),C(""),x(""),b("")};return n.jsxs("div",{children:[v&&n.jsx(Ts,{tx:v,wallet:t,onSign:I,onReject:()=>g(null)}),n.jsxs(ge,{p:20,style:{marginBottom:12},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:14},children:[n.jsxs("div",{style:{flex:1,minWidth:0},children:[n.jsxs(Ce,{children:["Connected Wallet â€” ",Qe]}),n.jsx("div",{style:{fontSize:12,color:i.accent,...L,wordBreak:"break-all",marginBottom:10},children:(t==null?void 0:t.address)||"â€”"}),n.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[n.jsx(pe,{onClick:()=>{var $;return($=navigator.clipboard)==null?void 0:$.writeText((t==null?void 0:t.address)||"")},variant:"ghost",size:"sm",children:"COPY"}),n.jsx(Ct,{href:`${Ut}/addresses/${t==null?void 0:t.address}`,label:"EXPLORER â†—"})]})]}),n.jsxs("div",{style:{display:"flex",gap:6,alignItems:"center",flexShrink:0,marginLeft:14},children:[n.jsx(ee,{text:(t==null?void 0:t.provider)==="demo"?"DEMO":((h=t==null?void 0:t.provider)==null?void 0:h.toUpperCase())||"â€”",color:["kasware","kastle","ghost"].includes(String((t==null?void 0:t.provider)||""))?i.ok:i.warn,dot:!0}),n.jsx(pe,{onClick:S,disabled:a,size:"sm",variant:"ghost",children:a?"...":"REFRESH"})]})]}),c&&n.jsxs("div",{style:{background:i.dLow,border:`1px solid ${i.danger}30`,borderRadius:4,padding:"8px 12px",marginBottom:12,fontSize:12,color:i.danger,...L},children:["RPC: ",c]}),n.jsx("div",{style:{display:"grid",gridTemplateColumns:B?"1fr":"repeat(3,1fr)",gap:12},children:[["Balance",`${r??e.capitalLimit} KAS`,r?i.accent:i.warn],["UTXOs",r?String(o.length):"â€”",i.text],["Network",(t==null?void 0:t.network)||Te,i.dim]].map(([$,W,Y])=>n.jsxs("div",{children:[n.jsx(Ce,{children:$}),n.jsx("div",{style:{fontSize:18,color:Y,fontWeight:700,...L},children:W})]},$))}),_&&n.jsxs("div",{style:{fontSize:11,color:i.dim,marginTop:8,...L},children:["Fetched ",_.toLocaleTimeString()," via ",wr]})]}),n.jsxs(ge,{p:20,style:{marginBottom:12},children:[n.jsx(Ce,{children:"Withdraw KAS"}),n.jsxs("div",{style:{background:i.s2,borderRadius:4,padding:"9px 13px",marginBottom:12,display:"flex",justifyContent:"space-between"},children:[n.jsxs("span",{style:{fontSize:11,color:i.dim,...L},children:["Available (after ",er," KAS reserve)"]}),n.jsxs("span",{style:{fontSize:14,color:i.accent,fontWeight:700,...L},children:[F," KAS"]})]}),n.jsx($t,{label:"Recipient Address",value:N,onChange:C,placeholder:"kaspa:... or kaspatest:..."}),n.jsxs("div",{style:{display:"grid",gridTemplateColumns:B?"1fr":"1fr auto",gap:8,alignItems:"flex-end",marginBottom:12},children:[n.jsx($t,{label:`Amount (max ${F} KAS)`,value:M,onChange:x,type:"number",suffix:"KAS",placeholder:"0.0000"}),n.jsx(pe,{onClick:()=>x(F),variant:"ghost",size:"sm",style:{marginBottom:1},children:"MAX"})]}),n.jsx($t,{label:"Note (optional)",value:R,onChange:b,placeholder:"e.g. Profit extraction"}),n.jsxs(pe,{onClick:U,disabled:!St(N,Ae)||!(Number(M)>0)||Number(M)>j,style:{width:"100%",padding:"10px 0"},children:["INITIATE WITHDRAWAL â€” SIGN WITH ",((G=t==null?void 0:t.provider)==null?void 0:G.toUpperCase())||"WALLET"]}),Number(M||0)>j&&n.jsx("div",{style:{fontSize:11,color:i.warn,marginTop:6,...L},children:"Requested withdrawal exceeds available amount after reserve and network fee."})]}),n.jsxs(ge,{p:20,style:{marginBottom:12},children:[n.jsx(Ce,{children:"Deposit KAS"}),n.jsx("div",{style:{fontSize:12,color:i.dim,marginBottom:12},children:"Send KAS directly to your connected wallet address. Funds are available after DAG confirmation (~1â€“2s)."}),n.jsxs("div",{style:{background:i.s2,borderRadius:4,padding:14,border:`1px solid ${i.accent}25`},children:[n.jsx("div",{style:{fontSize:12,color:i.accent,...L,wordBreak:"break-all",marginBottom:10},children:(t==null?void 0:t.address)||"â€”"}),n.jsx(Ct,{href:`${Ut}/addresses/${t==null?void 0:t.address}`,label:"VIEW ON KASPA EXPLORER â†—"})]})]}),o.length>0&&n.jsxs(ge,{p:0,children:[n.jsx("div",{style:{padding:"11px 16px",borderBottom:`1px solid ${i.border}`,display:"flex",justifyContent:"space-between"},children:n.jsxs("span",{style:{fontSize:11,color:i.dim,...L},children:["UTXO SET â€” ",o.length," outputs"]})}),o.map(($,W)=>{var me,Ee,Se;const Y=us((((me=$.utxoEntry)==null?void 0:me.amount)||0)/1e8,4),te=(Ee=$.utxoEntry)==null?void 0:Ee.blockDaaScore,ie=(Se=$.outpoint)==null?void 0:Se.transactionId;return n.jsxs("div",{style:{display:"grid",gridTemplateColumns:B?"1fr":"1fr 100px 120px 60px",gap:8,padding:"8px 16px",borderBottom:`1px solid ${i.border}`,alignItems:"center"},children:[n.jsxs("span",{style:{fontSize:11,color:i.dim,...L,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:[ie==null?void 0:ie.slice(0,34),"..."]}),n.jsxs("span",{style:{fontSize:12,color:i.ok,fontWeight:700,...L,textAlign:B?"left":"right"},children:[Y," KAS"]}),n.jsxs("span",{style:{fontSize:11,color:i.dim,...L,textAlign:B?"left":"right"},children:["DAA ",te]}),n.jsx("div",{style:{textAlign:B?"left":"right"},children:n.jsx(Ct,{href:`${Ut}/txs/${ie}`,label:"â†—"})})]},W)})]})]})}const rl=y.lazy(()=>Wt(()=>import("./PerfChart-BaUZSk_m.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url).then(e=>({default:e.PerfChart}))),sl=y.lazy(()=>Wt(()=>import("./IntelligencePanel-k9uqzesM.js"),__vite__mapDeps([5,1]),import.meta.url).then(e=>({default:e.IntelligencePanel}))),nl=y.lazy(()=>Wt(()=>import("./TreasuryPanel-B20KsyP-.js"),__vite__mapDeps([6,1,2,3,4]),import.meta.url).then(e=>({default:e.TreasuryPanel}))),il=y.lazy(()=>Wt(()=>import("./PortfolioPanel-8fdeEgfw.js"),__vite__mapDeps([7,1]),import.meta.url).then(e=>({default:e.PortfolioPanel}))),ol=y.lazy(()=>Wt(()=>import("./PnlAttributionPanel-DdqVmX3l.js"),__vite__mapDeps([8,1]),import.meta.url).then(e=>({default:e.PnlAttributionPanel}))),al=y.lazy(()=>Wt(()=>import("./AlertsPanel-CidWn8vy.js"),__vite__mapDeps([9,1]),import.meta.url).then(e=>({default:e.AlertsPanel})));function cl({agent:e,wallet:t,agents:r=[],activeAgentId:s,onSelectAgent:o}){var Ks,js,Fs,Us;const x=Cr*1e3,R=`${Te}:${String((t==null?void 0:t.address)||"unknown").toLowerCase()}`,b=R,f=R,p=`${Te}:${String((t==null?void 0:t.address)||"unknown").toLowerCase()}:${String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"default").toLowerCase()}`,S=y.useRef(!1),K=y.useRef(""),j=y.useRef({sig:"",ts:0}),[F,B]=y.useState(!1),[U,I]=y.useState("overview"),{status:h,setStatus:G,transitionAgentStatus:$}=$c("RUNNING"),[W,Y]=y.useState(()=>ns(e.name)),[te,ie]=y.useState([]),[me,Ee]=y.useState(!1),[Se,Pe]=y.useState(e.execMode||"manual"),[Ie]=y.useState(parseFloat(e.autoApproveThreshold)||50),[We,xe]=y.useState(()=>mn(tr,R)),[be,tt]=y.useState(Gs),[He,Ve]=y.useState(()=>Date.now()+x),[Je,Ge]=y.useState(typeof window<"u"?window.innerWidth:1200),at=y.useMemo(()=>mc(),[]),{kasData:Z,marketHistory:we,setMarketHistory:Me,kasDataLoading:m,kasDataError:E,liveConnected:q,streamConnected:T,streamRetryCount:X,refreshKasData:ne}=Kd({walletAddress:t==null?void 0:t.address,wsUrl:zr,livePollMs:5e3,streamReconnectMaxDelayMs:12e3,maxMarketSnapshots:240}),V=y.useCallback(O=>Y(re=>[{ts:Date.now(),...O},...re].slice(0,320)),[320]),_e=String((e==null?void 0:e.strategyLabel)||(e==null?void 0:e.strategyTemplate)||"Custom"),{alertConfig:k,alertSaveBusy:le,lastAlertResult:Ne,sendAlertEvent:ye,patchAlertConfig:Le,toggleAlertType:ve,saveAlertConfig:oe,sendTestAlert:w}=Zc({alertScope:f,agentName:e==null?void 0:e.name,agentId:e==null?void 0:e.agentId,activeStrategyLabel:_e}),{queue:J,setQueue:Ye,signingItem:rt,pendingCount:Re,sendWalletTransfer:mt,receiptBackoffMs:Ht,prependQueueItem:_t,prependSignedBroadcastedQueueItem:Ke,handleQueueSign:Be,handleQueueReject:je,handleSigningReject:Vt,handleSigned:ct,rejectAllPending:Gt,receiptConsistencyMetrics:bt}=Od({wallet:t,maxQueueEntries:160,addLog:V,kasPriceUsd:Number((Z==null?void 0:Z.priceUsd)||0),setTab:I,receiptRetryBaseMs:2e3,receiptRetryMaxMs:3e4,receiptTimeoutMs:48e4,receiptMaxAttempts:18,receiptPollIntervalMs:1200,receiptPollBatchSize:2,sendAlertEvent:ye,agentName:e==null?void 0:e.name,agentId:e==null?void 0:e.agentId}),{settleTreasuryFeePayout:st,attachCombinedTreasuryOutput:Mt}=Xd({enabled:Yt,treasuryFeeKas:it,treasuryAddress:No,walletAddress:t==null?void 0:t.address,walletProvider:t==null?void 0:t.provider,kasPriceUsd:Number((Z==null?void 0:Z.priceUsd)||0),maxQueueEntries:160,addLog:V,setQueue:Ye,sendWalletTransfer:mt,receiptBackoffMs:Ht});y.useEffect(()=>{xe(mn(tr,R))},[R]),y.useEffect(()=>{if(typeof window>"u")return;const O=()=>Ge(window.innerWidth);return window.addEventListener("resize",O),()=>window.removeEventListener("resize",O)},[]),y.useEffect(()=>{h==="RUNNING"&&Ve(Date.now()+x)},[h,x]),y.useEffect(()=>{U==="billing"&&I("treasury")},[U]);const dt=e.risk==="low"?.4:e.risk==="medium"?.65:.85,Rt=y.useMemo(()=>{const O=Array.isArray(r)&&r.length>0?r:[e],re=new Map;for(const de of O){const Ue=String((de==null?void 0:de.agentId)||(de==null?void 0:de.name)||"").trim();Ue&&re.set(Ue,de)}return Array.from(re.values())},[e,r]),ir=y.useMemo(()=>kc({decisions:te,queue:J,log:W,marketHistory:we,realizedMinConfirmations:ot,confirmationDepthPolicy:Io}),[te,J,W,we]),ue=fd({pnlAttribution:ir,receiptConsistencyMetrics:bt}),wt=y.useMemo(()=>{var Ue;const O=ue.truth,re=ir,de=O.degraded&&String((re==null?void 0:re.netPnlMode)||"")==="realized"?"hybrid":re==null?void 0:re.netPnlMode;return{...re,netPnlMode:de,truthDegraded:O.degraded,truthDegradedReason:((Ue=O.reasons)==null?void 0:Ue[0])||"",truthMismatchRatePct:O.mismatchRatePct,truthCheckedSignals:O.checked,truthMismatchSignals:O.mismatches}},[ue.truth,ir]);y.useEffect(()=>{var At,lr,ur,fr;const O=ue==null?void 0:ue.calibration,re=ue==null?void 0:ue.truth;if(!O||!re)return;const de={agentId:String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||""),agentName:String((e==null?void 0:e.name)||""),network:Te,walletAddress:String((t==null?void 0:t.address)||""),calibrationHealth:Number(O.health||0),calibrationTier:String(O.tier||"unknown"),sizeMultiplier:Number(O.sizeMultiplier||1),autoApproveDisabled:!!(ue!=null&&ue.autoApproveDisabled),autoApproveDisableDeferred:!!O.autoApproveDisableDeferred,confidenceBrierScore:Number(((At=O.metrics)==null?void 0:At.brier)||0),evCalibrationErrorPct:Number(((lr=O.metrics)==null?void 0:lr.evCalErrorPct)||0),regimeHitRatePct:Number(((ur=O.metrics)==null?void 0:ur.regimeHitRatePct)||0),regimeHitSamples:Number(((fr=O.metrics)==null?void 0:fr.regimeHitSamples)||0),truthDegraded:!!re.degraded,truthMismatchRatePct:Number(re.mismatchRatePct||0),checkedTs:Date.now()},Ue=JSON.stringify({a:de.agentId,n:de.network,h:Number(de.calibrationHealth.toFixed(4)),t:de.calibrationTier,s:Number(de.sizeMultiplier.toFixed(4)),ad:de.autoApproveDisabled,dd:de.autoApproveDisableDeferred,b:Number(de.confidenceBrierScore.toFixed(4)),e:Number(de.evCalibrationErrorPct.toFixed(3)),r:Number(de.regimeHitRatePct.toFixed(2)),rs:de.regimeHitSamples,td:de.truthDegraded,tm:Number(de.truthMismatchRatePct.toFixed(2))}),D=Date.now(),Oe=j.current;Oe.sig===Ue&&D-Oe.ts<15e3||(j.current={sig:Ue,ts:D},jc(de).catch(()=>{}))},[e==null?void 0:e.agentId,e==null?void 0:e.name,t==null?void 0:t.address,ue,Te]),cd({agent:e,cycleIntervalMs:x,runtimeScope:p,maxDecisionEntries:120,maxLogEntries:320,maxQueueEntries:160,maxMarketSnapshots:240,runtimeHydrated:F,setRuntimeHydrated:B,status:h,execMode:Se,liveExecutionArmed:be,queue:J,log:W,decisions:te,marketHistory:we,attributionSummary:wt,nextAutoCycleAt:He,setStatus:G,setExecMode:Pe,setLiveExecutionArmed:tt,setQueue:Ye,setLog:Y,setDecisions:ie,setMarketHistory:Me,setNextAutoCycleAt:Ve,liveExecutionDefault:Gs});const{portfolioConfig:or,portfolioSummary:ar,activePortfolioRow:Fe,patchPortfolioConfig:Ci,patchPortfolioAgentOverride:ki,refreshPortfolioPeers:Mi}=Yd({portfolioScope:b,allAgents:Rt,activeAgentId:e==null?void 0:e.agentId,walletAddress:t==null?void 0:t.address,walletKas:Number((Z==null?void 0:Z.walletKas)||0),activeDecisions:te,activeQueue:J,activeAttributionSummary:wt}),cr=y.useCallback(async()=>{var O,re,de,Ue;if(!(S.current||h!=="RUNNING"||!F)){S.current=!0,Ee(!0);try{if(!Z){V({type:"ERROR",msg:"No live Kaspa data available. Reconnect feed before running cycle.",fee:null});return}Ve(Date.now()+x),V({type:"DATA",msg:`Kaspa DAG snapshot: DAA ${((O=Z==null?void 0:Z.dag)==null?void 0:O.daaScore)||"â€”"} Â· Wallet ${(Z==null?void 0:Z.walletKas)||"â€”"} KAS`,fee:null}),xe(bc(tr,R));const D=await fc(e,Z||{},{history:we}),Oe=String((D==null?void 0:D.decision_source)||"ai"),At=String(((re=D==null?void 0:D.quant_metrics)==null?void 0:re.regime)||"NA");_r&&!["ACCUMULATE","HOLD"].includes(D.action)&&(D.action="HOLD",D.rationale=`${String(D.rationale||"")} Execution constrained by accumulate-only mode.`.trim());const lr=Date.now();ie(ht=>[{ts:lr,dec:D,kasData:Z,source:Oe},...ht].slice(0,120)),V({type:"AI",msg:`${D.action} Â· Conf ${D.confidence_score} Â· Kelly ${(D.kelly_fraction*100).toFixed(1)}% Â· Monte Carlo ${D.monte_carlo_win_pct}% win Â· regime:${At} Â· source:${Oe} Â· ${(D==null?void 0:D.engine_latency_ms)||0}ms`,fee:.12}),D!=null&&D.quant_metrics&&V({type:"DATA",msg:`Quant core â†’ samples ${D.quant_metrics.sample_count??"â€”"} Â· edge ${D.quant_metrics.edge_score??"â€”"} Â· vol ${D.quant_metrics.ewma_volatility??"â€”"} Â· dataQ ${D.quant_metrics.data_quality_score??"â€”"}`,fee:null}),(Oe==="fallback"||Oe==="quant-core")&&(V({type:"SYSTEM",msg:`Local quant decision active (${(D==null?void 0:D.decision_source_detail)||"ai endpoint unavailable"}). Auto-approve uses same guardrails; AI overlay unavailable or bypassed.`,fee:null}),/ai_|timeout|endpoint|transport|request/i.test(String((D==null?void 0:D.decision_source_detail)||""))&&ye({type:"ai_outage",key:`ai_outage:${String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"agent")}`,title:`${(e==null?void 0:e.name)||"Agent"} AI overlay unavailable`,message:`Quant core fallback active. detail=${String((D==null?void 0:D.decision_source_detail)||"n/a")}`,severity:"warn",meta:{decision_source:Oe,regime:At}}));const ur=D.confidence_score>=Vs,fr=D.risk_score<=dt,Wi=Math.max(0,Math.min(1,Number((ue==null?void 0:ue.effectiveSizingMultiplier)||1))),Hi=!!(ue!=null&&ue.autoApproveDisabled),Vi=Array.isArray(ue==null?void 0:ue.autoApproveDisableReasons)?ue.autoApproveDisableReasons:[],Gi=Number((Z==null?void 0:Z.walletKas)||0),Yi=Yt&&(t==null?void 0:t.provider)!=="demo"&&it>0&&he.supportsNativeMultiOutput(String((t==null?void 0:t.provider)||"")),$s=Yt&&(t==null?void 0:t.provider)!=="demo"&&it>0?Yi?it:it+vt:0,Bs=Math.max(0,Gi-er-vt-$s),Xi=q&&!E&&(t==null?void 0:t.provider)!=="demo";if(!fr)V({type:"VALID",msg:`Risk gate FAILED â€” score ${D.risk_score} > ${dt} ceiling`,fee:null}),V({type:"EXEC",msg:"BLOCKED by risk gate",fee:.03}),ye({type:"risk_event",key:`risk_gate:${String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"agent")}`,title:`${(e==null?void 0:e.name)||"Agent"} risk gate blocked cycle`,message:`Risk score ${D.risk_score} exceeded ceiling ${dt}. action=${D.action} regime=${At}`,severity:"warn",meta:{risk_score:D.risk_score,risk_ceiling:dt,regime:At}});else if(!ur)V({type:"VALID",msg:`Confidence ${D.confidence_score} < ${Vs} threshold`,fee:null}),V({type:"EXEC",msg:"HOLD â€” confidence gate enforced",fee:.08});else if(D.action==="ACCUMULATE"&&Bs<=0)V({type:"VALID",msg:`Insufficient spendable balance after reserve (${er} KAS), network fee (${vt} KAS), and treasury payout reserve (${$s.toFixed(4)} KAS).`,fee:null}),V({type:"EXEC",msg:"HOLD â€” waiting for available balance",fee:.03});else if(V({type:"VALID",msg:`Risk OK (${D.risk_score}) Â· Conf OK (${D.confidence_score}) Â· Kelly ${(D.kelly_fraction*100).toFixed(1)}%`,fee:null}),Se==="notify")V({type:"EXEC",msg:`NOTIFY mode active â€” ${D.action} signal recorded, no transaction broadcast.`,fee:.01});else if(!be||!Xi){const ht=be?"network feed or wallet provider is not execution-ready":"live execution is disarmed";V({type:"EXEC",msg:`Signal generated (${D.action}) but no transaction broadcast because ${ht}.`,fee:.01})}else if(D.action!=="HOLD"){const ht=Number(D.capital_allocation_kas||0),lt=D.action==="ACCUMULATE"?Number((Math.max(0,ht)*Wi).toFixed(6)):ht;D.action==="ACCUMULATE"&&lt<ht&&V({type:"SYSTEM",msg:`Calibration guardrail scaled execution from ${ht} to ${lt.toFixed(6)} KAS (health ${Number(((de=ue==null?void 0:ue.calibration)==null?void 0:de.health)||1).toFixed(3)} Â· tier ${String(((Ue=ue==null?void 0:ue.calibration)==null?void 0:Ue.tier)||"healthy").toUpperCase()}).`,fee:null});const Br=Number((Fe==null?void 0:Fe.cycleCapKas)||0),Dr=D.action==="ACCUMULATE"&&Br>0?Math.min(lt,Br):lt,mr=D.action==="ACCUMULATE"?Math.min(Dr,Bs):lt;if(D.action==="ACCUMULATE"&&Br>0&&lt>Dr&&V({type:"SYSTEM",msg:`Shared portfolio allocator capped ${e.name} cycle from ${lt} to ${Dr.toFixed(4)} KAS.`,fee:null}),lt>mr&&V({type:"SYSTEM",msg:`Clamped execution amount from ${lt} to ${mr.toFixed(4)} KAS (available balance guardrail).`,fee:null}),!(mr>0)){V({type:"EXEC",msg:"HOLD â€” computed execution amount is zero",fee:.03});return}const qi=kr({id:vr(),type:D.action,metaKind:"action",from:t==null?void 0:t.address,to:Ir,amount_kas:Number(mr.toFixed(6)),purpose:D.rationale.slice(0,60),status:"pending",ts:Date.now(),dec:D}),De=Mt(qi);De!=null&&De.treasuryCombined&&V({type:"TREASURY",msg:`Using combined treasury routing in primary transaction (${String((t==null?void 0:t.provider)||"wallet")}) Â· treasury ${Number((De==null?void 0:De.treasuryCombinedFeeKas)||it).toFixed(6)} KAS`,fee:null});const Ds=Se==="autonomous"&&De.amount_kas<=Ie&&(Oe==="ai"||Oe==="hybrid-ai"),zs=Ds&&!Hi;if(Ds&&!zs&&V({type:"SIGN",msg:`Auto-approve blocked by guardrail (${Vi.join(",")||"policy"}). Action routed to manual queue.`,fee:null}),zs)try{const Pt=await mt(De);V({type:"EXEC",msg:`AUTO-APPROVED: ${D.action} Â· ${De.amount_kas} KAS Â· txid: ${Pt.slice(0,16)}...`,fee:.08,truthLabel:"BROADCASTED",receiptProvenance:"ESTIMATED"}),V({type:"TREASURY",msg:`Fee split â†’ Pool: ${(et*ps).toFixed(4)} KAS / Treasury: ${(et*ft).toFixed(4)} KAS`,fee:et});const Qi=Ke(De,Pt);await st(Qi,"auto")}catch(Pt){_t(De),V({type:"SIGN",msg:`Auto-approve fallback to manual queue: ${(Pt==null?void 0:Pt.message)||"wallet broadcast failed"}`,fee:null})}else V({type:"SIGN",msg:`Action queued for wallet signature: ${D.action} Â· ${De.amount_kas} KAS`,fee:null}),_t(De)}else V({type:"EXEC",msg:"HOLD â€” no action taken",fee:.08})}catch(D){const Oe=Pr(D,{domain:"system"});V({type:"ERROR",msg:Ss(Oe),fee:null}),Oe.domain==="tx"&&Oe.code==="TX_BROADCAST_FAILED"&&$({type:"FAIL",reason:Oe.message})}finally{Ee(!1),S.current=!1}}},[_r,120,Fe,V,e,Ie,x,Se,Z,be,q,we,E,_t,Ke,dt,F,mt,st,ye,h,$,R,t]);Bc({status:h,runtimeHydrated:F,loading:me,liveConnected:q,kasDataError:E,nextAutoCycleAt:He,cycleIntervalMs:x,cycleLockRef:S,setNextAutoCycleAt:Ve,runCycle:cr}),y.useEffect(()=>{var de,Ue,D;const O=String(((D=(Ue=(de=te[0])==null?void 0:de.dec)==null?void 0:Ue.quant_metrics)==null?void 0:D.regime)||"");if(!O)return;if(!K.current){K.current=O;return}if(K.current===O)return;const re=K.current;K.current=O,ye({type:"regime_shift",key:`regime_shift:${String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"agent")}:${re}->${O}`,title:`${(e==null?void 0:e.name)||"Agent"} regime shift`,message:`Regime changed from ${re} to ${O}.`,severity:O==="RISK_OFF"?"warn":"info",meta:{previous_regime:re,regime:O}})},[e==null?void 0:e.agentId,e==null?void 0:e.name,te,ye]);const Ri=y.useCallback(async O=>{const re=rt?{...rt}:null;if(await ct(O),!re||(re==null?void 0:re.metaKind)==="treasury_fee")return;const de={...re,status:"signed",txid:O==null?void 0:O.txid};await st(de,"post-sign")},[ct,st,rt]),Ps=()=>{$({type:"KILL"}),V({type:"SYSTEM",msg:"KILL-SWITCH activated â€” agent suspended. All pending actions cancelled.",fee:null}),ye({type:"risk_event",key:`kill_switch:${String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"agent")}`,title:`${(e==null?void 0:e.name)||"Agent"} kill-switch activated`,message:"Agent suspended and pending queue rejected.",severity:"danger",meta:{pending_rejected:J.filter(O=>O.status==="pending").length}}),Gt()},dr=parseFloat(W.filter(O=>O.fee).reduce((O,re)=>O+(re.fee||0),0).toFixed(4));Number((Z==null?void 0:Z.walletKas)||0);const wi=Yt&&(t==null?void 0:t.provider)!=="demo"&&it>0&&he.supportsNativeMultiOutput(String((t==null?void 0:t.provider)||"")),Li=Yt&&(t==null?void 0:t.provider)!=="demo"&&it>0?wi?it:it+vt:0,Pi=dd({viewportWidth:Je,nextAutoCycleAt:He,status:h,totalFees:dr,queue:J,decisions:te,liveConnected:q,kasDataError:E,wallet:t,kasData:Z,reserveKas:er,netFeeKas:vt,treasuryReserveKas:Li,wsUrl:zr,streamConnected:T,streamRetryCount:X}),{isMobile:pt,isTablet:Oi,summaryGridCols:Ki,splitGridCols:ji,controlsGridCols:Fi,spendableKas:Ui,liveExecutionReady:$r,autoCycleCountdownLabel:Os,lastDecision:Lt,lastDecisionSource:$i,streamBadgeText:Bi,streamBadgeColor:Di}=Pi,zi=[{k:"overview",l:"OVERVIEW"},{k:"portfolio",l:"PORTFOLIO"},{k:"intelligence",l:"INTELLIGENCE"},{k:"attribution",l:"ATTRIBUTION"},{k:"alerts",l:"ALERTS"},{k:"queue",l:`QUEUE${Re>0?` (${Re})`:""}`},{k:"treasury",l:"TREASURY"},{k:"wallet",l:"WALLET"},{k:"log",l:"LOG"},{k:"controls",l:"CONTROLS"}];return y.useEffect(()=>{Re<=0||ye({type:"queue_pending",key:`queue_pending_count:${String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"agent")}`,title:`${(e==null?void 0:e.name)||"Agent"} has pending signatures`,message:`${Re} transaction${Re>1?"s":""} awaiting wallet approval.`,severity:Re>=3?"warn":"info",meta:{pending_count:Re}})},[e==null?void 0:e.agentId,e==null?void 0:e.name,Re,ye]),n.jsxs("div",{style:{maxWidth:1460,margin:"0 auto",padding:pt?"14px 14px 22px":"22px 24px 34px"},children:[rt&&n.jsx(Ts,{tx:rt,wallet:t,onSign:Ri,onReject:Vt}),n.jsxs("div",{style:{display:"flex",flexDirection:pt?"column":"row",justifyContent:"space-between",alignItems:pt?"stretch":"flex-start",marginBottom:16,gap:pt?10:0},children:[n.jsxs("div",{children:[n.jsxs("div",{style:{fontSize:11,color:i.dim,letterSpacing:"0.1em",...L,marginBottom:2},children:["FORGE.OS / AGENT / ",e.name]}),n.jsx("div",{style:{fontSize:18,color:i.text,fontWeight:700,...L},children:e.name})]}),n.jsxs("div",{style:{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap",justifyContent:pt?"flex-start":"flex-end"},children:[n.jsx(ee,{text:h,color:h==="RUNNING"?i.ok:h==="PAUSED"?i.warn:i.danger,dot:!0}),n.jsx(ee,{text:Se.toUpperCase(),color:i.accent}),n.jsx(ee,{text:String(_e).toUpperCase(),color:i.text}),n.jsx(ee,{text:be?"LIVE EXEC ON":"LIVE EXEC OFF",color:be?i.ok:i.warn,dot:!0}),n.jsx(ee,{text:_r?"ACCUMULATE-ONLY":"MULTI-ACTION",color:_r?i.ok:i.warn}),n.jsx(ee,{text:((Ks=t==null?void 0:t.provider)==null?void 0:Ks.toUpperCase())||"WALLET",color:i.purple,dot:!0}),n.jsx(ee,{text:`ENGINE ${String(at).toUpperCase()}`,color:at==="worker"?i.ok:i.warn}),n.jsx(ee,{text:q?"DAG LIVE":"DAG OFFLINE",color:q?i.ok:i.danger,dot:!0}),n.jsx(ee,{text:Bi,color:Di,dot:!0})]})]}),n.jsx(el,{kasDataError:E,refreshKasData:ne,kasDataLoading:m,liveExecutionArmed:be,liveExecutionReady:$r,executionGuardrails:ue,pendingCount:Re,isMobile:pt,setTab:I}),n.jsx("div",{style:{display:"flex",borderBottom:`1px solid ${i.border}`,marginBottom:18,overflowX:"auto"},children:zi.map(O=>n.jsx("button",{"data-testid":`dashboard-tab-${O.k}`,onClick:()=>I(O.k),style:{background:"none",border:"none",borderBottom:`2px solid ${U===O.k?i.accent:"transparent"}`,color:U===O.k?i.accent:i.dim,padding:"7px 14px",fontSize:11,cursor:"pointer",letterSpacing:"0.08em",...L,marginBottom:-1,whiteSpace:"nowrap",transition:"color 0.15s"},children:O.l},O.k))}),U==="overview"&&n.jsxs("div",{children:[n.jsx("div",{style:{display:"grid",gridTemplateColumns:Ki,gap:10,marginBottom:12},children:[{l:"Wallet Balance",v:`${(Z==null?void 0:Z.walletKas)||e.capitalLimit} KAS`,s:Ze(t==null?void 0:t.address),c:i.accent},{l:"DAA Score",v:((Fs=(js=Z==null?void 0:Z.dag)==null?void 0:js.daaScore)==null?void 0:Fs.toLocaleString())||"â€”",s:"Kaspa DAG height",c:i.text},{l:"Pending Signatures",v:Re,s:"In action queue",c:Re>0?i.warn:i.dim},{l:"Total Protocol Fees",v:`${dr} KAS`,s:`${(dr*ft).toFixed(4)} KAS â†’ treasury`,c:i.text}].map(O=>n.jsxs(ge,{p:14,children:[n.jsx(Ce,{children:O.l}),n.jsx("div",{style:{fontSize:18,color:O.c,fontWeight:700,...L,marginBottom:2},children:O.v}),n.jsx("div",{style:{fontSize:11,color:i.dim},children:O.s})]},O.l))}),n.jsxs(ge,{p:16,style:{marginBottom:12},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:10,flexWrap:"wrap",marginBottom:8},children:[n.jsx(Ce,{children:"Mission Control"}),n.jsx(Zd,{networkLabel:Qe,status:h,execMode:Se,liveExecutionArmed:be,autoCycleCountdownLabel:Os,lastDecisionSource:$i,usage:We,executionGuardrails:ue,receiptConsistencyMetrics:bt})]}),n.jsxs("div",{style:{display:"grid",gridTemplateColumns:Oi?"1fr":"1fr 1fr 1fr 1fr",gap:8,marginBottom:10},children:[n.jsxs("div",{style:{background:i.s2,border:`1px solid ${i.border}`,borderRadius:6,padding:"10px 12px"},children:[n.jsx("div",{style:{fontSize:10,color:i.dim,...L,marginBottom:4},children:"Spendable Balance"}),n.jsxs("div",{style:{fontSize:13,color:i.ok,fontWeight:700,...L},children:[Ui.toFixed(4)," KAS"]})]}),n.jsxs("div",{style:{background:i.s2,border:`1px solid ${i.border}`,borderRadius:6,padding:"10px 12px"},children:[n.jsx("div",{style:{fontSize:10,color:i.dim,...L,marginBottom:4},children:"Last Decision"}),n.jsx("div",{style:{fontSize:13,color:i.text,fontWeight:700,...L},children:(Lt==null?void 0:Lt.action)||"â€”"})]}),n.jsxs("div",{style:{background:i.s2,border:`1px solid ${i.border}`,borderRadius:6,padding:"10px 12px"},children:[n.jsx("div",{style:{fontSize:10,color:i.dim,...L,marginBottom:4},children:"Capital / Cycle"}),n.jsxs("div",{style:{fontSize:13,color:i.text,fontWeight:700,...L},children:[e.capitalLimit," KAS"]})]}),n.jsxs("div",{style:{background:i.s2,border:`1px solid ${i.border}`,borderRadius:6,padding:"10px 12px"},children:[n.jsx("div",{style:{fontSize:10,color:i.dim,...L,marginBottom:4},children:"Portfolio Cycle Cap"}),n.jsx("div",{style:{fontSize:13,color:Fe!=null&&Fe.cycleCapKas?i.ok:i.dim,fontWeight:700,...L},children:Fe!=null&&Fe.cycleCapKas?`${Fe.cycleCapKas} KAS`:"â€”"})]}),n.jsxs("div",{style:{background:i.s2,border:`1px solid ${i.border}`,borderRadius:6,padding:"10px 12px"},children:[n.jsx("div",{style:{fontSize:10,color:i.dim,...L,marginBottom:4},children:"Execution Readiness"}),n.jsx("div",{style:{fontSize:13,color:$r?i.ok:i.warn,fontWeight:700,...L},children:$r?"READY":"NOT READY"})]}),n.jsxs("div",{style:{background:i.s2,border:`1px solid ${i.border}`,borderRadius:6,padding:"10px 12px"},children:[n.jsx("div",{style:{fontSize:10,color:i.dim,...L,marginBottom:4},children:"KAS Price (USD)"}),n.jsx("div",{style:{fontSize:13,color:i.text,fontWeight:700,...L},children:Number((Z==null?void 0:Z.priceUsd)||0)>0?`$${Number(Z.priceUsd).toFixed(6)}`:"â€”"})]}),n.jsxs("div",{style:{background:i.s2,border:`1px solid ${i.border}`,borderRadius:6,padding:"10px 12px"},children:[n.jsx("div",{style:{fontSize:10,color:i.dim,...L,marginBottom:4},children:"Quant Samples"}),n.jsx("div",{style:{fontSize:13,color:i.text,fontWeight:700,...L},children:((Us=Lt==null?void 0:Lt.quant_metrics)==null?void 0:Us.sample_count)??we.length??0})]})]}),n.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[n.jsx(Ct,{href:`${Ut}/addresses/${t==null?void 0:t.address}`,label:"WALLET EXPLORER â†—"}),n.jsx(Ct,{href:`${Ut}/addresses/${Ir}`,label:"VAULT EXPLORER â†—"})]})]}),n.jsx("div",{style:{marginBottom:12},children:n.jsx(y.Suspense,{fallback:n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Performance"}),n.jsx("div",{style:{fontSize:12,color:i.dim},children:"Loading performance chart..."})]}),children:n.jsx(rl,{decisions:te,kpiTarget:e.kpiTarget})})}),n.jsxs("div",{style:{display:"grid",gridTemplateColumns:ji,gap:12},children:[n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Agent Configuration"}),[["Strategy",_e],["Strategy Class",String((e==null?void 0:e.strategyClass)||"custom").toUpperCase()],["Risk",e.risk.toUpperCase()],["Capital / Cycle",`${e.capitalLimit} KAS`],["Portfolio Allocator","AUTO"],["Exec Mode",Se.toUpperCase()],["Auto-Approve â‰¤",`${Ie} KAS`],["Horizon",`${e.horizon} days`],["KPI Target",`${e.kpiTarget}% ROI`]].map(([O,re])=>n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:`1px solid ${i.border}`},children:[n.jsx("span",{style:{fontSize:12,color:i.dim,...L},children:O}),n.jsx("span",{style:{fontSize:12,color:i.text,...L},children:re})]},O)),n.jsxs("div",{style:{fontSize:11,color:i.dim,marginTop:8},children:["Shared portfolio weighting and allocator caps are managed automatically. Operator funding is set with ",n.jsx("span",{style:{color:i.text,...L},children:"Capital / Cycle"}),"."]})]}),n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Actions"}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[n.jsx(pe,{onClick:cr,disabled:me||h!=="RUNNING",style:{padding:"10px 0"},children:me?"PROCESSING...":"RUN QUANT CYCLE"}),n.jsx(pe,{onClick:ne,disabled:m,variant:"ghost",style:{padding:"9px 0"},children:m?"FETCHING DAG...":q?"REFRESH KASPA DATA":zr?"RECONNECT STREAM/DATA":"RECONNECT KASPA FEED"}),n.jsx(pe,{onClick:()=>tt(O=>!O),variant:be?"warn":"primary",style:{padding:"9px 0"},children:be?"DISARM LIVE EXECUTION":"ARM LIVE EXECUTION"}),n.jsxs(pe,{onClick:()=>I("queue"),variant:"ghost",style:{padding:"9px 0"},children:["ACTION QUEUE ",Re>0?`(${Re})`:""]}),n.jsx(pe,{onClick:()=>$({type:h==="RUNNING"?"PAUSE":"RESUME"}),variant:"ghost",style:{padding:"9px 0"},children:h==="RUNNING"?"PAUSE":"RESUME"}),n.jsx(pe,{onClick:Ps,variant:"danger",style:{padding:"9px 0"},children:"KILL-SWITCH"})]})]})]})]}),U==="portfolio"&&n.jsx(y.Suspense,{fallback:n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Portfolio"}),n.jsx("div",{style:{fontSize:12,color:i.dim},children:"Loading portfolio allocator..."})]}),children:n.jsx(il,{agents:Rt,activeAgentId:s||(e==null?void 0:e.agentId),walletKas:(Z==null?void 0:Z.walletKas)||0,summary:ar,config:or,onConfigPatch:Ci,onAgentOverridePatch:ki,onSelectAgent:o,onRefresh:Mi})}),U==="intelligence"&&n.jsx(y.Suspense,{fallback:n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Intelligence"}),n.jsx("div",{style:{fontSize:12,color:i.dim},children:"Loading intelligence panel..."})]}),children:n.jsx(sl,{decisions:te,queue:J,loading:me,onRun:cr})}),U==="attribution"&&n.jsx(y.Suspense,{fallback:n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Attribution"}),n.jsx("div",{style:{fontSize:12,color:i.dim},children:"Loading attribution panel..."})]}),children:n.jsx(ol,{summary:wt})}),U==="alerts"&&n.jsx(y.Suspense,{fallback:n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Alerts"}),n.jsx("div",{style:{fontSize:12,color:i.dim},children:"Loading alerts panel..."})]}),children:n.jsx(al,{config:k,onPatch:Le,onToggleType:ve,onSave:oe,onTest:w,saving:le,lastResult:Ne})}),U==="queue"&&n.jsx(qd,{queue:J,wallet:t,onSign:Be,onReject:je,receiptConsistencyMetrics:bt}),U==="treasury"&&n.jsx(y.Suspense,{fallback:n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Treasury"}),n.jsx("div",{style:{fontSize:12,color:i.dim},children:"Loading treasury panel..."})]}),children:n.jsx(nl,{log:W,agentCapital:e.capitalLimit})}),U==="wallet"&&n.jsx(tl,{agent:e,wallet:t}),U==="log"&&n.jsxs(ge,{p:0,children:[n.jsxs("div",{style:{padding:"12px 18px",borderBottom:`1px solid ${i.border}`,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("span",{style:{fontSize:11,color:i.dim,...L},children:[W.length," entries Â· ",dr," KAS fees"]}),n.jsx(pe,{onClick:cr,disabled:me||h!=="RUNNING",size:"sm",children:me?"...":"RUN CYCLE"})]}),n.jsx("div",{style:{maxHeight:520,overflowY:"auto"},children:W.map((O,re)=>n.jsxs("div",{style:{display:"grid",gridTemplateColumns:pt?"74px 58px 1fr":"92px 72px 1fr 80px",gap:10,padding:"8px 18px",borderBottom:`1px solid ${i.border}`,alignItems:"center"},children:[n.jsx("span",{style:{fontSize:11,color:i.dim,...L},children:$n(O.ts)}),n.jsx("span",{style:{fontSize:11,color:_c[O.type]||i.dim,fontWeight:700,...L},children:O.type}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:5},children:[n.jsx("div",{style:{fontSize:12,color:i.text,...L,lineHeight:1.4},children:O.msg}),((O==null?void 0:O.truthLabel)||(O==null?void 0:O.receiptProvenance))&&n.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[(O==null?void 0:O.truthLabel)&&n.jsx(ee,{text:String(O.truthLabel),color:String(O.truthLabel).includes("CHAIN CONFIRMED")?i.ok:String(O.truthLabel).includes("BACKEND CONFIRMED")?i.purple:String(O.truthLabel).includes("BROADCASTED")?i.warn:i.dim}),(O==null?void 0:O.receiptProvenance)&&n.jsx(ee,{text:String(O.receiptProvenance),color:String(O.receiptProvenance).toUpperCase()==="CHAIN"?i.ok:String(O.receiptProvenance).toUpperCase()==="BACKEND"?i.purple:i.warn})]})]}),!pt&&n.jsx("span",{style:{fontSize:11,color:i.dim,textAlign:"right",...L},children:O.fee!=null?`${O.fee} KAS`:"â€”"})]},re))})]}),U==="controls"&&n.jsxs("div",{style:{display:"grid",gridTemplateColumns:Fi,gap:14},children:[n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Execution Mode"}),oi.map(O=>{const re=Se===O.v;return n.jsxs("div",{onClick:()=>Pe(O.v),style:{padding:"12px 14px",borderRadius:4,marginBottom:8,cursor:"pointer",border:`1px solid ${re?i.accent:i.border}`,background:re?i.aLow:i.s2,transition:"all 0.15s"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:3},children:[n.jsx("div",{style:{width:10,height:10,borderRadius:"50%",background:re?i.accent:i.muted,flexShrink:0}}),n.jsx("span",{style:{fontSize:12,color:re?i.accent:i.text,fontWeight:700,...L},children:O.l})]}),n.jsx("div",{style:{fontSize:11,color:i.dim,marginLeft:20},children:O.desc})]},O.v)})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[n.jsxs(ge,{p:18,children:[n.jsx(Ce,{children:"Agent Controls"}),n.jsxs("div",{style:{fontSize:11,color:i.dim,...L,marginBottom:10},children:["Auto cycle cadence: every ",Cr,"s Â· Next cycle in ",Os]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[n.jsx(pe,{onClick:()=>$({type:h==="RUNNING"?"PAUSE":"RESUME"}),variant:"ghost",style:{padding:"10px 0"},children:h==="RUNNING"?"PAUSE AGENT":"RESUME AGENT"}),n.jsx(pe,{onClick:()=>tt(O=>!O),variant:be?"warn":"primary",style:{padding:"10px 0"},children:be?"DISARM LIVE EXECUTION":"ARM LIVE EXECUTION"}),n.jsx(pe,{onClick:()=>I("wallet"),variant:"ghost",style:{padding:"10px 0"},children:"MANAGE WALLET"}),n.jsx(pe,{onClick:Ps,variant:"danger",style:{padding:"10px 0"},children:"ACTIVATE KILL-SWITCH"})]})]}),n.jsxs(ge,{p:18,children:[n.jsxs(Ce,{children:["Active Risk Limits â€” ",e.risk.toUpperCase()]}),[["Max Single Exposure",e.risk==="low"?"5%":e.risk==="medium"?"10%":"20%",i.warn],["Drawdown Halt",e.risk==="low"?"-8%":e.risk==="medium"?"-15%":"-25%",i.danger],["Confidence Floor","0.75",i.dim],["Kelly Cap",e.risk==="low"?"10%":e.risk==="medium"?"20%":"40%",i.warn],["Auto-Approve â‰¤",`${Ie} KAS`,i.accent]].map(([O,re,de])=>n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:`1px solid ${i.border}`},children:[n.jsx("span",{style:{fontSize:12,color:i.dim,...L},children:O}),n.jsx("span",{style:{fontSize:12,color:de,fontWeight:700,...L},children:re})]},O))]})]})]})]})}function dl(){const[e,t]=y.useState(null),[r,s]=y.useState("create"),[o,d]=y.useState([]),[a,u]=y.useState(""),[c,l]=y.useState(!1),[_,A]=y.useState(typeof window<"u"?window.innerWidth:1280),v=b=>{t(b)},g=b=>{d(f=>[...f.filter(S=>(S==null?void 0:S.agentId)!==(b==null?void 0:b.agentId)),b].slice(-24)),u(String((b==null?void 0:b.agentId)||"")),s("dashboard")},N=y.useMemo(()=>o.find(b=>String(b==null?void 0:b.agentId)===String(a))||o[o.length-1]||null,[a,o]),C=Te==="mainnet",M=y.useMemo(()=>to.filter(b=>b.id==="mainnet"||b.id.startsWith("testnet")),[]),x=_<860,R=b=>{if(!(typeof window>"u"||c||b===Te||(e||o.length>0)&&!window.confirm("Switching networks will reset the current wallet session and agent state. Continue?"))){l(!0);try{window.localStorage.setItem("forgeos.network",b);const p=new URL(window.location.href);p.searchParams.set("network",b),window.location.assign(p.toString())}catch{l(!1)}}};return y.useEffect(()=>{if(typeof window>"u")return;const b=()=>A(window.innerWidth);return window.addEventListener("resize",b),()=>window.removeEventListener("resize",b)},[]),e?n.jsxs("div",{className:"forge-shell",style:{color:i.text},children:[n.jsx(ni,{}),n.jsxs("div",{className:"forge-content",style:{minHeight:"100vh"},children:[n.jsxs("div",{className:"forge-topbar",style:{borderBottom:`1px solid ${i.border}`,padding:"12px clamp(14px, 2vw, 24px)",display:"flex",flexDirection:x?"column":"row",alignItems:x?"stretch":"center",justifyContent:"space-between",gap:x?10:0},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:14,justifyContent:x?"space-between":"flex-start"},children:[n.jsxs("div",{style:{fontSize:14,fontWeight:700,letterSpacing:"0.14em",...L},children:[n.jsx("span",{style:{color:i.accent},children:"FORGE"}),n.jsx("span",{style:{color:i.text},children:".OS"})]}),n.jsx("div",{style:{width:1,height:14,background:i.border}}),n.jsx("div",{style:{fontSize:10,color:i.dim,letterSpacing:"0.08em",...L},children:"AI-NATIVE FINANCIAL OS Â· KASPA"})]}),n.jsxs("div",{style:{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap",justifyContent:x?"flex-start":"flex-end"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,border:`1px solid ${C?i.warn:i.ok}50`,background:C?i.wLow:i.oLow,borderRadius:6,padding:"4px 6px"},children:[n.jsx("span",{style:{fontSize:10,color:C?i.warn:i.ok,letterSpacing:"0.08em",...L},children:Qe.toUpperCase()}),n.jsx("select",{"data-testid":"network-select",value:rr.id,onChange:b=>R(b.target.value),disabled:c,style:{background:"transparent",color:i.text,border:`1px solid ${i.border}`,borderRadius:4,padding:"4px 8px",fontSize:10,letterSpacing:"0.05em",...L},title:"Switch runtime Kaspa network profile",children:M.map(b=>n.jsx("option",{value:b.id,style:{background:i.s1,color:i.text},children:b.label},b.id))})]}),n.jsx("button",{onClick:()=>s("create"),style:{background:r==="create"?i.s2:"none",border:`1px solid ${r==="create"?i.border:"transparent"}`,color:r==="create"?i.text:i.dim,padding:"5px 14px",borderRadius:4,fontSize:11,cursor:"pointer",...L},children:"NEW AGENT"}),o.map(b=>{const f=String((N==null?void 0:N.agentId)||"")===String((b==null?void 0:b.agentId)||"");return n.jsx("button",{onClick:()=>{u(String((b==null?void 0:b.agentId)||"")),s("dashboard")},style:{background:f&&r==="dashboard"?i.s2:"none",border:`1px solid ${f&&r==="dashboard"?i.accent:"transparent"}`,color:f?i.accent:i.dim,padding:"5px 10px",borderRadius:4,fontSize:11,cursor:"pointer",maxWidth:140,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",...L},title:String((b==null?void 0:b.name)||"Agent"),children:String((b==null?void 0:b.name)||"AGENT")},String((b==null?void 0:b.agentId)||(b==null?void 0:b.name)||Math.random()))}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,padding:"5px 12px",border:`1px solid ${i.border}`,borderRadius:4},children:[n.jsx("div",{style:{width:6,height:6,borderRadius:"50%",background:(e==null?void 0:e.provider)==="demo"?i.warn:i.ok}}),n.jsx("span",{style:{fontSize:10,color:i.dim,letterSpacing:"0.08em",...L},children:Ze(e==null?void 0:e.address)})]}),n.jsx(pe,{onClick:()=>{t(null),d([]),u(""),s("create")},variant:"ghost",size:"sm",children:"DISCONNECT"})]})]}),r==="create"||!N?n.jsx(Ea,{wallet:e,onComplete:g}):n.jsx(cl,{agent:N,agents:o,activeAgentId:a,onSelectAgent:b=>{u(b),s("dashboard")},wallet:e})]})]}):n.jsx(ua,{onConnect:v})}class ll extends Un.Component{constructor(r){super(r);gt(this,"resetApp",()=>{if(typeof window>"u")return;const r=new URL(window.location.href);r.searchParams.set("_recover",Date.now().toString()),window.location.replace(r.toString())});gt(this,"clearLocalStateAndReload",()=>{if(!(typeof window>"u")){try{const r=Object.keys(window.localStorage);for(const s of r)s.startsWith("forgeos.")&&window.localStorage.removeItem(s)}catch{}this.resetApp()}});this.state={hasError:!1,message:""}}static getDerivedStateFromError(r){return{hasError:!0,message:(r==null?void 0:r.message)||"Unknown runtime error"}}componentDidCatch(r){console.error("ForgeOS runtime crash:",r)}render(){return this.state.hasError?n.jsxs("div",{style:{minHeight:"100vh",background:"#0a0a0a",color:"#f5f5f5",padding:24,fontFamily:"ui-monospace, SFMono-Regular, Menlo, monospace"},children:[n.jsx("div",{style:{fontSize:16,fontWeight:700,marginBottom:8},children:"ForgeOS runtime error"}),n.jsx("div",{style:{fontSize:12,opacity:.8,marginBottom:12},children:"The app encountered an unexpected error. Reload, then check console/network config if this continues."}),n.jsx("pre",{style:{whiteSpace:"pre-wrap",background:"#111",border:"1px solid #222",padding:12,borderRadius:6},children:this.state.message}),n.jsxs("div",{style:{marginTop:12,display:"flex",gap:8,flexWrap:"wrap"},children:[n.jsx("button",{type:"button",onClick:this.resetApp,style:{border:"1px solid #3a4e66",background:"#111826",color:"#d7e4f7",borderRadius:8,padding:"8px 12px",cursor:"pointer"},children:"Retry App"}),n.jsx("button",{type:"button",onClick:this.clearLocalStateAndReload,style:{border:"1px solid #5a3340",background:"#241018",color:"#ffd5dc",borderRadius:8,padding:"8px 12px",cursor:"pointer"},children:"Clear ForgeOS Session"})]})]}):this.props.children}}window.__FORGEOS_BOOTED__=!0;document.documentElement.setAttribute("data-forgeos-booted","1");window.__FORGEOS_RENDERED__||(window.__FORGEOS_RENDERED__=!0,eo.createRoot(document.getElementById("root")).render(n.jsx(Un.StrictMode,{children:n.jsx(ll,{children:n.jsx(dl,{})})})));export{ps as A,ee as B,ge as C,Ct as E,$t as I,Ce as L,ft as T,i as a,pe as b,_l as c,$n as d,No as e,ml as f,it as g,Yt as h,Ut as i,_c as j,L as m};
