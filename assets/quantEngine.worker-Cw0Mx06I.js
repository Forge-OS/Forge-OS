(function(){"use strict";function s(e,t=0){const i=Number(e);return Number.isFinite(i)?i:t}function d(e,t,i){return Math.min(i,Math.max(t,e))}function _e(e){return e.length?e.reduce((t,i)=>t+i,0)/e.length:0}function Le(e){if(e.length<2)return 0;const t=_e(e);return e.reduce((i,r)=>i+(r-t)**2,0)/(e.length-1)}function Z(e){return Math.sqrt(Math.max(0,Le(e)))}function K(e){return e[e.length-1]}function Pe(e){if(e.length<2)return[];const t=[];for(let i=1;i<e.length;i+=1)t.push(e[i]-e[i-1]);return t}function D(e,t=1){if(e.length<=t)return 0;const i=K(e),r=e[e.length-1-t];return!(r>0)||!Number.isFinite(i)?0:(i-r)/r}function we(e){const t=[];for(let i=1;i<e.length;i+=1){const r=e[i-1],a=e[i];r>0&&a>0&&t.push(Math.log(a/r))}return t}function Re(e,t=.94){if(!e.length)return 0;let i=e[0]**2;for(let r=1;r<e.length;r+=1)i=t*i+(1-t)*e[r]**2;return Math.sqrt(Math.max(0,i))}function ue(e){if(e.length<2)return 0;const t=e.length;let i=0,r=0,a=0,c=0;for(let _=0;_<t;_+=1)i+=_,r+=e[_],a+=_*e[_],c+=_*_;const o=t*c-i*i;return o===0?0:(t*a-i*r)/o}function Ue(e,t){if(!t.length)return 0;const i=Z(t);return i===0?0:(e-_e(t))/i}function $e(e){if(!e.length)return 0;let t=e[0],i=0;for(const r of e)r>t&&(t=r),t>0&&(i=Math.max(i,(t-r)/t));return i}function Fe(e){return e>30?1:e<-30?0:1/(1+Math.exp(-e))}function l(e,t=4){const i=10**t;return Math.round(e*i)/i}function W(e,t){return t<=0?[]:e.slice(Math.max(0,e.length-t))}const Be={"1h":60*60*1e3,"4h":4*60*60*1e3,"24h":24*60*60*1e3},ee={"1h":.45,"4h":.35,"24h":.2};function He(e,t){return{candle:{timeframe:e,startTs:t,endTs:t,open:0,high:0,low:0,close:0,samples:0,coverage:0},returnPct:0,slopePct:0,volatilityPct:0,score:0}}function te(e,t,i){const r=Be[e],a=i-r,c=t.filter(E=>E.ts>=a&&E.ts<=i&&E.priceUsd>0);if(c.length<2)return He(e,i);const o=c[0],_=c[c.length-1];let n=-1/0,u=1/0;const p=[],m=[];for(let E=0;E<c.length;E+=1){const C=Math.max(0,s(c[E].priceUsd,0));if(p.push(C),C>n&&(n=C),C<u&&(u=C),E>0){const H=p[E-1];H>0&&C>0&&m.push(Math.log(C/H))}}const g=Math.max(0,s(o.priceUsd,0)),f=Math.max(0,s(_.priceUsd,0)),A=g>0?(f-g)/g*100:0,M=ue(p),S=g>0?M/g*100:0,T=Z(m)*100,b=Math.max(0,_.ts-o.ts),w=d(b/r,0,1),O=d(A/2.6,-1.2,1.2),h=d(S/.8,-1,1),v=d(T/2.5,0,.55),x=d(O*.65+h*.35-v,-1,1);return{candle:{timeframe:e,startTs:o.ts,endTs:_.ts,open:l(g,8),high:l(n===-1/0?f:n,8),low:l(u===1/0?f:u,8),close:l(f,8),samples:c.length,coverage:l(w,4)},returnPct:l(A,4),slopePct:l(S,4),volatilityPct:l(T,4),score:l(x,4)}}function Ve(e,t=Date.now()){const i=te("1h",e,t),r=te("4h",e,t),a=te("24h",e,t),c={"1h":i,"4h":r,"24h":a},o=Object.entries(c).filter(([,A])=>A.candle.samples>=2&&A.candle.coverage>.05);if(o.length===0)return{signals:c,weightedScore:0,alignment:0,coverage:0,dominantTimeframe:"1h"};let _=0,n=0,u=0,p=0,m={tf:"1h",strength:0};for(const[A,M]of o){const S=ee[A]*M.candle.coverage;_+=M.score*S,n+=S,u+=M.candle.coverage*ee[A],p+=Math.sign(M.score)*Math.min(1,Math.abs(M.score));const T=Math.abs(M.score)*M.candle.coverage*ee[A];T>m.strength&&(m={tf:A,strength:T})}const g=n>0?_/n:0,f=o.length>0?Math.abs(p/o.length):0;return{signals:c,weightedScore:l(d(g,-1,1),4),alignment:l(d(f,0,1),4),coverage:l(d(u,0,1),4),dominantTimeframe:m.tf}}function Ke(e){const t=String((e==null?void 0:e.risk)||"medium").toLowerCase(),i=String((e==null?void 0:e.strategyTemplate)||"").toLowerCase();if(t==="low"){const a={label:"low",kellyCap:.08,riskCeiling:.42,exposureCapPct:.12,drawdownPenaltyStart:.03};return i==="dca_accumulator"?{...a,kellyCap:.06,exposureCapPct:.1,drawdownPenaltyStart:.025}:i==="dca_bot"?{...a,kellyCap:.07,exposureCapPct:.11,drawdownPenaltyStart:.028}:i==="mean_reversion"?{...a,riskCeiling:.38,exposureCapPct:.1}:a}if(t==="high"){const a={label:"high",kellyCap:.22,riskCeiling:.82,exposureCapPct:.35,drawdownPenaltyStart:.1};return i==="vol_breakout"?{...a,kellyCap:.2,exposureCapPct:.28,riskCeiling:.76}:a}const r={label:"medium",kellyCap:.14,riskCeiling:.65,exposureCapPct:.22,drawdownPenaltyStart:.06};return i==="trend"?{...r,kellyCap:.16,exposureCapPct:.24}:i==="dca_accumulator"?{...r,kellyCap:.1,riskCeiling:.58,exposureCapPct:.16,drawdownPenaltyStart:.045}:i==="mean_reversion"?{...r,riskCeiling:.56,exposureCapPct:.18}:i==="vol_breakout"?{...r,kellyCap:.12,riskCeiling:.6,drawdownPenaltyStart:.05}:r}function qe(e){const t=String((e==null?void 0:e.strategyTemplate)||(e==null?void 0:e.strategyLabel)||"custom").toLowerCase();return t.includes("mean")?"mean_reversion":t.includes("trend")?"trend":t.includes("breakout")||t.includes("vol")?"vol_breakout":t.includes("dca")||t.includes("accum")?"dca":"custom"}function Ge(e,t,i,r){const a=qe(e),c=[`template:${a}`,`regime:${t}`];let o={mode:"BASELINE",reason:"",kellyCapMultiplier:1,riskCeilingMultiplier:1,exposureCapMultiplier:1,actionBias:0};return t==="RISK_OFF"?o={mode:"CAPITAL_PRESERVATION",reason:"risk_off",kellyCapMultiplier:.55,riskCeilingMultiplier:.78,exposureCapMultiplier:.62,actionBias:-.14}:a==="trend"?t==="RANGE_VOL"?o={mode:"TREND_TO_RANGE_DEFENSE",reason:"trend_template_range_vol",kellyCapMultiplier:.74,riskCeilingMultiplier:.86,exposureCapMultiplier:.78,actionBias:-.08}:(t==="TREND_UP"||t==="FLOW_ACCUMULATION")&&(o={mode:"TREND_CAPTURE",reason:"trend_template_aligned",kellyCapMultiplier:1.12,riskCeilingMultiplier:1.06,exposureCapMultiplier:1.1,actionBias:.06}):a==="mean_reversion"?t==="RANGE_VOL"?o={mode:"MEAN_REVERSION_ATTACK",reason:"mean_reversion_template_aligned",kellyCapMultiplier:1.1,riskCeilingMultiplier:1.04,exposureCapMultiplier:1.08,actionBias:.04}:t==="TREND_UP"&&(o={mode:"MEAN_REVERSION_TO_TREND_GUARD",reason:"mean_reversion_template_misaligned",kellyCapMultiplier:.86,riskCeilingMultiplier:.92,exposureCapMultiplier:.9,actionBias:-.03}):a==="dca"&&(t==="FLOW_ACCUMULATION"||t==="TREND_UP")?o={mode:"FLOW_DCA_SCALING",reason:"dca_template_flow_alignment",kellyCapMultiplier:1.08,riskCeilingMultiplier:1.02,exposureCapMultiplier:1.16,actionBias:.05}:a==="vol_breakout"&&t==="RANGE_VOL"&&(o={mode:"BREAKOUT_PREP",reason:"vol_breakout_template_aligned",kellyCapMultiplier:1.05,riskCeilingMultiplier:1.03,exposureCapMultiplier:1.03,actionBias:.03}),r.coverage>.2&&r.alignment<.45?(o.kellyCapMultiplier*=.84,o.exposureCapMultiplier*=.88,o.actionBias-=.04,c.push("mtf_alignment_low")):r.weightedScore>.35?(o.actionBias+=.03,c.push("mtf_bullish")):r.weightedScore<-.35&&(o.actionBias-=.06,c.push("mtf_bearish")),i==="HIGH"&&a!=="vol_breakout"&&(o.kellyCapMultiplier*=.9,o.exposureCapMultiplier*=.92,c.push("high_volatility_damping")),o.kellyCapMultiplier=d(o.kellyCapMultiplier,.45,1.22),o.riskCeilingMultiplier=d(o.riskCeilingMultiplier,.7,1.12),o.exposureCapMultiplier=d(o.exposureCapMultiplier,.55,1.28),o.actionBias=d(o.actionBias,-.2,.16),o.reason=[o.reason,...c].filter(Boolean).join(";"),o}function pe(e){var c,o,_,n,u,p,m,g;if(!e)return null;const t=s(e.ts??e.fetched??((c=e==null?void 0:e.kasData)==null?void 0:c.fetched)??((o=e==null?void 0:e.kasData)==null?void 0:o.ts),NaN),i=s(e.priceUsd??e.price??((_=e==null?void 0:e.kasData)==null?void 0:_.priceUsd),0),r=s(e.daaScore??((n=e==null?void 0:e.dag)==null?void 0:n.daaScore)??((u=e==null?void 0:e.kasData)==null?void 0:u.daaScore)??((m=(p=e==null?void 0:e.kasData)==null?void 0:p.dag)==null?void 0:m.daaScore),0),a=s(e.walletKas??((g=e==null?void 0:e.kasData)==null?void 0:g.walletKas),0);return!Number.isFinite(t)||t<=0?null:{ts:t,priceUsd:Math.max(0,i),daaScore:Math.max(0,r),walletKas:Math.max(0,a)}}function je(e,t){const i=[];for(const c of Array.isArray(t==null?void 0:t.history)?t.history:[]){const o=pe(c);o&&i.push(o)}const r=pe(e);r&&i.push(r),i.sort((c,o)=>c.ts-o.ts);const a=[];for(const c of i){const o=a[a.length-1];o&&c.ts===o.ts&&c.priceUsd===o.priceUsd&&c.daaScore===o.daaScore&&c.walletKas===o.walletKas||a.push(c)}return a.slice(-240)}function ze(e){return e<.008?"LOW":e<.02?"MEDIUM":"HIGH"}function We(e,t){return!(t>0)||e<=t*.06?"MINIMAL":e<=t*.2?"MODERATE":"SIGNIFICANT"}function Qe(e,t,i,r,a,c){return e<-.45||i>.12&&t>.02?"RISK_OFF":e>.35&&t<.03&&r>=0&&a>=.1?"TREND_UP":e<-.25&&a<-.18&&c>=.45?"TREND_DOWN":Math.abs(e)<.15&&t>.015&&c<.65?"RANGE_VOL":r>.25&&e>=0&&a>=-.05?"FLOW_ACCUMULATION":"NEUTRAL"}function Ye(e){const t=[];return e.dataQualityScore<.55&&t.push("Limited local sample history"),e.volatilityEstimate==="HIGH"&&t.push("Elevated short-horizon volatility"),e.drawdownPct>.08&&t.push("Recent drawdown pressure"),e.liquidityImpact!=="MINIMAL"&&t.push("Position size may impact wallet liquidity"),e.regime==="RISK_OFF"&&t.push("Risk-off regime detected"),typeof e.mtfAlignment=="number"&&e.mtfAlignment<.45&&t.push("Timeframe trend alignment is weak"),e.strategyMode&&e.strategyMode!=="BASELINE"&&t.push(`Regime-adaptive mode: ${e.strategyMode.toLowerCase().replace(/_/g," ")}`),t.length===0&&t.push("Normal market conditions"),t.slice(0,5)}function Je(e){const t=e.momentumScore>.2?"positive momentum":e.momentumScore<-.2?"negative momentum":"mixed momentum",i=e.regime.toLowerCase().replace(/_/g," "),r=e.mtfScore>.2?"bullish":e.mtfScore<-.2?"bearish":"mixed";return[`${e.action} because the local quant core detects ${i} with ${t}, EWMA volatility ${(e.ewmaVol*100).toFixed(2)}%, and DAA velocity ${l(e.daaVelocity,2)}.`,`Regime-adaptive mode ${e.strategyMode.toLowerCase().replace(/_/g," ")} is active; multi-timeframe (${e.mtfDominant}) signal is ${r}.`,`Model win probability is ${(e.winProbability*100).toFixed(1)}% with expected value ${l(e.expectedValuePct,2)}%; sizing is capped by risk profile and data-quality score ${l(e.dataQualityScore,2)}.`].join(" ")}function Xe(e,t,i){const r=je(t,i),a=Ke(e),c=Math.max(0,s(e==null?void 0:e.capitalLimit,0)),o=r[r.length-1],_=s(i==null?void 0:i.now,Date.now()),n=Ve(r,_),u=r.map(L=>L.priceUsd).filter(L=>L>0),p=r.map(L=>L.daaScore).filter(L=>L>0),m=r.map(L=>L.walletKas).filter(L=>L>=0),g=we(u),f=W(g,24),A=g.length?K(g):0,M=Re(f,.92),S=ze(M),T=D(u,1),b=D(u,5),w=D(u,20),O=T*1.4+b*.9+w*.6+n.weightedScore*.45+n.signals["1h"].score*.2,h=d(O*12,-2,2),v=d(Ue(A,f),-4,4),x=Pe(p),E=x.length?K(x):0,C=ue(W(p,16)),H=Z(W(x,16)),se=d(C/Math.max(1,Math.abs(E)||1)*.25+(E>0?.15:-.1),-1,1),P=i==null?void 0:i.dagSignals,vt=P?d(P.bpsDeviation/200,-.12,.12)+(P.activitySurge?.08:0):0,Ae=d(se+vt,-1,1),Y=$e(W(u,48)),Et=d(u.length/32,0,1),Tt=d(p.length/32,0,1),bt=d(r.length/48,0,1),F=d(.15+bt*.45+Et*.3+Tt*.1,.15,1),U=Qe(h,M,Y,Ae,n.weightedScore,n.alignment),k=Ge(e,U,S,n),J=d(a.riskCeiling*k.riskCeilingMultiplier,.18,.94),X=d(a.exposureCapPct*k.exposureCapMultiplier,.04,.55),ve=d(M/.03,0,2),Ee=d((Y-a.drawdownPenaltyStart)/Math.max(.01,.2-a.drawdownPenaltyStart),0,1.2),kt=1-F,Ct=d((h+k.actionBias)/2,-1,1),It=Fe(.1+Ct*1.2+Ae*.55+n.weightedScore*.48+k.actionBias*.45-ve*.55-Ee*.6),B=d(.5+(It-.5)*(.4+F*.6),.35,.82),xt=l(B*100,2),Te=h+k.actionBias>.35?2.1:h+k.actionBias<-.35?1.1:S==="HIGH"?1.3:1.7,G=l(d(M*100*2.2+1.4,1.2,12),2),be=l(d(G*Te,2.2,22),2),V=l(B*be-(1-B)*G,2),Ot=Math.max(.01,Te),ke=Math.max(0,B-(1-B)/Ot),ae=d(a.kellyCap*k.kellyCapMultiplier*(.55+.45*F),.015,Math.max(.02,a.kellyCap*1.25)),ce=l(d(ke,0,ae),4),j=l(d(.18+ve*.26+Ee*.28+(h<-.35?.16:0)+(S==="HIGH"&&H>15?.1:0)+kt*.18-(h>.35?.06:0)-(n.weightedScore>.25&&n.alignment>.55?.04:0)+(U==="RISK_OFF"?.08:0),.04,.98),4),Nt=l(V/Math.max(1,G),4),Ce=Math.max(0,s((o==null?void 0:o.walletKas)??(t==null?void 0:t.walletKas),0)),z=Ce>0?Ce:Math.max(0,K(m)||0),Ie=h+k.actionBias*1.3+n.weightedScore*.4,Lt=d(.35-k.actionBias*.8-n.weightedScore*.1,.16,.52),Pt=-.2-k.actionBias*.5;let N="HOLD";j>J+.08&&Ie<Pt&&z>.5?N="REDUCE":V>Lt&&ce>.008&&j<=J?N="ACCUMULATE":Math.abs(Ie)<.12&&S==="HIGH"&&(N="REBALANCE");const le=c*ce*(1+d(V/6,0,.65))*d(1+k.actionBias,.75,1.25),wt=c*X,xe=z>0?z*Math.max(.08,X):c;let $=Math.min(c,Math.max(0,le),wt,xe);N==="HOLD"&&($=0),N==="REDUCE"&&($=Math.min(Math.max(c*.05,le),z*.25||c)),N==="REBALANCE"&&($=Math.min(Math.max(c*.03,le*.7),xe)),$=l(Math.max(0,$),6);const Rt=c>0?l(d($/c*100,0,100),2):0,Oe=We($,z||c||1),Ut=N==="ACCUMULATE"?U==="TREND_UP"||U==="FLOW_ACCUMULATION"?"ENTRY":"SCALING":N==="REDUCE"?"EXIT":"HOLDING",$t=l(d(.52+d(Math.abs(V)/5,0,.2)+F*.14+n.alignment*.06+Math.abs(n.weightedScore)*.05-j*.12+(N==="HOLD"?.02:0),.45,.97),4),Ft=Ye({dataQualityScore:F,volatilityEstimate:S,drawdownPct:Y,liquidityImpact:Oe,regime:U,mtfAlignment:n.alignment,strategyMode:k.mode}),Bt=Je({action:N,regime:U,momentumScore:h,ewmaVol:M,winProbability:B,expectedValuePct:V,dataQualityScore:F,daaVelocity:E,strategyMode:k.mode,mtfScore:n.weightedScore,mtfDominant:n.dominantTimeframe}),Ne=d(Math.round(45+j*120+(S==="HIGH"?45:0)),45,240),Ht=new Date(_+Ne*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),Vt={regime:U,sample_count:r.length,data_quality_score:l(F,4),price_usd:l(s(K(u),s(t==null?void 0:t.priceUsd,0)),6),price_return_1_pct:l(T*100,4),price_return_5_pct:l(b*100,4),price_return_20_pct:l(w*100,4),momentum_z:l(v,4),ewma_volatility:l(M,6),daa_velocity:l(E,4),daa_slope:l(C,4),bps_velocity:P?l(P.bpsVelocity,2):void 0,bps_deviation_pct:P?l(P.bpsDeviation,2):void 0,dag_momentum_bias:P?l(P.dagMomentumBias,4):void 0,drawdown_pct:l(Y*100,4),win_probability_model:l(B,4),edge_score:l(Nt,4),kelly_raw:l(ke,4),kelly_cap:l(ae,4),risk_ceiling:l(J,4),risk_profile:a.label,exposure_cap_pct:l(X*100,4),strategy_template:String((e==null?void 0:e.strategyTemplate)||"custom"),strategy_mode:k.mode,strategy_mode_reason:k.reason,mtf_signal_1h:l(n.signals["1h"].score,4),mtf_signal_4h:l(n.signals["4h"].score,4),mtf_signal_24h:l(n.signals["24h"].score,4),mtf_alignment_score:l(n.alignment,4),mtf_weighted_score:l(n.weightedScore,4),mtf_coverage_score:l(n.coverage,4),mtf_dominant_timeframe:n.dominantTimeframe,adaptive_kelly_cap:l(ae,4),adaptive_risk_ceiling:l(J,4),adaptive_exposure_cap_pct:l(X*100,4)};return{action:N,confidence_score:$t,risk_score:j,kelly_fraction:ce,capital_allocation_kas:$,capital_allocation_pct:Rt,expected_value_pct:V,stop_loss_pct:G,take_profit_pct:be,monte_carlo_win_pct:xt,volatility_estimate:S,liquidity_impact:Oe,strategy_phase:Ut,rationale:Bt,risk_factors:Ft,next_review_trigger:`Re-evaluate in ~${Ne}s (around ${Ht}) or on >${l(G/2,2)}% price move / regime change.`,decision_source:"quant-core",decision_source_detail:`regime:${U};mode:${k.mode};samples:${r.length};mtf:${l(n.weightedScore,3)}`,quant_metrics:Vt}}function Ze(e){return{...e||{},risk_factors:Array.isArray(e==null?void 0:e.risk_factors)?[...e.risk_factors]:[],quant_metrics:e!=null&&e.quant_metrics&&typeof e.quant_metrics=="object"?{...e.quant_metrics}:void 0}}function De(e){const t=new Map;return{get(i){return t.get(i)||null},set(i,r,a){for(t.set(i,{ts:Date.now(),signature:r,decision:Ze(a)});t.size>e;){const c=t.keys().next().value;if(!c)break;t.delete(c)}}}}function et(e,t){var g,f;const i=String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"default").trim().toLowerCase(),r=String((e==null?void 0:e.risk)||"medium").trim().toLowerCase(),a=String((e==null?void 0:e.strategyTemplate)||(e==null?void 0:e.strategyLabel)||"custom").trim().toLowerCase(),c=String((e==null?void 0:e.execMode)||(e==null?void 0:e.mode)||"default").trim().toLowerCase(),o=l(Math.max(0,s(e==null?void 0:e.capitalLimit,0)),6),_=l(Math.max(0,s(e==null?void 0:e.kpiTarget,0)),4),n=Math.max(0,Math.round(s(e==null?void 0:e.horizon,0))),u=l(Math.max(0,s(e==null?void 0:e.autoApproveThreshold,0)),6),p=String((t==null?void 0:t.address)||"").trim().toLowerCase(),m=String(((g=t==null?void 0:t.dag)==null?void 0:g.networkName)||((f=t==null?void 0:t.dag)==null?void 0:f.network)||"").trim().toLowerCase();return[i,r,`tpl:${a}`,`mode:${c}`,`${o}`,`kpi:${_}`,`hz:${n}`,`aa:${u}`,`addr:${p}`,`net:${m}`].join("|")}function tt(e){const t=(e==null?void 0:e.quant_metrics)||{},i=String(t.regime||"NA"),r=String((e==null?void 0:e.volatility_estimate)||"NA"),a=String((e==null?void 0:e.action)||"HOLD"),c=Math.round(d(s(e==null?void 0:e.confidence_score,0)*10,0,10)),o=Math.round(d(s(e==null?void 0:e.risk_score,1)*10,0,10)),_=Math.round(d(s(t.edge_score,0)*10,-20,20)),n=Math.round(d(s(e==null?void 0:e.kelly_fraction,0)*100,0,100)),u=Math.round(d(s(t.data_quality_score,0)*10,0,10)),p=Math.round(d(s(t.sample_count,0),0,999));return[i,r,a,`c${c}`,`r${o}`,`e${_}`,`k${n}`,`d${u}`,`s${p}`].join("|")}const Q="sha256/canonical-json";function ie(e){if(e==null)return"null";const t=typeof e;return t==="number"?Number.isFinite(e)?JSON.stringify(e):"null":t==="boolean"?e?"true":"false":t==="string"?JSON.stringify(e):Array.isArray(e)?`[${e.map(i=>ie(i)).join(",")}]`:t==="object"?`{${Object.entries(e).filter(([r,a])=>typeof a<"u").sort(([r],[a])=>r.localeCompare(a)).map(([r,a])=>`${JSON.stringify(r)}:${ie(a)}`).join(",")}}`:"null"}async function it(e){var c;const i=new TextEncoder().encode(e),r=(c=globalThis.crypto)==null?void 0:c.subtle;if(!r||typeof r.digest!="function")throw new Error("SHA-256 hashing requires WebCrypto subtle.digest");const a=await r.digest("SHA-256",i);return Array.from(new Uint8Array(a)).map(o=>o.toString(16).padStart(2,"0")).join("")}async function re(e){return`${Q}:${await it(ie(e))}`}function rt(e,t){return{audit_record_version:String((e==null?void 0:e.audit_record_version)||t.decisionAuditRecordVersion),hash_algo:String((e==null?void 0:e.hash_algo)||t.auditHashAlgo),prompt_version:String((e==null?void 0:e.prompt_version)||t.aiPromptVersion),ai_response_schema_version:String((e==null?void 0:e.ai_response_schema_version)||t.aiResponseSchemaVersion),quant_feature_snapshot_hash:String((e==null?void 0:e.quant_feature_snapshot_hash)||""),decision_hash:String((e==null?void 0:e.decision_hash)||""),overlay_plan_reason:String((e==null?void 0:e.overlay_plan_reason)||""),engine_path:String((e==null?void 0:e.engine_path)||""),created_ts:Math.max(0,Math.round(s(e==null?void 0:e.created_ts,Date.now())))}}function de(e){return new Promise(t=>setTimeout(t,e))}function me(e){const t=Math.floor(Math.random()*90);return 160*(e+1)+t}function nt(e){try{return JSON.parse(e)}catch{throw new Error("AI response was not valid JSON")}}function ot(e){const t={"Content-Type":"application/json"};if(e.apiUrl.includes("api.anthropic.com")){if(!e.anthropicApiKey)throw new Error("Anthropic API key missing. Set VITE_ANTHROPIC_API_KEY or configure VITE_AI_API_URL to your secure backend endpoint.");t["x-api-key"]=e.anthropicApiKey,t["anthropic-version"]="2023-06-01"}return t}function st(e,t,i){var c,o,_,n,u,p,m;const r={fetched:s(t==null?void 0:t.fetched,0),address:String((t==null?void 0:t.address)||""),walletKas:l(s(t==null?void 0:t.walletKas,0),6),priceUsd:l(s(t==null?void 0:t.priceUsd,0),8),dag:{daaScore:s((c=t==null?void 0:t.dag)==null?void 0:c.daaScore,0),difficulty:s(((o=t==null?void 0:t.dag)==null?void 0:o.difficulty)??((_=t==null?void 0:t.dag)==null?void 0:_.virtualDaaScore),0),networkName:String(((n=t==null?void 0:t.dag)==null?void 0:n.networkName)||((u=t==null?void 0:t.dag)==null?void 0:u.network)||""),pastMedianTime:s(((p=t==null?void 0:t.dag)==null?void 0:p.pastMedianTime)??((m=t==null?void 0:t.dag)==null?void 0:m.virtualPastMedianTime),0)}},a=(i==null?void 0:i.quant_metrics)||{};return`You are a quant-grade AI risk overlay for a Kaspa-native autonomous trading engine. The local quant core (deterministic math) has already computed features, regime, Kelly cap, and risk limits. Your job is to refine the decision WITHOUT violating the local risk envelope.

Respond ONLY with a valid JSON object â€” no markdown, no prose, no code fences.

AGENT PROFILE:
Name: ${e.name}
Strategy: momentum / on-chain flow / risk-controlled execution
Risk Tolerance: ${e.risk} (low=conservative, high=aggressive)
KPI Target: ${e.kpiTarget}% ROI
Capital per Cycle: ${e.capitalLimit} KAS
Auto-Approve Threshold: ${e.autoApproveThreshold} KAS

KASPA SNAPSHOT:
${JSON.stringify(r)}

LOCAL QUANT CORE PRIOR (trust this as the primary signal unless you have a strong reason):
${JSON.stringify({action:i.action,confidence_score:i.confidence_score,risk_score:i.risk_score,kelly_fraction:i.kelly_fraction,capital_allocation_kas:i.capital_allocation_kas,expected_value_pct:i.expected_value_pct,stop_loss_pct:i.stop_loss_pct,take_profit_pct:i.take_profit_pct,monte_carlo_win_pct:i.monte_carlo_win_pct,quant_metrics:a,rationale:i.rationale,risk_factors:i.risk_factors})}

RULES:
1. Do not exceed quant_metrics.kelly_cap in kelly_fraction.
2. Do not exceed local quant capital_allocation_kas by more than 25%.
3. If quant_metrics.regime is RISK_OFF, avoid ACCUMULATE unless confidence_score >= 0.9 and risk_score <= quant_metrics.risk_ceiling.
4. Preserve strict risk discipline; prefer HOLD over low-quality conviction.
5. Keep rationale concise and reference actual metrics from the snapshot/core prior.

OUTPUT (strict JSON, all fields required):
{
  "action": "ACCUMULATE or REDUCE or HOLD or REBALANCE",
  "confidence_score": 0.00,
  "risk_score": 0.00,
  "kelly_fraction": 0.00,
  "capital_allocation_kas": 0.00,
  "capital_allocation_pct": 0,
  "expected_value_pct": 0.00,
  "stop_loss_pct": 0.00,
  "take_profit_pct": 0.00,
  "monte_carlo_win_pct": 0,
  "volatility_estimate": "LOW or MEDIUM or HIGH",
  "liquidity_impact": "MINIMAL or MODERATE or SIGNIFICANT",
  "strategy_phase": "ENTRY or SCALING or HOLDING or EXIT",
  "rationale": "Two concise sentences citing specific metrics and why this refines the quant-core prior.",
  "risk_factors": ["factor1", "factor2", "factor3"],
  "next_review_trigger": "Describe the specific condition that should trigger next decision cycle"
}`}async function at(e){var u;const{agent:t,kasData:i,quantCoreDecision:r,config:a,sanitizeDecision:c}=e,o=st(t,i,r),_=a.apiUrl.includes("api.anthropic.com")?{model:a.model,max_tokens:900,messages:[{role:"user",content:o}]}:{prompt:o,agent:t,kasData:i,quantCore:r};let n;for(let p=0;p<a.maxAttempts;p+=1){const m=new AbortController,g=setTimeout(()=>m.abort(),a.timeoutMs);try{const f=await fetch(a.apiUrl,{method:"POST",headers:ot(a),body:JSON.stringify(_),signal:m.signal});if(!f.ok){const A=Number(f.status||0);if(a.retryableStatuses.has(A)&&p+1<a.maxAttempts){await de(me(p));continue}throw new Error(`AI endpoint ${A||"request_failed"}`)}n=await f.json();break}catch(f){const A=(f==null?void 0:f.name)==="AbortError",M=String((f==null?void 0:f.message)||""),S=(f==null?void 0:f.name)==="TypeError"||/failed to fetch|network|load failed/i.test(M);if(!A&&S&&p+1<a.maxAttempts){await de(me(p));continue}throw f}finally{clearTimeout(g)}}if((u=n==null?void 0:n.error)!=null&&u.message)throw new Error(n.error.message);if(Array.isArray(n==null?void 0:n.content)){const p=n.content.map(g=>g.text||"").join(""),m=nt(p.replace(/```json|```/g,"").trim());return c({...m,decision_source:"ai"},t)}return n!=null&&n.decision?c({...n.decision,decision_source:"ai"},t):c({...n,decision_source:"ai"},t)}function ct(e){const{coreDecision:t,cached:i,config:r}=e,a=Date.now(),c=tt(t),o=(t==null?void 0:t.quant_metrics)||{};if(!r.aiTransportReady)return{kind:"skip",reason:"ai_transport_not_configured",signature:c};if(r.aiOverlayMode==="off")return{kind:"skip",reason:"ai_overlay_mode_off",signature:c};if(r.aiOverlayMode==="always")return{kind:"call",reason:"ai_overlay_mode_always",signature:c};if(i&&i.signature===c){const O=Math.max(0,a-i.ts);if(O<=r.minIntervalMs)return{kind:"reuse",reason:`cache_hit_min_interval_${O}ms`,signature:c};if(r.aiOverlayMode==="adaptive"&&O<=r.cacheTtlMs){const h=s(t==null?void 0:t.confidence_score,0),v=s(t==null?void 0:t.risk_score,1),x=s(o.risk_ceiling,.65),E=String(o.regime||"NEUTRAL"),C=Math.abs(s(o.edge_score,0)),H=h<.88&&h>.56,se=Math.abs(v-x)<.06;if(!H&&!se&&!(E==="RISK_OFF"||E==="RANGE_VOL")&&C>.2)return{kind:"reuse",reason:`cache_hit_stable_state_${O}ms`,signature:c}}}const _=s(o.data_quality_score,0),n=s(t==null?void 0:t.confidence_score,0),u=s(t==null?void 0:t.risk_score,1),p=s(o.risk_ceiling,.65),m=String(o.regime||"NEUTRAL"),g=Math.abs(s(o.edge_score,0)),f=s(o.sample_count,0),A=s(t==null?void 0:t.kelly_fraction,0);if(_<.4||f<6)return{kind:"skip",reason:"low_data_quality",signature:c};const M=m==="RISK_OFF"||m==="RANGE_VOL",S=Math.abs(u-p)<.08,T=n<.9&&n>.58,b=g<.12;return _>=.72&&n>=.88&&!M&&!S&&g>=.25&&(A===0||A>=.02)?{kind:"skip",reason:"quant_core_high_conviction",signature:c}:M||S||T||b?{kind:"call",reason:"adaptive_uncertain_or_sensitive",signature:c}:{kind:"skip",reason:"adaptive_cost_control",signature:c}}function lt(e,t,i){const r=[...Array.isArray(e)?e:[],...Array.isArray(t)?t:[]];return i&&r.push(i),Array.from(new Set(r.map(a=>String(a).trim()).filter(Boolean))).slice(0,6)}function _t(e){var x,E,C;const{agent:t,coreDecision:i,aiDecision:r,aiLatencyMs:a,startedAt:c,sanitizeDecision:o}=e,_=String(((x=i==null?void 0:i.quant_metrics)==null?void 0:x.regime)||"NEUTRAL"),n=s((E=i==null?void 0:i.quant_metrics)==null?void 0:E.risk_ceiling,.65),u=String((r==null?void 0:r.action)||"HOLD");let p=u,m=!1;_==="RISK_OFF"&&u==="ACCUMULATE"&&(p=i.action==="REDUCE"?"REDUCE":"HOLD",m=!0),s(i==null?void 0:i.risk_score,0)>n&&u==="ACCUMULATE"&&(p=i.action==="REDUCE"?"REDUCE":"HOLD",m=!0);const g=l(Math.max(s(i==null?void 0:i.risk_score,1),s(r==null?void 0:r.risk_score,1)),4);let f=l(d(s(i==null?void 0:i.confidence_score,.5)*.58+s(r==null?void 0:r.confidence_score,.5)*.42-(m?.08:0),0,1),4);p==="HOLD"&&(f=Math.min(f,.86));const A=s((C=i==null?void 0:i.quant_metrics)==null?void 0:C.kelly_cap,s(i==null?void 0:i.kelly_fraction,0)),M=l(d(Math.min(Math.max(s(i==null?void 0:i.kelly_fraction,0)*.8,s(r==null?void 0:r.kelly_fraction,0)*.6),A||1),0,1),4);let S=0;const T=s(i==null?void 0:i.capital_allocation_kas,0),b=s(r==null?void 0:r.capital_allocation_kas,0);p==="ACCUMULATE"?S=Math.min(b||T,T*1.25||b||0):(p==="REDUCE"||p==="REBALANCE")&&(S=Math.min(Math.max(T,b*.75),Math.max(T*1.5,b)));const w=lt(i==null?void 0:i.risk_factors,r==null?void 0:r.risk_factors,m?"AI signal conflict; core risk override applied":void 0),O=String((r==null?void 0:r.rationale)||"AI overlay unavailable.").trim(),v=`${String((i==null?void 0:i.rationale)||"").trim()} AI overlay: ${O}`.slice(0,900);return o({...r,action:p,confidence_score:f,risk_score:g,kelly_fraction:M,capital_allocation_kas:p==="HOLD"?0:S,expected_value_pct:l(s(i==null?void 0:i.expected_value_pct,0)*.6+s(r==null?void 0:r.expected_value_pct,0)*.4,2),stop_loss_pct:l(Math.max(s(i==null?void 0:i.stop_loss_pct,0),s(r==null?void 0:r.stop_loss_pct,0)),2),take_profit_pct:l(s(i==null?void 0:i.take_profit_pct,0)*.6+s(r==null?void 0:r.take_profit_pct,0)*.4,2),monte_carlo_win_pct:l(s(i==null?void 0:i.monte_carlo_win_pct,0)*.65+s(r==null?void 0:r.monte_carlo_win_pct,0)*.35,2),volatility_estimate:(i==null?void 0:i.volatility_estimate)||(r==null?void 0:r.volatility_estimate),liquidity_impact:(i==null?void 0:i.liquidity_impact)||(r==null?void 0:r.liquidity_impact),strategy_phase:p==="ACCUMULATE"?(i==null?void 0:i.strategy_phase)||(r==null?void 0:r.strategy_phase):(r==null?void 0:r.strategy_phase)||(i==null?void 0:i.strategy_phase),rationale:v,risk_factors:w,next_review_trigger:(i==null?void 0:i.next_review_trigger)||(r==null?void 0:r.next_review_trigger),decision_source:"hybrid-ai",decision_source_detail:`regime:${_};ai_latency_ms:${a};mode:quant_core_guarded`,quant_metrics:{...(i==null?void 0:i.quant_metrics)||{},ai_overlay_applied:!0,ai_action_raw:u,ai_confidence_raw:s(r==null?void 0:r.confidence_score,0)},engine_latency_ms:Date.now()-c},t)}const I={};function ut(e,t=!1){const i=String(e??"").trim();return i?/^(1|true|yes)$/i.test(i):t}function pt(e){const t=String(e||"always").trim().toLowerCase();return t==="off"||t==="always"||t==="adaptive"?t:"adaptive"}const ne=I.VITE_AI_API_URL||"https://api.anthropic.com/v1/messages",he=I.VITE_ANTHROPIC_API_KEY||"",fe=Math.max(0,Number(I.VITE_AI_OVERLAY_MIN_INTERVAL_MS||15e3)),dt=Math.max(fe,Number(I.VITE_AI_OVERLAY_CACHE_TTL_MS||45e3)),y={aiApiUrl:ne,aiModel:I.VITE_AI_MODEL||"claude-sonnet-4-20250514",anthropicApiKey:he,aiTimeoutMs:Math.max(800,Number(I.VITE_AI_SOFT_TIMEOUT_MS||2200)),aiFallbackEnabled:String(I.VITE_AI_FALLBACK_ENABLED||"true").toLowerCase()!=="false",aiOverlayMode:pt(I.VITE_AI_OVERLAY_MODE),aiOverlayMinIntervalMs:fe,aiOverlayCacheTtlMs:dt,aiOverlayCacheMaxEntries:512,aiTransportReady:!!ne&&(!ne.includes("api.anthropic.com")||!!he),aiMaxAttempts:Math.max(1,Math.min(3,Number(I.VITE_AI_MAX_ATTEMPTS||2))),aiRetryableStatuses:new Set([408,425,429,500,502,503,504]),decisionAuditRecordVersion:"forgeos.decision.audit.v1",aiPromptVersion:"forgeos.quant.overlay.prompt.v1",aiResponseSchemaVersion:"forgeos.ai.decision.schema.v1",auditSignerUrl:String(I.VITE_DECISION_AUDIT_SIGNER_URL||"").trim(),auditSignerToken:String(I.VITE_DECISION_AUDIT_SIGNER_TOKEN||"").trim(),auditSignerTimeoutMs:Math.max(500,Number(I.VITE_DECISION_AUDIT_SIGNER_TIMEOUT_MS||1500)),auditSignerRequired:ut(I.VITE_DECISION_AUDIT_SIGNER_REQUIRED,!1)};function oe(e,t){return[String(e||"").trim(),t].filter(Boolean).join(";").slice(0,220)}function ye(e){const{agent:t,coreDecision:i,reason:r,startedAt:a,sanitizeDecision:c}=e;return c({...i,decision_source:"quant-core",decision_source_detail:oe(i==null?void 0:i.decision_source_detail,`fallback_reason:${r}`),engine_latency_ms:Date.now()-a},t)}function ge(e){var o;const{agent:t,cached:i,startedAt:r,reason:a,sanitizeDecision:c}=e;return c({...i.decision||{},decision_source:"hybrid-ai",decision_source_detail:oe((o=i==null?void 0:i.decision)==null?void 0:o.decision_source_detail,a),engine_latency_ms:Date.now()-r},t)}const Me=De(y.aiOverlayCacheMaxEntries);function mt(){const e={"Content-Type":"application/json"};return y.auditSignerToken&&(e.Authorization=`Bearer ${y.auditSignerToken}`),e}async function ht(e){var c;const t=e==null?void 0:e.audit_record;if(!t||!y.auditSignerUrl)return e;const i=rt(t,{decisionAuditRecordVersion:y.decisionAuditRecordVersion,auditHashAlgo:Q,aiPromptVersion:y.aiPromptVersion,aiResponseSchemaVersion:y.aiResponseSchemaVersion}),r=new AbortController,a=setTimeout(()=>r.abort(),y.auditSignerTimeoutMs);try{const o=await fetch(y.auditSignerUrl,{method:"POST",headers:mt(),body:JSON.stringify({signingPayload:i}),signal:r.signal}),_=await o.json().catch(()=>({}));if(!o.ok)throw new Error(String(((c=_==null?void 0:_.error)==null?void 0:c.message)||`audit_signer_${o.status||"failed"}`));const n=_!=null&&_.signature&&typeof _.signature=="object"?_.signature:_,u={status:"signed",alg:String((n==null?void 0:n.alg)||(n==null?void 0:n.algorithm)||"unknown").slice(0,80),key_id:String((n==null?void 0:n.keyId)||(n==null?void 0:n.key_id)||"").slice(0,160),sig_b64u:String((n==null?void 0:n.signatureB64u)||(n==null?void 0:n.signature)||(n==null?void 0:n.sig_b64u)||"").slice(0,600),payload_hash_sha256_b64u:String((n==null?void 0:n.payloadHashSha256B64u)||(n==null?void 0:n.payload_hash_sha256_b64u)||"").slice(0,160),signer:String((n==null?void 0:n.signer)||"audit-signer").slice(0,80),signed_ts:Math.max(0,Math.round(s((n==null?void 0:n.signedAt)??(n==null?void 0:n.signed_ts),Date.now()))),signing_latency_ms:Math.max(0,Math.round(s((n==null?void 0:n.signingLatencyMs)??(n==null?void 0:n.signing_latency_ms),0))),public_key_pem:typeof(n==null?void 0:n.publicKeyPem)=="string"?n.publicKeyPem.slice(0,4e3):typeof(n==null?void 0:n.public_key_pem)=="string"?n.public_key_pem.slice(0,4e3):void 0};return{...e,audit_record:{...t,crypto_signature:u}}}catch(o){const _=(o==null?void 0:o.name)==="AbortError"?`audit_signer_timeout_${y.auditSignerTimeoutMs}ms`:String((o==null?void 0:o.message)||"audit_signer_failed");if(y.auditSignerRequired)throw new Error(_);return{...e,audit_record:{...t,crypto_signature:{status:"error",signer:"audit-signer",error:_.slice(0,240)}}}}finally{clearTimeout(a)}}function ft(e){if(!e||typeof e!="object"||Array.isArray(e))return;const t={};for(const[i,r]of Object.entries(e))if(i){if(typeof r=="number"){if(!Number.isFinite(r))continue;t[i]=Math.abs(r)>=1e3?Math.round(r):l(r,6);continue}if(typeof r=="string"){t[i]=r.slice(0,80);continue}typeof r=="boolean"&&(t[i]=r)}return Object.keys(t).length>0?t:void 0}function R(e,t){const i=String((e==null?void 0:e.action)||"HOLD").toUpperCase(),r=["ACCUMULATE","REDUCE","HOLD","REBALANCE"].includes(i)?i:"HOLD",a=Math.max(0,s(t==null?void 0:t.capitalLimit,0)),c=d(s(e==null?void 0:e.capital_allocation_kas,0),0,a),o=a>0?d(c/a*100,0,100):d(s(e==null?void 0:e.capital_allocation_pct,0),0,100),_=d(s(e==null?void 0:e.confidence_score,0),0,1),n=d(s(e==null?void 0:e.risk_score,1),0,1),u=String((e==null?void 0:e.volatility_estimate)||"MEDIUM").toUpperCase(),p=["LOW","MEDIUM","HIGH"].includes(u)?u:"MEDIUM",m=String((e==null?void 0:e.liquidity_impact)||"MODERATE").toUpperCase(),g=["MINIMAL","MODERATE","SIGNIFICANT"].includes(m)?m:"MODERATE",f=String((e==null?void 0:e.strategy_phase)||"HOLDING").toUpperCase(),A=["ENTRY","SCALING","HOLDING","EXIT"].includes(f)?f:"HOLDING",M=Array.isArray(e==null?void 0:e.risk_factors)?e.risk_factors.map(E=>String(E)).filter(Boolean).slice(0,6):[],S=String((e==null?void 0:e.decision_source)||"ai").toLowerCase(),T=["ai","fallback","quant-core","hybrid-ai"].includes(S)?S:"ai",b=String((e==null?void 0:e.decision_source_detail)||"").slice(0,220),w=ft(e==null?void 0:e.quant_metrics),O=Math.max(0,Math.round(s(e==null?void 0:e.engine_latency_ms,0))),h=e!=null&&e.audit_record&&typeof e.audit_record=="object"?e.audit_record:null,v=h!=null&&h.crypto_signature&&typeof h.crypto_signature=="object"?h.crypto_signature:null,x=h?{audit_record_version:String(h.audit_record_version||y.decisionAuditRecordVersion).slice(0,80),hash_algo:String(h.hash_algo||Q).slice(0,64),prompt_version:String(h.prompt_version||y.aiPromptVersion).slice(0,80),ai_response_schema_version:String(h.ai_response_schema_version||y.aiResponseSchemaVersion).slice(0,80),quant_feature_snapshot_hash:String(h.quant_feature_snapshot_hash||"").slice(0,120),decision_hash:String(h.decision_hash||"").slice(0,120),audit_sig:String(h.audit_sig||"").slice(0,140),overlay_plan_reason:String(h.overlay_plan_reason||"").slice(0,160),engine_path:String(h.engine_path||"").slice(0,80),prompt_used:!!h.prompt_used,ai_transport_ready:!!h.ai_transport_ready,created_ts:Math.max(0,Math.round(s(h.created_ts,0))),crypto_signature:v?{status:String(v.status||"").slice(0,32)||void 0,alg:String(v.alg||"").slice(0,80)||void 0,key_id:String(v.key_id||v.keyId||"").slice(0,160)||void 0,sig_b64u:String(v.sig_b64u||v.signatureB64u||"").slice(0,600)||void 0,payload_hash_sha256_b64u:String(v.payload_hash_sha256_b64u||v.payloadHashSha256B64u||"").slice(0,160)||void 0,signer:String(v.signer||"").slice(0,80)||void 0,signed_ts:Math.max(0,Math.round(s(v.signed_ts??v.signedAt,0))),signing_latency_ms:Math.max(0,Math.round(s(v.signing_latency_ms??v.signingLatencyMs,0))),public_key_pem:typeof v.public_key_pem=="string"?v.public_key_pem.slice(0,4e3):typeof v.publicKeyPem=="string"?v.publicKeyPem.slice(0,4e3):void 0,error:String(v.error||"").slice(0,240)||void 0}:void 0,quant_feature_snapshot_excerpt:h.quant_feature_snapshot_excerpt&&typeof h.quant_feature_snapshot_excerpt=="object"?{regime:String(h.quant_feature_snapshot_excerpt.regime||"").slice(0,40),sample_count:Math.max(0,Math.round(s(h.quant_feature_snapshot_excerpt.sample_count,0))),edge_score:l(s(h.quant_feature_snapshot_excerpt.edge_score,0),6),data_quality_score:l(s(h.quant_feature_snapshot_excerpt.data_quality_score,0),6),price_usd:l(s(h.quant_feature_snapshot_excerpt.price_usd,0),8),wallet_kas:l(s(h.quant_feature_snapshot_excerpt.wallet_kas,0),6),daa_score:Math.max(0,Math.round(s(h.quant_feature_snapshot_excerpt.daa_score,0)))}:void 0}:void 0;return{action:r,confidence_score:l(_,4),risk_score:l(n,4),kelly_fraction:d(s(e==null?void 0:e.kelly_fraction,0),0,1),capital_allocation_kas:Number(c.toFixed(6)),capital_allocation_pct:Number(o.toFixed(2)),expected_value_pct:Number(s(e==null?void 0:e.expected_value_pct,0).toFixed(2)),stop_loss_pct:Number(Math.max(0,s(e==null?void 0:e.stop_loss_pct,0)).toFixed(2)),take_profit_pct:Number(Math.max(0,s(e==null?void 0:e.take_profit_pct,0)).toFixed(2)),monte_carlo_win_pct:Number(d(s(e==null?void 0:e.monte_carlo_win_pct,0),0,100).toFixed(2)),volatility_estimate:p,liquidity_impact:g,strategy_phase:A,rationale:String((e==null?void 0:e.rationale)||"No rationale returned by engine."),risk_factors:M,next_review_trigger:String((e==null?void 0:e.next_review_trigger)||"On next cycle or major DAA/price movement."),decision_source:T,decision_source_detail:b,quant_metrics:w,engine_latency_ms:O,...x?{audit_record:x}:{}}}function yt(e,t,i){var a,c,o;const r=(i==null?void 0:i.quant_metrics)||{};return{agent:{id:String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"agent"),risk:String((e==null?void 0:e.risk)||""),capitalLimit:l(Math.max(0,s(e==null?void 0:e.capitalLimit,0)),6),autoApproveThreshold:l(Math.max(0,s(e==null?void 0:e.autoApproveThreshold,0)),6),strategyTemplate:String((e==null?void 0:e.strategyTemplate)||(e==null?void 0:e.strategyLabel)||"custom")},kaspa:{address:String((t==null?void 0:t.address)||""),walletKas:l(Math.max(0,s(t==null?void 0:t.walletKas,0)),6),priceUsd:l(Math.max(0,s(t==null?void 0:t.priceUsd,0)),8),daaScore:Math.max(0,Math.round(s((a=t==null?void 0:t.dag)==null?void 0:a.daaScore,0))),network:String(((c=t==null?void 0:t.dag)==null?void 0:c.networkName)||((o=t==null?void 0:t.dag)==null?void 0:o.network)||"")},quantCore:{action:String((i==null?void 0:i.action)||"HOLD"),confidence_score:l(s(i==null?void 0:i.confidence_score,0),4),risk_score:l(s(i==null?void 0:i.risk_score,0),4),kelly_fraction:l(s(i==null?void 0:i.kelly_fraction,0),6),capital_allocation_kas:l(s(i==null?void 0:i.capital_allocation_kas,0),6),expected_value_pct:l(s(i==null?void 0:i.expected_value_pct,0),4),quant_metrics:{regime:String((r==null?void 0:r.regime)||""),sample_count:Math.max(0,Math.round(s(r==null?void 0:r.sample_count,0))),edge_score:l(s(r==null?void 0:r.edge_score,0),6),data_quality_score:l(s(r==null?void 0:r.data_quality_score,0),6),ewma_volatility:l(s(r==null?void 0:r.ewma_volatility,0),6),risk_ceiling:l(s(r==null?void 0:r.risk_ceiling,0),6),kelly_cap:l(s(r==null?void 0:r.kelly_cap,0),6)}}}}async function gt(e){var _,n,u,p,m,g,f,A,M,S,T,b;const t=e.decision||{},i=yt(e.agent,e.kasData,e.quantCoreDecision),r=await re(i),a={...t,audit_record:void 0},c=await re(a),o=await re({decision_hash:c,quant_feature_snapshot_hash:r,prompt_version:y.aiPromptVersion,ai_response_schema_version:y.aiResponseSchemaVersion,overlay_plan_reason:e.overlayPlanReason,engine_path:e.enginePath});return R({...t,audit_record:{audit_record_version:y.decisionAuditRecordVersion,hash_algo:Q,prompt_version:y.aiPromptVersion,ai_response_schema_version:y.aiResponseSchemaVersion,quant_feature_snapshot_hash:r,decision_hash:c,audit_sig:o,overlay_plan_reason:e.overlayPlanReason,engine_path:e.enginePath,prompt_used:e.enginePath==="hybrid-ai"||e.enginePath==="ai",ai_transport_ready:y.aiTransportReady,created_ts:Date.now(),quant_feature_snapshot_excerpt:{regime:String(((n=(_=e.quantCoreDecision)==null?void 0:_.quant_metrics)==null?void 0:n.regime)||""),sample_count:Math.max(0,Math.round(s((p=(u=e.quantCoreDecision)==null?void 0:u.quant_metrics)==null?void 0:p.sample_count,0))),edge_score:l(s((g=(m=e.quantCoreDecision)==null?void 0:m.quant_metrics)==null?void 0:g.edge_score,0),6),data_quality_score:l(s((A=(f=e.quantCoreDecision)==null?void 0:f.quant_metrics)==null?void 0:A.data_quality_score,0),6),price_usd:l(s((M=e.kasData)==null?void 0:M.priceUsd,0),8),wallet_kas:l(s((S=e.kasData)==null?void 0:S.walletKas,0),6),daa_score:Math.max(0,Math.round(s((b=(T=e.kasData)==null?void 0:T.dag)==null?void 0:b.daaScore,0)))}}},e.agent)}async function q(e){const t=await gt(e);return ht(t)}function Mt(e){return Me.get(e)}function St(e,t,i){Me.set(e,t,i)}async function At(e,t,i){const r=Date.now(),a=R({...Xe(e,t,i),engine_latency_ms:Date.now()-r},e),c=et(e,t),o=Mt(c),_=ct({coreDecision:a,cached:o,config:{aiTransportReady:y.aiTransportReady,aiOverlayMode:y.aiOverlayMode,minIntervalMs:y.aiOverlayMinIntervalMs,cacheTtlMs:y.aiOverlayCacheTtlMs}});if(_.kind==="skip"&&_.reason==="ai_transport_not_configured"&&!y.aiFallbackEnabled&&y.aiOverlayMode!=="off")throw new Error("Real AI overlay is required but AI transport is not configured (set VITE_AI_API_URL and credentials/proxy).");if(_.kind==="skip")return q({decision:ye({agent:e,coreDecision:a,reason:_.reason,startedAt:r,sanitizeDecision:R}),agent:e,kasData:t,quantCoreDecision:a,overlayPlanReason:_.reason,enginePath:"quant-core"});if(_.kind==="reuse"&&o)return q({decision:ge({agent:e,cached:o,startedAt:r,reason:_.reason,sanitizeDecision:R}),agent:e,kasData:t,quantCoreDecision:a,overlayPlanReason:_.reason,enginePath:"hybrid-ai"});const n=Date.now();try{const u=await at({agent:e,kasData:t,quantCoreDecision:a,config:{apiUrl:y.aiApiUrl,model:y.aiModel,anthropicApiKey:y.anthropicApiKey,timeoutMs:y.aiTimeoutMs,maxAttempts:y.aiMaxAttempts,retryableStatuses:y.aiRetryableStatuses},sanitizeDecision:R}),p=Date.now()-n,m=_t({agent:e,coreDecision:a,aiDecision:u,aiLatencyMs:p,startedAt:r,sanitizeDecision:R});return m.decision_source_detail=oe(m==null?void 0:m.decision_source_detail,`overlay_plan:${_.reason}`),St(c,_.signature,m),q({decision:m,agent:e,kasData:t,quantCoreDecision:a,overlayPlanReason:_.reason,enginePath:"hybrid-ai"})}catch(u){if(o){const p=Math.max(0,Date.now()-o.ts);if(p<=y.aiOverlayCacheTtlMs)return q({decision:ge({agent:e,cached:o,startedAt:r,reason:`ai_error_cache_reuse_${p}ms`,sanitizeDecision:R}),agent:e,kasData:t,quantCoreDecision:a,overlayPlanReason:`ai_error_cache_reuse_${p}ms`,enginePath:"hybrid-ai"})}if(y.aiFallbackEnabled){const p=(u==null?void 0:u.name)==="AbortError"?`ai_timeout_${y.aiTimeoutMs}ms`:(u==null?void 0:u.message)||"request failure";return q({decision:ye({agent:e,coreDecision:a,reason:p,startedAt:r,sanitizeDecision:R}),agent:e,kasData:t,quantCoreDecision:a,overlayPlanReason:p,enginePath:"quant-core"})}throw(u==null?void 0:u.name)==="AbortError"?new Error(`AI request timeout (${y.aiTimeoutMs}ms)`):u}}const Se=1e4;self.onmessage=async e=>{const t=e.data;if(!(!t||typeof t.id!="number"))try{const i=new Promise((c,o)=>setTimeout(()=>o(new Error(`Quant engine timed out after ${Se}ms`)),Se)),r=await Promise.race([At(t.agent,t.kasData,t.context),i]),a={id:t.id,ok:!0,decision:r};self.postMessage(a)}catch(i){const r={id:t.id,ok:!1,error:String((i==null?void 0:i.message)||"Quant worker request failed")};self.postMessage(r)}}})();
