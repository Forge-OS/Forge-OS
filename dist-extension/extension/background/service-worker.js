(function(){"use strict";const $=Math.round(440)+24,V=Math.round(720*1)+32,Z=3e5;function tt(t){if(Array.isArray(t))return t;if(typeof t!="string")return null;const n=t.trim();if(!n)return[];try{const e=JSON.parse(n);return Array.isArray(e)?e:null}catch{return null}}function et(t){return!t||typeof t!="object"?null:t}function D(t){const n=tt(t);if(!n)return null;const e=n.slice(-64),i=[];for(const o of e){const c=et(o);c&&i.push(c)}const r=JSON.stringify(i);return r.length>Z?null:{json:r,count:i.length}}function nt(){return{activeConnect:null,activeSign:null,connectQueue:[],signQueue:[]}}function U(t,n){return typeof t=="number"&&Number.isFinite(t)&&t>0?t:n}function F(t,n){const e=t;return!e||typeof e.requestId!="string"||!e.requestId||!Number.isFinite(e.tabId)?null:{requestId:e.requestId,tabId:Number(e.tabId),origin:typeof e.origin=="string"&&e.origin?e.origin:void 0,createdAt:U(e.createdAt,n)}}function B(t,n){const e=t;return!e||typeof e.requestId!="string"||!e.requestId||!Number.isFinite(e.tabId)||typeof e.message!="string"?null:{requestId:e.requestId,tabId:Number(e.tabId),origin:typeof e.origin=="string"&&e.origin?e.origin:void 0,message:e.message,createdAt:U(e.createdAt,n)}}function rt(t,n){if(!Array.isArray(t))return[];const e=[];for(const i of t){const r=F(i,n);if(r&&e.push(r),e.length>=100)break}return e}function ot(t,n){if(!Array.isArray(t))return[];const e=[];for(const i of t){const r=B(i,n);if(r&&e.push(r),e.length>=100)break}return e}function it(t,n=Date.now()){const e=rt(t.connectQueue,n),i=ot(t.signQueue,n),r=F(t.activeConnect,n),o=B(t.activeSign,n);return{activeConnect:r??e.shift()??null,activeSign:o??i.shift()??null,connectQueue:e,signQueue:i}}function ct(t,n){const e=[...t.connectQueue,n];return{activeConnect:t.activeConnect??e.shift()??null,activeSign:t.activeSign,connectQueue:e,signQueue:[...t.signQueue]}}function ut(t,n){const e=[...t.signQueue,n],i=t.activeSign??e.shift()??null;return{activeConnect:t.activeConnect,activeSign:i,connectQueue:[...t.connectQueue],signQueue:e}}function T(t,n){const e=t.activeConnect;if(!e)return{state:t,resolved:null,stale:!0};if(n&&n!==e.requestId)return{state:t,resolved:null,stale:!0};const i=[...t.connectQueue];return{state:{activeConnect:i.shift()??null,activeSign:t.activeSign,connectQueue:i,signQueue:[...t.signQueue]},resolved:e,stale:!1}}function A(t,n){const e=t.activeSign;if(!e)return{state:t,resolved:null,stale:!0};if(n&&n!==e.requestId)return{state:t,resolved:null,stale:!0};const i=[...t.signQueue],r=i.shift()??null;return{state:{activeConnect:t.activeConnect,activeSign:r,connectQueue:[...t.connectQueue],signQueue:i},resolved:e,stale:!1}}function y(t){return t.connectQueue.length+t.signQueue.length+(t.activeConnect?1:0)+(t.activeSign?1:0)}function st(t,n){const e=[],i=[];let r=t.activeConnect,o=t.activeSign;(r==null?void 0:r.tabId)===n&&(e.push(r),r=null),(o==null?void 0:o.tabId)===n&&(i.push(o),o=null);const c=t.connectQueue.filter(f=>f.tabId===n?(e.push(f),!1):!0),u=t.signQueue.filter(f=>f.tabId===n?(i.push(f),!1):!0);return r||(r=c.shift()??null),o||(o=u.shift()??null),{state:{activeConnect:r,activeSign:o,connectQueue:c,signQueue:u},removedConnect:e,removedSign:i}}function I(t){return(typeof t=="string"?t.trim().toLowerCase():"")||"__unknown_origin__"}function m(t,n){const e=I(n);let i=0;return t.activeConnect&&I(t.activeConnect.origin)===e&&i++,t.activeSign&&I(t.activeSign.origin)===e&&i++,i+=t.connectQueue.filter(r=>I(r.origin)===e).length,i+=t.signQueue.filter(r=>I(r.origin)===e).length,i}function at(t,n,e){const i=n-Math.max(1,e),r=[],o=[];let c=t.activeConnect,u=t.activeSign;const f=[...t.connectQueue],v=[...t.signQueue];c&&c.createdAt<=i&&(r.push(c),c=null),u&&u.createdAt<=i&&(o.push(u),u=null);const a=f.filter(l=>l.createdAt<=i?(r.push(l),!1):!0),d=v.filter(l=>l.createdAt<=i?(o.push(l),!1):!0);return c||(c=a.shift()??null),u||(u=d.shift()??null),{state:{activeConnect:c,activeSign:u,connectQueue:a,signQueue:d},expiredConnect:r,expiredSign:o}}const K={mainnet:"https://api.kaspa.org","testnet-10":"https://api-tn10.kaspa.org","testnet-11":"https://api-tn11.kaspa.org","testnet-12":"https://api-tn12.kaspa.org"},dt=1e8,P="forgeos-balance-poll",N="forgeos-autolock",q="forgeos-pending-sweep",E={};function lt(t,n){const e=E==null?void 0:E[t];if(typeof e!="string")return n;const i=e.trim().toLowerCase();return i==="true"?!0:i==="false"?!1:n}function R(t,n,e,i){const r=Number(E==null?void 0:E[t]);return Number.isFinite(r)?Math.min(i,Math.max(e,Math.floor(r))):n}const ft=R("VITE_EXT_PENDING_REQUEST_TTL_MS",12e4,3e4,9e5),Q=R("VITE_EXT_PENDING_PER_ORIGIN",4,1,20),X=R("VITE_EXT_PENDING_TOTAL_MAX",40,Q,200),pt=lt("VITE_EXT_PENDING_STRICT_GLOBAL_ORDER",!1),b="forgeos.wallet.meta.v2",W="forgeos.session.agents.v2",C="forgeos.connect.pending",w="forgeos.sign.pending",G="forgeos.connect.queue",x="forgeos.sign.queue";function Y(t){chrome.runtime.sendMessage({type:"FORGEOS_AGENTS_UPDATED",count:Math.max(0,Math.floor(t||0)),updatedAt:Date.now()}).catch(()=>{})}function gt(t){const n=D(t);return n?(chrome.storage.local.set({[W]:n.json}),Y(n.count),!0):!1}async function L(){var i,r;try{await chrome.action.openPopup();return}catch{}const t=chrome.runtime.getManifest(),n=((i=t==null?void 0:t.action)==null?void 0:i.default_popup)||((r=t==null?void 0:t.browser_action)==null?void 0:r.default_popup)||"extension/popup/index.html",e=String(n).replace(/^\/+/,"");await chrome.windows.create({url:chrome.runtime.getURL(e),type:"popup",width:$,height:V,focused:!0})}async function ht(){return new Promise(t=>{chrome.storage.local.get(b,n=>{try{const e=n[b];if(!e)return t(null);const i=typeof e=="string"?JSON.parse(e):e;if(typeof(i==null?void 0:i.address)!="string")return t(null);t({address:i.address,network:typeof(i==null?void 0:i.network)=="string"?i.network:"mainnet"})}catch{t(null)}})})}async function St(){const t=await ht();if(!(t!=null&&t.address)){chrome.action.setBadgeText({text:""});return}const n=K[t.network??"mainnet"]??K.mainnet;try{const e=await fetch(`${n}/addresses/${encodeURIComponent(t.address)}/balance`);if(!e.ok)return;const i=await e.json(),r=((i==null?void 0:i.balance)??0)/dt,o=r>=1e6?`${(r/1e6).toFixed(1)}M`:r>=1e3?`${(r/1e3).toFixed(1)}K`:r.toFixed(0);chrome.action.setBadgeText({text:o}),chrome.action.setBadgeBackgroundColor({color:"#39DDB6"})}catch{}}function H(t){var e;const n=(e=t==null?void 0:t.tab)==null?void 0:e.url;if(typeof n=="string")try{return new URL(n).origin}catch{return}}let j=Promise.resolve();function h(t){j=j.then(t).catch(()=>{})}function g(t,n,e){chrome.tabs.sendMessage(t,{type:"FORGEOS_CONNECT_RESULT",requestId:n,...e.result?{result:e.result}:{},...e.error?{error:e.error}:{}}).catch(()=>{})}function S(t,n,e){chrome.tabs.sendMessage(t,{type:"FORGEOS_SIGN_RESULT",requestId:n,...e.result!==void 0?{result:e.result}:{},...e.error?{error:e.error}:{}}).catch(()=>{})}function M(t){if(!pt)return t;let n=t.activeConnect,e=t.activeSign;const i=[...t.connectQueue],r=[...t.signQueue];if(n&&e&&(n.createdAt<=e.createdAt?(r.unshift(e),e=null):(i.unshift(n),n=null)),!n&&!e){const o=i[0]??null,c=r[0]??null;o&&(!c||o.createdAt<=c.createdAt)?n=i.shift()??null:c&&(e=r.shift()??null)}return{activeConnect:n,activeSign:e,connectQueue:i,signQueue:r}}async function k(){const t=await chrome.storage.session.get([C,w,G,x]),n=it({activeConnect:t==null?void 0:t[C],activeSign:t==null?void 0:t[w],connectQueue:t==null?void 0:t[G],signQueue:t==null?void 0:t[x]});return M(n)}async function p(t){const n=M(t),e={[G]:n.connectQueue,[x]:n.signQueue};n.activeConnect&&(e[C]=n.activeConnect),n.activeSign&&(e[w]=n.activeSign),await chrome.storage.session.set(e);const i=[];n.activeConnect||i.push(C),n.activeSign||i.push(w),i.length&&await chrome.storage.session.remove(i)}async function _(t=Date.now()){const n=await k(),e=at(n,t,ft);if(e.expiredConnect.length+e.expiredSign.length===0)return e.state;const r=M(e.state);await p(r),await s(r);for(const o of e.expiredConnect)g(o.tabId,o.requestId,{error:"Forge-OS: request timed out"});for(const o of e.expiredSign)S(o.tabId,o.requestId,{error:"Forge-OS: request timed out"});return r}async function _t(t){if(!Number.isFinite(t)||t<=0)return k();const n=await _(),e=st(n,t);if(e.removedConnect.length+e.removedSign.length===0)return e.state;await p(e.state),await s(e.state);for(const r of e.removedConnect)g(r.tabId,r.requestId,{error:"Forge-OS: request cancelled because the requesting tab was closed."});for(const r of e.removedSign)S(r.tabId,r.requestId,{error:"Forge-OS: request cancelled because the requesting tab was closed."});return e.state}async function s(t){const n=t??await k().catch(()=>nt()),e=y(n);if(e>0){chrome.action.setBadgeText({text:e>9?"9+":String(e)}),chrome.action.setBadgeBackgroundColor({color:"#39DDB6"});return}await St()}function z(){chrome.alarms.get(P,t=>{t||chrome.alarms.create(P,{periodInMinutes:1})})}function J(){chrome.alarms.get(q,t=>{t||chrome.alarms.create(q,{periodInMinutes:1})})}function It(t){chrome.alarms.clear(N,()=>{chrome.alarms.create(N,{delayInMinutes:t})})}function Et(){chrome.alarms.clear(N)}chrome.runtime.onInstalled.addListener(()=>{z(),J(),s().catch(()=>{})}),chrome.runtime.onStartup.addListener(()=>{z(),J(),s().catch(()=>{})}),chrome.tabs.onRemoved.addListener(t=>{h(async()=>{await _t(t)})}),chrome.alarms.onAlarm.addListener(t=>{if(t.name===P){s().catch(()=>{});return}if(t.name===q){h(async()=>{await _()});return}t.name===N&&(chrome.runtime.sendMessage({type:"AUTOLOCK_FIRED"}).catch(()=>{}),chrome.action.setBadgeText({text:"ðŸ”’"}),setTimeout(()=>{s().catch(()=>{})},3e3))}),chrome.runtime.onMessage.addListener((t,n)=>{var e,i;if((t==null?void 0:t.type)==="FORGEOS_SYNC_AGENTS"){gt(t==null?void 0:t.agents)&&s().catch(()=>{});return}if((t==null?void 0:t.type)==="FORGEOS_SYNC"){const r={},o=D(t==null?void 0:t.agents);if(o&&(r[W]=o.json),t.wallet)try{const c=JSON.parse(t.wallet),u={};typeof(c==null?void 0:c.address)=="string"&&(u.address=c.address),typeof(c==null?void 0:c.network)=="string"&&(u.network=c.network),u.address&&(r[b]=JSON.stringify(u))}catch{}Object.keys(r).length>0&&(chrome.storage.local.set(r),o&&Y(o.count),s().catch(()=>{}));return}if((t==null?void 0:t.type)==="SCHEDULE_AUTOLOCK"){It(typeof t.minutes=="number"?t.minutes:15);return}if((t==null?void 0:t.type)==="CANCEL_AUTOLOCK"){Et();return}if((t==null?void 0:t.type)==="FORGEOS_OPEN_POPUP"){L().catch(()=>{});return}if((t==null?void 0:t.type)==="FORGEOS_OPEN_FOR_CONNECT"){const r=(e=n==null?void 0:n.tab)==null?void 0:e.id;if(!r)return;const o=typeof t.requestId=="string"?t.requestId:"";if(!o){g(r,o,{error:"Invalid connect request"});return}const c=Date.now(),u=H(n),f=I(u),v={requestId:o,tabId:r,origin:u,createdAt:c};h(async()=>{let a=await _(c);if(y(a)>=X){g(r,o,{error:"Too many pending requests. Try again in a moment."});return}if(m(a,f)>=Q){g(r,o,{error:"Too many pending requests from this site. Wait for approval or timeout."});return}const d=y(a)===0;if(a=ct(a,v),await p(a),await s(a),!!d)try{await L()}catch{const l=T(a,v.requestId);if(!l.resolved)return;await p(l.state),await s(l.state),g(l.resolved.tabId,l.resolved.requestId,{error:"Could not open Forge-OS popup. Click the extension icon in your toolbar."})}});return}if((t==null?void 0:t.type)==="FORGEOS_OPEN_FOR_SIGN"){const r=(i=n==null?void 0:n.tab)==null?void 0:i.id;if(!r)return;const o=typeof t.requestId=="string"?t.requestId:"",c=typeof t.message=="string"?t.message:null;if(!o||c===null){S(r,o,{error:"Invalid sign request"});return}const u=Date.now(),f=H(n),v=I(f),a={requestId:o,tabId:r,origin:f,message:c,createdAt:u};h(async()=>{let d=await _(u);if(y(d)>=X){S(r,o,{error:"Too many pending requests. Try again in a moment."});return}if(m(d,v)>=Q){S(r,o,{error:"Too many pending requests from this site. Wait for approval or timeout."});return}const l=y(d)===0;if(d=ut(d,a),await p(d),await s(d),!!l)try{await L()}catch{const O=A(d,a.requestId);if(!O.resolved)return;await p(O.state),await s(O.state),S(O.resolved.tabId,O.resolved.requestId,{error:"Could not open Forge-OS popup. Click the extension icon in your toolbar."})}});return}if((t==null?void 0:t.type)==="FORGEOS_CONNECT_APPROVE"){h(async()=>{const r=await _(),o=T(r,typeof t.requestId=="string"?t.requestId:void 0);if(o.stale||!o.resolved)return;const c=typeof t.address=="string"?t.address:"",u=typeof t.network=="string"?t.network:"";!c||!u?g(o.resolved.tabId,o.resolved.requestId,{error:"Invalid connect approval payload"}):g(o.resolved.tabId,o.resolved.requestId,{result:{address:c,network:u}}),await p(o.state),await s(o.state)});return}if((t==null?void 0:t.type)==="FORGEOS_CONNECT_REJECT"){h(async()=>{const r=await _(),o=T(r,typeof t.requestId=="string"?t.requestId:void 0);o.stale||!o.resolved||(g(o.resolved.tabId,o.resolved.requestId,{error:typeof t.error=="string"?t.error:"Connection rejected by user"}),await p(o.state),await s(o.state))});return}if((t==null?void 0:t.type)==="FORGEOS_SIGN_APPROVE"){h(async()=>{const r=await _(),o=A(r,typeof t.requestId=="string"?t.requestId:void 0);if(o.stale||!o.resolved)return;const c=typeof t.signature=="string"?t.signature:"";S(o.resolved.tabId,o.resolved.requestId,{result:c||null,error:c?void 0:"Invalid signature payload"}),await p(o.state),await s(o.state)});return}if((t==null?void 0:t.type)==="FORGEOS_SIGN_REJECT"){h(async()=>{const r=await _(),o=A(r,typeof t.requestId=="string"?t.requestId:void 0);o.stale||!o.resolved||(S(o.resolved.tabId,o.resolved.requestId,{error:typeof t.error=="string"?t.error:"Signing rejected by user"}),await p(o.state),await s(o.state))});return}})})();
