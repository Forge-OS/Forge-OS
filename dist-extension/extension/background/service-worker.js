(function(){"use strict";const Z=Math.round(440)+24,tt=Math.round(720*1)+32,et=3e5;function nt(t){if(Array.isArray(t))return t;if(typeof t!="string")return null;const n=t.trim();if(!n)return[];try{const e=JSON.parse(n);return Array.isArray(e)?e:null}catch{return null}}function rt(t){return!t||typeof t!="object"?null:t}function M(t){const n=nt(t);if(!n)return null;const e=n.slice(-64),i=[];for(const r of e){const c=rt(r);c&&i.push(c)}const o=JSON.stringify(i);return o.length>et?null:{json:o,count:i.length}}function ot(){return{activeConnect:null,activeSign:null,connectQueue:[],signQueue:[]}}function k(t,n){return typeof t=="number"&&Number.isFinite(t)&&t>0?t:n}function B(t,n){const e=t;return!e||typeof e.requestId!="string"||!e.requestId||!Number.isFinite(e.tabId)?null:{requestId:e.requestId,tabId:Number(e.tabId),origin:typeof e.origin=="string"&&e.origin?e.origin:void 0,createdAt:k(e.createdAt,n)}}function m(t,n){const e=t;return!e||typeof e.requestId!="string"||!e.requestId||!Number.isFinite(e.tabId)||typeof e.message!="string"?null:{requestId:e.requestId,tabId:Number(e.tabId),origin:typeof e.origin=="string"&&e.origin?e.origin:void 0,message:e.message,createdAt:k(e.createdAt,n)}}function it(t,n){if(!Array.isArray(t))return[];const e=[];for(const i of t){const o=B(i,n);if(o&&e.push(o),e.length>=100)break}return e}function ct(t,n){if(!Array.isArray(t))return[];const e=[];for(const i of t){const o=m(i,n);if(o&&e.push(o),e.length>=100)break}return e}function ut(t,n=Date.now()){const e=it(t.connectQueue,n),i=ct(t.signQueue,n),o=B(t.activeConnect,n),r=m(t.activeSign,n);return{activeConnect:o??e.shift()??null,activeSign:r??i.shift()??null,connectQueue:e,signQueue:i}}function st(t,n){const e=[...t.connectQueue,n];return{activeConnect:t.activeConnect??e.shift()??null,activeSign:t.activeSign,connectQueue:e,signQueue:[...t.signQueue]}}function at(t,n){const e=[...t.signQueue,n],i=t.activeSign??e.shift()??null;return{activeConnect:t.activeConnect,activeSign:i,connectQueue:[...t.connectQueue],signQueue:e}}function T(t,n){const e=t.activeConnect;if(!e)return{state:t,resolved:null,stale:!0};if(n&&n!==e.requestId)return{state:t,resolved:null,stale:!0};const i=[...t.connectQueue];return{state:{activeConnect:i.shift()??null,activeSign:t.activeSign,connectQueue:i,signQueue:[...t.signQueue]},resolved:e,stale:!1}}function q(t,n){const e=t.activeSign;if(!e)return{state:t,resolved:null,stale:!0};if(n&&n!==e.requestId)return{state:t,resolved:null,stale:!0};const i=[...t.signQueue],o=i.shift()??null;return{state:{activeConnect:t.activeConnect,activeSign:o,connectQueue:[...t.connectQueue],signQueue:i},resolved:e,stale:!1}}function v(t){return t.connectQueue.length+t.signQueue.length+(t.activeConnect?1:0)+(t.activeSign?1:0)}function dt(t,n){const e=[],i=[];let o=t.activeConnect,r=t.activeSign;(o==null?void 0:o.tabId)===n&&(e.push(o),o=null),(r==null?void 0:r.tabId)===n&&(i.push(r),r=null);const c=t.connectQueue.filter(a=>a.tabId===n?(e.push(a),!1):!0),u=t.signQueue.filter(a=>a.tabId===n?(i.push(a),!1):!0);return o||(o=c.shift()??null),r||(r=u.shift()??null),{state:{activeConnect:o,activeSign:r,connectQueue:c,signQueue:u},removedConnect:e,removedSign:i}}function S(t){return(typeof t=="string"?t.trim().toLowerCase():"")||"__unknown_origin__"}function K(t,n){const e=S(n);let i=0;return t.activeConnect&&S(t.activeConnect.origin)===e&&i++,t.activeSign&&S(t.activeSign.origin)===e&&i++,i+=t.connectQueue.filter(o=>S(o.origin)===e).length,i+=t.signQueue.filter(o=>S(o.origin)===e).length,i}function lt(t,n,e){const i=n-Math.max(1,e),o=[],r=[];let c=t.activeConnect,u=t.activeSign;const a=[...t.connectQueue],p=[...t.signQueue];c&&c.createdAt<=i&&(o.push(c),c=null),u&&u.createdAt<=i&&(r.push(u),u=null);const d=a.filter(f=>f.createdAt<=i?(o.push(f),!1):!0),l=p.filter(f=>f.createdAt<=i?(r.push(f),!1):!0);return c||(c=d.shift()??null),u||(u=l.shift()??null),{state:{activeConnect:c,activeSign:u,connectQueue:d,signQueue:l},expiredConnect:o,expiredSign:r}}const X={mainnet:"https://api.kaspa.org","testnet-10":"https://api-tn10.kaspa.org","testnet-11":"https://api-tn11.kaspa.org","testnet-12":"https://api-tn12.kaspa.org"},ft=1e8,R="forgeos-balance-poll",w="forgeos-autolock",Q="forgeos-pending-sweep",y={};function W(t,n){const e=y==null?void 0:y[t];if(typeof e!="string")return n;const i=e.trim().toLowerCase();return i==="true"?!0:i==="false"?!1:n}function b(t,n,e,i){const o=Number(y==null?void 0:y[t]);return Number.isFinite(o)?Math.min(i,Math.max(e,Math.floor(o))):n}const pt=b("VITE_EXT_PENDING_REQUEST_TTL_MS",12e4,3e4,9e5),G=b("VITE_EXT_PENDING_PER_ORIGIN",4,1,20),Y=b("VITE_EXT_PENDING_TOTAL_MAX",40,G,200),gt=W("VITE_EXT_PENDING_STRICT_GLOBAL_ORDER",!1),ht=W("VITE_EXT_POPUP_WINDOW_FALLBACK",!1),L="forgeos.wallet.meta.v2",H="forgeos.session.agents.v2",N="forgeos.connect.pending",C="forgeos.sign.pending",U="forgeos.connect.queue",x="forgeos.sign.queue";function j(t){chrome.runtime.sendMessage({type:"FORGEOS_AGENTS_UPDATED",count:Math.max(0,Math.floor(t||0)),updatedAt:Date.now()}).catch(()=>{})}function _t(t){const n=M(t);return n?(chrome.storage.local.set({[H]:n.json}),j(n.count),!0):!1}async function A(){var c,u;const t=chrome.runtime.getManifest(),n=((c=t==null?void 0:t.action)==null?void 0:c.default_popup)||((u=t==null?void 0:t.browser_action)==null?void 0:u.default_popup)||"extension/popup/index.html",e=String(n).replace(/^\/+/,""),i=chrome.runtime.getURL(e),r=(await chrome.windows.getAll({populate:!0})).find(a=>(a.tabs??[]).some(p=>typeof(p==null?void 0:p.url)=="string"&&p.url===i));if(r!=null&&r.id){await chrome.windows.update(r.id,{focused:!0});return}try{await chrome.action.openPopup();return}catch{}if(!ht)throw new Error("Could not open Forge-OS popup automatically.");await chrome.windows.create({url:i,type:"popup",width:Z,height:tt,focused:!0})}async function P(t){if(!(v(t)<=0))try{await A()}catch{}}async function It(){return new Promise(t=>{chrome.storage.local.get(L,n=>{try{const e=n[L];if(!e)return t(null);const i=typeof e=="string"?JSON.parse(e):e;if(typeof(i==null?void 0:i.address)!="string")return t(null);t({address:i.address,network:typeof(i==null?void 0:i.network)=="string"?i.network:"mainnet"})}catch{t(null)}})})}async function Et(){const t=await It();if(!(t!=null&&t.address)){chrome.action.setBadgeText({text:""});return}const n=X[t.network??"mainnet"]??X.mainnet;try{const e=await fetch(`${n}/addresses/${encodeURIComponent(t.address)}/balance`);if(!e.ok)return;const i=await e.json(),o=((i==null?void 0:i.balance)??0)/ft,r=o>=1e6?`${(o/1e6).toFixed(1)}M`:o>=1e3?`${(o/1e3).toFixed(1)}K`:o.toFixed(0);chrome.action.setBadgeText({text:r}),chrome.action.setBadgeBackgroundColor({color:"#39DDB6"})}catch{}}function z(t){var e;const n=(e=t==null?void 0:t.tab)==null?void 0:e.url;if(typeof n=="string")try{return new URL(n).origin}catch{return}}let J=Promise.resolve();function _(t){J=J.then(t).catch(()=>{})}function h(t,n,e){chrome.tabs.sendMessage(t,{type:"FORGEOS_CONNECT_RESULT",requestId:n,...e.result?{result:e.result}:{},...e.error?{error:e.error}:{}}).catch(()=>{})}function I(t,n,e){chrome.tabs.sendMessage(t,{type:"FORGEOS_SIGN_RESULT",requestId:n,...e.result!==void 0?{result:e.result}:{},...e.error?{error:e.error}:{}}).catch(()=>{})}function D(t){if(!gt)return t;let n=t.activeConnect,e=t.activeSign;const i=[...t.connectQueue],o=[...t.signQueue];if(n&&e&&(n.createdAt<=e.createdAt?(o.unshift(e),e=null):(i.unshift(n),n=null)),!n&&!e){const r=i[0]??null,c=o[0]??null;r&&(!c||r.createdAt<=c.createdAt)?n=i.shift()??null:c&&(e=o.shift()??null)}return{activeConnect:n,activeSign:e,connectQueue:i,signQueue:o}}async function F(){const t=await chrome.storage.session.get([N,C,U,x]),n=ut({activeConnect:t==null?void 0:t[N],activeSign:t==null?void 0:t[C],connectQueue:t==null?void 0:t[U],signQueue:t==null?void 0:t[x]});return D(n)}async function g(t){const n=D(t),e={[U]:n.connectQueue,[x]:n.signQueue};n.activeConnect&&(e[N]=n.activeConnect),n.activeSign&&(e[C]=n.activeSign),await chrome.storage.session.set(e);const i=[];n.activeConnect||i.push(N),n.activeSign||i.push(C),i.length&&await chrome.storage.session.remove(i)}async function E(t=Date.now()){const n=await F(),e=lt(n,t,pt);if(e.expiredConnect.length+e.expiredSign.length===0)return e.state;const o=D(e.state);await g(o),await s(o);for(const r of e.expiredConnect)h(r.tabId,r.requestId,{error:"Forge-OS: request timed out"});for(const r of e.expiredSign)I(r.tabId,r.requestId,{error:"Forge-OS: request timed out"});return o}async function St(t){if(!Number.isFinite(t)||t<=0)return F();const n=await E(),e=dt(n,t);if(e.removedConnect.length+e.removedSign.length===0)return e.state;await g(e.state),await s(e.state);for(const o of e.removedConnect)h(o.tabId,o.requestId,{error:"Forge-OS: request cancelled because the requesting tab was closed."});for(const o of e.removedSign)I(o.tabId,o.requestId,{error:"Forge-OS: request cancelled because the requesting tab was closed."});return e.state}async function s(t){const n=t??await F().catch(()=>ot()),e=v(n);if(e>0){chrome.action.setBadgeText({text:e>9?"9+":String(e)}),chrome.action.setBadgeBackgroundColor({color:"#39DDB6"});return}await Et()}function V(){chrome.alarms.get(R,t=>{t||chrome.alarms.create(R,{periodInMinutes:1})})}function $(){chrome.alarms.get(Q,t=>{t||chrome.alarms.create(Q,{periodInMinutes:1})})}function vt(t){chrome.alarms.clear(w,()=>{chrome.alarms.create(w,{delayInMinutes:t})})}function yt(){chrome.alarms.clear(w)}chrome.runtime.onInstalled.addListener(()=>{V(),$(),s().catch(()=>{})}),chrome.runtime.onStartup.addListener(()=>{V(),$(),s().catch(()=>{})}),chrome.tabs.onRemoved.addListener(t=>{_(async()=>{await St(t)})}),chrome.alarms.onAlarm.addListener(t=>{if(t.name===R){s().catch(()=>{});return}if(t.name===Q){_(async()=>{await E()});return}t.name===w&&(chrome.runtime.sendMessage({type:"AUTOLOCK_FIRED"}).catch(()=>{}),chrome.action.setBadgeText({text:"ðŸ”’"}),setTimeout(()=>{s().catch(()=>{})},3e3))}),chrome.runtime.onMessage.addListener((t,n)=>{var e,i;if((t==null?void 0:t.type)==="FORGEOS_SYNC_AGENTS"){_t(t==null?void 0:t.agents)&&s().catch(()=>{});return}if((t==null?void 0:t.type)==="FORGEOS_SYNC"){const o={},r=M(t==null?void 0:t.agents);if(r&&(o[H]=r.json),t.wallet)try{const c=JSON.parse(t.wallet),u={};typeof(c==null?void 0:c.address)=="string"&&(u.address=c.address),typeof(c==null?void 0:c.network)=="string"&&(u.network=c.network),u.address&&(o[L]=JSON.stringify(u))}catch{}Object.keys(o).length>0&&(chrome.storage.local.set(o),r&&j(r.count),s().catch(()=>{}));return}if((t==null?void 0:t.type)==="SCHEDULE_AUTOLOCK"){vt(typeof t.minutes=="number"?t.minutes:15);return}if((t==null?void 0:t.type)==="CANCEL_AUTOLOCK"){yt();return}if((t==null?void 0:t.type)==="FORGEOS_OPEN_POPUP"){A().catch(()=>{});return}if((t==null?void 0:t.type)==="FORGEOS_OPEN_FOR_CONNECT"){const o=(e=n==null?void 0:n.tab)==null?void 0:e.id;if(!o)return;const r=typeof t.requestId=="string"?t.requestId:"";if(!r){h(o,r,{error:"Invalid connect request"});return}const c=Date.now(),u=z(n),a=S(u),p={requestId:r,tabId:o,origin:u,createdAt:c};_(async()=>{let d=await E(c);if(v(d)>=Y){h(o,r,{error:"Too many pending requests. Try again in a moment."});return}if(K(d,a)>=G){h(o,r,{error:"Too many pending requests from this site. Wait for approval or timeout."});return}const l=v(d)===0;if(d=st(d,p),await g(d),await s(d),!!l)try{await A()}catch{const f=T(d,p.requestId);if(!f.resolved)return;await g(f.state),await s(f.state),h(f.resolved.tabId,f.resolved.requestId,{error:"Could not open Forge-OS popup. Click the extension icon in your toolbar."})}});return}if((t==null?void 0:t.type)==="FORGEOS_OPEN_FOR_SIGN"){const o=(i=n==null?void 0:n.tab)==null?void 0:i.id;if(!o)return;const r=typeof t.requestId=="string"?t.requestId:"",c=typeof t.message=="string"?t.message:null;if(!r||c===null){I(o,r,{error:"Invalid sign request"});return}const u=Date.now(),a=z(n),p=S(a),d={requestId:r,tabId:o,origin:a,message:c,createdAt:u};_(async()=>{let l=await E(u);if(v(l)>=Y){I(o,r,{error:"Too many pending requests. Try again in a moment."});return}if(K(l,p)>=G){I(o,r,{error:"Too many pending requests from this site. Wait for approval or timeout."});return}const f=v(l)===0;if(l=at(l,d),await g(l),await s(l),!!f)try{await A()}catch{const O=q(l,d.requestId);if(!O.resolved)return;await g(O.state),await s(O.state),I(O.resolved.tabId,O.resolved.requestId,{error:"Could not open Forge-OS popup. Click the extension icon in your toolbar."})}});return}if((t==null?void 0:t.type)==="FORGEOS_CONNECT_APPROVE"){_(async()=>{const o=await E(),r=T(o,typeof t.requestId=="string"?t.requestId:void 0);if(r.stale||!r.resolved)return;const c=typeof t.address=="string"?t.address:"",u=typeof t.network=="string"?t.network:"";!c||!u?h(r.resolved.tabId,r.resolved.requestId,{error:"Invalid connect approval payload"}):h(r.resolved.tabId,r.resolved.requestId,{result:{address:c,network:u}}),await g(r.state),await s(r.state),await P(r.state)});return}if((t==null?void 0:t.type)==="FORGEOS_CONNECT_REJECT"){_(async()=>{const o=await E(),r=T(o,typeof t.requestId=="string"?t.requestId:void 0);r.stale||!r.resolved||(h(r.resolved.tabId,r.resolved.requestId,{error:typeof t.error=="string"?t.error:"Connection rejected by user"}),await g(r.state),await s(r.state),await P(r.state))});return}if((t==null?void 0:t.type)==="FORGEOS_SIGN_APPROVE"){_(async()=>{const o=await E(),r=q(o,typeof t.requestId=="string"?t.requestId:void 0);if(r.stale||!r.resolved)return;const c=typeof t.signature=="string"?t.signature:"";I(r.resolved.tabId,r.resolved.requestId,{result:c||null,error:c?void 0:"Invalid signature payload"}),await g(r.state),await s(r.state),await P(r.state)});return}if((t==null?void 0:t.type)==="FORGEOS_SIGN_REJECT"){_(async()=>{const o=await E(),r=q(o,typeof t.requestId=="string"?t.requestId:void 0);r.stale||!r.resolved||(I(r.resolved.tabId,r.resolved.requestId,{error:typeof t.error=="string"?t.error:"Signing rejected by user"}),await g(r.state),await s(r.state),await P(r.state))});return}})})();
